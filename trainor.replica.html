{% load static %}<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainer Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Define color variables for easier management */
        :root {
            --text-dark: #333333;
            --text-medium: #666666;
            --background-light: #F0F2F5; /* Main content background */
            --card-background: #FFFFFF;
            --green-icon: #28A745; /* Standard green for approved */
            --red-icon: #DC3545;   /* Standard red for drop out */
            --purple-icon: #6F42C1; /* Muted purple for programs */
            --sidebar-logo-color: #2a6dbd; /* Adjusted to match the darker end of the gradient */
            --sidebar-active-hover-color: rgba(255, 255, 255, 0.2); /* A subtle white overlay for hover/active */
            --dark-blue-card-bg: #2C5EBD; /* Dark blue background for new cards */
            --dark-blue-card-text: #FFFFFF; /* White text for dark blue cards */
            --light-blue-pie: #5C88E5; /* Light blue for pie chart segment */
            --red-pie: #FF6B6B; /* Red for pie chart segment */
            --table-header-blue: #4A89DC; /* Blue for job table header */
            --status-active-bg: #E6F7D9; /* Light green for active status */
            --status-active-text: #52C41A; /* Dark green for active status text */
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: var(--background-light);
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #4a90e2 0%, #2a6dbd 100%);
            color: white;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            border-top-right-radius: 15px;
            border-bottom-right-radius: 15px;
            transition: width 0.3s ease-in-out, transform 0.3s ease-in-out;
            z-index: 10;
        }


        .sidebar-text {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .sidebar-logo-text {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }

        .sidebar-header .logo {
            width: 40px;
            height: 40px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 10px;
            color: var(--sidebar-logo-color);
            font-size: 1.5rem;
        }

        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-nav li {
            margin-bottom: 10px;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        .sidebar-nav a:hover, .sidebar-nav a.active {
            background-color: var(--sidebar-active-hover-color);
        }

        .sidebar-nav a i {
            margin-right: 10px;
            font-size: 1.1rem;
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
            background-color: var(--background-light);
            min-height: 100vh;
            transition: margin-left 0.3s ease-in-out;
        }


        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--card-background);
            border-bottom: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-info .icon {
            margin-right: 10px;
            color: var(--text-medium);
            cursor: pointer;
        }

        .user-info .avatar {
            width: 35px;
            height: 35px;
            background-color: var(--sidebar-logo-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 500;
            margin-left: 10px;
        }

        /* Notification box styles */
        .notification-box {
            position: absolute;
            right: 20px;
            top: 60px;
            width: 250px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            border: 1px solid #e0e0e0;
        }

        .notification-box .header-notif {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: var(--sidebar-logo-color);
        }

        .notification-box ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .notification-box li {
            padding: 10px 16px;
            border-bottom: 1px solid #f0f0f0;
            color: var(--text-medium);
            font-size: 0.9rem;
        }

        .notification-box li:hover {
            background-color: #f5f5f5;
        }

        /* Common styles for content sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Overview Specific Styles */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 0.9rem;
            color: var(--text-medium);
            margin-bottom: 5px;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .card-subtitle {
            font-size: 0.8rem;
            color: var(--text-medium);
            margin-top: 5px;
        }

        .dark-blue-card {
            background-color: var(--dark-blue-card-bg);
            color: var(--dark-blue-card-text);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 250px;
            position: relative;
            transition: transform 0.2s ease;
        }

        .dark-blue-card:hover {
            transform: translateY(-5px);
        }

        .dark-blue-card h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .dark-blue-card .content-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .dark-blue-card .sub-text {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .chart-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .ongoing-training-card .program-name {
            font-size: 1.7rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .ongoing-training-card .detail-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .ongoing-training-card .detail-row i {
            margin-right: 8px;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .ongoing-training-card .last-updated {
            margin-top: auto;
            font-size: 0.8rem;
            opacity: 0.7;
            text-align: right;
        }

        /* Common Table Styles */
        .list-container {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .list-header .left-controls,
        .list-header .right-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .list-header select,
        .list-header input[type="search"] {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        .list-header input[type="search"] {
            width: 200px;
        }

        .list-header .add-button {
            background-color: var(--table-header-blue);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .list-header .add-button:hover {
            background-color: #3a7bd5;
        }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            text-align: left;
        }

        .data-table th {
            background-color: var(--table-header-blue);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .data-table td {
            color: var(--text-dark);
        }

        .data-table tr:hover {
            background-color: #f5f5f5;
        }

        .data-table .actions a,
        .data-table .actions button {
            color: white;
            text-decoration: none;
            margin-right: 10px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .data-table .actions a.view {
            background-color: #2a6dbd;
        }

        .data-table .actions a.view:hover {
            background-color: #1a5ca0;
        }

        .data-table .actions a.archive,
        .data-table .actions button.finished {
            background-color: #28a745;
        }

        .data-table .actions a.archive:hover,
        .data-table .actions button.finished:hover {
            background-color: #218838;
        }

        .data-table .actions button.dropped {
            background-color: #dc3545;
        }

        .data-table .actions button.dropped:hover {
            background-color: #c82333;
        }

        .data-table .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .data-table .status-badge.active {
            background-color: var(--status-active-bg);
            color: var(--status-active-text);
        }

        .data-table .status-badge.pending {
            background-color: #FFF3CD;
            color: #FFC107;
        }

        .data-table .status-badge.approved {
            background-color: #D4EDDA;
            color: #28A745;
        }

        .data-table .status-badge.finished {
            background-color: #D4EDDA;
            color: #28A745;
        }

        .data-table .status-badge.dropped {
            background-color: #F8D7DA;
            color: #DC3545;
        }

        /* Task-specific styles */
        .task-column-header {
            position: relative;
        }

        .check-all-task-checkbox {
            margin-right: 8px;
        }

        .dynamic-task-checkbox {
            transform: scale(1.2);
        }

        .trainee-progress {
            font-weight: 600;
            color: var(--table-header-blue);
        }

        /* Task delete button styles */
        .task-delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-left: 5px;
            transition: background-color 0.2s ease;
        }

        .task-delete-btn:hover {
            background-color: #c82333;
        }

        /* Calendar Styles */
        .calendar-day {
            min-height: 120px;
            border: 1px solid #e5e7eb;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-day:hover {
            background-color: #f8fafc;
        }

        .calendar-day.has-training {
            background-color: #f0f9ff;
            border-color: #3b82f6;
        }

        /* Date range selection styles */
        .calendar-day.range-start {
            background-color: #dbeafe !important;
            border-left: 3px solid #3b82f6;
        }

        .calendar-day.range-middle {
            background-color: #eff6ff !important;
            border-top: 2px solid #93c5fd;
            border-bottom: 2px solid #93c5fd;
        }

        .calendar-day.range-end {
            background-color: #dbeafe !important;
            border-right: 3px solid #3b82f6;
        }

        .calendar-day.range-single {
            background-color: #dbeafe !important;
            border: 3px solid #3b82f6;
        }

        .calendar-day.selecting {
            background-color: #fef3c7 !important;
            border: 2px dashed #f59e0b;
        }

        .task-item {
            font-size: 0.75rem;
            padding: 2px 6px;
            margin: 1px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .task-item:hover {
            opacity: 0.8;
            transform: scale(1.02);
        }

        /* Multi-day task spanning styles */
        .task-item.span-start {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            position: relative;
        }

        .task-item.span-start::after {
            content: '';
            position: absolute;
            right: -1px;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: inherit;
        }

        .task-item.span-middle {
            border-radius: 0;
            position: relative;
        }

        .task-item.span-middle::before,
        .task-item.span-middle::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: inherit;
        }

        .task-item.span-middle::before {
            left: -1px;
        }

        .task-item.span-middle::after {
            right: -1px;
        }

        .task-item.span-end {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            position: relative;
        }

        .task-item.span-end::before {
            content: '';
            position: absolute;
            left: -1px;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: inherit;
        }

        .task-item.span-single {
            /* Normal styling for single-day tasks */
        }

        /* ‚úÖ NEW: Multi-day attendance indicator */
        .multi-day-attendance-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            background-color: #10b981;
            color: white;
            font-size: 0.6rem;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
            z-index: 10;
        }

        .task-item.attendance-available {
            border: 2px solid #10b981 !important;
            box-shadow: 0 0 0 1px #10b981;
        }

        .task-item.attendance-taken {
            opacity: 0.7;
            border: 2px solid #6b7280 !important;
        }

        /* Trainer indicator for training sessions */
        .trainer-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background-color: #f59e0b;
            color: white;
            font-size: 0.6rem;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
        }

        .task-item.own-training {
            border: 2px solid #10b981;
        }

        .task-item.other-training {
            border: 1px dashed #6b7280;
            opacity: 0.9;
        }

        /* Training session indicators */
        .training-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3b82f6;
        }

        /* Month navigation with training indicators */
        .month-nav-button {
            position: relative;
        }

        .month-nav-button.has-training::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 6px;
            height: 6px;
            background-color: #ef4444;
            border-radius: 50%;
        }

        /* Training summary panel */
        .training-summary {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .training-count {
            font-weight: 600;
            color: #1e40af;
        }

        /* Trainer filter */
        .trainer-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .trainer-filter select {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        /* Date range selection info */
        .date-range-info {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            display: none;
        }

        .date-range-info.active {
            display: block;
        }

        .date-range-info .range-text {
            font-weight: 600;
            color: #1e40af;
        }

        .date-range-info .clear-selection {
            background-color: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
        }

        /* Modal Styles - Updated */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* Training Creation Modal - Made Wider */
        .modal-content {
            background-color: var(--card-background);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 800px; /* ‚úÖ Increased from 450px to 800px */
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            opacity: 0;
            animation: fadeInScale 0.3s forwards;
        }

        @keyframes fadeInScale {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h3 {
            font-size: 1.8rem; /* ‚úÖ Slightly larger heading */
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 25px;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
        }

        .modal-content label {
            display: block;
            font-size: 0.95rem;
            color: var(--text-medium);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .modal-content input[type="text"],
        .modal-content input[type="date"],
        .modal-content input[type="time"],
        .modal-content select,
        .modal-content textarea {
            width: 100%;
            padding: 12px 15px; /* ‚úÖ Slightly more padding */
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            color: var(--text-dark);
            margin-bottom: 20px;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }

        .modal-content input:focus,
        .modal-content select:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: var(--table-header-blue);
            box-shadow: 0 0 0 3px rgba(74, 137, 220, 0.1);
        }

        /* ‚úÖ Enhanced grid layout for form fields */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .modal-buttons button {
            padding: 12px 25px; /* ‚úÖ Larger buttons */
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-size: 1rem;
        }

        .modal-buttons .cancel-button {
            background-color: #e0e0e0;
            color: var(--text-dark);
        }

        .modal-buttons .cancel-button:hover {
            background-color: #d0d0d0;
            transform: translateY(-1px);
        }

        .modal-buttons .add-button-modal {
            background-color: var(--table-header-blue);
            color: white;
        }

        .modal-buttons .add-button-modal:hover {
            background-color: #3a7bd5;
            transform: translateY(-1px);
        }

        /* Activity Details Modal */
        .activity-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .activity-details-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .activity-details-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 30px;
            border-bottom: 2px solid #e5e7eb;
            background-color: #f8fafc;
            flex-shrink: 0;
        }

        .activity-details-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

        .activity-details-body {
            padding: 30px;
            flex: 1;
            overflow-y: auto;
            background-color: white;
        }

        .activity-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .activity-info-item {
            display: flex;
            flex-direction: column;
        }

        .activity-info-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-medium);
            margin-bottom: 5px;
        }

        .activity-info-value {
            font-size: 1.1rem;
            color: var(--text-dark);
            padding: 8px 12px;
            background-color: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .activity-description {
            margin-top: 20px;
        }

        .activity-description h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .activity-description p {
            color: var(--text-medium);
            line-height: 1.6;
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .activity-details-footer {
            padding: 20px 30px;
            border-top: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8fafc;
            flex-shrink: 0;
        }

        .attendance-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .attendance-status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .attendance-status-badge.not-taken {
            background-color: #fef3c7;
            color: #d97706;
        }

        .attendance-status-badge.completed {
            background-color: #d1fae5;
            color: #059669;
        }

        .attendance-status-badge.late {
            background-color: #fee2e2;
            color: #dc2626;
        }

        /* ‚úÖ NEW: Multi-day attendance status */
        .attendance-status-badge.multi-day-available {
            background-color: #dbeafe;
            color: #1e40af;
        }

        /* Attendance Sheet Modal - Full Screen */
        .attendance-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* ‚úÖ Darker overlay */
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .attendance-content {
            background-color: white;
            border-radius: 12px;
            width: 95vw; /* ‚úÖ Almost full width */
            height: 90vh; /* ‚úÖ Almost full height */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .attendance-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 30px; /* ‚úÖ More padding */
            border-bottom: 2px solid #e5e7eb;
            background-color: #f8fafc;
            flex-shrink: 0;
        }

        .attendance-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0;
        }

        .attendance-body {
            padding: 30px;
            flex: 1;
            overflow-y: auto;
            background-color: white;
        }

        .attendance-body h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--text-dark);
            border-bottom: 2px solid var(--table-header-blue);
            padding-bottom: 10px;
        }

        .attendance-footer {
            padding: 20px 30px;
            border-top: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8fafc;
            flex-shrink: 0;
        }

        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1rem; /* ‚úÖ Larger font */
            margin-top: 20px;
        }

        .attendance-table th,
        .attendance-table td {
            border: 1px solid #e5e7eb;
            padding: 15px 20px; /* ‚úÖ More padding */
            text-align: center;
        }

        .attendance-table th {
            background-color: var(--table-header-blue);
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .attendance-table td {
            background-color: white;
        }

        .attendance-table tr:nth-child(even) td {
            background-color: #f8fafc;
        }

        .attendance-table tr:hover td {
            background-color: #e6f3ff;
        }

        .attendance-table input[type="radio"] {
            transform: scale(1.3); /* ‚úÖ Larger radio buttons */
            margin: 0;
        }

        /* ‚úÖ Close button for full screen modal */
        .attendance-close-btn, .activity-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 2rem;
            color: #666;
            cursor: pointer;
            z-index: 1001;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .attendance-close-btn:hover, .activity-close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        /* All Training Sessions Modal - Also make wider */
        #allTrainingsModal .modal-content {
            max-width: 1200px; /* ‚úÖ Even wider for the training list */
            width: 95%;
        }

        /* ‚úÖ Enhanced form styling for the wider modal */
        .info-text {
            background-color: #e6f3ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #1e40af;
        }

        .info-text i {
            margin-right: 8px;
            color: #3b82f6;
        }

        .trainer-display {
            padding: 15px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f9f9f9;
            margin-bottom: 20px;
            font-weight: 600;
            color: var(--text-medium);
            display: flex;
            align-items: center;
        }

        .trainer-display::before {
            content: "üë®‚Äçüè´";
            margin-right: 10px;
            font-size: 1.2rem;
        }

        /* Progress bar styles */
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.high {
            background-color: #28a745;
        }

        .progress-fill.medium {
            background-color: #ffc107;
        }

        .progress-fill.low {
            background-color: #007bff;
        }

        .progress-fill.none {
            background-color: #6c757d;
        }

        /* Confirmation Dialog Styles */
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .confirmation-content {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .confirmation-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .confirmation-icon.warning {
            color: #f59e0b;
        }

        .confirmation-icon.error {
            color: #ef4444;
        }

        .confirmation-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-dark);
        }

        .confirmation-message {
            font-size: 1rem;
            color: var(--text-medium);
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .confirmation-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirmation-buttons button {
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-size: 1rem;
        }

        .confirmation-buttons .confirm-btn {
            background-color: #ef4444;
            color: white;
        }

        .confirmation-buttons .confirm-btn:hover {
            background-color: #dc2626;
        }

        .confirmation-buttons .cancel-btn {
            background-color: #e5e7eb;
            color: var(--text-dark);
        }

        .confirmation-buttons .cancel-btn:hover {
            background-color: #d1d5db;
        }

        /* Late submission warning */
        .late-warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .late-warning.show {
            display: block;
        }

        .late-warning-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .late-warning-icon {
            color: #d97706;
            font-size: 1.2rem;
        }

        .late-warning-text {
            color: #92400e;
            font-weight: 500;
        }

        /* Disabled state for attendance already taken */
        .attendance-disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .attendance-completed-message {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .attendance-completed-message .icon {
            font-size: 2rem;
            color: #059669;
            margin-bottom: 10px;
        }

        .attendance-completed-message .title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #047857;
            margin-bottom: 5px;
        }

        .attendance-completed-message .subtitle {
            color: #065f46;
        }

        /* Pagination styles */
        .pagination {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 20px;
            gap: 5px;
        }

        .pagination span {
            font-size: 0.9rem;
            color: var(--text-medium);
            margin-right: 10px;
        }

        .pagination button {
            background-color: var(--card-background);
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        .pagination button:hover:not(.active-page):not(:disabled) {
            background-color: #f0f0f0;
        }

        .pagination button.active-page {
            background-color: var(--table-header-blue);
            color: white;
            border-color: var(--table-header-blue);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Multi-day attendance indicator */
        .multi-day-indicator {
            background-color: #3b82f6;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: bold;
        }

        /* ‚úÖ NEW: Day selector for multi-day attendance */
        .day-selector {
            background-color: #f0f9ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .day-selector h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 10px;
        }

        .day-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .day-button {
            padding: 8px 16px;
            border: 2px solid #bfdbfe;
            background-color: white;
            color: #1e40af;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .day-button:hover {
            background-color: #dbeafe;
        }

        .day-button.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .day-button.completed {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
            opacity: 0.8;
        }

        /* Responsive adjustments for modals */
        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
                padding: 15px 10px;
            }

            .sidebar-header h2, .sidebar-nav span, .user-info span {
                display: none;
            }

            .sidebar-nav a {
                justify-content: center;
                padding: 10px 0;
            }

            .sidebar-nav a i {
                margin-right: 0;
            }

            .main-content {
                margin-left: 80px;
                padding: 15px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .list-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .list-header input[type="search"] {
                width: 100%;
            }

            .list-header .add-button {
                width: 100%;
                justify-content: center;
            }

            .dashboard-cards {
                grid-template-columns: 1fr;
            }

            .chart-section {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                max-width: none;
                padding: 20px;
                margin: 10px;
            }
                                                                        
            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
                                                                        
            .attendance-content, .activity-details-content {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
            }
                                                                        
            .attendance-body, .activity-details-body {
                padding: 20px;
            }
                                                                        
            .attendance-table th,
            .attendance-table td {
                padding: 10px 8px;
                font-size: 0.9rem;
            }

            .activity-info-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .day-buttons {
                justify-content: center;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="sidebar" class="sidebar">
        <div>
            <div class="sidebar-header">
                <div class="flex items-center flex-1">
                    <div class="logo">
                        <img src="{% static 'Images/icon.png' %}" alt="Logo" style="width: 30px; height: 30px; border-radius: 50%;">
                    </div>
                    <h2 class="sidebar-logo-text">DLL - LMSTC</h2>
                </div>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#" data-section="overview" class="nav-link flex items-center p-2 rounded-lg bg-blue-700"><i class="fas fa-tachometer-alt mr-3"></i> <span class="sidebar-text">Overview</span></a></li>
                    <li><a href="#" data-section="masterlist" class="nav-link flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors"><i class="fas fa-list-alt mr-3"></i> <span class="sidebar-text">Master List</span></a></li>
                    <li><a href="#" data-section="reports" class="nav-link flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors"><i class="fas fa-chart-bar mr-3"></i> <span class="sidebar-text">Reports</span></a></li>
                    <li><a href="#" data-section="schedule" class="nav-link flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors"><i class="fas fa-calendar-alt mr-3"></i> <span class="sidebar-text">Schedule</span></a></li>
                    <li><a href="#" data-section="task" class="nav-link flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors"><i class="fas fa-tasks mr-3"></i> <span class="sidebar-text">Task</span></a></li>
                </ul>
            </nav>
        </div>
        <div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="{% url 'logout_view' %}"><i class="fas fa-sign-out-alt"></i> <span class="sidebar-text">Sign Out</span></a></li>
                </ul>
            </nav>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>Trainor Process Dashboard</h1>
            <div class="user-info">
                <i class="fas fa-bell icon" id="bell-btn"></i>
                <div id="notification-box" class="notification-box hidden">
                    <div class="header-notif">Notifications</div>
                    <ul>
                        <li>No new notifications</li>
                    </ul>
                </div>
                <span>Welcome!</span>
                <div class="avatar">{{ user.first_name.0|default:"U" }}</div>
                <span>{{ user.first_name|default:"User" }}</span>
            </div>
        </div>

        <!-- Overview Section -->
        <div id="overview-section" class="content-section active">
            <h2 class="text-2xl font-semibold text-gray-800 mb-5">Overview</h2>
            
            <!-- Program Assigned Section - Enhanced Design -->
            {% if trainer_profile %}
            <div class="list-container mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Program Assignment</h3>
                    <div class="flex items-center gap-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>Active
                        </span>
                    </div>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm hover:shadow-md transition-shadow duration-200">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">{{ trainer_profile.program.program_name }}</h4>
                            <div class="flex items-center gap-4 text-sm text-gray-600 mb-3">
                                <span><i class="fas fa-user-tie mr-1"></i>{{ trainer_profile.user.first_name }} {{ trainer_profile.user.last_name }}</span>
                                <span><i class="fas fa-envelope mr-1"></i>{{ trainer_profile.user.email }}</span>
                            </div>
                            <div class="flex flex-wrap gap-1 mb-3">
                                <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">Trainer</span>
                                <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">{{ trainer_profile.program.program_name }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-calendar mr-1"></i>Assigned Program
                        </div>
                        <div class="flex gap-2">
                            <button class="px-3 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                                <i class="fas fa-eye mr-1"></i>View Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Dashboard Cards - Enhanced Layout -->
            <div class="dashboard-cards">
                <div class="card">
                    <div class="card-title">Enrolled Trainees</div>
                    <div class="card-value">{{ approvedapplicant|length|default:0 }}</div>
                    <div class="card-subtitle">Currently Active Trainees</div>
                </div>
                <div class="card">
                    <div class="card-title">Program Duration</div>
                    <div class="card-value">3 Months</div>
                    <div class="card-subtitle">Last Active: <span style="color: #28a745; font-weight: 600;">Today</span></div>
                </div>
                <div class="card">
                    <div class="card-title">All Training Sessions</div>
                    <div class="card-value" id="totalTrainingSessions">{{ all_trainings|length|default:0 }}</div>
                    <div class="card-subtitle">System-wide sessions</div>
                </div>
                <div class="card">
                    <div class="card-title">My Training Sessions</div>
                    <div class="card-value" id="myTrainingSessions">{{ my_trainings|length|default:0 }}</div>
                    <div class="card-subtitle">Sessions I created</div>
                </div>
            </div>

            <!-- Enhanced Chart Section -->
            <div class="chart-section">
                <div class="dark-blue-card">
                    <h3>Program Progress Overview</h3>
                    <div style="position: relative; height: 200px; display: flex; justify-content: center; align-items: center;">
                        <canvas id="completionChart" width="200" height="200"></canvas>
                    </div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Overall Completion</span>
                            <span>65%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 65%;"></div>
                        </div>
                    </div>
                </div>
                <div class="dark-blue-card ongoing-training-card">
                    <h3>Training Summary</h3>
                    <div class="program-name">
                        {% if trainer_profile %}
                            {{ trainer_profile.program.program_name }}
                        {% else %}
                            Computer Hardware Servicing
                        {% endif %}
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-users"></i> Active Trainees: {{ approvedapplicant|length|default:5 }}
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-calendar-alt"></i> Program Started: January 2025
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-tasks"></i> Total Sessions: <span id="overviewTrainingCount">{{ all_trainings|length|default:0 }}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-user-check"></i> My Sessions: <span id="overviewMyTrainingCount">{{ my_trainings|length|default:0 }}</span>
                    </div>
                    <div class="detail-row">
                        <i class="fas fa-chart-line"></i> Completion Rate: 65%
                    </div>
                    <div class="last-updated">Last updated: Today</div>
                </div>
            </div>

            <!-- Quick Actions Section -->
            <div class="list-container">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Quick Actions</h3>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <button class="flex flex-col items-center p-4 bg-white border border-gray-200 rounded-lg hover:shadow-md transition-shadow duration-200 hover:border-blue-300">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-3">
                            <i class="fas fa-calendar-plus text-blue-600 text-xl"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-700">Schedule Training</span>
                    </button>
                    
                    <button class="flex flex-col items-center p-4 bg-white border border-gray-200 rounded-lg hover:shadow-md transition-shadow duration-200 hover:border-green-300">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-3">
                            <i class="fas fa-user-check text-green-600 text-xl"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-700">Take Attendance</span>
                    </button>
                    
                    <button class="flex flex-col items-center p-4 bg-white border border-gray-200 rounded-lg hover:shadow-md transition-shadow duration-200 hover:border-purple-300">
                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-3">
                            <i class="fas fa-chart-bar text-purple-600 text-xl"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-700">View Reports</span>
                    </button>
                    
                    <button class="flex flex-col items-center p-4 bg-white border border-gray-200 rounded-lg hover:shadow-md transition-shadow duration-200 hover:border-orange-300">
                        <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center mb-3">
                            <i class="fas fa-tasks text-orange-600 text-xl"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-700">Manage Tasks</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Master List Section -->
        <div id="masterlist-section" class="content-section">
            <h2 class="text-2xl font-semibold text-gray-800 mb-5">Enrolled Applicants Masterlist</h2>
            <div class="list-container">
                <p class="text-sm text-gray-600 mb-4">
                    Total enrolled: {{ approvedapplicant|length|default:0 }}
                </p>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Trainee Name</th>
                                <th>Enrolled Program</th>
                                <th>Progress</th>
                                <th>Attendance Summary</th>
                                <th>Enrollment Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for approved in approvedapplicant %}
                            <tr>
                                <td>{{ approved.applicant.learner_profile.first.last_name }}, {{ approved.applicant.learner_profile.first.first_name }}</td>
                                <td>{{ approved.program.program_name }}</td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <div class="progress-bar">
                                            {% if approved.progress >= 70 %}
                                                <div class="progress-fill high" style="width: {{ approved.progress }}%;"></div>
                                            {% elif approved.progress >= 40 %}
                                                <div class="progress-fill medium" style="width: {{ approved.progress }}%;"></div>
                                            {% elif approved.progress > 0 %}
                                                <div class="progress-fill low" style="width: {{ approved.progress }}%;"></div>
                                            {% else %}
                                                <div class="progress-fill none" style="width: 0%;"></div>
                                            {% endif %}
                                        </div>
                                        <span class="text-sm text-gray-600">{{ approved.progress|default:0 }}%</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="text-center" id="student-attendance-{{ approved.applicant.id }}">
                                        <div class="grid grid-cols-2 border text-center text-xs font-semibold">
                                            <div class="border-r py-1">PRESENT</div>
                                            <div class="py-1">ABSENT</div>
                                        </div>
                                        <div class="grid grid-cols-2 border-b border-l border-r text-center">
                                            <div class="border-r py-1 text-green-600 font-semibold">
                                                {{ approved.total_present|default:0 }}
                                            </div>
                                            <div class="py-1 text-red-600 font-semibold">
                                                {{ approved.total_absent|default:0 }}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ approved.approved_at|date:"Y-m-d" }}</td>
                                <td class="actions">
                                    {% if approved.status == 'finished' %}
                                        <span class="status-badge finished">Finished</span>
                                    {% elif approved.status == 'dropped' %}
                                        <span class="status-badge dropped">Dropped</span>
                                    {% else %}
                                        <button onclick="updateStatus({{ approved.id }}, 'finished')" class="finished">
                                            Finished
                                        </button>
                                        <button onclick="updateStatus({{ approved.id }}, 'dropped')" class="dropped">
                                            Dropped
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-gray-500">No approved applicants found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- Schedule Section with Calendar -->
        <div id="schedule-section" class="content-section">
            <div class="list-container">
                <!-- Header -->
                <div class="list-header">
                    <h1 class="text-2xl font-bold text-gray-800">Training Schedule/Calendar (All Trainers)</h1>
                    <div class="flex gap-2">
                        <button id="showAllTrainingsBtn" class="add-button" style="background-color: #10b981;">
                            <i class="fas fa-list"></i>
                            View All Sessions
                        </button>
                        <button id="createTaskBtn" class="add-button">
                            <i class="fas fa-plus"></i>
                            Create Training Task
                        </button>
                    </div>
                </div>

                <!-- Trainer Filter -->
                <div class="trainer-filter">
                    <label for="trainerFilter" class="font-medium text-gray-700">Filter by Trainer:</label>
                    <select id="trainerFilter" class="trainer-filter-select">
                        <option value="all">All Trainers</option>
                        <option value="mine">My Sessions Only</option>
                        {% for trainer in all_trainers %}
                        <option value="{{ trainer.id }}">{{ trainer.get_full_name|default:trainer.username }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Date Range Selection Info -->
                <div id="dateRangeInfo" class="date-range-info">
                    <div class="flex items-center justify-between">
                        <div>
                            <i class="fas fa-calendar-alt mr-2"></i>
                            <span class="range-text" id="rangeText">No date range selected</span>
                        </div>
                        <div>
                            <button id="clearRangeBtn" class="clear-selection">Clear Selection</button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        Click and drag to select multiple days, or click a single day for one-day events.
                    </div>
                </div>

                <!-- Training Summary -->
                <div class="training-summary">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="training-count" id="currentMonthTrainingCount">0</span> training sessions this month
                        </div>
                        <div>
                            <span class="training-count" id="totalTrainingCount">{{ all_trainings|length|default:0 }}</span> total sessions scheduled (all trainers)
                        </div>
                        <div>
                            <span class="training-count" id="myTrainingCountSummary">{{ my_trainings|length|default:0 }}</span> my sessions
                        </div>
                    </div>
                </div>

                <!-- Calendar Navigation -->
                <div class="flex justify-between items-center mb-4 p-4 border-b border-gray-200">
                    <button id="prevMonth" class="p-2 hover:bg-gray-100 rounded-full month-nav-button">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h2 id="currentMonth" class="text-xl font-semibold text-gray-800"></h2>
                    <button id="nextMonth" class="p-2 hover:bg-gray-100 rounded-full month-nav-button">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <!-- Calendar Grid -->
                <div class="p-6">
                    <!-- Day Headers -->
                    <div class="grid grid-cols-7 gap-0 mb-2">
                        <div class="bg-gray-800 text-white text-center py-2 text-sm font-medium rounded-l">SUN</div>
                        <div class="bg-gray-800 text-white text-center py-2 text-sm font-medium">MON</div>
                        <div class="bg-gray-800 text-white text-center py-2 text-sm font-medium">TUE</div>
                        <div class="bg-gray-800 text-white text-center py-2 text-sm font-medium">WED</div>
                        <div class="bg-gray-800 text-white text-center py-2 text-sm font-medium">THU</div>
                        <div class="bg-gray-800 text-white text-center py-2 text-sm font-medium">FRI</div>
                        <div class="bg-gray-800 text-white text-center py-2 text-sm font-medium rounded-r">SAT</div>
                    </div>
                    <!-- Calendar Days -->
                    <div id="calendarGrid" class="grid grid-cols-7 gap-0 border border-gray-300 rounded">
                        <!-- Calendar days will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Legend -->
                <div class="px-6 py-4 border-t border-gray-200">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Training Categories & Trainers</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="text-xs font-semibold text-gray-600 mb-2">Categories:</h4>
                            <div class="flex flex-wrap gap-4 text-xs">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-blue-500 rounded"></div>
                                    <span>Activity</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-green-500 rounded"></div>
                                    <span>Examination</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-purple-500 rounded"></div>
                                    <span>Workshop</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-orange-500 rounded"></div>
                                    <span>Seminar</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-xs font-semibold text-gray-600 mb-2">Session Types:</h4>
                            <div class="flex flex-wrap gap-4 text-xs">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 border-2 border-green-500 rounded"></div>
                                    <span>My Sessions</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 border border-gray-400 border-dashed rounded"></div>
                                    <span>Other Trainers</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-3 bg-blue-500 rounded" style="border-radius: 4px 0 0 4px;"></div>
                                    <span>Multi-day Events</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 bg-green-500 border-2 border-green-600 rounded"></div>
                                    <span>Attendance Available</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports-section" class="content-section">
            <h2 class="text-2xl font-semibold text-gray-800 mb-5">Reports</h2>
            
            <!-- Summary Cards -->
            <div class="dashboard-cards mb-6">
                <div class="card">
                    <div class="card-title">Total Applicants</div>
                    <div class="card-value">{{ approvedapplicant|length|default:0 }}</div>
                    <div class="card-subtitle">Enrolled in program</div>
                </div>
                <div class="card">
                    <div class="card-title">Passed</div>
                    <div class="card-value">{{ applicant_passers|length|default:0 }}</div>
                    <div class="card-subtitle">Successfully completed</div>
                </div>
                <div class="card">
                    <div class="card-title">Failed</div>
                    <div class="card-value">0</div>
                    <div class="card-subtitle">Did not meet requirements</div>
                </div>
                <div class="card">
                    <div class="card-title">In Progress</div>
                    <div class="card-value">{{ approvedapplicant|length|default:0 }}</div>
                    <div class="card-subtitle">Currently enrolled</div>
                </div>
            </div>

            <!-- Reports Table -->
            <div class="list-container">
                <div class="list-header">
                    <div class="left-controls">
                        <h3 class="text-xl font-semibold text-gray-800">Applicant Performance Report</h3>
                    </div>
                    <div class="right-controls">
                        <select id="statusFilterReports" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">
                            <option value="all">All Status</option>
                            <option value="passed">Passed</option>
                            <option value="failed">Failed</option>
                            <option value="in-progress">In Progress</option>
                        </select>
                        <button class="add-button" onclick="exportReport()">
                            <i class="fas fa-download"></i>
                            Export Report
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="reportsTable">
                        <thead>
                            <tr>
                                <th>Full Name</th>
                                <th>Program</th>
                                <th>Overall Grade</th>
                                <th>Progress</th>
                                <th>Attendance Rate</th>
                                <th>Status</th>
                                <th>Completion Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Active/In Progress Applicants -->
                            {% for approved in approvedapplicant %}
                            <tr data-status="in-progress">
                                <td class="font-medium">
                                    {{ approved.applicant.learner_profile.first.first_name }} {{ approved.applicant.learner_profile.first.last_name }}
                                </td>
                                <td>{{ approved.program.program_name }}</td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        {% if approved.final_grade %}
                                            <span class="text-lg font-semibold 
                                                {% if approved.final_grade >= 85 %}text-green-600
                                                {% elif approved.final_grade >= 75 %}text-blue-600
                                                {% elif approved.final_grade >= 65 %}text-yellow-600
                                                {% else %}text-red-600{% endif %}">
                                                {{ approved.final_grade }}%
                                            </span>
                                        {% else %}
                                            <span class="text-gray-500">Not graded</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <div class="progress-bar" style="width: 100px;">
                                            {% if approved.progress >= 70 %}
                                                <div class="progress-fill" style="width: {{ approved.progress }}%; background-color: #10b981;"></div>
                                            {% elif approved.progress >= 40 %}
                                                <div class="progress-fill" style="width: {{ approved.progress }}%; background-color: #f59e0b;"></div>
                                            {% elif approved.progress > 0 %}
                                                <div class="progress-fill" style="width: {{ approved.progress }}%; background-color: #ef4444;"></div>
                                            {% else %}
                                                <div class="progress-fill" style="width: 0%;"></div>
                                            {% endif %}
                                        </div>
                                        <span class="text-sm text-gray-600">{{ approved.progress|default:0 }}%</span>
                                    </div>
                                </td>
                                <td>
                                    {% if approved.total_present or approved.total_absent %}
                                        {% widthratio approved.total_present approved.total_present|add:approved.total_absent 100 as attendance_rate %}
                                        <span class="{% if attendance_rate >= 80 %}text-green-600{% elif attendance_rate >= 60 %}text-yellow-600{% else %}text-red-600{% endif %} font-medium">
                                            {{ attendance_rate }}%
                                        </span>
                                    {% else %}
                                        <span class="text-gray-500">No data</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if approved.status == 'finished' %}
                                        <span class="status-badge finished">Finished</span>
                                    {% elif approved.status == 'dropped' %}
                                        <span class="status-badge dropped">Dropped</span>
                                    {% else %}
                                        <span class="status-badge active">In Progress</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if approved.status == 'finished' %}
                                        {{ approved.completion_date|date:"M j, Y"|default:"Not completed" }}
                                    {% else %}
                                        <span class="text-gray-500">In progress</span>
                                    {% endif %}
                                </td>
                                <td class="actions">
                                    <button class="view" onclick="viewApplicantDetails({{ approved.id }})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="view" onclick="generateIndividualReport({{ approved.id }})" style="background-color: #6366f1;">
                                        <i class="fas fa-file-alt"></i> Report
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center text-gray-500">No applicants found.</td>
                            </tr>
                            {% endfor %}

                            <!-- Passed Applicants -->
                            {% for passer in applicant_passers %}
                            <tr data-status="passed">
                                <td class="font-medium">
                                    {{ passer.applicant.learner_profile.first.first_name }} {{ passer.applicant.learner_profile.first.last_name }}
                                </td>
                                <td>{{ passer.program.program_name }}</td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        {% if passer.final_grade %}
                                            <span class="text-lg font-semibold text-green-600">
                                                {{ passer.final_grade }}%
                                            </span>
                                            <i class="fas fa-medal text-yellow-500" title="Passed"></i>
                                        {% else %}
                                            <span class="text-green-600 font-semibold">Passed</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <div class="progress-bar" style="width: 100px;">
                                            <div class="progress-fill" style="width: 100%; background-color: #10b981;"></div>
                                        </div>
                                        <span class="text-sm text-gray-600">100%</span>
                                    </div>
                                </td>
                                <td>
                                    {% if passer.total_present or passer.total_absent %}
                                        {% widthratio passer.total_present passer.total_present|add:passer.total_absent 100 as attendance_rate %}
                                        <span class="text-green-600 font-medium">{{ attendance_rate }}%</span>
                                    {% else %}
                                        <span class="text-gray-500">No data</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="status-badge approved">Passed</span>
                                </td>
                                <td>{{ passer.completion_date|date:"M j, Y"|default:"Not recorded" }}</td>
                                <td class="actions">
                                    <button class="view" onclick="viewApplicantDetails({{ passer.id }})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    <button class="view" onclick="generateIndividualReport({{ passer.id }})" style="background-color: #6366f1;">
                                        <i class="fas fa-file-alt"></i> Report
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Task Section -->
        <div id="task-section" class="content-section">
            <h2 class="text-2xl font-semibold text-gray-800 mb-5">Task</h2>
            <div class="list-container">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Trainee Task Completion</h3>
                <div class="list-header">
                    <div class="left-controls">
                        <span>Show</span>
                        <select id="taskEntriesPerPage">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <span>entries</span>
                    </div>
                    <div class="right-controls">
                        <span>Search:</span>
                        <input type="search" id="taskSearchInput" placeholder="Search by Trainee Name...">
                        <button id="addTaskButton" class="add-button">
                            <i class="fas fa-plus"></i> Add Task
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table" id="taskTable">
                        <thead>
                            <tr>
                                <th>TRAINEE NAME</th>
                                <th>PROGRESS</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for approved in approvedapplicant %}
                            <tr>
                                <td>{{ approved.applicant.username }}</td>
                                <td class="trainee-progress">0%</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td>John Doe</td>
                                <td class="trainee-progress">0%</td>
                            </tr>
                            <tr>
                                <td>Jane Smith</td>
                                <td class="trainee-progress">0%</td>
                            </tr>
                            <tr>
                                <td>Peter Jones</td>
                                <td class="trainee-progress">0%</td>
                            </tr>
                            <tr>
                                <td>Alice Brown</td>
                                <td class="trainee-progress">0%</td>
                            </tr>
                            <tr>
                                <td>Bob White</td>
                                <td class="trainee-progress">0%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="pagination">
                    <span id="taskPaginationInfo">Showing 1 to 10 of {{ approvedapplicant|length|default:5 }} entries</span>
                    <button id="taskPrevPage" disabled>Previous</button>
                    <button class="active-page">1</button>
                    <button>2</button>
                    <button id="taskNextPage">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- All Training Sessions Modal -->
    <div id="allTrainingsModal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 900px;">
            <h3>All Training Sessions (All Trainers)</h3>
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date Range</th>
                            <th>Training Name</th>
                            <th>Time</th>
                            <th>Room</th>
                            <th>Trainer</th>
                            <th>Category</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="allTrainingsTableBody">
                        <!-- Training sessions will be populated here -->
                    </tbody>
                </table>
            </div>
            <div class="modal-buttons">
                <button type="button" id="closeAllTrainingsBtn" class="cancel-button">Close</button>
            </div>
        </div>
    </div>

    <!-- Task Creation Modal - Enhanced -->
    <div id="taskModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Create New Training Task</h3>
            <form id="taskForm" method="post" action="{% url 'training_management' %}">
                {% csrf_token %}
                <div id="formErrors" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
                <div id="successMessage" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4"></div>
                                                                                
                <!-- Program Name - Full Width -->
                <div class="form-row single">
                    <div class="form-group">
                        <label for="id_program_name">Program/Task Name</label>
                        <input type="text" name="program_name" id="id_program_name" placeholder="Enter program or task name" required>
                    </div>
                </div>
                                                                                
                <!-- Date Range -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_start_date">Start Date</label>
                        <input type="date" name="start_date" id="id_start_date" required>
                    </div>
                    <div class="form-group">
                        <label for="id_end_date">End Date (Optional)</label>
                        <input type="date" name="end_date" id="id_end_date">
                    </div>
                </div>
                                                                                
                <!-- Time Range -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_task_time">Start Time</label>
                        <input type="time" name="task_time" id="id_task_time" required>
                    </div>
                    <div class="form-group">
                        <label for="id_end_time">End Time</label>
                        <input type="time" name="end_time" id="id_end_time">
                    </div>
                </div>
                                                                                
                <!-- Room and Category -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="id_room_lab">Room/Laboratory</label>
                        <select name="room_lab" id="id_room_lab" required>
                            <option value="">Select Room/Lab</option>
                            <option value="Lab A">Lab A</option>
                            <option value="Lab B">Lab B</option>
                            <option value="Lab C">Lab C</option>
                            <option value="Conference Room">Conference Room</option>
                            <option value="Training Room 1">Training Room 1</option>
                            <option value="Training Room 2">Training Room 2</option>
                            <option value="Workshop Area">Workshop Area</option>
                            <option value="Computer Lab">Computer Lab</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_category">Category</label>
                        <select name="category" id="id_category" required>
                            <option value="">Select Category</option>
                            <option value="activity">Activity</option>
                            <option value="examination">Examination</option>
                            <option value="workshop">Workshop</option>
                            <option value="seminar">Seminar</option>
                        </select>
                    </div>
                </div>
                                                                                
                <!-- Trainer Display -->
                <div class="form-row single">
                    <div class="form-group">
                        <label>Trainer</label>
                        <div class="trainer-display">
                            {{ request.user.get_full_name|default:request.user.username }}
                        </div>
                        <input type="hidden" name="trainer" id="id_trainer" value="{{ request.user.id }}">
                    </div>
                </div>
                                                                                
                <!-- Description -->
                <div class="form-row single">
                    <div class="form-group">
                        <label for="id_description">Description (Optional)</label>
                        <textarea name="description" id="id_description" rows="4" placeholder="Enter task description"></textarea>
                    </div>
                </div>
                                                                                
                <!-- Info Text -->
                <div class="info-text">
                    <i class="fas fa-info-circle"></i>
                    <strong>Multi-day events:</strong> If you select an end date, this training will span multiple days. Leave end date empty for single-day events. Attendance can be taken on any day within the date range.
                </div>
                                                                                
                <div class="modal-buttons">
                    <button type="button" id="cancelBtn" class="cancel-button">Cancel</button>
                    <button type="submit" class="add-button-modal">
                        <i class="fas fa-plus mr-2"></i>
                        Add Training Task
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Task Modal for Task Section -->
    <div id="addTaskModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Add New Task</h3>
            <form id="addTaskForm">
                {% csrf_token %}
                <label for="newTaskNameInput">Task Name:</label>
                <input type="text" id="newTaskNameInput" placeholder="e.g., Module 2 Exam" required>
                <div class="modal-buttons">
                    <button type="button" id="cancelAddTask" class="cancel-button">Cancel</button>
                    <button type="submit" id="confirmAddTask" class="add-button-modal">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Activity Details Modal -->
    <div id="activityDetailsModal" class="activity-details-modal">
        <div class="activity-details-content">
            <!-- Close Button -->
            <button class="activity-close-btn" id="activityDetailsCloseBtn" title="Close">
                <i class="fas fa-times"></i>
            </button>
                                                            
            <div class="activity-details-header">
                <div class="flex items-center">
                    <div id="activityBadge" class="px-4 py-2 rounded-full text-white bg-blue-500 mr-4 text-lg font-semibold">Activity</div>
                    <div>
                        <div id="activityTitle" class="text-xl font-semibold text-gray-800">Training Activity</div>
                        <div id="activityTrainer" class="text-gray-600 text-sm mt-1">Trainer: John Doe</div>
                    </div>
                </div>
            </div>
                                                            
            <div class="activity-details-body">
                <div class="activity-info-grid">
                    <div class="activity-info-item">
                        <div class="activity-info-label">Date & Time</div>
                        <div class="activity-info-value" id="activityDateTime">January 15, 2025 - 1:00 PM to 2:00 PM</div>
                    </div>
                    <div class="activity-info-item">
                        <div class="activity-info-label">Room/Laboratory</div>
                        <div class="activity-info-value" id="activityRoom">Lab A</div>
                    </div>
                    <div class="activity-info-item">
                        <div class="activity-info-label">Category</div>
                        <div class="activity-info-value" id="activityCategory">Activity</div>
                    </div>
                    <div class="activity-info-item">
                        <div class="activity-info-label">Duration</div>
                        <div class="activity-info-value" id="activityDuration">1 day</div>
                    </div>
                </div>
                                                                                
                <div class="activity-description">
                    <h4>Description</h4>
                    <p id="activityDescriptionText">No description provided for this training activity.</p>
                </div>

                <!-- ‚úÖ NEW: Multi-day attendance day selector -->
                <div id="multiDaySelector" class="day-selector hidden">
                    <h4><i class="fas fa-calendar-days mr-2"></i>Select Day for Attendance</h4>
                    <div class="day-buttons" id="dayButtons">
                        <!-- Day buttons will be generated dynamically -->
                    </div>
                    <div class="text-sm text-gray-600 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        You can take attendance for any day within this multi-day training session.
                    </div>
                </div>
            </div>
                                                            
            <div class="activity-details-footer">
                <div class="attendance-status">
                    <span class="text-sm text-gray-600">Attendance Status:</span>
                    <span class="attendance-status-badge not-taken" id="attendanceStatusBadge">Not Taken</span>
                </div>
                <div class="flex gap-3">
                    <button id="closeActivityDetailsBtn" class="cancel-button">
                        <i class="fas fa-times mr-2"></i>
                        Close
                    </button>
                    <button id="takeAttendanceBtn" class="add-button-modal" style="background-color: #059669;">
                        <i class="fas fa-clipboard-check mr-2"></i>
                        Take Attendance
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Sheet Modal - Full Screen -->
    <div id="attendanceModal" class="attendance-modal">
        <div class="attendance-content">
            <!-- Close Button -->
            <button class="attendance-close-btn" id="attendanceCloseBtn" title="Close">
                <i class="fas fa-times"></i>
            </button>
                                                            
            <div class="attendance-header">
                <div class="flex items-center">
                    <div id="taskBadge" class="px-4 py-2 rounded-full text-white bg-pink-200 text-pink-800 mr-4 text-lg font-semibold">Exam</div>
                    <div>
                        <div id="taskTime" class="text-xl font-semibold text-gray-800">1:00 pm - 2:00 pm</div>
                        <div id="taskTrainer" class="text-gray-600 text-sm mt-1"></div>
                        <!-- Multi-day indicator -->
                        <div id="multiDayIndicator" class="hidden">
                            <span class="multi-day-indicator">Multi-day Event</span>
                            <span class="text-sm text-gray-600 ml-2" id="currentDayInfo">Day 1 of 3</span>
                        </div>
                    </div>
                </div>
                <button id="createTaskBtnAttendance" class="add-button">
                    <i class="fas fa-plus"></i>
                    Create Task
                </button>
            </div>
                                                            
            <div class="attendance-body">
                <h2>Attendance Management</h2>
                                                                                
                <!-- Late Warning -->
                <div id="lateWarning" class="late-warning">
                    <div class="late-warning-content">
                        <i class="fas fa-exclamation-triangle late-warning-icon"></i>
                        <span class="late-warning-text">Warning: This attendance is being submitted after the scheduled time. This will be marked as a late submission.</span>
                    </div>
                </div>
                                                                                
                <!-- Attendance Already Completed Message -->
                <div id="attendanceCompletedMessage" class="attendance-completed-message hidden">
                    <div class="icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="title">Attendance Already Completed</div>
                    <div class="subtitle">This attendance has been submitted and cannot be modified.</div>
                </div>
                                                                                
                <div id="attendancePermissionMessage" class="hidden bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-4">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Note: You can view this attendance but only the session creator can modify it.
                </div>
                                                                                
                <div class="overflow-x-auto">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th class="text-left" style="width: 40%;">Student Name</th>
                                <th style="width: 30%;">Present</th>
                                <th style="width: 30%;">Absent</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceList">
                            <!-- Student attendance rows will be generated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
                                                            
            <div class="attendance-footer">
                <div class="text-sm text-gray-600">
                    <i class="fas fa-users mr-2"></i>
                    <span id="attendanceStats">Managing attendance for training session</span>
                </div>
                <div class="flex gap-3">
                    <button id="closeAttendanceBtn" class="cancel-button">
                        <i class="fas fa-times mr-2"></i>
                        Cancel
                    </button>
                    <button id="saveAttendanceBtn" class="add-button-modal" style="background-color: #28a745;">
                        <i class="fas fa-save mr-2"></i>
                        SAVE ATTENDANCE
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmationDialog" class="confirmation-dialog">
        <div class="confirmation-content">
            <div class="confirmation-icon warning">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="confirmation-title" id="confirmationTitle">Confirm Action</div>
            <div class="confirmation-message" id="confirmationMessage">Are you sure you want to proceed?</div>
            <div class="confirmation-buttons">
                <button id="confirmationCancelBtn" class="cancel-btn">Cancel</button>
                <button id="confirmationConfirmBtn" class="confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Chart
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('completionChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Complete', 'Remaining'],
                    datasets: [{
                        data: [55, 45],
                        backgroundColor: ['#60A5FA', '#F87171'],
                        borderColor: '#1E3A8A',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    cutout: '50%',
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: 'white'
                            }
                        }
                    }
                }
            });
        });

        // Bell notification toggle
        const bellBtn = document.getElementById("bell-btn");
        const notificationBox = document.getElementById("notification-box");

        bellBtn.addEventListener("click", () => {
            notificationBox.classList.toggle("hidden");
        });

        // Click outside to close
        document.addEventListener("click", (e) => {
            if (!bellBtn.contains(e.target) && !notificationBox.contains(e.target)) {
                notificationBox.classList.add("hidden");
            }
        });

        // Section switching and sidebar toggle
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarLinks = document.querySelectorAll('.sidebar-nav a[data-section]');
            const contentSections = document.querySelectorAll('.content-section');
            

            function showSection(sectionId) {
                contentSections.forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');

                // Update navigation active state
                sidebarLinks.forEach(link => {
                    link.classList.remove('bg-blue-700');
                    link.classList.add('hover:bg-blue-600', 'transition-colors');
                });
                const activeLink = document.querySelector(`.sidebar-nav a[data-section="${sectionId.replace('-section', '')}"]`);
                if (activeLink) {
                    activeLink.classList.add('bg-blue-700');
                    activeLink.classList.remove('hover:bg-blue-600', 'transition-colors');
                }
            }

            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.dataset.section + '-section';
                    showSection(sectionId);
                    
                    // Update active state - remove bg-blue-700 from all links and add hover classes
                    sidebarLinks.forEach(nav => {
                        nav.classList.remove('bg-blue-700');
                        nav.classList.add('hover:bg-blue-600', 'transition-colors');
                    });
                    // Add bg-blue-700 to clicked link and remove hover classes
                    this.classList.add('bg-blue-700');
                    this.classList.remove('hover:bg-blue-600', 'transition-colors');
                });
            });

            // Task functionality
            initializeTaskFunctionality();
            
            // Reports functionality
            initializeReportsFunctionality();
        });

        // Enhanced Task functionality with delete capability
        function initializeTaskFunctionality() {
            const taskSearchInput = document.getElementById('taskSearchInput');
            const taskTable = document.getElementById('taskTable');
            const taskTableHeaderRow = taskTable.querySelector('thead tr');
            const taskTableBody = taskTable.querySelector('tbody');
            const taskEntriesPerPageSelect = document.getElementById('taskEntriesPerPage');
            const taskPrevPageBtn = document.getElementById('taskPrevPage');
            const taskNextPageBtn = document.getElementById('taskNextPage');
            const taskPaginationInfo = document.getElementById('taskPaginationInfo');
            const addTaskButton = document.getElementById('addTaskButton');
            const addTaskModal = document.getElementById('addTaskModal');
            const newTaskNameInput = document.getElementById('newTaskNameInput');
            const confirmAddTaskBtn = document.getElementById('confirmAddTask');
            const cancelAddTaskBtn = document.getElementById('cancelAddTask');

            let currentTaskPage = 1;
            let taskRowsPerPage = parseInt(taskEntriesPerPageSelect.value);
            let allTraineeRows = Array.from(taskTableBody.querySelectorAll('tr'));
            let taskList = []; // Store tasks for database operations

            // Function to delete a task column
            function deleteTask(taskId) {
                // Show confirmation dialog
                if (confirm(`Are you sure you want to delete this task? This action cannot be undone.`)) {
                    // Remove task from header
                    const headerToRemove = taskTableHeaderRow.querySelector(`[data-task-id="${taskId}"]`);
                    if (headerToRemove) {
                        headerToRemove.parentElement.remove();
                    }

                    // Remove task checkboxes from all rows
                    allTraineeRows.forEach(row => {
                        const cellToRemove = row.querySelector(`.task-checkbox-${taskId}`);
                        if (cellToRemove) {
                            cellToRemove.parentElement.remove();
                        }
                    });

                    // Remove from task list
                    taskList = taskList.filter(task => task.id !== taskId);

                    // Send delete request to server
                    deleteTaskFromDatabase(taskId);

                    // Update progress for all rows
                    allTraineeRows.forEach(row => updateTraineeProgress(row));
                    updateTaskPagination();
                }
            }

            // Function to send delete request to database
            function deleteTaskFromDatabase(taskId) {
                fetch('/delete-task/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        task_id: taskId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Task deleted successfully');
                    } else {
                        console.error('Error deleting task:', data.error);
                        alert('Error deleting task. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting task. Please try again.');
                });
            }

            // Function to save task to database
            function saveTaskToDatabase(taskName, taskId) {
                fetch('/add-task/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        task_name: taskName,
                        task_id: taskId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Task saved successfully');
                        // Add to local task list
                        taskList.push({
                            id: taskId,
                            name: taskName,
                            database_id: data.task_database_id
                        });
                    } else {
                        console.error('Error saving task:', data.error);
                        alert('Error saving task. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error saving task. Please try again.');
                });
            }

            // Function to save task completion to database
            function saveTaskCompletion(studentId, taskId, isCompleted) {
                fetch('/save-task-completion/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        task_id: taskId,
                        is_completed: isCompleted
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Task completion saved successfully');
                    } else {
                        console.error('Error saving task completion:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }

            // Function to update the state of a specific "Check All" checkbox
            function updateCheckAllCheckboxState(headerCheckboxId, individualCheckboxClass) {
                const headerCheckbox = document.querySelector(`[data-task-id="${headerCheckboxId}"]`);
                if (!headerCheckbox) return;

                const visibleIndividualCheckboxes = Array.from(taskTableBody.querySelectorAll(`.${individualCheckboxClass}`)).filter(cb => cb.closest('tr').style.display !== 'none');
                                                                
                if (visibleIndividualCheckboxes.length === 0) {
                    headerCheckbox.checked = false;
                    headerCheckbox.indeterminate = false;
                } else {
                    const allChecked = visibleIndividualCheckboxes.every(checkbox => checkbox.checked);
                    const anyChecked = visibleIndividualCheckboxes.some(checkbox => checkbox.checked);

                    if (allChecked) {
                        headerCheckbox.checked = true;
                        headerCheckbox.indeterminate = false;
                    } else if (anyChecked) {
                        headerCheckbox.checked = false;
                        headerCheckbox.indeterminate = true;
                    } else {
                        headerCheckbox.checked = false;
                        headerCheckbox.indeterminate = false;
                    }
                }
            }

            // Function to handle "Check All" header checkbox click
            function handleCheckAllClick(event) {
                const headerCheckbox = event.target;
                const taskId = headerCheckbox.dataset.taskId;
                const individualCheckboxClass = `task-checkbox-${taskId}`;
                const isChecked = headerCheckbox.checked;

                const allIndividualCheckboxes = taskTableBody.querySelectorAll(`.${individualCheckboxClass}`);
                allIndividualCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                    // Save to database
                    const studentId = getStudentIdFromRow(checkbox.closest('tr'));
                    if (studentId) {
                        saveTaskCompletion(studentId, taskId, isChecked);
                    }
                });

                updateCheckAllCheckboxState(taskId, individualCheckboxClass);
                allTraineeRows.forEach(row => updateTraineeProgress(row));
            }

            // Function to get student ID from table row
            function getStudentIdFromRow(row) {
                // You'll need to add data attributes to your rows or implement this based on your data structure
                const studentName = row.querySelector('td:first-child').textContent.trim();
                // This is a simplified approach - you should store actual student IDs
                return studentName; // Replace with actual student ID logic
            }

            // Function to calculate and update progress for a single trainee row
            function updateTraineeProgress(traineeRow) {
                const progressCell = traineeRow.querySelector('.trainee-progress');
                if (!progressCell) return;

                const taskCheckboxesInRow = traineeRow.querySelectorAll('input[type="checkbox"].dynamic-task-checkbox');
                let checkedCount = 0;
                let totalTasks = 0;

                taskCheckboxesInRow.forEach(checkbox => {
                    const taskId = checkbox.dataset.taskId;
                    const taskHeader = taskTableHeaderRow.querySelector(`[data-task-id="${taskId}"]`);
                    if (taskHeader) {
                        totalTasks++;
                        if (checkbox.checked) {
                            checkedCount++;
                        }
                    }
                });

                const progress = totalTasks > 0 ? Math.round((checkedCount / totalTasks) * 100) : 0;
                progressCell.textContent = `${progress}%`;
            }

            // Function to handle individual task checkbox click (event delegation)
            taskTableBody.addEventListener('change', function(event) {
                if (event.target.classList.contains('dynamic-task-checkbox')) {
                    const taskId = event.target.dataset.taskId;
                    const studentId = getStudentIdFromRow(event.target.closest('tr'));
                    const isCompleted = event.target.checked;

                    // Save to database
                    if (studentId) {
                        saveTaskCompletion(studentId, taskId, isCompleted);
                    }

                    updateCheckAllCheckboxState(taskId, `task-checkbox-${taskId}`);
                    updateTraineeProgress(event.target.closest('tr'));
                }
            });

            // Event listener for dynamically added "Check All" checkboxes in headers
            taskTableHeaderRow.addEventListener('change', function(event) {
                if (event.target.classList.contains('check-all-task-checkbox')) {
                    handleCheckAllClick(event);
                }
            });

            // Event listener for delete buttons
            taskTableHeaderRow.addEventListener('click', function(event) {
                if (event.target.classList.contains('task-delete-btn')) {
                    const taskId = event.target.dataset.taskId;
                    deleteTask(taskId);
                }
            });

            function updateTaskPagination() {
                taskRowsPerPage = parseInt(taskEntriesPerPageSelect.value);
                const searchTerm = taskSearchInput.value.toLowerCase();
                                                                
                let filteredTaskRows = allTraineeRows.filter(row => {
                    return row.querySelector('td:first-child').textContent.toLowerCase().includes(searchTerm);
                });

                const totalPages = Math.ceil(filteredTaskRows.length / taskRowsPerPage);
                if (currentTaskPage > totalPages && totalPages > 0) {
                    currentTaskPage = totalPages;
                } else if (totalPages === 0) {
                    currentTaskPage = 1;
                }

                const startIndex = (currentTaskPage - 1) * taskRowsPerPage;
                const endIndex = startIndex + taskRowsPerPage;

                allTraineeRows.forEach(row => row.style.display = 'none');
                                                                
                for (let i = startIndex; i < endIndex && i < filteredTaskRows.length; i++) {
                    filteredTaskRows[i].style.display = '';
                }

                taskPrevPageBtn.disabled = currentTaskPage === 1;
                taskNextPageBtn.disabled = currentTaskPage === totalPages || totalPages === 0;

                const startEntry = filteredTaskRows.length > 0 ? startIndex + 1 : 0;
                const endEntry = Math.min(endIndex, filteredTaskRows.length);
                taskPaginationInfo.textContent = `Showing ${startEntry} to ${endEntry} of ${filteredTaskRows.length} entries`;

                // Update progress for all visible rows after pagination
                filteredTaskRows.forEach(row => updateTraineeProgress(row));
            }

            taskSearchInput.addEventListener('keyup', function() {
                currentTaskPage = 1;
                updateTaskPagination();
            });

            taskEntriesPerPageSelect.addEventListener('change', function() {
                currentTaskPage = 1;
                updateTaskPagination();
            });

            taskPrevPageBtn.addEventListener('click', function() {
                if (currentTaskPage > 1) {
                    currentTaskPage--;
                    updateTaskPagination();
                }
            });

            taskNextPageBtn.addEventListener('click', function() {
                const searchTerm = taskSearchInput.value.toLowerCase();
                let filteredTaskRows = allTraineeRows.filter(row => {
                    return row.querySelector('td:first-child').textContent.toLowerCase().includes(searchTerm);
                });
                const totalPages = Math.ceil(filteredTaskRows.length / taskRowsPerPage);
                if (currentTaskPage < totalPages) {
                    currentTaskPage++;
                    updateTaskPagination();
                }
            });

            // Modal related event listeners
            addTaskButton.addEventListener('click', function(e) {
                e.preventDefault();
                newTaskNameInput.value = '';
                addTaskModal.classList.remove('hidden');
            });

            cancelAddTaskBtn.addEventListener('click', function() {
                addTaskModal.classList.add('hidden');
            });

            // Enhanced add task form submission
            document.getElementById('addTaskForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const taskName = newTaskNameInput.value.trim();
                if (taskName) {
                    const taskId = taskName.replace(/\s+/g, '').replace(/[^a-zA-Z0-9]/g, '');
                                                                                
                    // Add new header column with delete button
                    const newTh = document.createElement('th');
                    newTh.classList.add('task-column-header');
                    newTh.dataset.taskName = taskName;
                    newTh.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <input type="checkbox" class="check-all-task-checkbox" data-task-id="${taskId}"> ${taskName}
                            </div>
                            <button type="button" class="task-delete-btn" data-task-id="${taskId}" title="Delete Task">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                                                                                
                    // Find the 'PROGRESS' header and insert before it
                    const progressHeader = taskTableHeaderRow.querySelector('th:last-child');
                    if (progressHeader && progressHeader.textContent.trim() === 'PROGRESS') {
                        taskTableHeaderRow.insertBefore(newTh, progressHeader);
                    } else {
                        taskTableHeaderRow.appendChild(newTh);
                    }

                    // Add new checkbox cell for each trainee row
                    allTraineeRows.forEach(row => {
                        const newTd = document.createElement('td');
                        newTd.innerHTML = `<input type="checkbox" class="task-checkbox-${taskId} dynamic-task-checkbox" data-task-id="${taskId}">`;
                                                                                                
                        const progressCellInRow = row.querySelector('.trainee-progress');
                        if (progressCellInRow) {
                            row.insertBefore(newTd, progressCellInRow);
                        } else {
                            row.appendChild(newTd);
                        }
                    });

                    // Save task to database
                    saveTaskToDatabase(taskName, taskId);

                    updateTaskPagination();
                    addTaskModal.classList.add('hidden');
                } else {
                    alert("Task name cannot be empty.");
                }
            });

            // Close modal if clicking outside the content
            addTaskModal.addEventListener('click', function(event) {
                if (event.target === addTaskModal) {
                    addTaskModal.classList.add('hidden');
                }
            });

            // Initial calls
            updateTaskPagination();
        }

        // Reports functionality
        function initializeReportsFunctionality() {
            const statusFilter = document.getElementById('statusFilterReports');
            const reportsTable = document.getElementById('reportsTable');
            
            if (statusFilter && reportsTable) {
                // Status filter functionality
                statusFilter.addEventListener('change', function() {
                    const selectedStatus = this.value;
                    const tableRows = reportsTable.querySelectorAll('tbody tr');
                    
                    tableRows.forEach(row => {
                        const rowStatus = row.getAttribute('data-status');
                        
                        if (selectedStatus === 'all' || rowStatus === selectedStatus) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            }
        }

        // Export report functionality
        function exportReport() {
            const table = document.getElementById('reportsTable');
            const statusFilter = document.getElementById('statusFilterReports');
            const selectedStatus = statusFilter ? statusFilter.value : 'all';
            
            // Get visible rows only
            const visibleRows = Array.from(table.querySelectorAll('tbody tr')).filter(row => 
                row.style.display !== 'none'
            );
            
            if (visibleRows.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Create CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add headers
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => 
                th.textContent.trim()
            );
            csvContent += headers.join(',') + '\n';
            
            // Add data rows
            visibleRows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td')).map(td => {
                    let cellText = td.textContent.trim();
                    // Clean up cell text and escape commas
                    cellText = cellText.replace(/,/g, ';').replace(/\n/g, ' ');
                    return `"${cellText}"`;
                });
                csvContent += cells.join(',') + '\n';
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            
            const currentDate = new Date().toISOString().split('T')[0];
            const statusText = selectedStatus === 'all' ? 'All' : selectedStatus.charAt(0).toUpperCase() + selectedStatus.slice(1);
            link.setAttribute('download', `Applicant_Report_${statusText}_${currentDate}.csv`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // View applicant details function
        function viewApplicantDetails(applicantId) {
            // This function can be expanded to show a modal with detailed applicant information
            alert(`Viewing details for applicant ID: ${applicantId}`);
            // TODO: Implement detailed view modal
        }

        // Generate individual report function
        function generateIndividualReport(applicantId) {
            // This function can be expanded to generate a detailed PDF report for individual applicant
            alert(`Generating individual report for applicant ID: ${applicantId}`);
            // TODO: Implement individual PDF report generation
        }

        // Status update function
        function updateStatus(applicantId, status) {

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/update-status/';

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;

            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'applicant_id';
            idInput.value = applicantId;

            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'status';
            statusInput.value = status;

            form.appendChild(csrfInput);
            form.appendChild(idInput);
            form.appendChild(statusInput);

            document.body.appendChild(form);
            form.submit();
        }


        // ‚úÖ ENHANCED: Calendar and attendance functionality with multi-day support
        $(document).ready(function() {
            let currentDate = new Date();
            const modal = $('#taskModal');
            const attendanceModal = $('#attendanceModal');
            const activityDetailsModal = $('#activityDetailsModal');
            const allTrainingsModal = $('#allTrainingsModal');
            const confirmationDialog = $('#confirmationDialog');
            const form = $('#taskForm');
            const formErrors = $('#formErrors');
            const successMessage = $('#successMessage');
            const currentUserId = {{ request.user.id }};

            // Date range selection variables
            let isSelecting = false;
            let selectionStart = null;
            let selectionEnd = null;
            let selectedRange = [];

            // ‚úÖ NEW: Multi-day attendance tracking
            let attendanceSubmitted = {};
            let multiDayAttendanceStatus = {}; // Track attendance for each day of multi-day events
            let currentTrainingData = null;
            let selectedAttendanceDay = null; // Currently selected day for multi-day attendance

            // ‚úÖ FIXED: Helper function to format date without timezone issues
            function formatDateString(date) {
                // Create a new date object to avoid mutation
                const localDate = new Date(date.getTime());
                const year = localDate.getFullYear();
                const month = String(localDate.getMonth() + 1).padStart(2, '0');
                const day = String(localDate.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // ‚úÖ FIXED: Parse date string properly to avoid timezone issues
            function parseDate(dateString) {
                if (!dateString) return null;
                // Parse as local date to avoid timezone conversion
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                }
                return new Date(dateString);
            }

            // Format time for display (12-hour format)
            function formatTimeDisplay(time) {
                if (!time) return '';
                const [hours, minutes] = time.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'pm' : 'am';
                const hour12 = hour % 12 || 12;
                return `${hour12}:${minutes} ${ampm}`;
            }

            // ‚úÖ FIXED: Parse date range from training data with proper date handling
            function parseDateRange(startDate, endDate) {
                const dates = [];
                const start = parseDate(startDate);
                const end = endDate ? parseDate(endDate) : parseDate(startDate);
                                
                if (!start) return dates;
                                
                const current = new Date(start);
                const endDate_obj = end || start;
                                
                while (current <= endDate_obj) {
                    dates.push(formatDateString(current));
                    current.setDate(current.getDate() + 1);
                }
                                
                return dates;
            }

            // Check if attendance is late
            function isAttendanceLate(trainingDate, trainingTime) {
                const now = new Date();
                const trainingDateTime = new Date(`${trainingDate}T${trainingTime}`);
                return now > trainingDateTime;
            }

            // ‚úÖ NEW: Check if attendance is available for any day in multi-day training
            function isAttendanceAvailableForTraining(training) {
                if (!training.isOwn) return false;
                
                // For multi-day trainings, check if attendance is available for any day
                if (training.dateRange.length > 1) {
                    return training.dateRange.some(dateStr => {
                        const dayKey = `${training.id}_${dateStr}`;
                        return !multiDayAttendanceStatus[dayKey];
                    });
                }
                
                // For single-day trainings, check the original logic
                return !attendanceSubmitted[training.id];
            }

            // ‚úÖ NEW: Get attendance status for multi-day training
            function getMultiDayAttendanceStatus(training) {
                if (training.dateRange.length === 1) {
                    return attendanceSubmitted[training.id] ? 'completed' : 'not-taken';
                }
                
                const completedDays = training.dateRange.filter(dateStr => {
                    const dayKey = `${training.id}_${dateStr}`;
                    return multiDayAttendanceStatus[dayKey];
                }).length;
                
                if (completedDays === 0) return 'not-taken';
                if (completedDays === training.dateRange.length) return 'completed';
                return 'multi-day-available';
            }

            // Load ALL training data from Django (from all trainers) with multi-day support
            let allTrainings = [
                {% for training in all_trainings %}
                {
                    id: {{ training.id }},
                    name: "{{ training.program_name|escapejs }}",
                    startDate: "{{ training.start_date|date:'Y-m-d' }}",
                    endDate: "{{ training.end_date|date:'Y-m-d'|default:'' }}",
                    dateRange: [],
                    time: "{{ training.task_time|default:'09:00'|escapejs }}",
                    endTime: "{{ training.end_time|default:'10:00'|escapejs }}",
                    room: "{{ training.room_lab|escapejs }}",
                    trainer: "{{ training.trainer.get_full_name|default:training.trainer.username|escapejs }}",
                    trainerId: {{ training.trainer.id }},
                    category: "{{ training.category|default:'activity'|escapejs }}",
                    description: "{{ training.description|default:''|escapejs }}",
                    isOwn: {{ training.trainer.id }} === currentUserId,
                    attendanceSubmitted: false // Will be updated from server
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            // ‚úÖ FIXED: Process date ranges for all trainings with proper date handling
            allTrainings.forEach(training => {
                training.dateRange = parseDateRange(training.startDate, training.endDate || training.startDate);
                console.log(`Training: ${training.name}, Date Range:`, training.dateRange);
            });

            // Load my training data from Django
            let myTrainings = allTrainings.filter(training => training.isOwn);

            // Current filtered trainings (starts with all trainings)
            let filteredTrainings = [...allTrainings];

            // Debug: Log all trainings to console
            console.log('All training sessions loaded:', allTrainings);
            console.log('Total training sessions:', allTrainings.length);
            console.log('My training sessions:', myTrainings.length);

            // Load student data from Django
            let students = [
                {% for approved in approvedapplicant %}
                {
                    id: {{ approved.applicant.id }},
                    name: "{{ approved.applicant.get_full_name|default:approved.applicant.username|escapejs }}",
                    attendance: {}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            // If no students are loaded from Django, use mock data for demo
            if (students.length === 0) {
                students = [
                    { id: 1, name: "Name 1", attendance: {} },
                    { id: 2, name: "Name 2", attendance: {} },
                    { id: 3, name: "Name 3", attendance: {} },
                    { id: 4, name: "Name 4", attendance: {} },
                    { id: 5, name: "Name 5", attendance: {} }
                ];
            }

            // Category colors mapping
            const categoryColors = {
                'activity': 'bg-blue-500 text-white',
                'examination': 'bg-green-500 text-white',
                'workshop': 'bg-purple-500 text-white',
                'seminar': 'bg-orange-500 text-white',
                'default': 'bg-gray-500 text-white'
            };

            // Date range selection functions
            function clearDateSelection() {
                $('.calendar-day').removeClass('range-start range-middle range-end range-single selecting');
                selectedRange = [];
                selectionStart = null;
                selectionEnd = null;
                isSelecting = false;
                $('#dateRangeInfo').removeClass('active');
                $('#rangeText').text('No date range selected');
            }

            function updateDateRangeDisplay() {
                if (selectedRange.length === 0) {
                    $('#dateRangeInfo').removeClass('active');
                    return;
                }

                $('#dateRangeInfo').addClass('active');
                                                                
                if (selectedRange.length === 1) {
                    const date = parseDate(selectedRange[0]);
                    if (date && !isNaN(date.getTime())) {
                        $('#rangeText').text(`Selected: ${date.toLocaleDateString()}`);
                    } else {
                        $('#rangeText').text(`Selected: ${selectedRange[0]}`);
                    }
                } else {
                    const startDate = parseDate(selectedRange[0]);
                    const endDate = parseDate(selectedRange[selectedRange.length - 1]);
                    if (startDate && endDate && !isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                        $('#rangeText').text(`Selected: ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()} (${selectedRange.length} days)`);
                    } else {
                        $('#rangeText').text(`Selected: ${selectedRange[0]} - ${selectedRange[selectedRange.length - 1]} (${selectedRange.length} days)`);
                    }
                }
            }

            function selectDateRange(startDate, endDate) {
                clearDateSelection();
                                                                
                const start = parseDate(startDate);
                const end = parseDate(endDate);
                                                                
                // Ensure start is before end
                if (start > end) {
                    [start, end] = [end, start];
                }
                                                                
                selectedRange = [];
                const current = new Date(start);
                                                                
                while (current <= end) {
                    selectedRange.push(formatDateString(current));
                    current.setDate(current.getDate() + 1);
                }
                                                                
                // Apply visual styling
                selectedRange.forEach((dateStr, index) => {
                    const dayElement = $(`.calendar-day[data-date="${dateStr}"]`);
                    if (selectedRange.length === 1) {
                        dayElement.addClass('range-single');
                    } else if (index === 0) {
                        dayElement.addClass('range-start');
                    } else if (index === selectedRange.length - 1) {
                        dayElement.addClass('range-end');
                    } else {
                        dayElement.addClass('range-middle');
                    }
                });
                                                                
                updateDateRangeDisplay();
            }

            // Clear range button
            $('#clearRangeBtn').click(function() {
                clearDateSelection();
            });

            // Trainer filter functionality
            $('#trainerFilter').change(function() {
                const selectedValue = $(this).val();
                                                                
                if (selectedValue === 'all') {
                    filteredTrainings = [...allTrainings];
                } else if (selectedValue === 'mine') {
                    filteredTrainings = [...myTrainings];
                } else {
                    const trainerId = parseInt(selectedValue);
                    filteredTrainings = allTrainings.filter(training => training.trainerId === trainerId);
                }
                                                                
                generateCalendar(currentDate);
                console.log('Filtered trainings:', filteredTrainings.length);
            });

            // Update training counts
            function updateTrainingCounts() {
                const totalCount = allTrainings.length;
                const myCount = myTrainings.length;
                const currentMonthTrainings = filteredTrainings.filter(training => {
                    return training.dateRange.some(dateStr => {
                        const trainingDate = parseDate(dateStr);
                        return trainingDate.getMonth() === currentDate.getMonth() &&
                               trainingDate.getFullYear() === currentDate.getFullYear();
                    });
                });

                $('#totalTrainingCount').text(totalCount);
                $('#currentMonthTrainingCount').text(currentMonthTrainings.length);
                $('#totalTrainingSessions').text(totalCount);
                $('#myTrainingSessions').text(myCount);
                $('#myTrainingCountSummary').text(myCount);
                $('#overviewTrainingCount').text(totalCount);
                $('#overviewMyTrainingCount').text(myCount);
            }

            // Get months with training sessions
            function getMonthsWithTrainings() {
                const monthsWithTrainings = new Set();
                filteredTrainings.forEach(training => {
                    training.dateRange.forEach(dateStr => {
                        const date = parseDate(dateStr);
                        const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                        monthsWithTrainings.add(monthKey);
                    });
                });
                return monthsWithTrainings;
            }

            // Update navigation buttons to show training indicators
            function updateNavigationIndicators() {
                const monthsWithTrainings = getMonthsWithTrainings();
                                                                
                // Check previous month
                const prevMonth = new Date(currentDate);
                prevMonth.setMonth(prevMonth.getMonth() - 1);
                const prevMonthKey = `${prevMonth.getFullYear()}-${prevMonth.getMonth()}`;
                                                                
                // Check next month
                const nextMonth = new Date(currentDate);
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                const nextMonthKey = `${nextMonth.getFullYear()}-${nextMonth.getMonth()}`;
                                                                
                // Add indicators
                $('#prevMonth').toggleClass('has-training', monthsWithTrainings.has(prevMonthKey));
                $('#nextMonth').toggleClass('has-training', monthsWithTrainings.has(nextMonthKey));
            }

            // ‚úÖ NEW: Generate day selector for multi-day attendance
            function generateDaySelector(training) {
                const dayButtons = $('#dayButtons');
                dayButtons.empty();
                
                training.dateRange.forEach((dateStr, index) => {
                    const date = parseDate(dateStr);
                    const dayKey = `${training.id}_${dateStr}`;
                    const isCompleted = multiDayAttendanceStatus[dayKey];
                    const dayNumber = index + 1;
                    
                    const button = $(`
                        <button class="day-button ${isCompleted ? 'completed' : ''}" 
                                data-date="${dateStr}" 
                                data-day-key="${dayKey}">
                            Day ${dayNumber}<br>
                            <small>${date.toLocaleDateString()}</small>
                            ${isCompleted ? '<br><i class="fas fa-check"></i>' : ''}
                        </button>
                    `);
                    
                    button.click(function() {
                        if (!isCompleted) {
                            $('.day-button').removeClass('active');
                            $(this).addClass('active');
                            selectedAttendanceDay = dateStr;
                        }
                    });
                    
                    dayButtons.append(button);
                });
                
                // Auto-select first available day
                const firstAvailableDay = training.dateRange.find(dateStr => {
                    const dayKey = `${training.id}_${dateStr}`;
                    return !multiDayAttendanceStatus[dayKey];
                });
                
                if (firstAvailableDay) {
                    selectedAttendanceDay = firstAvailableDay;
                    $(`.day-button[data-date="${firstAvailableDay}"]`).addClass('active');
                }
            }

            // ‚úÖ ENHANCED: Show activity details modal with multi-day support
            function showActivityDetailsModal(trainingId, name, time, category, trainer, trainerId, isOwn, room, description, dateRange) {
                currentTrainingData = {
                    id: trainingId,
                    name: name,
                    time: time,
                    category: category,
                    trainer: trainer,
                    trainerId: trainerId,
                    isOwn: isOwn,
                    room: room,
                    description: description,
                    dateRange: dateRange
                };

                // Set activity details
                $('#activityTitle').text(name);
                $('#activityTrainer').text(`Trainer: ${trainer}`);
                $('#activityRoom').text(room);
                $('#activityCategory').text(category.charAt(0).toUpperCase() + category.slice(1));
                                                                
                // Set badge color based on category
                $('#activityBadge').removeClass().addClass('px-4 py-2 rounded-full text-white mr-4 text-lg font-semibold');
                if (category === 'activity') {
                    $('#activityBadge').addClass('bg-blue-500');
                } else if (category === 'examination') {
                    $('#activityBadge').addClass('bg-green-500');
                } else if (category === 'workshop') {
                    $('#activityBadge').addClass('bg-purple-500');
                } else if (category === 'seminar') {
                    $('#activityBadge').addClass('bg-orange-500');
                } else {
                    $('#activityBadge').addClass('bg-gray-500');
                }
                $('#activityBadge').text(category.charAt(0).toUpperCase() + category.slice(1));

                // ‚úÖ FIXED: Format date and time with proper date parsing
                const startDate = parseDate(dateRange[0]);
                const endDate = dateRange.length > 1 ? parseDate(dateRange[dateRange.length - 1]) : null;
                let dateTimeText = startDate ? startDate.toLocaleDateString() : 'Invalid Date';
                if (endDate && endDate.getTime() !== startDate.getTime()) {
                    dateTimeText += ` - ${endDate.toLocaleDateString()}`;
                }
                if (time) {
                    dateTimeText += ` - ${time}`;
                }
                $('#activityDateTime').text(dateTimeText);

                // Set duration
                const duration = dateRange.length === 1 ? '1 day' : `${dateRange.length} days`;
                $('#activityDuration').text(duration);

                // Set description
                $('#activityDescriptionText').text(description || 'No description provided for this training activity.');

                // ‚úÖ NEW: Show/hide multi-day selector
                const isMultiDay = dateRange.length > 1;
                if (isMultiDay && isOwn) {
                    $('#multiDaySelector').removeClass('hidden');
                    generateDaySelector(currentTrainingData);
                } else {
                    $('#multiDaySelector').addClass('hidden');
                }

                // ‚úÖ ENHANCED: Check attendance status for multi-day support
                const attendanceStatus = getMultiDayAttendanceStatus(currentTrainingData);
                const statusBadge = $('#attendanceStatusBadge');
                statusBadge.removeClass('not-taken completed late multi-day-available');
                                                                
                if (attendanceStatus === 'completed') {
                    statusBadge.addClass('completed').text('All Days Completed');
                    $('#takeAttendanceBtn').prop('disabled', true).text('Attendance Completed');
                } else if (attendanceStatus === 'multi-day-available') {
                    statusBadge.addClass('multi-day-available').text('Partial Completion');
                    $('#takeAttendanceBtn').prop('disabled', false).html('<i class="fas fa-clipboard-check mr-2"></i>Take Attendance');
                } else {
                    const isLate = isAttendanceLate(dateRange[0], time.split(' - ')[0]);
                    if (isLate) {
                        statusBadge.addClass('late').text('Late Submission');
                    } else {
                        statusBadge.addClass('not-taken').text('Not Taken');
                    }
                    $('#takeAttendanceBtn').prop('disabled', false).html('<i class="fas fa-clipboard-check mr-2"></i>Take Attendance');
                }

                // Show/hide take attendance button based on ownership
                if (!isOwn) {
                    $('#takeAttendanceBtn').hide();
                } else {
                    $('#takeAttendanceBtn').show();
                }

                activityDetailsModal.css('display', 'flex');
            }

            function generateCalendar(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());

                const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];

                $('#currentMonth').text(monthNames[month] + ' ' + year);

                let calendarHTML = '';
                let currentCalendarDate = new Date(startDate);

                for (let week = 0; week < 6; week++) {
                    for (let day = 0; day < 7; day++) {
                        const dayNumber = currentCalendarDate.getDate();
                        const isCurrentMonth = currentCalendarDate.getMonth() === month;
                        const dateString = formatDateString(currentCalendarDate);

                        // Get trainings for this date (using filtered trainings)
                        const dayTrainings = filteredTrainings.filter(training =>
                             training.dateRange.includes(dateString)
                        );

                        const hasTraining = dayTrainings.length > 0;
                        let trainingsHTML = '';

                        dayTrainings.forEach(training => {
                            const colorClass = categoryColors[training.category] || categoryColors['default'];
                            const startTime = formatTimeDisplay(training.time);
                            const endTime = formatTimeDisplay(training.endTime);
                            const timeDisplay = startTime && endTime ? `${startTime} - ${endTime}` : startTime;
                                                                                                                
                            // Determine span position for multi-day events
                            let spanClass = 'span-single';
                            if (training.dateRange.length > 1) {
                                const dateIndex = training.dateRange.indexOf(dateString);
                                if (dateIndex === 0) {
                                    spanClass = 'span-start';
                                } else if (dateIndex === training.dateRange.length - 1) {
                                    spanClass = 'span-end';
                                } else {
                                    spanClass = 'span-middle';
                                }
                            }
                                                                                                                
                            // ‚úÖ NEW: Add visual distinction for attendance availability
                            const attendanceStatus = getMultiDayAttendanceStatus(training);
                            let attendanceClass = '';
                            let attendanceIndicator = '';
                            
                            if (training.isOwn) {
                                if (attendanceStatus === 'completed') {
                                    attendanceClass = 'attendance-taken';
                                } else if (attendanceStatus === 'multi-day-available' || attendanceStatus === 'not-taken') {
                                    attendanceClass = 'attendance-available';
                                    if (training.dateRange.length > 1) {
                                        // Check if this specific day has attendance available
                                        const dayKey = `${training.id}_${dateString}`;
                                        if (!multiDayAttendanceStatus[dayKey]) {
                                            attendanceIndicator = '<div class="multi-day-attendance-indicator">‚úì</div>';
                                        }
                                    }
                                }
                            }

                            // Add visual distinction for own vs other trainers' sessions
                            const sessionClass = training.isOwn ? 'own-training' : 'other-training';
                            const trainerBadge = training.isOwn ? '' : `<div class="trainer-badge">${training.trainer.split(' ').map(n => n[0]).join('')}</div>`;
                                                                                                                
                            // Show different content based on span position
                            let displayContent = '';
                            if (spanClass === 'span-start' || spanClass === 'span-single') {
                                displayContent = `
                                    <div class="font-semibold truncate">${training.name}</div>
                                    <div class="text-xs truncate">${timeDisplay}</div>
                                    <div class="text-xs truncate">${training.room}</div>
                                    <div class="text-xs truncate">by ${training.trainer}</div>
                                `;
                            } else if (spanClass === 'span-middle') {
                                displayContent = `
                                    <div class="font-semibold truncate">${training.name}</div>
                                    <div class="text-xs truncate">continues...</div>
                                `;
                            } else if (spanClass === 'span-end') {
                                displayContent = `
                                    <div class="font-semibold truncate">${training.name}</div>
                                    <div class="text-xs truncate">ends ${timeDisplay}</div>
                                `;
                            }

                            trainingsHTML += `
                                <div class="task-item ${colorClass} ${sessionClass} ${spanClass} ${attendanceClass}"
                                     data-training-id="${training.id}"
                                     data-name="${training.name}"
                                     data-time="${timeDisplay}"
                                     data-room="${training.room}"
                                     data-trainer="${training.trainer}"
                                     data-trainer-id="${training.trainerId}"
                                     data-category="${training.category}"
                                     data-is-own="${training.isOwn}"
                                     data-description="${training.description}"
                                     data-date-range='${JSON.stringify(training.dateRange)}'
                                     title="${training.name} - ${training.trainer} - ${training.room} (${training.dateRange.length} day${training.dateRange.length > 1 ? 's' : ''})">
                                    ${displayContent}
                                    ${attendanceIndicator}
                                    ${trainerBadge}
                                </div>
                            `;
                        });

                        calendarHTML += `
                            <div class="calendar-day p-2 ${isCurrentMonth ? 'bg-white' : 'bg-gray-100'} ${hasTraining ? 'has-training' : ''}"
                                  data-date="${dateString}">
                                <div class="font-semibold text-sm ${isCurrentMonth ? 'text-gray-900' : 'text-gray-400'} mb-1">
                                    ${dayNumber}
                                    ${hasTraining ? '<div class="training-indicator"></div>' : ''}
                                </div>
                                <div class="space-y-1">
                                    ${trainingsHTML}
                                </div>
                            </div>
                        `;

                        currentCalendarDate.setDate(currentCalendarDate.getDate() + 1);
                    }
                }

                $('#calendarGrid').html(calendarHTML);

                // Update counts and indicators
                updateTrainingCounts();
                updateNavigationIndicators();

                // Add click event to task items - Show activity details first
                $('.task-item').click(function(e) {
                    e.stopPropagation();
                    const trainingId = $(this).data('training-id');
                    const name = $(this).data('name');
                    const time = $(this).data('time');
                    const category = $(this).data('category');
                    const trainer = $(this).data('trainer');
                    const trainerId = $(this).data('trainer-id');
                    const isOwn = $(this).data('is-own');
                    const room = $(this).data('room');
                    const description = $(this).data('description');
                    const dateRange = $(this).data('date-range');

                    showActivityDetailsModal(trainingId, name, time, category, trainer, trainerId, isOwn, room, description, dateRange);
                });

                // ‚úÖ FIXED: Add date range selection functionality with proper date handling
                $('.calendar-day').off('mousedown mouseenter mouseup');
                                                                
                $('.calendar-day').mousedown(function(e) {
                    e.preventDefault();
                    const clickedDate = $(this).data('date');
                                                                                
                    // If clicking on a task item, don't start selection
                    if ($(e.target).closest('.task-item').length > 0) {
                        return;
                    }
                                                                                
                    isSelecting = true;
                    selectionStart = clickedDate;
                    selectionEnd = clickedDate;
                                                                                
                    clearDateSelection();
                    selectDateRange(selectionStart, selectionEnd);
                });

                $('.calendar-day').mouseenter(function() {
                    if (isSelecting) {
                        const hoveredDate = $(this).data('date');
                        selectionEnd = hoveredDate;
                        selectDateRange(selectionStart, selectionEnd);
                    }
                });

                $(document).mouseup(function() {
                    if (isSelecting) {
                        isSelecting = false;
                                                                                                
                        // Update form fields if modal is open
                        if (selectedRange.length > 0 && !modal.hasClass('hidden')) {
                            $('#id_start_date').val(selectedRange[0]);
                            if (selectedRange.length > 1) {
                                $('#id_end_date').val(selectedRange[selectedRange.length - 1]);
                            } else {
                                $('#id_end_date').val('');
                            }
                        }
                    }
                });
            }

            // Show all trainings modal with multi-day support
            function showAllTrainingsModal() {
                let tableHTML = '';
                                                                
                // Sort trainings by date (use all trainings, not filtered)
                const sortedTrainings = [...allTrainings].sort((a, b) => parseDate(a.startDate) - parseDate(b.startDate));
                                                                
                sortedTrainings.forEach(training => {
                    const startTime = formatTimeDisplay(training.time);
                    const endTime = formatTimeDisplay(training.endTime);
                    const timeDisplay = startTime && endTime ? `${startTime} - ${endTime}` : startTime;
                    const categoryBadge = `<span class="status-badge ${training.category}">${training.category}</span>`;
                    const trainerBadge = training.isOwn ?
                        `<span class="text-green-600 font-semibold">${training.trainer} (Me)</span>` :
                        `<span class="text-gray-600">${training.trainer}</span>`;
                                                                                
                    // Format date range display
                    let dateRangeDisplay = training.startDate;
                    if (training.endDate && training.endDate !== training.startDate) {
                        dateRangeDisplay += ` - ${training.endDate}`;
                    }
                                                                                
                    tableHTML += `
                        <tr>
                            <td>${dateRangeDisplay}</td>
                            <td>${training.name}</td>
                            <td>${timeDisplay}</td>
                            <td>${training.room}</td>
                            <td>${trainerBadge}</td>
                            <td>${categoryBadge}</td>
                            <td class="actions">
                                <button onclick="showActivityDetailsFromList(${training.id}, '${training.name}', '${timeDisplay}', '${training.category}', '${training.trainer}', ${training.trainerId}, ${training.isOwn}, '${training.room}', '${training.description}', '${JSON.stringify(training.dateRange).replace(/'/g, "\\'")}')" class="view">
                                    View Details
                                </button>
                            </td>
                        </tr>
                    `;
                });
                                                                
                $('#allTrainingsTableBody').html(tableHTML);
                allTrainingsModal.removeClass('hidden');
            }

            // Global function for showing activity details from list
            window.showActivityDetailsFromList = function(trainingId, name, time, category, trainer, trainerId, isOwn, room, description, dateRangeStr) {
                allTrainingsModal.addClass('hidden');
                const dateRange = JSON.parse(dateRangeStr);
                showActivityDetailsModal(trainingId, name, time, category, trainer, trainerId, isOwn, room, description, dateRange);
            };

            // ‚úÖ ENHANCED: Show attendance modal with multi-day support
            function showAttendanceModal(trainingId, name, time, category, trainer, trainerId, isOwn, selectedDay = null) {
                // Get the training data to check if it's multi-day
                const training = allTrainings.find(t => t.id === trainingId);
                const isMultiDay = training && training.dateRange.length > 1;
                
                // ‚úÖ NEW: For multi-day trainings, use selected day or first available day
                let targetDate = selectedDay;
                if (isMultiDay && !targetDate) {
                    targetDate = training.dateRange.find(dateStr => {
                        const dayKey = `${trainingId}_${dateStr}`;
                        return !multiDayAttendanceStatus[dayKey];
                    }) || training.dateRange[0];
                }

                // ‚úÖ NEW: Check if attendance was already submitted for this specific day
                const dayKey = isMultiDay ? `${trainingId}_${targetDate}` : trainingId;
                const isAttendanceCompleted = isMultiDay ? multiDayAttendanceStatus[dayKey] : attendanceSubmitted[trainingId];

                if (isAttendanceCompleted && isOwn) {
                    $('#attendanceCompletedMessage').removeClass('hidden');
                    $('#attendanceList').addClass('attendance-disabled');
                    $('#saveAttendanceBtn').prop('disabled', true).text('Attendance Already Submitted');
                } else {
                    $('#attendanceCompletedMessage').addClass('hidden');
                    $('#attendanceList').removeClass('attendance-disabled');
                    if (isOwn) {
                        $('#saveAttendanceBtn').prop('disabled', false).html('<i class="fas fa-save mr-2"></i>SAVE ATTENDANCE');
                    }
                }

                // Check if submission would be late
                if (training && isOwn) {
                    const checkDate = targetDate || training.startDate;
                    const isLate = isAttendanceLate(checkDate, training.time.split(' - ')[0]);
                    if (isLate && !isAttendanceCompleted) {
                        $('#lateWarning').addClass('show');
                    } else {
                        $('#lateWarning').removeClass('show');
                    }
                }

                // Set task details in the modal
                $('#taskBadge').text(name);
                $('#taskBadge').removeClass().addClass('px-4 py-2 rounded-full text-white mr-4 text-lg font-semibold');
                                                                
                // Set badge color based on category
                if (category === 'activity') {
                    $('#taskBadge').addClass('bg-blue-500');
                } else if (category === 'examination') {
                    $('#taskBadge').addClass('bg-green-500');
                } else if (category === 'workshop') {
                    $('#taskBadge').addClass('bg-purple-500');
                } else if (category === 'seminar') {
                    $('#taskBadge').addClass('bg-orange-500');
                } else {
                    $('#taskBadge').addClass('bg-pink-200 text-pink-800');
                }
                                                                
                $('#taskTime').text(time || '1:00 pm - 2:00 pm');
                $('#taskTrainer').text(`Trainer: ${trainer}`);

                // ‚úÖ NEW: Show multi-day indicator and current day info
                if (isMultiDay) {
                    $('#multiDayIndicator').removeClass('hidden');
                    const dayIndex = training.dateRange.indexOf(targetDate) + 1;
                    const targetDateObj = parseDate(targetDate);
                    $('#currentDayInfo').text(`Day ${dayIndex} of ${training.dateRange.length} - ${targetDateObj.toLocaleDateString()}`);
                } else {
                    $('#multiDayIndicator').addClass('hidden');
                }
                                                                
                // Store current training ID and ownership for saving attendance
                $('#attendanceModal').data('training-id', trainingId);
                $('#attendanceModal').data('is-own', isOwn);
                $('#attendanceModal').data('trainer-id', trainerId);
                $('#attendanceModal').data('target-date', targetDate);
                $('#attendanceModal').data('is-multi-day', isMultiDay);
                                                                
                // Show/hide permission message and disable save button if not owner
                if (!isOwn) {
                    $('#attendancePermissionMessage').removeClass('hidden');
                    $('#saveAttendanceBtn').prop('disabled', true).text('View Only');
                } else {
                    $('#attendancePermissionMessage').addClass('hidden');
                }
                                                                
                // ‚úÖ ENHANCED: Load existing attendance data from server with day-specific support
                const attendanceUrl = isMultiDay ? `/get-attendance/${trainingId}/?date=${targetDate}` : `/get-attendance/${trainingId}/`;
                
                $.ajax({
                    url: attendanceUrl,
                    type: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(response) {
                        if (response.students) {
                            // Check if attendance was already submitted
                            const hasAttendanceData = response.students.some(student => student.status);
                            if (hasAttendanceData) {
                                if (isMultiDay) {
                                    multiDayAttendanceStatus[dayKey] = true;
                                } else {
                                    attendanceSubmitted[trainingId] = true;
                                }
                            }

                            // Generate attendance list with existing data
                            let attendanceHTML = '';
                            response.students.forEach(student => {
                                const isPresent = student.status === 'present';
                                const isMissed = student.status === 'missed';
                                const disabledAttr = (!isOwn || isAttendanceCompleted) ? 'disabled' : '';
                                                                                                                                
                                attendanceHTML += `
                                    <tr data-student-id="${student.id}">
                                        <td class="text-left">${student.name}</td>
                                        <td>
                                            <input type="radio" name="attendance_${student.id}" value="present" class="attendance-radio"
                                                 ${isPresent ? 'checked' : ''} ${disabledAttr}>
                                        </td>
                                        <td>
                                            <input type="radio" name="attendance_${student.id}" value="missed" class="attendance-radio"
                                                ${isMissed ? 'checked' : ''} ${disabledAttr}>
                                        </td>
                                    </tr>
                                `;
                            });
                            $('#attendanceList').html(attendanceHTML);

                            // Update UI based on submission status
                            if (isAttendanceCompleted && isOwn) {
                                $('#attendanceCompletedMessage').removeClass('hidden');
                                $('#attendanceList').addClass('attendance-disabled');
                                $('#saveAttendanceBtn').prop('disabled', true).text('Attendance Already Submitted');
                                $('#lateWarning').removeClass('show');
                            }
                        }
                    },
                    error: function() {
                        // Fallback to generating list without existing data
                        let attendanceHTML = '';
                        students.forEach(student => {
                            const disabledAttr = (!isOwn || isAttendanceCompleted) ? 'disabled' : '';
                            attendanceHTML += `
                                <tr data-student-id="${student.id}">
                                    <td class="text-left">${student.name}</td>
                                    <td>
                                        <input type="radio" name="attendance_${student.id}" value="present" class="attendance-radio" ${disabledAttr}>
                                    </td>
                                    <td>
                                        <input type="radio" name="attendance_${student.id}" value="missed" class="attendance-radio" ${disabledAttr}>
                                    </td>
                                </tr>
                            `;
                        });
                        $('#attendanceList').html(attendanceHTML);
                    }
                });
                                                                
                // Show the modal
                attendanceModal.css('display', 'flex');
            }

            // Show confirmation dialog
            function showConfirmationDialog(title, message, onConfirm, iconType = 'warning') {
                $('#confirmationTitle').text(title);
                $('#confirmationMessage').text(message);
                                                                
                const icon = $('.confirmation-icon');
                icon.removeClass('warning error').addClass(iconType);
                                                                
                confirmationDialog.css('display', 'flex');
                                                                
                // Set up confirm button click
                $('#confirmationConfirmBtn').off('click').on('click', function() {
                    confirmationDialog.css('display', 'none');
                    if (onConfirm) onConfirm();
                });
            }

            // Calendar navigation
            $('#prevMonth').click(function() {
                currentDate.setMonth(currentDate.getMonth() - 1);
                generateCalendar(currentDate);
            });

            $('#nextMonth').click(function() {
                currentDate.setMonth(currentDate.getMonth() + 1);
                generateCalendar(currentDate);
            });

            // Show all trainings modal
            $('#showAllTrainingsBtn').click(function() {
                showAllTrainingsModal();
            });

            $('#closeAllTrainingsBtn').click(function() {
                allTrainingsModal.addClass('hidden');
            });

            // ‚úÖ ENHANCED: Activity details modal handlers with multi-day support
            $('#takeAttendanceBtn').click(function() {
                if (currentTrainingData) {
                    const isMultiDay = currentTrainingData.dateRange.length > 1;
                    
                    if (isMultiDay && selectedAttendanceDay) {
                        // Use selected day for multi-day training
                        activityDetailsModal.css('display', 'none');
                        showAttendanceModal(
                            currentTrainingData.id,
                            currentTrainingData.name,
                            currentTrainingData.time,
                            currentTrainingData.category,
                            currentTrainingData.trainer,
                            currentTrainingData.trainerId,
                            currentTrainingData.isOwn,
                            selectedAttendanceDay
                        );
                    } else if (!isMultiDay) {
                        // Single day training
                        activityDetailsModal.css('display', 'none');
                        showAttendanceModal(
                            currentTrainingData.id,
                            currentTrainingData.name,
                            currentTrainingData.time,
                            currentTrainingData.category,
                            currentTrainingData.trainer,
                            currentTrainingData.trainerId,
                            currentTrainingData.isOwn
                        );
                    } else {
                        alert('Please select a day for attendance.');
                    }
                }
            });

            $('#closeActivityDetailsBtn, #activityDetailsCloseBtn').click(function() {
                activityDetailsModal.css('display', 'none');
                selectedAttendanceDay = null;
            });

            // Modal handling
            $('#createTaskBtn, #createTaskBtnAttendance').click(function() {
                attendanceModal.css('display', 'none');
                activityDetailsModal.css('display', 'none');
                allTrainingsModal.addClass('hidden');
                modal.removeClass('hidden');
                form[0].reset();
                formErrors.addClass('hidden');
                successMessage.addClass('hidden');
                                                                
                // Set dates from selection if available
                if (selectedRange.length > 0) {
                    $('#id_start_date').val(selectedRange[0]);
                    if (selectedRange.length > 1) {
                        $('#id_end_date').val(selectedRange[selectedRange.length - 1]);
                    } else {
                        $('#id_end_date').val('');
                    }
                } else {
                    // Set today's date as default
                    const today = formatDateString(new Date());
                    $('#id_start_date').val(today);
                    $('#id_end_date').val('');
                }
            });

            // Close attendance modal
            $('#closeAttendanceBtn, #attendanceCloseBtn').click(function() {
                attendanceModal.css('display', 'none');
            });

            // Close confirmation dialog
            $('#confirmationCancelBtn').click(function() {
                confirmationDialog.css('display', 'none');
            });

            // ‚úÖ ENHANCED: Save attendance with multi-day support and confirmation
            $('#saveAttendanceBtn').click(function() {
                const trainingId = $('#attendanceModal').data('training-id');
                const isOwn = $('#attendanceModal').data('is-own');
                const targetDate = $('#attendanceModal').data('target-date');
                const isMultiDay = $('#attendanceModal').data('is-multi-day');
                                                                
                // Check if user can save attendance
                if (!isOwn) {
                    alert('You can only modify attendance for sessions you created.');
                    return;
                }

                // ‚úÖ NEW: Check if already submitted for this specific day
                const dayKey = isMultiDay ? `${trainingId}_${targetDate}` : trainingId;
                const isCompleted = isMultiDay ? multiDayAttendanceStatus[dayKey] : attendanceSubmitted[trainingId];
                
                if (isCompleted) {
                    alert('Attendance has already been submitted for this day and cannot be modified.');
                    return;
                }

                // Check if it's a late submission
                const training = allTrainings.find(t => t.id === trainingId);
                const checkDate = targetDate || training.startDate;
                const isLate = training && isAttendanceLate(checkDate, training.time.split(' - ')[0]);
                                                                
                let confirmationTitle = 'Confirm Attendance Submission';
                let confirmationMessage = 'Are you sure you want to submit this attendance? This action cannot be undone.';
                                                                
                if (isMultiDay) {
                    const dayIndex = training.dateRange.indexOf(targetDate) + 1;
                    const targetDateObj = parseDate(targetDate);
                    confirmationTitle = 'Multi-Day Training Attendance';
                    confirmationMessage = `This attendance is for Day ${dayIndex} of ${training.dateRange.length} (${targetDateObj.toLocaleDateString()}). You can take attendance for other days separately. Are you sure you want to continue?`;
                } else if (isLate) {
                    confirmationTitle = 'Late Attendance Submission';
                    confirmationMessage = 'Warning: You are submitting attendance after the scheduled time. This will be marked as a late submission. Are you sure you want to continue?';
                }

                showConfirmationDialog(confirmationTitle, confirmationMessage, function() {
                    submitAttendance(trainingId, targetDate, isMultiDay);
                });
            });

            // ‚úÖ ENHANCED: Function to actually submit attendance with multi-day support
            function submitAttendance(trainingId, targetDate = null, isMultiDay = false) {
                // Disable the button to prevent double submission
                $('#saveAttendanceBtn').prop('disabled', true).text('Saving...');

                // Collect attendance data
                let attendanceData = [];
                $('#attendanceList tr').each(function() {
                    const studentId = $(this).data('student-id');
                    const status = $(this).find(`input[name="attendance_${studentId}"]:checked`).val();
                    if (studentId && status) {
                        attendanceData.push({
                            student_id: studentId,
                            status: status
                        });
                    }
                });

                console.log('Saving attendance for training ID:', trainingId);
                console.log('Target date:', targetDate);
                console.log('Is multi-day:', isMultiDay);
                console.log('Attendance data:', attendanceData);

                // ‚úÖ ENHANCED: Send AJAX request to save attendance with day-specific support
                const requestData = {
                    training_id: trainingId,
                    attendance: attendanceData
                };

                if (isMultiDay && targetDate) {
                    requestData.target_date = targetDate;
                }

                $.ajax({
                    url: '/save-attendance/',
                    type: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json',
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                    },
                    data: JSON.stringify(requestData),
                    success: function(response) {
                        if (response.success) {
                            // ‚úÖ NEW: Mark attendance as submitted for the specific day
                            if (isMultiDay && targetDate) {
                                const dayKey = `${trainingId}_${targetDate}`;
                                multiDayAttendanceStatus[dayKey] = true;
                            } else {
                                attendanceSubmitted[trainingId] = true;
                            }
                                                                                                                
                            // Show success message
                            const training = allTrainings.find(t => t.id === trainingId);
                            let successMsg = 'Attendance saved successfully! This attendance is now locked and cannot be modified.';
                            
                            if (isMultiDay && targetDate) {
                                const dayIndex = training.dateRange.indexOf(targetDate) + 1;
                                const targetDateObj = parseDate(targetDate);
                                successMsg = `Attendance saved successfully for Day ${dayIndex} (${targetDateObj.toLocaleDateString()})! You can still take attendance for other days in this training session.`;
                            }

                            alert(successMsg);
                                                                                                                
                            // Update attendance counts in the UI if provided
                            if (response.counts) {
                                console.log('Updated counts:', response.counts);
                                updateAttendanceSummary(response.counts);
                            }

                            // Update local student attendance data
                            attendanceData.forEach(item => {
                                const student = students.find(s => s.id === item.student_id);
                                if (student) {
                                    const attendanceKey = isMultiDay ? `${trainingId}_${targetDate}` : trainingId;
                                    student.attendance[attendanceKey] = item.status;
                                }
                            });

                            // Update UI to show completed state
                            $('#attendanceCompletedMessage').removeClass('hidden');
                            $('#attendanceList').addClass('attendance-disabled');
                            $('#lateWarning').removeClass('show');
                                                                                                                
                            // ‚úÖ NEW: Regenerate calendar to update visual indicators
                            generateCalendar(currentDate);
                                                                                                                
                            // Close the modal after a short delay
                            setTimeout(function() {
                                attendanceModal.css('display', 'none');
                                // Refresh the page to update attendance counts in the table
                                location.reload();
                            }, 2000);
                        } else {
                            alert('Error saving attendance: ' + (response.error || 'Unknown error'));
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error:', error);
                        console.error('Response:', xhr.responseText);
                        alert('An error occurred while saving attendance. Please try again.');
                    },
                    complete: function() {
                        // Re-enable the button
                        $('#saveAttendanceBtn').prop('disabled', false).html('<i class="fas fa-save mr-2"></i>SAVE ATTENDANCE');
                    }
                });
            }

            // Function to update attendance summary in the UI
            function updateAttendanceSummary(counts) {
                console.log('Total Present:', counts.total_present);
                console.log('Total Absent:', counts.total_absent);
                console.log('Not Marked:', counts.not_marked);
                console.log('Total Students:', counts.total_students);
            }

            // Close modal when clicking outside
            $(window).click(function(e) {
                if ($(e.target).is(attendanceModal)) {
                    attendanceModal.css('display', 'none');
                }
                if ($(e.target).is(activityDetailsModal)) {
                    activityDetailsModal.css('display', 'none');
                    selectedAttendanceDay = null;
                }
                if ($(e.target).is(allTrainingsModal)) {
                    allTrainingsModal.addClass('hidden');
                }
                if ($(e.target).is(confirmationDialog)) {
                    confirmationDialog.css('display', 'none');
                }
            });

            $('#closeModal, #cancelBtn').click(function() {
                modal.addClass('hidden');
                clearDateSelection();
            });

            modal.click(function(e) {
                if (e.target === this) {
                    modal.addClass('hidden');
                    clearDateSelection();
                }
            });

            // Form submission with AJAX and multi-day support
            form.submit(function(e) {
                e.preventDefault();
                const formData = new FormData(this);

                $.ajax({
                    url: form.attr('action'),
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(response) {
                        if (response.success) {
                            // Add new training to calendar
                            const startDate = formData.get('start_date');
                            const endDate = formData.get('end_date');
                                                                                                                
                            const newTraining = {
                                id: response.training.id,
                                name: response.training.program_name,
                                startDate: startDate,
                                endDate: endDate || '',
                                dateRange: parseDateRange(startDate, endDate || startDate),
                                time: formData.get('task_time') || '09:00',
                                endTime: formData.get('end_time') || '10:00',
                                room: response.training.room_lab,
                                trainer: response.training.trainer_name,
                                trainerId: currentUserId,
                                category: formData.get('category') || 'activity',
                                description: formData.get('description') || '',
                                isOwn: true,
                                attendanceSubmitted: false
                            };

                            allTrainings.push(newTraining);
                            myTrainings.push(newTraining);
                                                                                                                
                            // Update filtered trainings based on current filter
                            const currentFilter = $('#trainerFilter').val();
                            if (currentFilter === 'all') {
                                filteredTrainings = [...allTrainings];
                            } else if (currentFilter === 'mine') {
                                filteredTrainings = [...myTrainings];
                            } else if (parseInt(currentFilter) === currentUserId) {
                                filteredTrainings = [...myTrainings];
                            }
                                                                                                                
                            generateCalendar(currentDate);

                            // Show success message
                            successMessage.html('Training task created successfully!').removeClass('hidden');
                            formErrors.addClass('hidden');

                            // Close modal after 2 seconds
                            setTimeout(function() {
                                modal.addClass('hidden');
                                form[0].reset();
                                successMessage.addClass('hidden');
                                clearDateSelection();
                            }, 2000);
                        } else {
                            // Show errors
                            let errorHtml = '<ul>';
                            if (response.errors) {
                                for (let field in response.errors) {
                                    for (let error of response.errors[field]) {
                                        errorHtml += `<li><strong>${field}:</strong> ${error}</li>`;
                                    }
                                }
                            } else {
                                errorHtml += '<li>An error occurred while creating the training task.</li>';
                            }
                            errorHtml += '</ul>';
                            formErrors.html(errorHtml).removeClass('hidden');
                            successMessage.addClass('hidden');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error:', error);
                        formErrors.html('<ul><li>An error occurred while submitting the form. Please try again.</li></ul>').removeClass('hidden');
                        successMessage.addClass('hidden');
                    }
                });
            });

            // Initialize calendar
            generateCalendar(currentDate);

            // Initial update of training counts
            updateTrainingCounts();
        });

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Function to refresh student attendance summary
        function refreshStudentAttendance(studentId) {
            fetch(`/get-student-attendance/${studentId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const container = document.getElementById(`student-attendance-${studentId}`);
                        if (container) {
                            const presentElement = container.querySelector('.grid .border-r');
                            const absentElement = container.querySelector('.grid div:last-child');
                            if (presentElement) {
                                presentElement.innerHTML = `<div class="border-r py-1 text-green-600 font-semibold">${data.total_present}</div>`;
                            }
                            if (absentElement) {
                                absentElement.innerHTML = `<div class="py-1 text-red-600 font-semibold">${data.total_absent}</div>`;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error refreshing student attendance:', error);
                });
        }

        // Helper function to show notifications
        function showNotification(message, type) {
            const notification = document.createElement("div");
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 20px;
                border-radius: 5px;
                color: white;
                z-index: 1000;
                ${type === "success" ? "background-color: #10b981;" : "background-color: #ef4444;"}
            `;
            document.body.appendChild(notification);

            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
