{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLL - LMSTC Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Libraries for document download functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    {% load static %}
    <script>
        // Define the path to ph.json using Django's static file handling
        const phJsonPath = "{% static 'data/ph.json' %}";
    </script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
        }
        
        .sidebar-gradient {
            background: linear-gradient(180deg, #4a90e2 0%, #2a6dbd 100%);
        }
        
        /* Sidebar collapse styles */
        .sidebar {
            width: 16rem;
            transition: width 0.3s ease-in-out, transform 0.3s ease-in-out;
            position: relative;
            z-index: 10;
        }
        
        .sidebar.collapsed {
            width: 4rem;
        }
        
        .sidebar.collapsed .sidebar-text {
            opacity: 0;
            visibility: hidden;
        }
        
        .sidebar.collapsed .sidebar-logo-text {
            opacity: 0;
            visibility: hidden;
        }
        
        .sidebar.collapsed .dropdown-toggle .fa-chevron-down {
            opacity: 0;
        }
        
        .sidebar-text {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        .sidebar-logo-text {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        .main-content {
            transition: margin-left 0.3s ease-in-out;
            margin-left: 0;
        }
        
        
        .overlay-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            flex-direction: column;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        .overlay-page.active {
            opacity: 1;
            visibility: visible;
        }
        
        .overlay-page button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease-in-out;
        }
        
        .overlay-page button:hover {
            background-color: #2a6dbd;
        }
        
        .dropdown-menu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .dropdown-menu.active {
            max-height: 200px;
        }
        
        .container-card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 2rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        
        .pagination-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            background-color: white;
            color: #4b5563;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        
        .pagination-button:hover:not(.active) {
            background-color: #f3f4f6;
        }
        
        .pagination-button.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        
        .modal.active {
            display: flex;
            opacity: 1;
        }
        
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4b5563;
        }
        
        #notificationContainer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 4000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        
        .notification {
            background-color: #4CAF50;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            display: flex;
            align-items: center;
            min-width: 250px;
        }
        
        .notification.active {
            opacity: 1;
            visibility: visible;
        }
        
        .notification.success {
            background-color: #4CAF50;
        }
        
        .notification.error {
            background-color: #EF4444;
        }
        
        .notification.info {
            background-color: #3B82F6;
        }
        
        .notification .icon {
            margin-right: 10px;
            font-size: 1.25rem;
        }

        .pagination-controls {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-top: 1rem;
            gap: 1rem;
        }

        .pagination-info {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .pagination-nav {
            display: flex;
            gap: 0.25rem;
        }

        .pagination-nav button {
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            background-color: white;
            color: #374151;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .pagination-nav button:hover:not(:disabled) {
            background-color: #f3f4f6;
        }

        .pagination-nav button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-nav button.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .items-per-page {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #374151;
        }

        .items-per-page select {
            padding: 0.25rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: white;
        }

        .filter-control {
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .filter-control {
                flex-direction: row;
                align-items: center;
                gap: 0.5rem;
            }
        }

        .filter-control label {
            white-space: nowrap;
        }

        /* ✅ FIXED NOTIFICATION BOX STYLES */
        #notification-box {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 8px;
            width: 320px;
            background: white;
            color: black;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 50;
            border: 1px solid #e5e7eb;
        }

        #notification-box.hidden {
            display: none;
        }
        
        /* Row highlight style */
        .row-highlight {
            background-color: #FEF9C3; /* amber-100 */
            transition: background-color 1s ease;
            outline: 2px solid #F59E0B; /* amber-500 */
            outline-offset: -2px;
        }
/* Sliding Toggle Switch Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4a90e2;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Auto-collapse sidebar styles */
        .sidebar.auto-collapse {
            width: 4rem;
        }

        .sidebar.auto-collapse .sidebar-text {
            opacity: 0;
            visibility: hidden;
        }

        .sidebar.auto-collapse .sidebar-logo-text {
            opacity: 0;
            visibility: hidden;
        }

        .sidebar.auto-collapse .dropdown-toggle .fa-chevron-down {
            opacity: 0;
        }

        .sidebar.auto-collapse:hover {
            width: 16rem;
        }

        .sidebar.auto-collapse:hover .sidebar-text {
            opacity: 1;
            visibility: visible;
        }

        .sidebar.auto-collapse:hover .sidebar-logo-text {
            opacity: 1;
            visibility: visible;
        }

        .sidebar.auto-collapse:hover .dropdown-toggle .fa-chevron-down {
            opacity: 1;
        }

        /* Calendar Styles */
        .calendar-container {
            font-family: 'Inter', sans-serif;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: linear-gradient(135deg, #4a90e2, #2a6dbd);
            color: white;
            border-radius: 0.5rem;
        }

        .calendar-nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .calendar-nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .calendar-day-header {
            background-color: #f3f4f6;
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: #374151;
        }

        .calendar-day {
            background-color: white;
            min-height: 80px;
            padding: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .calendar-day:hover {
            background-color: #f9fafb;
        }

        .calendar-day.other-month {
            background-color: #f9fafb;
            color: #9ca3af;
        }

        .calendar-day.selected {
            background-color: #dbeafe;
            border: 2px solid #3b82f6;
        }

        .calendar-day.today {
            background-color: #fef3c7;
            border: 2px solid #f59e0b;
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .calendar-event {
            background-color: #3b82f6;
            color: white;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-bottom: 0.125rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .calendar-event:hover {
            background-color: #2563eb;
        }

        .calendar-event.enrollment {
            background-color: #10b981;
        }

        .calendar-event.enrollment:hover {
            background-color: #059669;
        }

        .calendar-event.departmental {
            background-color: #8b5cf6;
        }

        .calendar-event.departmental:hover {
            background-color: #7c3aed;
        }

        .event-indicator {
            position: absolute;
            bottom: 0.25rem;
            right: 0.25rem;
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            background-color: #ef4444;
        }

        /* Enhanced Collapse Arrow Button Styling */
        #sidebarToggleBtn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 10px;
            padding: 10px 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(15px);
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        #sidebarToggleBtn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }

        #sidebarToggleBtn:hover::before {
            left: 100%;
        }

        #sidebarToggleBtn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        #sidebarToggleBtn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 
                0 2px 10px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        #sidebarToggleBtn:focus {
            outline: none;
            box-shadow: 
                0 0 0 3px rgba(255, 255, 255, 0.3),
                0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #sidebarToggleIcon {
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            color: rgba(255, 255, 255, 0.95);
        }

        /* Arrow animation on hover */
        #sidebarToggleBtn:hover #sidebarToggleIcon {
            transform: scale(1.15);
            color: rgba(255, 255, 255, 1);
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
        }

        /* Sidebar header styling enhancement */
        .sidebar-header {
            position: relative;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            margin-bottom: 1rem;
        }

        /* Logo enhancement */
        .sidebar-header img {
            transition: all 0.3s ease;
        }

        .sidebar-header:hover img {
            transform: scale(1.05);
            filter: brightness(1.1);
        }
    </style>
</head>
<body class="flex h-screen bg-gray-100">
    <!-- Messages Notification -->
    {% if messages %}
        {% for message in messages %}
        <div id="notice-message" class="notification active" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; {% if message.tags == 'success' %}background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);{% else %}
            {% if message.tags == 'error' %}background: linear-gradient(135deg, #ef4444, #dc2626); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);{% else %}
              {% if message.tags == 'warning' %}background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);{% else %}background: linear-gradient(135deg, #3b82f6, #1d4ed8); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);{% endif %}
            {% endif %}
          {% endif %}">
            {% if message.tags == 'success' %}
                <i class="icon fas fa-check-circle"></i>
            {% else %}
                {% if message.tags == 'error' %}<i class="icon fas fa-exclamation-triangle"></i>{% else %}
                  {% if message.tags == 'warning' %}<i class="icon fas fa-exclamation-circle"></i>{% else %}
                    <i class="icon fas fa-info-circle"></i>
                  {% endif %}
                {% endif %}
            {% endif %}
            <span>{{ message }}</span>
        </div>
        {% endfor %}
        <script>
            setTimeout(function(){
                const notices = document.querySelectorAll('.notification.active');
                notices.forEach(notice => {
                    notice.classList.remove('active');
                    setTimeout(() => {
                        notice.remove();
                    }, 300);
                });
            }, 3000);
        </script>
    {% endif %}

    <!-- Overlay Page -->
    <div id="overlayPage" class="overlay-page">
        <p id="overlayText"></p>
        <button id="goBackBtn">Go Back</button>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Add Program Modal -->
    <div id="addProgramModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeProgramModalBtn">&times;</button>
            <h3 class="text-2xl font-bold text-blue-500 mb-6 text-center">Add New Program</h3>
            <form id="addProgramForm" method="POST" action="{% url 'add_program' %}" enctype="multipart/form-data" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label for="programName" class="block text-gray-700 text-sm font-bold mb-2">Program Name</label>
                    <input type="text" id="programName" name="program_name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500" placeholder="Enter program name" required>
                </div>
                <div>
                    <label for="programDescription" class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                    <textarea id="programDescription" name="program_detail" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500" placeholder="Enter program description" required></textarea>
                </div>
                <div>
                    <label for="programSchedule" class="block text-gray-700 text-sm font-bold mb-2">Schedule</label>
                    <input type="text" id="programSchedule" name="program_sched" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Monday-Friday 8:00 AM - 5:00 PM" required>
                </div>
                <div>
                    <label for="programTrainer" class="block text-gray-700 text-sm font-bold mb-2">Trainer</label>
                    <input type="text" id="programTrainer" name="program_trainor" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500" placeholder="Enter trainer name">
                </div>
                <!-- Program Competencies Section -->
                <div class="border-t pt-4 mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-3">Program Competencies</label>
                    <p class="text-xs text-gray-600 mb-4">Define the competencies for this program following TESDA standards</p>
                    
                    <!-- Hidden input to store JSON data -->
                    <input type="hidden" id="programCompetenciesData" name="program_competencies">
                    
                    <!-- Competency Type Tabs -->
                    <div class="mb-4 flex border-b">
                        <button type="button" onclick="switchCompetencyTab('basic')" id="basicTab" class="competency-tab px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600">
                            Basic Competencies
                        </button>
                        <button type="button" onclick="switchCompetencyTab('common')" id="commonTab" class="competency-tab px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                            Common Competencies
                        </button>
                        <button type="button" onclick="switchCompetencyTab('core')" id="coreTab" class="competency-tab px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                            Core Competencies
                        </button>
                    </div>
                    
                    <!-- Basic Competencies Content -->
                    <div id="basicCompetencies" class="competency-content">
                        <div class="mb-3 flex justify-between items-center">
                            <p class="text-sm text-gray-600">Foundational skills required for all learners</p>
                            <button type="button" onclick="addCompetency('basic')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                <i class="fas fa-plus mr-1"></i>Add Basic
                            </button>
                        </div>
                        <div id="basicCompetenciesList" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- Basic competencies will be added here dynamically -->
                        </div>
                    </div>
                    
                    <!-- Common Competencies Content -->
                    <div id="commonCompetencies" class="competency-content hidden">
                        <div class="mb-3 flex justify-between items-center">
                            <p class="text-sm text-gray-600">Skills shared across similar programs</p>
                            <button type="button" onclick="addCompetency('common')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                <i class="fas fa-plus mr-1"></i>Add Common
                            </button>
                        </div>
                        <div id="commonCompetenciesList" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- Common competencies will be added here dynamically -->
                        </div>
                    </div>
                    
                    <!-- Core Competencies Content -->
                    <div id="coreCompetencies" class="competency-content hidden">
                        <div class="mb-3 flex justify-between items-center">
                            <p class="text-sm text-gray-600">Program-specific technical skills</p>
                            <button type="button" onclick="addCompetency('core')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                <i class="fas fa-plus mr-1"></i>Add Core
                            </button>
                        </div>
                        <div id="coreCompetenciesList" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- Core competencies will be added here dynamically -->
                        </div>
                    </div>
                </div>
                <!-- Career Opportunities Section -->
                <div class="border-t pt-4 mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-3">Career/Job Opportunities</label>
                    <p class="text-xs text-gray-600 mb-4">List potential job positions that graduates can pursue</p>
                    
                    <div class="mb-3 flex justify-between items-center">
                        <button type="button" onclick="addJobOpportunity(false)" class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600">
                            <i class="fas fa-briefcase mr-1"></i>Add Job Opportunity
                        </button>
                    </div>
                    <div id="jobOpportunitiesList" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Job opportunities will be added here dynamically -->
                    </div>
                </div>
                <div>
                    <label for="programImage" class="block text-gray-700 text-sm font-bold mb-2">Program Image</label>
                    <input type="file" id="programImage" name="program_image" accept="image/*" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Optional: Upload an image for the program</p>
                </div>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md w-full hover:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    <i class="fas fa-plus mr-2"></i>Add Program
                </button>
            </form>
        </div>
    </div>

    <!-- Trainer Registration Modal -->
    <div id="trainerRegistrationModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeModalBtn">&times;</button>
            <h3 class="text-2xl font-bold text-blue-500 mb-6 text-center">Trainer Registration</h3>
            <form id="trainerRegistrationForm" method="POST" action="{% url 'Dashboard_trainor' %}" class="space-y-4">
                {% csrf_token %}
                <div>
                    <label for="fullname" class="block text-gray-700 text-sm font-bold mb-2">Full Name</label>
                    <input type="text" id="fullname" name="fullname" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500" placeholder="Enter full name" required>
                </div>
                <div>
                    <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                    <input type="email" id="email" name="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500" placeholder="Enter email" required>
                </div>
                <div>
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="password" name="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500 pr-10" placeholder="Enter password" required>
                        <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-600">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label for="expertise" class="block text-gray-700 text-sm font-bold mb-2">Programs (Select one or more)</label>
                    <select name="expertise" id="programSelect" multiple class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500" style="min-height: 150px;" required>
                        {% for prog in Programss %}
                            <option value="{{ prog.id }}">{{ prog.program_name }}</option>
                        {% empty %}
                            <option disabled>No programs available</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-600 mt-1">Hold Ctrl/Cmd to select multiple programs</p>
                </div>
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md w-full hover:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Register Trainer
                </button>
            </form>
        </div>
    </div>

    <!-- Manage Trainor Programs Modal -->
    <div id="manageTrainerProgramsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close-btn" id="closeManageProgramsBtn">&times;</button>
            <h3 class="text-2xl font-bold text-blue-500 mb-6 text-center">Manage Trainer Programs</h3>
            <p class="text-center text-gray-600 mb-4">Trainer: <span id="trainerNameDisplay" class="font-semibold"></span></p>
            
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-3">Assigned Programs</h4>
                <div id="assignedProgramsList" class="space-y-2 min-h-[100px] max-h-[200px] overflow-y-auto border border-gray-200 rounded p-3">
                    <p class="text-gray-400 text-center">Loading...</p>
                </div>
            </div>
            
            <div>
                <h4 class="text-lg font-semibold text-gray-700 mb-3">Add New Program</h4>
                <div class="flex gap-2">
                    <select id="programToAssign" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select a program...</option>
                    </select>
                    <button onclick="assignProgram()" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors">
                        <i class="fas fa-plus mr-1"></i>Assign
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Applicant Details Modal -->
    <div id="applicantModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto; background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); padding: 2.5rem; border: 1px solid #e2e8f0;">
            <button class="modal-close-btn" onclick="closeApplicantModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #4b5563;">&times;</button>
            
            <!-- Header Section -->
            <div class="relative mb-8 flex flex-col md:flex-row items-center justify-between">
                <div class="text-center md:text-left md:flex-grow">
                    <p class="text-lg font-bold text-gray-800">Technical Education and Skills Development Authority</p>
                    <p class="text-md text-gray-600">Pangasiwaan sa Edukasyong Teknikal at Pagpapaunlad ng Kasanayan</p>
                    <p class="text-sm text-gray-500 mt-2">MIS 03 – 01 (ver. 2020)</p>
                    <h1 class="text-2xl font-extrabold text-gray-900 mt-6 mb-4 uppercase tracking-wide">Learners Profile Form</h1>
                </div>
                <div class="mt-4 md:mt-0 md:ml-8 flex-shrink-0">
                    <div style="position: relative; width: 128px; height: 128px; border: 2px dashed #94a3b8; border-radius: 0.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: #64748b; font-size: 0.875rem; overflow: hidden;">
                        <img id="modal-profile-picture" src="" alt="ID Picture" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 5;">
                        <div style="position: relative; z-index: 15; pointer-events: none;">
                            <span class="text-xs">ID Picture</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Section 1: T2MIS Auto Generated -->
            <div class="mb-8">
                <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; color: #1a202c; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem;">1. T2MIS Auto Generated</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4a5568; margin-bottom: 0.5rem;">1.1. Unique Learner Identifier (ULI) Number:</label>
                        <input type="text" style="display: block; width: 100%; padding: 0.75rem 1rem; font-size: 1rem; line-height: 1.5; color: #4a5568; background-color: #f7fafc; border: 1px solid #cbd5e0; border-radius: 0.5rem;" placeholder="ULI-XXXX-XXXX-XXXX" readonly disabled value="None">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #4a5568; margin-bottom: 0.5rem;">1.2. Entry Date:</label>
                        <input type="date" id="modal-entry-date" style="display: block; width: 100%; padding: 0.75rem 1rem; font-size: 1rem; line-height: 1.5; color: #4a5568; background-color: #f7fafc; border: 1px solid #cbd5e0; border-radius: 0.5rem;" disabled>
                    </div>
                </div>
            </div>
            
            <!-- Section 2: Learner/Manpower Profile -->
            <div class="mb-8">
                <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; color: #1a202c; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem;">2. Learner/Manpower Profile</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">2.1 Name</label>
                        <input type="text" id="modal-last-name" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-first-name" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-middle-name" class="w-full border rounded p-2" disabled>
                    </div>
                    <!-- Address -->
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">2.2 Complete Permanent Mailing Address</label>
                        <input type="text" id="modal-region-name" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-province-name" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-city-name" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-barangay-name" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-district" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-street" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-email" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-contact-number" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-nationality" class="w-full border rounded p-2" disabled>
                    </div>
                </div>
            </div>
            
            <div>
                <h2 class="font-bold text-lg text-blue-700 mb-2 flex justify-start">3. Personal Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">3.1 Sex</label>
                        <input type="text" id="modal-sex" class="w-full border rounded p-2" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">3.2 Civil Status</label>
                        <input type="text" id="modal-civil-status" class="w-full border rounded p-2" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">3.3 Employment Status (Before the Training)</label>
                        <input type="text" id="modal-employment-status" class="w-full border rounded p-2" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">Monthly Income</label>
                        <input type="text" id="modal-monthly-income" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">Date Hired</label>
                        <input type="date" id="modal-date-hired" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">Company Name</label>
                        <input type="text" id="modal-company-name" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">3.4. Birthdate</label>
                        <input type="text" id="modal-birthdate" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">Age</label>
                        <input type="number" id="modal-age" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">3.5. Birthplace</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-1">
                            <input type="text" id="modal-birthplace-region" class="border rounded p-2" disabled>
                            <input type="text" id="modal-birthplace-province" class="border rounded p-2" disabled>
                            <input type="text" id="modal-birthplace-city" class="border rounded p-2" disabled>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">3.6. Educational Attainment</label>
                        <input type="text" id="modal-educational-attainment" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">3.7. Parent/Guardian</label>
                        <input type="text" id="modal-parent-guardian" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">Complete Permanent Mailing Address</label>
                        <input type="text" id="modal-permanent-address" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                </div>
            </div>
            
            <div>
                <h2 class="font-bold text-lg text-blue-700 mb-2 flex justify-start">
                    4. Learner/Trainee/Student (Clients) Classification
                </h2>
                <div id="modal-classifications" class="border rounded p-2 text-left min-h-[40px]"></div>
            </div>
            
            <div>
                <h2 class="font-bold text-lg text-blue-700 mb-2 flex justify-start">
                    5. Type of Disability (For Persons with Disability only)
                </h2>
                <div id="modal-disability-type" class="border rounded p-2 text-left min-h-[40px]"></div>
            </div>
            
            <div>
                <h2 class="font-bold text-lg text-blue-700 mb-2 flex justify-start">
                    6. Cause of Disability (For Persons with Disability only)
                </h2>
                <div id="modal-disability-causes" class="border rounded p-2 text-left min-h-[40px]"></div>
            </div>
            
            <div class="space-y-2 mt-4">
                <label class="font-bold text-lg text-blue-700 mb-2 flex justify-start">7. Name of Course/Qualification</label>
                <input type="text" id="modal-course-qualification" class="w-full border rounded p-2" disabled>
                <label class="font-bold text-lg text-blue-700 mb-2 flex justify-start">8. Scholarship Package (TWSP, PESFA, STEP, others)</label>
                <input type="text" id="modal-scholarship" class="w-full border rounded p-2" disabled>
            </div>
            
            <div class="mt-6">
                <div class="border-l-4 border-blue-600 bg-blue-50 p-4 text-sm text-gray-700 rounded text-center">
                    <p class="font-bold text-lg text-blue-700 mb-2">9. Privacy Disclaimer</p>
                    <p>
                        I hereby allow TESDA to use/post my contact details, name, email, cellphone/landline nos. and other
                        information I provided which may be used for processing of my scholarship application, for employment
                        opportunities and for the survey of TESDA programs.
                    </p>
                </div>
                <div class="mt-6">
                    <h2 class="font-bold text-lg text-blue-700 mb-2">10. Applicant's Signature</h2>
                    <p class="text-sm text-gray-600 mb-6">This is to certify that the information stated above is true and correct.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-4 md:col-span-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Applicant's Name</label>
                                <input type="text" id="modal-applicant-name" class="w-full border border-gray-300 rounded p-2" disabled>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Date Accomplished</label>
                                <input type="text" id="modal-date-accomplished" class="w-full border border-gray-300 rounded p-2" disabled>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Continue with other form sections... -->
                <div class="bg-white border-t border-gray-200 p-4 shadow-lg mt-10 sticky">
                    <div class="flex justify-end gap-3">
                        {% if ProgAPP %}
                        <form method="post" action="{% url 'approve_application' ProgAPP.id %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="bg-green-600 hover:bg-green-700 focus:ring-2 focus:ring-green-500 focus:ring-offset-2 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200">
                                Approve
                            </button>
                        </form>
                        {% endif %}
                        
                        <button class="bg-blue-600 hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200" onclick="closeApplicantModal()">
                            Close
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Approved Details Modal -->
    <div id="approvedModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeApprovedModal()">&times;</button>
            <h3 class="text-2xl font-bold mb-4">Applicant Details</h3>
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-blue-700">DLL-LMSTC Registration Form</h1>
                    <p class="text-lg font-semibold text-gray-700 flex justify-start">LEARNERS PROFILE FORM</p>
                </div>
                <div class="w-24 h-24 bg-gray-200 flex items-center justify-center text-gray-500 border relative cursor-pointer overflow-hidden rounded">
                    <img id="modal-profile-picture" src="/placeholder.svg" alt="Profile Picture">
                </div>
            </div>
            
            <!-- Form content similar to your original modal -->
            <h2 class="font-bold text-lg text-blue-700 mb-2 flex justify-start">1. TWMS Auto Generated</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-semibold text-gray-600 flex justify-start">1.1 Unique Learner Identifier (ULI) Number:</label>
                    <input type="text" class="w-full border rounded p-2 mt-1" placeholder="" disabled value="None">
                </div>
                <div>
                    <label class="text-sm font-semibold text-gray-600 flex justify-start">1.2 Entry Date:</label>
                    <input type="date" id="modal-entry-date" class="w-full border rounded p-2" disabled>
                </div>
            </div>
            
            <div>
                <h2 class="font-bold text-lg text-blue-700 mb-2 flex justify-start">2. Learner/Manpower Profile</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">2.1 Name</label>
                        <input type="text" id="modal-last-name" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-first-name" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-middle-name" class="w-full border rounded p-2" disabled>
                    </div>
                    <!-- Address -->
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">2.2 Complete Permanent Mailing Address</label>
                        <input type="text" id="modal-region-name" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-province-name" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-city-name" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-barangay-name" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-district" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-street" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-email" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-contact-number" class="w-full border rounded p-2" disabled>
                        <input type="text" id="modal-nationality" class="w-full border rounded p-2" disabled>
                    </div>
                </div>
            </div>
            
            <div>
                <h2 class="font-bold text-lg text-blue-700 mb-2 flex justify-start">3. Personal Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">3.1 Sex</label>
                        <input type="text" id="modal-sex" class="w-full border rounded p-2" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">3.2 Civil Status</label>
                        <input type="text" id="modal-civil-status" class="w-full border rounded p-2" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">3.3 Employment Status (Before the Training)</label>
                        <input type="text" id="modal-employment-status" class="w-full border rounded p-2" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">Monthly Income</label>
                        <input type="text" id="modal-monthly-income" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">Date Hired</label>
                        <input type="date" id="modal-date-hired" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">Company Name</label>
                        <input type="text" id="modal-company-name" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">3.4. Birthdate</label>
                        <input type="text" id="modal-birthdate" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">Age</label>
                        <input type="number" id="modal-age" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">3.5. Birthplace</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-1">
                            <input type="text" id="modal-birthplace-region" class="border rounded p-2" disabled>
                            <input type="text" id="modal-birthplace-province" class="border rounded p-2" disabled>
                            <input type="text" id="modal-birthplace-city" class="border rounded p-2" disabled>
                        </div>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">3.6. Educational Attainment</label>
                        <input type="text" id="modal-educational-attainment" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">3.7. Parent/Guardian</label>
                        <input type="text" id="modal-parent-guardian" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                    <div>
                        <label class="text-sm font-semibold text-gray-600 flex justify-start">Complete Permanent Mailing Address</label>
                        <input type="text" id="modal-permanent-address" class="w-full border rounded p-2 mt-1" disabled>
                    </div>
                </div>
            </div>
            
            <div>
                <h2 class="font-bold text-lg text-blue-700 mb-2 flex justify-start">
                    4. Learner/Trainee/Student (Clients) Classification
                </h2>
                <div id="modal-classifications" class="border rounded p-2 text-left min-h-[40px]"></div>
            </div>
            
            <div>
                <h2 class="font-bold text-lg text-blue-700 mb-2 flex justify-start">
                    5. Type of Disability (For Persons with Disability only)
                </h2>
                <div id="modal-disability-type" class="border rounded p-2 text-left min-h-[40px]"></div>
            </div>
            
            <div>
                <h2 class="font-bold text-lg text-blue-700 mb-2 flex justify-start">
                    6. Cause of Disability (For Persons with Disability only)
                </h2>
                <div id="modal-disability-causes" class="border rounded p-2 text-left min-h-[40px]"></div>
            </div>
            
            <div class="space-y-2 mt-4">
                <label class="font-bold text-lg text-blue-700 mb-2 flex justify-start">7. Name of Course/Qualification</label>
                <input type="text" id="modal-course-qualification" class="w-full border rounded p-2" disabled>
                <label class="font-bold text-lg text-blue-700 mb-2 flex justify-start">8. Scholarship Package (TWSP, PESFA, STEP, others)</label>
                <input type="text" id="modal-scholarship" class="w-full border rounded p-2" disabled>
            </div>
            
            <div class="mt-6">
                <div class="border-l-4 border-blue-600 bg-blue-50 p-4 text-sm text-gray-700 rounded text-center">
                    <p class="font-bold text-lg text-blue-700 mb-2">9. Privacy Disclaimer</p>
                    <p>
                        I hereby allow TESDA to use/post my contact details, name, email, cellphone/landline nos. and other
                        information I provided which may be used for processing of my scholarship application, for employment
                        opportunities and for the survey of TESDA programs.
                    </p>
                </div>
                <div class="mt-6">
                    <h2 class="font-bold text-lg text-blue-700 mb-2">10. Applicant's Signature</h2>
                    <p class="text-sm text-gray-600 mb-6">This is to certify that the information stated above is true and correct.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="space-y-4 md:col-span-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Applicant's Name</label>
                                <input type="text" id="modal-applicant-name" class="w-full border border-gray-300 rounded p-2" disabled>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Date Accomplished</label>
                                <input type="text" id="modal-date-accomplished" class="w-full border border-gray-300 rounded p-2" disabled>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Continue with other form sections... -->
            <div class="bg-white border-t border-gray-200 p-4 shadow-lg mt-10">
                <button class="bg-blue-600 hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 text-white px-6 py-2 rounded-lg font-medium transition-colors duration-200" onclick="closeApprovedModal()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Decline Modal (used for both regular and walk-in applications) -->
    <div id="declineModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeDeclineModal()">&times;</button>
            <h2 class="text-xl font-semibold mb-4 text-red-600">Decline Application</h2>
            <p class="mb-4 text-gray-700">Are you sure you want to decline <span id="declineApplicantName" class="font-bold"></span>'s application?</p>
            <form id="declineForm" method="POST" action="{% url 'decline_application' %}">
                {% csrf_token %}
                <input type="hidden" name="application_id" id="declineApplicationId">
                <input type="hidden" id="declineType" value="program">
                
                <label for="commonReason" class="block text-sm font-medium text-gray-700 mb-1">Select a reason</label>
                <select id="commonReason" class="w-full mb-4 border-gray-300 rounded-lg text-black" onchange="updateReasonText()">
                    <option value="">-- Choose a reason --</option>
                    <option value="Incomplete/Incorrect Info">Incomplete/Incorrect Info</option>
                    <option value="Does not meet qualifications">Does not meet qualifications</option>
                    <option value="Other">Other</option>
                </select>
                
                <label for="declineReason" class="block text-sm font-medium text-gray-700 mb-1">Reason for Decline</label>
                <textarea id="declineReason" name="decline_reason" rows="3" class="w-full p-2 border border-gray-300 rounded-lg mb-4 text-black" placeholder="Write custom reason or select from above"></textarea>
                
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeDeclineModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg">
                        Cancel
                    </button>
                    <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                        Confirm Decline
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Include Field Review Modal -->
    {% include 'field_review_modal.html' %}

    <!-- Walk-in Registration Modal -->
    <div id="walkinModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 95vh; overflow-y: auto;">
            <button class="modal-close-btn" onclick="closeWalkinModal()">&times;</button>
            
            <!-- Step 1: Create Account -->
            <div id="walkinStep1" class="walkin-step">
                <h3 class="text-2xl font-bold text-blue-500 mb-6 text-center">Walk-in Registration - Step 1</h3>
                <p class="text-gray-600 mb-4 text-center">Enter the applicant's full name to create an account</p>
                <div class="space-y-4">
                    <div>
                        <label for="walkinFullName" class="block text-gray-700 text-sm font-bold mb-2">Full Name *</label>
                        <input type="text" id="walkinFullName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500" placeholder="Enter full name (e.g., Juan Dela Cruz)" required>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="createWalkinAccount()" class="bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600 transition-colors">
                        <i class="fas fa-user-plus mr-2"></i>Create Account
                    </button>
                </div>
            </div>

            <!-- Step 2: Select Program -->
            <div id="walkinStep2" class="walkin-step" style="display: none;">
                <h3 class="text-2xl font-bold text-blue-500 mb-6 text-center">Walk-in Registration - Step 2</h3>
                <p class="text-gray-600 mb-4 text-center">Select the program to apply for</p>
                <div class="space-y-4">
                    <div>
                        <label for="walkinProgram" class="block text-gray-700 text-sm font-bold mb-2">Program to Apply *</label>
                        <select id="walkinProgram" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="">Select program</option>
                            {% for prog in Programss %}
                                <option value="{{ prog.id }}">{{ prog.program_name }}</option>
                            {% empty %}
                                <option disabled>No programs available</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="flex justify-between mt-6">
                    <button type="button" onclick="showWalkinStep(1)" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Back
                    </button>
                    <button type="button" onclick="applyWalkinProgram()" class="bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600 transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i>Submit Application
                    </button>
                </div>
            </div>

            <!-- Step 3: Account Created -->
            <div id="walkinStep3" class="walkin-step" style="display: none;">
                <h3 class="text-2xl font-bold text-green-500 mb-6 text-center">Walk-in Registration Complete!</h3>
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-check-circle text-green-500 text-2xl mr-3"></i>
                        <h4 class="text-lg font-semibold text-green-800">Account Created Successfully</h4>
                    </div>
                    <div class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Username:</label>
                                <div class="bg-white border rounded px-3 py-2 font-mono text-blue-600" id="walkinUsername">-</div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password:</label>
                                <div class="bg-white border rounded px-3 py-2 font-mono text-blue-600" id="walkinPassword">-</div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Application Status:</label>
                            <div class="bg-yellow-100 border border-yellow-300 rounded px-3 py-2 text-yellow-800">
                                <i class="fas fa-clock mr-2"></i>Pending Approval (Queue #<span id="walkinQueueNumber">-</span>)
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h5 class="font-semibold text-blue-800 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>Important Information
                    </h5>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>• Please save these credentials for the applicant</li>
                        <li>• The application is now in the approval queue</li>
                        <li>• Ask the walk-in applicant to log in; they will be routed straight to the Learner's Profile form (registration_f1)</li>
                        <li>• This next-step profile completion is required only for walk-in applicants</li>
                        <li>• The applicant will be notified once approved</li>
                    </ul>
                </div>
                <div class="flex justify-center">
                    <button type="button" onclick="closeWalkinModal()" class="bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600 transition-colors">
                        <i class="fas fa-check mr-2"></i>Complete
                    </button>
                </div>
            </div>

            <!-- Hidden data storage -->
            <input type="hidden" id="walkinApplicantId">
            <input type="hidden" id="walkinApplicationId">
        </div>
    </div>

    <!-- Walk-in Applicant Details Modal -->
    <div id="walkinDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 95vh; overflow-y: auto;">
            <button class="modal-close-btn" onclick="closeWalkinDetailsModal()">&times;</button>
            <div class="mt-3">
                <h3 class="text-2xl font-bold text-blue-500 mb-6 text-center">Walk-in Applicant Details</h3>
                <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-user-circle text-green-500 text-2xl mr-3"></i>
                        <h4 class="text-lg font-semibold text-green-800" id="walkinDetailsName">-</h4>
                    </div>
                    <div class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Username:</label>
                                <div class="bg-white border rounded px-3 py-2 font-mono text-blue-600" id="walkinDetailsUsername">-</div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password:</label>
                                <div class="bg-white border rounded px-3 py-2 font-mono text-blue-600" id="walkinDetailsPassword">lmstc</div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Application Status:</label>
                            <div class="rounded px-3 py-2" id="walkinDetailsStatus">
                                <span id="walkinDetailsStatusIcon"></span><span id="walkinDetailsStatusText">-</span>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Queue Number:</label>
                            <div class="bg-blue-100 border border-blue-300 rounded px-3 py-2 text-blue-800">
                                <i class="fas fa-list-ol mr-2"></i>#<span id="walkinDetailsQueue">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h5 class="font-semibold text-blue-800 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>Important Information
                    </h5>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>• These are the login credentials for the walk-in applicant</li>
                        <li>• The applicant can use these credentials to log in</li>
                        <li>• They will be routed to the Learner's Profile form (registration_f1)</li>
                        <li>• Profile completion is required for walk-in applicants</li>
                    </ul>
                </div>
                <div class="flex justify-center">
                    <button type="button" onclick="closeWalkinDetailsModal()" class="bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600 transition-colors">
                        <i class="fas fa-check mr-2"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Program Modal -->
    <div id="viewProgramModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeViewProgramModal()">&times;</button>
            <h3 class="text-2xl font-bold text-blue-500 mb-6 text-center">Program Details</h3>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Program Name</label>
                            <div id="viewProgramName" class="bg-gray-50 border rounded w-full py-2 px-3 text-gray-700"></div>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Schedule</label>
                            <div id="viewProgramSchedule" class="bg-gray-50 border rounded w-full py-2 px-3 text-gray-700"></div>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Trainer</label>
                            <div id="viewProgramTrainer" class="bg-gray-50 border rounded w-full py-2 px-3 text-gray-700"></div>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Skills</label>
                            <div id="viewProgramSkills" class="bg-gray-50 border rounded w-full py-2 px-3 text-gray-700"></div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                            <div id="viewProgramDescription" class="bg-gray-50 border rounded w-full py-2 px-3 text-gray-700 min-h-[100px]"></div>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Program Image</label>
                            <div class="bg-gray-50 border rounded w-full py-2 px-3 text-center">
                                <img id="viewProgramImage" src="" alt="Program Image" class="max-w-full h-32 object-cover mx-auto rounded" style="display: none;">
                                <span id="viewProgramImagePlaceholder" class="text-gray-500">No image available</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Career Opportunities Display -->
                <div class="border-t pt-4 mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Career/Job Opportunities</label>
                    <div id="viewProgramJobOpportunities" class="bg-gray-50 border rounded w-full py-2 px-3 text-gray-700 min-h-[60px]">
                        <ul id="viewJobOpportunitiesList" class="list-disc list-inside space-y-1">
                            <!-- Job opportunities will be displayed here -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Program Modal -->
    <div id="editProgramModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeEditProgramModal()">&times;</button>
            <h3 class="text-2xl font-bold text-blue-500 mb-6 text-center">Edit Program</h3>
            <form id="editProgramForm" method="POST" enctype="multipart/form-data" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" id="editProgramId" name="program_id">
                <div>
                    <label for="editProgramName" class="block text-gray-700 text-sm font-bold mb-2">Program Name</label>
                    <input type="text" id="editProgramName" name="program_name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="editProgramDescription" class="block text-gray-700 text-sm font-bold mb-2">Description</label>
                    <textarea id="editProgramDescription" name="program_detail" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500" required></textarea>
                </div>
                <div>
                    <label for="editProgramSchedule" class="block text-gray-700 text-sm font-bold mb-2">Schedule</label>
                    <input type="text" id="editProgramSchedule" name="program_sched" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label for="editProgramTrainer" class="block text-gray-700 text-sm font-bold mb-2">Trainer</label>
                    <input type="text" id="editProgramTrainer" name="program_trainor" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500">
                </div>
                <!-- Edit Program Competencies Section -->
                <div class="border-t pt-4 mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-3">Program Competencies</label>
                    <p class="text-xs text-gray-600 mb-4">Define the competencies for this program following TESDA standards</p>
                    
                    <!-- Hidden input to store JSON data -->
                    <input type="hidden" id="editProgramCompetenciesData" name="program_competencies">
                    
                    <!-- Competency Type Tabs -->
                    <div class="mb-4 flex border-b">
                        <button type="button" onclick="switchEditCompetencyTab('basic')" id="editBasicTab" class="competency-tab px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600">
                            Basic Competencies
                        </button>
                        <button type="button" onclick="switchEditCompetencyTab('common')" id="editCommonTab" class="competency-tab px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                            Common Competencies
                        </button>
                        <button type="button" onclick="switchEditCompetencyTab('core')" id="editCoreTab" class="competency-tab px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                            Core Competencies
                        </button>
                    </div>
                    
                    <!-- Basic Competencies Content -->
                    <div id="editBasicCompetencies" class="competency-content">
                        <div class="mb-3 flex justify-between items-center">
                            <p class="text-sm text-gray-600">Foundational skills required for all learners</p>
                            <button type="button" onclick="addEditCompetency('basic')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                <i class="fas fa-plus mr-1"></i>Add Basic
                            </button>
                        </div>
                        <div id="editBasicCompetenciesList" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- Basic competencies will be added here dynamically -->
                        </div>
                    </div>
                    
                    <!-- Common Competencies Content -->
                    <div id="editCommonCompetencies" class="competency-content hidden">
                        <div class="mb-3 flex justify-between items-center">
                            <p class="text-sm text-gray-600">Skills shared across similar programs</p>
                            <button type="button" onclick="addEditCompetency('common')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                <i class="fas fa-plus mr-1"></i>Add Common
                            </button>
                        </div>
                        <div id="editCommonCompetenciesList" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- Common competencies will be added here dynamically -->
                        </div>
                    </div>
                    
                    <!-- Core Competencies Content -->
                    <div id="editCoreCompetencies" class="competency-content hidden">
                        <div class="mb-3 flex justify-between items-center">
                            <p class="text-sm text-gray-600">Program-specific technical skills</p>
                            <button type="button" onclick="addEditCompetency('core')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                <i class="fas fa-plus mr-1"></i>Add Core
                            </button>
                        </div>
                        <div id="editCoreCompetenciesList" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- Core competencies will be added here dynamically -->
                        </div>
                    </div>
                </div>
                <!-- Career Opportunities Section -->
                <div class="border-t pt-4 mt-4">
                    <label class="block text-gray-700 text-sm font-bold mb-3">Career/Job Opportunities</label>
                    <p class="text-xs text-gray-600 mb-4">List potential job positions that graduates can pursue</p>
                    
                    <div class="mb-3 flex justify-between items-center">
                        <button type="button" onclick="addJobOpportunity(true)" class="bg-purple-500 text-white px-3 py-1 rounded text-sm hover:bg-purple-600">
                            <i class="fas fa-briefcase mr-1"></i>Add Job Opportunity
                        </button>
                    </div>
                    <div id="editJobOpportunitiesList" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Job opportunities will be added here dynamically -->
                    </div>
                </div>
                <div>
                    <label for="editProgramImage" class="block text-gray-700 text-sm font-bold mb-2">Program Image</label>
                    <input type="file" id="editProgramImage" name="program_image" accept="image/*" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Leave empty to keep current image</p>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEditProgramModal()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <i class="fas fa-save mr-2"></i>Update Program
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Program Confirmation Modal -->
    <div id="deleteProgramModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close-btn" onclick="closeDeleteProgramModal()">&times;</button>
            <h3 class="text-2xl font-bold text-red-500 mb-6 text-center">Delete Program</h3>
            <div class="text-center">
                <i class="fas fa-exclamation-triangle text-red-500 text-6xl mb-4"></i>
                <p class="text-lg text-gray-700 mb-2">Are you sure you want to delete this program?</p>
                <p class="text-sm text-gray-500 mb-6">This action cannot be undone.</p>
                <div class="bg-red-50 border border-red-200 rounded p-4 mb-6">
                    <p class="text-red-700 font-semibold">Program to be deleted:</p>
                    <p id="deleteProgramName" class="text-red-600 font-bold text-lg"></p>
                </div>
                <div class="flex justify-center space-x-3">
                    <button type="button" onclick="closeDeleteProgramModal()" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                    <button type="button" id="confirmDeleteProgram" class="bg-red-500 text-white px-6 py-2 rounded-md hover:bg-red-600 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                        <i class="fas fa-trash mr-2"></i>Delete Program
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Creation/Edit Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close-btn" onclick="closeEventModal()">&times;</button>
            <h3 id="eventModalTitle" class="text-2xl font-bold text-blue-500 mb-6 text-center">Create New Event</h3>
            
            <form id="eventForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Event Title</label>
                    <input type="text" id="eventTitle" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select id="eventCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="toggleEnrollmentFields()" required>
                        <option value="">Select Category</option>
                        <option value="enrollment">Enrollment</option>
                        <option value="departmental">Departmental</option>
                    </select>
                </div>

                <div id="enrollmentFields" class="hidden space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-500 mt-1 mr-2"></i>
                            <p class="text-sm text-blue-700">
                                Batch and Trimester are automatically assigned based on the current Batch Cycle. These values cannot be changed manually.
                            </p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Batch (Auto-assigned)</label>
                            <input type="text" id="eventBatch" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed" readonly disabled>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Trimester (Auto-assigned)</label>
                            <input type="text" id="eventTrimester" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed" readonly disabled>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                        <input type="date" id="eventStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                        <input type="date" id="eventEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>

                <!-- Time fields only for departmental events -->
                <div id="timeFields" class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Time</label>
                        <input type="time" id="eventStartTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">End Time</label>
                        <input type="time" id="eventEndTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="eventDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Event description..."></textarea>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeEventModal()" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-save mr-2"></i>Save Event
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Account Details Modal -->
    <div id="viewAccountModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close-btn" onclick="closeViewAccountModal()">&times;</button>
            <h3 class="text-2xl font-bold text-blue-500 mb-6 text-center">Account Details</h3>
            
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="viewAccountUsername" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white" readonly>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <div class="flex items-center space-x-2">
                        <input type="password" id="viewAccountPassword" class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-white" readonly>
                        <button type="button" onclick="togglePasswordVisibility()" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-md transition-colors">
                            <i id="passwordToggleIcon" class="fas fa-eye"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">This is the actual password for this account</p>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Account Type</label>
                    <div id="viewAccountType" class="px-3 py-2 border border-gray-300 rounded-md bg-white"></div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="text" id="viewAccountEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white" readonly>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date Joined</label>
                    <input type="text" id="viewAccountDateJoined" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white" readonly>
                </div>
            </div>
            
            <div class="flex justify-end mt-6">
                <button type="button" onclick="closeViewAccountModal()" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close-btn" onclick="closeChangePasswordModal()">&times;</button>
            <h3 class="text-2xl font-bold text-yellow-500 mb-6 text-center">Change Password</h3>
            
            <form id="changePasswordForm" class="space-y-4">
                <input type="hidden" id="changePasswordUserId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="changePasswordUsername" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">New Password <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input type="password" id="newPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required minlength="4" placeholder="Enter new password">
                        <button type="button" onclick="toggleNewPasswordVisibility()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <i id="newPasswordToggleIcon" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input type="password" id="confirmPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required minlength="4" placeholder="Confirm new password">
                        <button type="button" onclick="toggleConfirmPasswordVisibility()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            <i id="confirmPasswordToggleIcon" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div id="passwordMatchError" class="text-red-500 text-sm hidden">
                    <i class="fas fa-exclamation-circle"></i> Passwords do not match!
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeChangePasswordModal()" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="bg-yellow-500 text-white px-6 py-2 rounded-md hover:bg-yellow-600 transition-colors">
                        <i class="fas fa-key mr-2"></i>Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Remove Account Confirmation Modal -->
    <div id="removeAccountModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close-btn" onclick="closeRemoveAccountModal()">&times;</button>
            <h3 class="text-2xl font-bold text-red-500 mb-6 text-center">Remove Account</h3>
            <div class="text-center">
                <i class="fas fa-exclamation-triangle text-red-500 text-6xl mb-4"></i>
                <p class="text-lg text-gray-700 mb-2">Are you sure you want to remove this account?</p>
                <p class="text-sm text-gray-500 mb-6">This action cannot be undone and will permanently delete the account from the database.</p>
                <div class="bg-red-50 border border-red-200 rounded p-4 mb-6">
                    <p class="text-red-700 font-semibold">Account to be removed:</p>
                    <p id="removeAccountUsername" class="text-red-600 font-bold text-lg"></p>
                    <p id="removeAccountType" class="text-sm text-gray-600 mt-1"></p>
                </div>
                <input type="hidden" id="removeAccountUserId">
                <div class="flex justify-center space-x-3">
                    <button type="button" onclick="closeRemoveAccountModal()" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                    <button type="button" onclick="confirmRemoveAccount()" class="bg-red-500 text-white px-6 py-2 rounded-md hover:bg-red-600 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                        <i class="fas fa-trash mr-2"></i>Remove Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Collapsible Sidebar -->
    <aside id="sidebar" class="sidebar sidebar-gradient text-white flex flex-col p-4 shadow-lg rounded-r-lg">
        
        <div class="flex items-center mb-8 sidebar-header">
            <div class="flex items-center flex-1">
                <img src="{% static 'Images/icon.png' %}" alt="Logo" class="mr-3 rounded-full w-10 h-10 shadow-lg">
                <h1 class="text-xl font-bold sidebar-logo-text text-white drop-shadow-sm">DLL - LMSTC</h1>
            </div>
            <!-- Enhanced Arrow Toggle Button -->
            <button id="sidebarToggleBtn" class="text-white focus:outline-none" title="Toggle Sidebar">
                <i id="sidebarToggleIcon" class="fas fa-arrow-left"></i>
            </button>
        </div>
        
        <nav class="flex-1">
            <ul>
                <li class="mb-4">
                    <a href="#" class="nav-link flex items-center p-2 rounded-lg bg-blue-700" data-page="Dashboard" data-content-type="dashboard">
                        <i class="fas fa-tachometer-alt mr-3"></i>
                        <span class="sidebar-text">Dashboard</span>
                    </a>
                </li>
                <li class="mb-4">
                    <div class="dropdown-toggle flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors cursor-pointer relative">
                        <i class="fas fa-user-graduate mr-3"></i>
                        <span class="sidebar-text">Applicant Profile</span>
                        {% if total_new_applications > 0 %}
                        <span class="absolute left-2 top-2 bg-red-500 rounded-full h-2 w-2 border border-white"></span>
                        {% endif %}
                        <i class="fas fa-chevron-down ml-auto text-xs transition-transform duration-300 transform sidebar-text"></i>
                    </div>
                    <ul class="dropdown-menu ml-6 mt-2 space-y-2">
                        <li>
                            <a href="#" class="nav-link flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors relative" data-page="Applicant List" data-content-type="applicant-list">
                                <i class="fas fa-clipboard-list mr-3"></i>
                                <span class="sidebar-text">Applicant List</span>
                                {% if total_new_applications > 0 %}
                                <span class="ml-2 px-2 py-0.5 bg-red-500 text-white text-xs font-bold rounded-full">NEW</span>
                                {% endif %}
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors" data-page="Approved Applicants" data-content-type="approved-applicants">
                                <i class="fas fa-user-check mr-3"></i>
                                <span class="sidebar-text">Approved Applicants</span>
                            </a>
                        </li>
                    </ul>
                </li>
                <!-- <li class="mb-4">
                    <div class="dropdown-toggle flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors cursor-pointer">
                        <i class="fas fa-briefcase mr-3"></i>
                        <span class="sidebar-text">Job Posting</span>
                        <i class="fas fa-chevron-down ml-auto text-xs transition-transform duration-300 transform sidebar-text"></i>
                    </div>
                    <ul class="dropdown-menu ml-6 mt-2 space-y-2">
                        <li>
                            <a href="#" class="nav-link flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors" data-page="Active Jobs" data-content-type="active-jobs">
                                <i class="fas fa-briefcase mr-3"></i>
                                <span class="sidebar-text">Active Jobs</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors" data-page="Archived Jobs" data-content-type="archived-jobs">
                                <i class="fas fa-archive mr-3"></i>
                                <span class="sidebar-text">Archived Jobs</span>
                            </a>
                        </li>
                    </ul>
                </li> -->
                <li class="mb-4">
                    <a href="#" class="nav-link flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors" data-page="Program Management" data-content-type="program-management">
                        <i class="fas fa-graduation-cap mr-3"></i>
                        <span class="sidebar-text">Program Management</span>
                    </a>
                </li>
                <li class="mb-4">
                    <div class="dropdown-toggle flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors cursor-pointer relative">
                        <i class="fas fa-file-alt mr-3"></i>
                        <span class="sidebar-text">Document Management</span>
                        {% if new_documents_count > 0 or new_tickets_count > 0 %}
                        <span class="absolute left-2 top-2 bg-red-500 rounded-full h-2 w-2 border border-white"></span>
                        {% endif %}
                        <i class="fas fa-chevron-down ml-auto text-xs transition-transform duration-300 transform sidebar-text"></i>
                    </div>
                    <ul class="dropdown-menu ml-6 mt-2 space-y-2">
                        <li>
                            <a href="#" class="nav-link flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors relative" data-page="Document Management" data-content-type="document-management">
                                <i class="fas fa-folder-open mr-3"></i>
                                <span class="sidebar-text">Documents</span>
                                {% if new_documents_count > 0 %}
                                <span class="ml-2 px-2 py-0.5 bg-red-500 text-white text-xs font-bold rounded-full">NEW</span>
                                {% endif %}
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors" data-page="Program" data-content-type="programs">
                                <i class="fas fa-chart-bar mr-3"></i>
                                <span class="sidebar-text">Report</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="nav-link flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors relative" data-page="Ticket" data-content-type="ticket">
                                <i class="fas fa-ticket-alt mr-3"></i>
                                <span class="sidebar-text">Tickets</span>
                                {% if new_tickets_count > 0 %}
                                <span class="ml-2 px-2 py-0.5 bg-red-500 text-white text-xs font-bold rounded-full">NEW</span>
                                {% endif %}
                            </a>
                        </li>
                    </ul>
                </li>
                <li class="mb-4">
                    </a>
                </li>
                <li class="mb-4">
                    <a href="#" class="nav-link flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors" data-page="Trainor" data-content-type="trainor-list">
                        <i class="fas fa-chalkboard-teacher mr-3"></i>
                        <span class="sidebar-text">Trainor Management</span>
                    </a>
                </li>
                

                <li class="mb-4">
                    <a href="#" class="nav-link flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors" data-page="Enrollments" data-content-type="clone">
                        <i class="fas fa-clone mr-3"></i>
                        <span class="sidebar-text">Enrollment Management</span>
                    </a>
                </li>
                

                <!-- <li class="mb-4">
                    <div class="flex items-center p-2 rounded-lg bg-blue-800 bg-opacity-30">
                        <i class="fas fa-inbox mr-3 text-blue-300"></i>
                        <span class="sidebar-text text-blue-300 italic text-sm">This is Empty</span>
                    </div>
                </li> -->
            </ul>
        </nav>
        <div class="mt-auto">
            <a href="{% url 'logout_view' %}" class="flex items-center p-2 rounded-lg hover:bg-blue-600 transition-colors">
                <i class="fas fa-sign-out-alt mr-3"></i>
                <span class="sidebar-text">Sign Out</span>
            </a>
        </div>
    </aside>
    <!-- Main Content -->
    <main id="mainContent" class="flex-1 p-8 overflow-y-auto main-content">
        <header class="flex items-center justify-between mb-6">
            <h2 class="text-3xl font-bold text-blue-700">Admin Control Panel</h2>
            <div class="flex items-center space-x-4">
                <!-- ✅ FIXED NOTIFICATION BELL -->
                <div class="relative">
                    <button id="bell-btn" class="relative focus:outline-none p-2 rounded-full hover:bg-blue-100 transition-colors">
                        <img src="{% static 'Images/bell.png' %}" alt="Bell" class="w-6 h-6" />
                        {% if total_new_applications > 0 or new_tickets_count > 0 or new_documents_count > 0 %}
                        <span class="absolute top-0 right-0 bg-red-500 rounded-full h-2.5 w-2.5 border-2 border-white z-10"></span>
                        {% endif %}
                        <span id="notification-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold z-20">0</span>
                    </button>
                    <div id="notification-box" class="hidden absolute right-0 top-full mt-2 w-80 bg-white text-black rounded-lg shadow-lg z-50 border border-gray-200">
                        <div class="p-4 border-b font-bold text-blue-600 flex justify-between items-center">
                            <span>Notifications</span>
                            <button id="mark-all-read" class="text-sm text-gray-500 hover:text-blue-600 transition-colors">Mark all read</button>
                        </div>
                        <div id="notifications-list" class="max-h-64 overflow-y-auto">
                            <div class="p-4 text-center text-gray-500">Loading notifications...</div>
                        </div>
                    </div>
                </div>
                <div class="text-gray-600">Welcome Back</div>
                <div class="text-xl font-bold text-yellow-400">{{ Dashboard_username }}</div>
                {% if user_profile_picture %}
                    <img src="{{ user_profile_picture }}" class="w-12 h-12 rounded-full bg-white/30 object-cover" alt="User Profile" onerror="this.src='{% static 'Images/user.png' %}'" />
                {% else %}
                    <img src="{% static 'Images/user.png' %}" class="w-12 h-12 rounded-full bg-white/30" alt="User" />
                {% endif %}
            </div>
        </header>

        <h2 class="text-3xl font-bold text-gray-800 mb-2" id="mainContentTitle">Dashboard</h2>
        
        <!-- Batch Cycle Indicator -->
        <div class="mb-6">
            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-blue-100 text-blue-800">
                <i class="fas fa-layer-group mr-2"></i>
                Current Batch Cycle: Batch {{ batch_cycle.current_batch }}
            </span>
            <span class="ml-2 text-sm text-gray-600">(Statistics shown are for the current batch cycle)</span>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent">
            <!-- Statistics Filter -->
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-2 md:mb-0">Statistics Filter</h3>
                <form method="get" class="flex items-center space-x-2">
                    <label for="dashboardBatchFilter" class="text-sm text-gray-600">Batch:</label>
                    <select id="dashboardBatchFilter" name="batch" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="this.form.submit()">
                        <option value="1" {% if dashboard_selected_batch == '1' %}selected{% endif %}>Batch 1</option>
                        <option value="2" {% if dashboard_selected_batch == '2' %}selected{% endif %}>Batch 2</option>
                        <option value="3" {% if dashboard_selected_batch == '3' %}selected{% endif %}>Batch 3</option>
                    </select>

                    <label for="dashboardYearFilter" class="text-sm text-gray-600">Year:</label>
                    <select id="dashboardYearFilter" name="year" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="this.form.submit()">
                        <option value="" {% if not dashboard_selected_year %}selected{% endif %}>All Years</option>
                        {% for y in years_range %}
                            <option value="{{ y }}" {% if dashboard_selected_year == y %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </form>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors" onclick="openApplicantStatsModal()">
                    <div>
                        <p class="text-sm text-gray-600">No. of Applicant</p>
                        <p id="statTotalApplicants" data-base="{{ counted_applicants }}" class="text-2xl font-bold text-gray-800">{{ counted_applicants }}</p>
                    </div>
                    <i class="fas fa-user-plus text-blue-500 text-3xl"></i>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors" onclick="openApprovedStatsModal()">
                    <div>
                        <p class="text-sm text-gray-600">No. of Approved Applicant</p>
                        <p id="statTotalApproved" data-base="{{ counted_approved }}" class="text-2xl font-bold text-gray-800">{{ counted_approved }}</p>
                    </div>
                    <i class="fas fa-user-check text-green-500 text-3xl"></i>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">No. of Drop Out</p>
                        <p id="statTotalDropped" data-base="{{ counted_dropped }}" class="text-2xl font-bold text-gray-800">{{ counted_dropped }}</p>
                    </div>
                    <i class="fas fa-user-times text-red-500 text-3xl"></i>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 flex items-center justify-between cursor-pointer hover:bg-gray-50 transition-colors" onclick="openProgramStatsModal()">
                    <div>
                        <p class="text-sm text-gray-600">No. of Programs</p>
                        <p class="text-2xl font-bold text-gray-800">{{counted_programs}}</p>
                    </div>
                    <i class="fas fa-book-open text-purple-500 text-3xl"></i>
                </div>
            </div>

            <!--sample debug-->

            <!-- Applicant Statistics Modal -->
            {% include 'modals/applicant_stats_modal.html' %}

            <!-- Approved Applicant Statistics Modal -->
            {% include 'modals/approved_stats_modal.html' %}

            <!-- Program Statistics Modal -->
            {% include 'modals/program_stats_modal.html' %}

            <!----------------------->

            <!-- Walk-in Application Section -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Walk-in Applications</h3>
                    <button id="newWalkinBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <i class="fas fa-plus mr-2"></i>New Walk-in
                    </button>
                </div>
                
                <!-- Walk-in Stats Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-blue-600 font-medium">Walk-in Applicants</p>
                                <p class="text-2xl font-bold text-blue-800">{{ counted_walkin_total }}</p>
                            </div>
                            <i class="fas fa-walking text-blue-500 text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-green-600 font-medium">Walk-in Approved</p>
                                <p class="text-2xl font-bold text-green-800">{{ counted_walkin_approved }}</p>
                            </div>
                            <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-50 to-yellow-100 p-4 rounded-lg border border-yellow-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-yellow-600 font-medium">Pending Walk-ins</p>
                                <p class="text-2xl font-bold text-yellow-800">{{ counted_walkin_pending }}</p>
                            </div>
                            <i class="fas fa-clock text-yellow-500 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Walk-in Queue Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="py-3 px-4 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Queue #</th>
                                <th class="py-3 px-4 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Name</th>
                                <th class="py-3 px-4 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Program Interest</th>
                                <th class="py-3 px-4 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Time Arrived</th>
                                <th class="py-3 px-4 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                                <th class="py-3 px-4 bg-gray-50 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% if walkin_applicants %}
                                {% for app in walkin_applicants %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="py-3 px-4 text-sm text-gray-900">{{ app.queue_number|default:forloop.counter }}</td>
                                        <td class="py-3 px-4 text-sm font-medium text-gray-900">
                                            {% if app.profile %}
                                                {{ app.profile.first_name }} {{ app.profile.middle_name }} {{ app.profile.last_name }}
                                            {% else %}
                                                {% if app.applicant %}
                                                    {{ app.applicant.first_name }} {{ app.applicant.last_name }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            {% endif %}
                                            {% if app.applicant %}<br><small class="text-gray-500">Username: {{ app.applicant.username }}</small>{% endif %}
                                        </td>
                                            <td class="py-3 px-4 text-sm text-gray-600">{{ app.program.program_name }}</td>
                                            <td class="py-3 px-4 text-sm text-gray-600">{{ app.applied_at|date:"M d, Y H:i" }}</td>
                                            <td class="py-3 px-4">
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                                                    {% if app.status == 'Approved' %}bg-green-100 text-green-800
                                                    {% else %}
                                                        {% if app.status == 'Pending' %}bg-yellow-100 text-yellow-800
                                                        {% else %}bg-red-100 text-red-800{% endif %}
                                                    {% endif %}">
                                                    {{ app.status }}
                                                </span>
                                            </td>
                                            <td class="py-3 px-4 text-sm">
                                                <button onclick="viewWalkinApplicantDetails('{{ app.applicant.username }}', '{{ app.applicant.get_full_name|default:app.applicant.username }}', '{{ app.status }}', '{{ app.queue_number|default:forloop.counter }}')" 
                                                        class="text-blue-600 hover:text-blue-800 mr-2">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                            </td>
                                        </tr>
                                {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center py-8 text-gray-500">
                                            <i class="fas fa-users text-4xl mb-2 text-gray-300"></i>
                                            <p class="text-lg">No walk-in applicants today</p>
                                            <p class="text-sm">Walk-in applicants will appear here when they arrive</p>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-500">
                                        <i class="fas fa-users text-4xl mb-2 text-gray-300"></i>
                                        <p class="text-lg">No walk-in applicants today</p>
                                        <p class="text-sm">Walk-in applicants will appear here when they arrive</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-center font-semibold text-gray-700 mb-3 text-sm">Program Enrollment Distribution</h3>
                    <div class="flex justify-center">
                        <canvas id="doughnutChart" width="400" height="300" class="max-w-full"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md flex flex-col justify-center items-center">
                    <h3 class="font-semibold text-gray-700 mb-3 text-sm">Monthly Application Trends</h3>
                    <div class="flex justify-center w-full">
                        <canvas id="barChart" width="400" height="300" class="max-w-full"></canvas>
                    </div>
                </div>
            </div>

            <!-- Summary Table -->
            <div class="container-card">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Summary Count of Applicants and Approved Applicants</h3>
                {% if Programss %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tl-md">Program Name</th>
                                <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Number of Application</th>
                                <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tr-md">Number of Approved Applicants</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for prog in combined_programs %}
                                <tr class="odd:bg-gray-100 program-summary-row" data-program="{{ prog.program_name }}">
                                    <td class="py-2 px-4 whitespace-nowrap">{{ prog.program_name }}</td>
                                    <td class="py-2 px-4 whitespace-nowrap">{{ prog.applied_count }}</td>
                                    <td class="py-2 px-4 whitespace-nowrap">{{ prog.approved_count }}</td>
                                </tr>

                            {% empty %}
                                <tr><td colspan="3" class="text-center">No programs found</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <h2>No programs available</h2>
                {% endif %}
            </div>
        </div>

        <!-- Clone Content -->
        <div id="cloneContent" class="hidden">

            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Enrollment Management</h3>
                <button onclick="showNewEventModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-plus mr-2"></i>Create Event
                </button>
            </div>

            <!-- Event Categories -->
            <div class="mb-6">
                <div class="flex space-x-4">
                    <button id="allCategoryBtn" onclick="selectCategory('all')" 
                            class="px-4 py-2 rounded-lg bg-blue-600 text-white font-medium transition-colors">
                        <i class="fas fa-list mr-2"></i>All Events
                    </button>
                    <button id="enrollmentCategoryBtn" onclick="selectCategory('enrollment')" 
                            class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                        <i class="fas fa-graduation-cap mr-2"></i>Enrollment
                    </button>
                    <button id="departmentalCategoryBtn" onclick="selectCategory('departmental')" 
                            class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors">
                        <i class="fas fa-building mr-2"></i>Departmental
                    </button>
                </div>
            </div>

            <!-- Batch Cycle Status Display -->
            <div id="batchCycleStatus" class="mb-6">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg shadow-md border-2 border-blue-200">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-sync-alt mr-3 text-blue-600"></i>
                            Current Batch Cycle Status
                        </h4>
                        <button onclick="checkBatchCycleStatus()" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-lg transition-colors">
                            <i class="fas fa-refresh mr-1"></i>Refresh
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-600 mb-1">Active Batch</div>
                            <div id="currentBatchDisplay" class="text-2xl font-bold text-blue-600">Loading...</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-600 mb-1">Cycle State</div>
                            <div id="cycleStateDisplay" class="text-lg font-semibold text-gray-800">Loading...</div>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-blue-100 border-l-4 border-blue-600 text-sm text-gray-700">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Note:</strong> When an enrollment event ends, the corresponding batch will be automatically activated. Batch buttons are disabled during active batch cycles.
                    </div>
                </div>
            </div>

            <!-- Program Batch & Semester Monitoring Table -->
            <div id="enrollmentControls" class="mb-6">
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <div class="flex justify-between items-center mb-6">
                        <h4 class="text-xl font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-clipboard-list mr-3 text-blue-600"></i>
                            Program Batch & Semester Monitoring
                        </h4>
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                <i class="fas fa-layer-group mr-1"></i>Current Batch: {{ current_batch }}
                            </span>
                            <button onclick="refreshMonitoring()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-sync-alt mr-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-4">
                        <i class="fas fa-info-circle mr-1"></i>
                        Monitor each program's current batch and semester status. Trainers can end semesters from their dashboard.
                    </p>
                    
                    <!-- Monitoring Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gradient-to-r from-blue-50 to-indigo-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                        <i class="fas fa-graduation-cap mr-2"></i>Program Name
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                        <i class="fas fa-layer-group mr-2"></i>Batch
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                        <i class="fas fa-calendar-alt mr-2"></i>Semester
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                        <i class="fas fa-flag mr-2"></i>Remarks
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% if program_monitoring %}
                                    {% for program in program_monitoring %}
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                                    <i class="fas fa-book text-white"></i>
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-semibold text-gray-900">{{ program.program_name }}</div>
                                                    <div class="text-xs text-gray-500">
                                                        <i class="fas fa-user-tie mr-1"></i>{{ program.trainer_name }}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800">
                                                <i class="fas fa-layer-group mr-1"></i>Batch {{ program.batch }}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex space-x-1">
                                                <div class="h-8 w-8 rounded-lg flex items-center justify-center text-xs font-bold {% if program.semester >= '1' %}bg-gradient-to-br from-green-400 to-green-600 text-white{% else %}bg-gray-200 text-gray-400{% endif %}">
                                                    1
                                                </div>
                                                <div class="h-8 w-8 rounded-lg flex items-center justify-center text-xs font-bold {% if program.semester >= '2' %}bg-gradient-to-br from-yellow-400 to-orange-500 text-white{% else %}bg-gray-200 text-gray-400{% endif %}">
                                                    2
                                                </div>
                                                <div class="h-8 w-8 rounded-lg flex items-center justify-center text-xs font-bold {% if program.semester >= '3' %}bg-gradient-to-br from-red-400 to-pink-600 text-white{% else %}bg-gray-200 text-gray-400{% endif %}">
                                                    3
                                                </div>
                                            </div>
                                            <div class="text-xs text-gray-600 mt-1">
                                                <i class="fas fa-calendar-check mr-1"></i>{{ program.semester_display }}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            {% if program.remark == 'Ongoing' %}
                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                                    <i class="fas fa-spinner fa-pulse mr-1"></i>{{ program.remark }}
                                                </span>
                                            {% else %}
                                                {% if 'Complete' in program.remark %}
                                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
                                                        <i class="fas fa-check-circle mr-1"></i>{{ program.remark }}
                                                    </span>
                                                {% else %}
                                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600">
                                                        <i class="fas fa-info-circle mr-1"></i>{{ program.remark }}
                                                    </span>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                                            <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                                            <p class="text-sm">No programs found</p>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Legend -->
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-xs font-semibold text-gray-700 mb-2">Legend:</p>
                        <div class="flex flex-wrap gap-3 text-xs">
                            <div class="flex items-center">
                                <span class="inline-block w-4 h-4 bg-green-500 rounded mr-1"></span>
                                <span class="text-gray-600">1st Semester</span>
                            </div>
                            <div class="flex items-center">
                                <span class="inline-block w-4 h-4 bg-yellow-500 rounded mr-1"></span>
                                <span class="text-gray-600">2nd Semester</span>
                            </div>
                            <div class="flex items-center">
                                <span class="inline-block w-4 h-4 bg-red-500 rounded mr-1"></span>
                                <span class="text-gray-600">3rd Semester</span>
                            </div>
                            <div class="flex items-center ml-4">
                                <span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-800 rounded text-xs mr-1">Ongoing</span>
                                <span class="text-gray-600">Semester in progress</span>
                            </div>
                            <div class="flex items-center">
                                <span class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs mr-1">Complete</span>
                                <span class="text-gray-600">Semester ended by trainor</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- End Batch Button - Only visible when all programs are complete -->
                    {% if can_end_batch %}
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <div class="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-400 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="bg-orange-500 p-3 rounded-full">
                                        <i class="fas fa-flag-checkered text-white text-2xl"></i>
                                    </div>
                                    <div>
                                        <h5 class="text-lg font-bold text-gray-800 flex items-center">
                                            <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                            All Programs Complete
                                        </h5>
                                        <p class="text-sm text-gray-700 mt-1">
                                            All trainors have completed their semesters. You can now end the current batch and progress to the next batch cycle.
                                        </p>
                                    </div>
                                </div>
                                <button onclick="handleAdminEndBatch()" 
                                        class="px-8 py-4 bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold rounded-lg shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:scale-105 hover:from-orange-600 hover:to-red-700">
                                    <i class="fas fa-flag-checkered mr-2"></i>End Batch
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Calendar and Events Layout -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8 mb-8">
                <!-- Calendar Section - Takes 2/3 width on xl screens -->
                <div class="xl:col-span-2 bg-white p-8 rounded-xl shadow-lg border border-gray-100">
                    <div class="flex items-center justify-between mb-6">
                        <h4 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-calendar-alt mr-3 text-blue-600"></i>Event Calendar
                        </h4>
                        <div class="text-sm text-gray-500">
                            <span id="currentMonthYear"></span>
                        </div>
                    </div>
                    <div id="enrollmentCalendar" class="calendar-container">
                        <!-- Calendar will be generated by JavaScript -->
                    </div>
                </div>

                <!-- Event Management Panel - Takes 1/3 width on xl screens -->
                <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-100">
                    <h4 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-cog mr-3 text-green-600"></i>Event Management
                    </h4>
                    
                    <!-- Quick Actions -->
                    <div class="space-y-3 mb-6">
                        <button onclick="showNewEventModal()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200 transform hover:scale-105 shadow-md">
                            <i class="fas fa-plus mr-2"></i>Create Event
                        </button>
                        <button onclick="editSelectedEvent()" class="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200 transform hover:scale-105 shadow-md">
                            <i class="fas fa-edit mr-2"></i>Edit Event
                        </button>
                        <button onclick="archiveSelectedEvent()" class="w-full bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200 transform hover:scale-105 shadow-md">
                            <i class="fas fa-archive mr-2"></i>Archive Event
                        </button>
                        <button onclick="removeSelectedEvent()" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200 transform hover:scale-105 shadow-md">
                            <i class="fas fa-trash mr-2"></i>Remove Event
                        </button>
                    </div>

                    <!-- Selected Event Info -->
                    <div id="selectedEventInfo" class="bg-gradient-to-br from-gray-50 to-gray-100 p-6 rounded-xl border border-gray-200 shadow-inner">
                        <div class="text-center">
                            <i class="fas fa-calendar-check text-3xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 text-sm font-medium">Select an event from the calendar or table to manage it</p>
                            <p class="text-gray-500 text-xs mt-2">Click on any event to view details and actions</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Events Table -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-8 py-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h4 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-list-alt mr-3 text-purple-600"></i>Events List
                        </h4>
                        <div class="flex items-center space-x-4">
                            <div class="text-sm text-gray-600">
                                <span id="eventCount">0</span> events found
                            </div>
                            <button onclick="removeSelectedEvent()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-trash mr-2"></i>Delete Selected
                            </button>
                            <button onclick="refreshEventsList()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Table Container with better spacing -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gradient-to-r from-gray-100 to-gray-200">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="selectAllEvents" onchange="toggleAllEvents()" 
                                            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                        <span class="ml-2">Select</span>
                                    </div>
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-tag mr-2"></i>Event Title
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-folder mr-2"></i>Category
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-calendar-day mr-2"></i>Start Date
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-calendar-check mr-2"></i>End Date
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-layer-group mr-2"></i>Batch/Trimester
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-info-circle mr-2"></i>Status
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                                    <i class="fas fa-cogs mr-2"></i>Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="eventsTableBody" class="bg-white divide-y divide-gray-100">
                            <!-- Events will be populated by JavaScript -->
                            <tr id="noEventsRow" class="hidden">
                                <td colspan="8" class="px-6 py-12 text-center">
                                    <div class="flex flex-col items-center justify-center">
                                        <i class="fas fa-calendar-times text-4xl text-gray-300 mb-4"></i>
                                        <h3 class="text-lg font-medium text-gray-500 mb-2">No Events Found</h3>
                                        <p class="text-gray-400 text-sm mb-4">Create your first event to get started</p>
                                        <button onclick="showNewEventModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                                            <i class="fas fa-plus mr-2"></i>Create Event
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Program Management Content -->
        <div id="programManagementContent" class="container-card hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                <h3 class="text-xl font-bold text-gray-800">Program Management</h3>
                <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                    <!-- Search Filter -->
                    <div class="filter-control">
                        <label for="programSearchFilter" class="block text-sm font-medium text-gray-700 mb-1">Search Programs:</label>
                        <input type="text" id="programSearchFilter" placeholder="Search by program name..." class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <!-- Items Per Page -->
                    <div class="items-per-page">
                        <label for="programItemsPerPage" class="block text-sm font-medium text-gray-700 mb-1">Show entries:</label>
                        <select id="programItemsPerPage" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <!-- Add Program Button -->
                    <div class="flex items-end">
                        <button id="addProgramBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                            <i class="fas fa-plus mr-2"></i>Add Program
                        </button>
                    </div>
                </div>
            </div>

            <!-- Program Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tl-md">Program Name</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Schedule</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Trainer</th>
                            <!-- <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Skills</th> -->
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tr-md">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="programTableBody" class="bg-white divide-y divide-gray-200">
                        {% if Programss %}
                            {% for program in Programss %}
                            <tr class="hover:bg-gray-50 transition-colors duration-200">
                                <td class="py-4 px-4 text-sm font-medium text-gray-900">
                                    <div class="flex items-center">
                                        <i class="fas fa-graduation-cap text-blue-500 mr-2"></i>
                                        {{ program.program_name }}
                                    </div>
                                </td>

                                <td class="py-4 px-4 text-sm text-gray-700">
                                    <div class="flex items-center">
                                        <i class="fas fa-clock text-green-500 mr-2"></i>
                                        {{ program.program_sched|default:"Schedule TBD" }}
                                    </div>
                                </td>
                                <td class="py-4 px-4 text-sm text-gray-700">
                                    <div class="flex items-center">
                                        <i class="fas fa-user-tie text-purple-500 mr-2"></i>
                                        {{ program.program_trainor|default:"No trainer assigned" }}
                                    </div>
                                </td>
                                <!-- <td class="py-4 px-4 text-sm text-gray-700">
                                    <div class="flex items-center">
                                        <i class="fas fa-tools text-orange-500 mr-2"></i>
                                        {{ program.program_skill|default:"Skills not specified" }}
                                    </div>
                                </td> -->
                                <td class="py-4 px-4 text-sm text-gray-500">
                                    <div class="flex items-center space-x-2">
                                        <button class="view-program-btn text-blue-600 hover:text-blue-900 transition-colors duration-200" 
                                                title="View Details"
                                                data-program-id="{{ program.id }}"
                                                data-program-name="{{ program.program_name }}"
                                                data-program-description="{{ program.program_detail|default:'No description available' }}"
                                                data-program-schedule="{{ program.program_sched|default:'Schedule TBD' }}"
                                                data-program-trainer="{{ program.program_trainor|default:'No trainer assigned' }}"
                                                data-program-skills="{{ program.program_skill|default:'Skills not specified' }}"
                                                data-program-image="{% if program.program_image %}{{ program.program_image.url }}{% endif %}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="edit-program-btn text-green-600 hover:text-green-900 transition-colors duration-200" 
                                                title="Edit Program"
                                                data-program-id="{{ program.id }}"
                                                data-program-name="{{ program.program_name }}"
                                                data-program-description="{{ program.program_detail|default:'' }}"
                                                data-program-schedule="{{ program.program_sched|default:'' }}"
                                                data-program-trainer="{{ program.program_trainor|default:'' }}"
                                                data-program-competencies='{{ program.program_competencies|default:None|tojson }}'>
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="delete-program-btn text-red-600 hover:text-red-900 transition-colors duration-200" 
                                                title="Delete Program"
                                                data-program-id="{{ program.id }}"
                                                data-program-name="{{ program.program_name }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr id="programNoDataRow">
                                <td colspan="8" class="text-center py-8 text-gray-500">
                                    <i class="fas fa-graduation-cap text-4xl mb-2 text-gray-300"></i>
                                    <p class="text-lg">No programs available</p>
                                    <p class="text-sm">Click "Add Program" to create your first program</p>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="pagination-controls">
                <div class="pagination-info" id="programPaginationInfo">
                    {% if Programss %}
                        Showing {{ Programss|length }} program{{ Programss|length|pluralize }} total
                    {% else %}
                        Showing 0 programs
                    {% endif %}
                </div>
                <div class="pagination-nav" id="programPaginationNav">
                    <button onclick="changeProgramPage('prev')" id="programPrevBtn" disabled>Previous</button>
                    <div id="programPageNumbers"></div>
                    <button onclick="changeProgramPage('next')" id="programNextBtn" disabled>Next</button>
                </div>
            </div>
        </div>

        <!-- Report Content -->
        <div id="programsContent" class="container-card hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                <h3 class="text-xl font-bold text-gray-800">Reports</h3>
                <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                    <!-- Year Filter -->
                    <div class="filter-control">
                        <label for="reportYearFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Year:</label>
                        <select id="reportYearFilter" onchange="filterReportsByYear()" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Years</option>
                            <option value="2025" selected>2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                        </select>
                    </div>
                    <div class="filter-control">
                        <label for="reportBatchFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Batch:</label>
                        <select id="reportBatchFilter" onchange="handleReportBatchFilterChange()" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="1" {% if dashboard_selected_batch == '1' %}selected{% endif %}>Batch 1</option>
                            <option value="2" {% if dashboard_selected_batch == '2' %}selected{% endif %}>Batch 2</option>
                            <option value="3" {% if dashboard_selected_batch == '3' %}selected{% endif %}>Batch 3</option>
                        </select>
                    </div>
                    <!-- Program Filter -->
                    <div class="filter-control">
                        <label for="reportProgramFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Program:</label>
                        <select id="reportProgramFilter" onchange="filterReportsByProgram()" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Programs</option>
                            {% for program in Programss %}
                                <option value="{{ program.program_name }}">{{ program.program_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Status Filter -->
                    <div class="filter-control">
                        <label for="reportStatusFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Status:</label>
                        <select id="reportStatusFilter" onchange="filterReportsByStatus()" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Status</option>
                            <option value="approved">Approved (Current)</option>
                            <option value="complete">Complete (Passed)</option>
                            <option value="dropped">Dropped</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="reportCardsContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                {% for prog in Programss %}
                <!-- Program Card -->
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 report-card"
                     data-program="{{ prog.program_name }}"
                     data-year="2025">
                    <div class="flex items-center justify-between mb-3">
                        <p class="text-lg font-semibold text-gray-800">{{ prog.program_name }}</p>
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                            <i class="fas fa-chart-bar mr-1"></i>Report
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">Program Trainor: <span class="font-medium">{{ prog.program_trainor }}</span></p>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="bg-blue-50 p-2 rounded">
                            <p class="text-xs text-gray-600">Approved</p>
                            <p class="text-lg font-semibold text-blue-600">{{ prog.approved_count }}</p>
                        </div>
                        <div class="bg-green-50 p-2 rounded">
                            <p class="text-xs text-gray-600">Completed</p>
                            <p class="text-lg font-semibold text-green-600">{{ prog.passed_count }}</p>
                        </div>
                        <div class="bg-orange-50 p-2 rounded">
                            <p class="text-xs text-gray-600">Dropped</p>
                            <p class="text-lg font-semibold text-orange-600">{{ prog.dropped_count|default:0 }}</p>
                        </div>
                        <div class="bg-red-50 p-2 rounded">
                            <p class="text-xs text-gray-600">Failed</p>
                            <p class="text-lg font-semibold text-red-600">{{ prog.failed_count|default:0 }}</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Year: <span class="font-medium text-blue-600">2025</span></p>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="openProgramModal('{{ prog.id }}', 'approved')" class="status-btn approved-btn bg-blue-500 text-white px-3 py-2 rounded-md hover:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 text-sm">
                            <i class="fas fa-user-check mr-1"></i>View Approved
                        </button>
                        <button onclick="openProgramModal('{{ prog.id }}', 'complete')" class="status-btn complete-btn bg-green-500 text-white px-3 py-2 rounded-md hover:bg-green-600 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 text-sm">
                            <i class="fas fa-graduation-cap mr-1"></i>View Complete
                        </button>
                        <button onclick="openProgramModal('{{ prog.id }}', 'dropped')" class="status-btn dropped-btn bg-orange-500 text-white px-3 py-2 rounded-md hover:bg-orange-600 transition-colors focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-50 text-sm">
                            <i class="fas fa-user-times mr-1"></i>View Dropped
                        </button>
                        <button onclick="openProgramModal('{{ prog.id }}', 'failed')" class="status-btn failed-btn bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 text-sm">
                            <i class="fas fa-times-circle mr-1"></i>View Failed
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <!-- No Results Message -->
            <div id="noReportsMessage" class="text-center py-8 text-gray-500 hidden">
                <i class="fas fa-search text-4xl mb-2 text-gray-300"></i>
                <p class="text-lg">No reports found</p>
                <p class="text-sm">Try adjusting your filters</p>
            </div>
        </div>

        <script>
        // Global filter variables for reports
        let reportCurrentYearFilter = 'all';
        let reportCurrentProgramFilter = 'all';
        let reportCurrentStatusFilter = 'all';

        // Filter reports by year
        function filterReportsByYear() {
            const yearFilter = document.getElementById('reportYearFilter').value;
            reportCurrentYearFilter = yearFilter;
            applyReportFilters();
        }

        // Filter reports by program
        function filterReportsByProgram() {
            const programFilter = document.getElementById('reportProgramFilter').value;
            reportCurrentProgramFilter = programFilter;
            applyReportFilters();
        }

        // Filter reports by status
        function filterReportsByStatus() {
            const statusFilter = document.getElementById('reportStatusFilter').value;
            reportCurrentStatusFilter = statusFilter;
            applyReportFilters();
        }

        function handleReportBatchFilterChange() {
            const batchSelect = document.getElementById('reportBatchFilter');
            if (!batchSelect) return;
            const selectedBatch = batchSelect.value;

            const dashboardBatchSelect = document.getElementById('dashboardBatchFilter');
            if (dashboardBatchSelect && dashboardBatchSelect.form) {
                dashboardBatchSelect.value = selectedBatch;
                dashboardBatchSelect.form.submit();
                return;
            }

            const url = new URL(window.location.href);
            if (selectedBatch) {
                url.searchParams.set('batch', selectedBatch);
            } else {
                url.searchParams.delete('batch');
            }
            window.location.href = url.toString();
        }

        // Apply all filters
        function applyReportFilters() {
            const reportCards = document.querySelectorAll('.report-card');
            const noResultsMessage = document.getElementById('noReportsMessage');
            let visibleCount = 0;

            // First, filter cards by Year and Program only
            reportCards.forEach(card => {
                const cardYear = card.getAttribute('data-year');
                const cardProgram = card.getAttribute('data-program');

                let showCard = true;

                // Apply year filter
                if (reportCurrentYearFilter !== 'all' && cardYear !== reportCurrentYearFilter) {
                    showCard = false;
                }

                // Apply program filter
                if (reportCurrentProgramFilter !== 'all' && cardProgram !== reportCurrentProgramFilter) {
                    showCard = false;
                }

                if (showCard) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });

            // Then, based on Status selection, show/hide buttons inside each visible card
            const status = reportCurrentStatusFilter; // 'all', 'approved', 'complete', 'dropped', 'failed'
            const buttonSelectorMap = {
                approved: '.approved-btn',
                complete: '.complete-btn',
                dropped: '.dropped-btn',
                failed: '.failed-btn'
            };

            // Count and limit to 10 visible cards
            let shownCards = 0;
            reportCards.forEach(card => {
                if (card.style.display !== 'none') {
                    // Control buttons visibility
                    const approvedBtn = card.querySelector('.approved-btn');
                    const completeBtn = card.querySelector('.complete-btn');
                    const droppedBtn = card.querySelector('.dropped-btn');
                    const failedBtn = card.querySelector('.failed-btn');

                    // Default: show all
                    [approvedBtn, completeBtn, droppedBtn, failedBtn].forEach(btn => {
                        if (btn) btn.style.display = '';
                    });

                    if (status !== 'all') {
                        // Hide all except the selected one
                        [approvedBtn, completeBtn, droppedBtn, failedBtn].forEach(btn => {
                            if (btn) btn.style.display = 'none';
                        });
                        const selector = buttonSelectorMap[status];
                        const targetBtn = card.querySelector(selector);
                        if (targetBtn) targetBtn.style.display = '';
                    }

                    // Enforce 10-card limit
                    if (shownCards < 10) {
                        card.classList.remove('hidden-by-limit');
                        shownCards++;
                    } else {
                        card.classList.add('hidden-by-limit');
                    }
                } else {
                    // If card is not visible from filters, ensure it's not counted and hidden by limit flag cleared
                    card.classList.remove('hidden-by-limit');
                }
            });

            // Apply the hidden-by-limit class to actually hide excess cards
            reportCards.forEach(card => {
                if (card.classList.contains('hidden-by-limit')) {
                    card.style.display = 'none';
                } else if (card.style.display !== 'none') {
                    card.style.display = 'block';
                }
            });

            // Count visible after limit
            visibleCount = Array.from(reportCards).filter(c => c.style.display !== 'none').length;

            // Show/hide no results message
            if (visibleCount === 0) {
                noResultsMessage.classList.remove('hidden');
            } else {
                noResultsMessage.classList.add('hidden');
            }
        }


        // Update the openProgramModal function to use selected year
        function openProgramModal(programId) {
            const modal = document.getElementById('programModal');
            const modalTitle = document.getElementById('modalProgramTitle');
            const modalTableBody = document.getElementById('modalTableBody');
            
            // Get program data
            const program = programData[programId];
            
            if (!program) {
                alert('Program data not found');
                return;
            }

            // Get selected year for modal title
            const selectedYear = document.getElementById('reportYearFilter').value;
            const displayYear = selectedYear === 'all' ? '2025' : selectedYear;
            
            // Update modal title with selected year
            modalTitle.textContent = `${program.name} Master List Year ${displayYear}`;
            
            // Clear existing table content
            modalTableBody.innerHTML = '';
            
            // Populate table with student data
            if (program.students && program.students.length > 0) {
                program.students.forEach((student, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                    row.innerHTML = `
                        <td class="border border-gray-300 p-3">${index + 1}</td>
                        <td class="border border-gray-300 p-3">${student.name}</td>
                        <td class="border border-gray-300 p-3">${student.program}</td>
                        <td class="border border-gray-300 p-3">${student.contact}</td>
                        <td class="border border-gray-300 p-3">${student.address}</td>
                        <td class="border border-gray-300 p-3">
                            <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                                ${student.status}
                            </span>
                        </td>
                    `;
                    modalTableBody.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" class="border border-gray-300 p-4 text-center text-gray-500">
                        No approved applicants found for this program in ${displayYear}
                    </td>
                `;
                modalTableBody.appendChild(row);
            }
            
            // Store current program ID and year for other functions
            modal.dataset.currentProgramId = programId;
            modal.dataset.currentYear = displayYear;
            
            // Show modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Update PDF download function to include year
        function downloadProgramPDF() {
            const modal = document.getElementById('programModal');
            const programId = modal.dataset.currentProgramId;
            const currentYear = modal.dataset.currentYear || '2025';
            const program = programData[programId];
            
            if (!program) {
                alert('Program data not found');
                return;
            }
            
            // Create a temporary element for PDF generation
            const tempElement = document.createElement('div');
            tempElement.style.cssText = `
                font-family: Arial, sans-serif;
                padding: 20px;
                background: white;
                color: black;
                width: 800px;
                margin: 0 auto;
            `;
            
            tempElement.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1e40af; padding-bottom: 15px;">
                    <h1 style="color: #1e40af; margin: 0; font-size: 24px;">Lucena Manpower Skill Training Center</h1>
                    <h2 style="color: #374151; margin: 10px 0; font-size: 18px;">Dalubhasaan Ng Lungsod Ng Lucena</h2>
                    <h3 style="color: #374151; margin: 5px 0; font-size: 16px;">${program.name} Master List Year ${currentYear}</h3>
                </div>
                ${document.querySelector('#programModal .overflow-x-auto').innerHTML}
            `;
            
            // Add to body temporarily
            document.body.appendChild(tempElement);
            
            // Generate PDF
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `${program.name.replace(/\s+/g, '_')}_Master_List_${currentYear}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    letterRendering: true
                },
                jsPDF: {
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'landscape'
                }
            };
            
            html2pdf().set(opt).from(tempElement).save().then(() => {
                // Remove temporary element
                document.body.removeChild(tempElement);
            });
        }

        // Initialize report filters when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set default year filter to 2025
            const yearFilter = document.getElementById('reportYearFilter');
            if (yearFilter) {
                yearFilter.value = '2025';
                applyReportFilters();
            }
        });
        </script>

        <!-- Program Modal -->
        <div id="programModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-6xl max-h-[90vh] overflow-y-auto relative mx-4">
                <button onclick="closeProgramModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold z-10">
                    &times;
                </button>
                
                <!-- Header Section -->
                <div class="text-center mb-6 border-b pb-4">
                    <div class="flex items-center justify-center mb-4">
                        <img src="{% static 'Images/icon.png' %}" alt="Logo" class="w-16 h-16 mr-4">
                        <div>
                            <h1 class="text-2xl font-bold text-blue-700">Lucena Manpower Skill Training Center</h1>
                            <h2 class="text-lg text-gray-600">Dalubhasaan Ng Lungsod Ng Lucena</h2>
                        </div>
                    </div>
                    <h3 id="modalProgramTitle" class="text-xl font-bold text-gray-800">Program Master List Year 2025</h3>
                </div>

                <!-- Table Section -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-blue-500 text-white">
                                <th class="border border-gray-300 p-3 text-left font-semibold">No.</th>
                                <th class="border border-gray-300 p-3 text-left font-semibold">Student Name</th>
                                <th class="border border-gray-300 p-3 text-left font-semibold">Program Applied</th>
                                <th class="border border-gray-300 p-3 text-left font-semibold">Contact</th>
                                <th class="border border-gray-300 p-3 text-left font-semibold">Address</th>
                                <th class="border border-gray-300 p-3 text-left font-semibold">Email Address</th>
                                <th class="border border-gray-300 p-3 text-left font-semibold">Sex</th>
                                <th class="border border-gray-300 p-3 text-left font-semibold">Status</th>
                            </tr>
                        </thead>
                        <tbody id="modalTableBody">
                            <!-- Table content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end mt-6 space-x-4 border-t pt-4">
                    <button onclick="printProgramReport()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-print mr-2"></i>Print Report
                    </button>
                    <button onclick="downloadProgramPDF()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-download mr-2"></i>Download PDF
                    </button>
                    <button onclick="closeProgramModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
        <script>
        // Program data - simplified approach
        let programData = {};

        function openProgramModal(programId, statusType = 'approved') {
            const modal = document.getElementById('programModal');
            const modalTitle = document.getElementById('modalProgramTitle');
            const modalTableBody = document.getElementById('modalTableBody');
            
            // Show loading state
                    modalTableBody.innerHTML = '<tr><td colspan="8" class="border border-gray-300 p-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</td></tr>';
            
            // Store current program ID and status type for other functions
            modal.dataset.currentProgramId = programId;
            modal.dataset.statusType = statusType;
            
            // Show modal immediately
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Fetch approved applicants from backend
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`/api/program/${programId}/applicants/?status=${statusType}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update modal title and badge based on status
                    const statusLabelMap = {
                        approved: 'Approved',
                        complete: 'Completed',
                        dropped: 'Dropped',
                        failed: 'Failed'
                    };
                    const statusLabel = statusLabelMap[statusType] || 'Approved';
                    modalTitle.textContent = `${data.program_name} - ${statusLabel} Applicants Master List Year 2025`;
                    
                    // Clear existing table content
                    modalTableBody.innerHTML = '';
                    
                    // Populate table with applicant data
                    if (data.applicants && data.applicants.length > 0) {
                        data.applicants.forEach((applicant, index) => {
                            const row = document.createElement('tr');
                            row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                            // Determine badge classes per status
                            const badgeClassMap = {
                                approved: 'bg-blue-100 text-blue-800',
                                complete: 'bg-green-100 text-green-800',
                                dropped: 'bg-orange-100 text-orange-800',
                                failed: 'bg-red-100 text-red-800'
                            };
                            const badgeClass = badgeClassMap[statusType] || 'bg-blue-100 text-blue-800';
                            row.innerHTML = `
                                <td class="border border-gray-300 p-3">${index + 1}</td>
                                <td class="border border-gray-300 p-3">${applicant.name || 'N/A'}</td>
                                <td class="border border-gray-300 p-3">${applicant.program || data.program_name}</td>
                                <td class="border border-gray-300 p-3">${applicant.contact || 'N/A'}</td>
                                <td class="border border-gray-300 p-3">${applicant.address || 'N/A'}</td>
                                <td class="border border-gray-300 p-3">${applicant.email || 'N/A'}</td>
                                <td class="border border-gray-300 p-3">${applicant.sex || 'N/A'}</td>
                                <td class="border border-gray-300 p-3">
                                    <span class="px-2 py-1 ${badgeClass} rounded-full text-sm font-medium">${applicant.status || statusLabel}</span>
                                </td>
                            `;
                            modalTableBody.appendChild(row);
                        });
                    } else {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="8" class="border border-gray-300 p-4 text-center text-gray-500">
                                No ${statusLabel.toLowerCase()} applicants found for this program
                            </td>
                        `;
                        modalTableBody.appendChild(row);
                    }
                } else {
                    modalTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="border border-gray-300 p-4 text-center text-red-500">
                                <i class="fas fa-exclamation-triangle mr-2"></i>${data.error || 'Error loading data'}
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching applicants:', error);
                modalTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="border border-gray-300 p-4 text-center text-red-500">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Error loading applicants. Please try again.
                        </td>
                    </tr>
                `;
            });
        }

        function closeProgramModal() {
            const modal = document.getElementById('programModal');
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }

        function printProgramReport() {
            const modal = document.getElementById('programModal');
            const headerSection = modal.querySelector('.flex.items-center.justify-center.mb-4');
            const title = document.getElementById('modalProgramTitle');
            const table = modal.querySelector('table');
            
            const printWindow = window.open('', '_blank');
            
            // Get logo source
            const logoImg = headerSection.querySelector('img');
            const logoSrc = logoImg ? logoImg.src : '';
            const orgName = headerSection.querySelector('h1') ? headerSection.querySelector('h1').textContent : 'Lucena Manpower Skill Training Center';
            const orgSubtitle = headerSection.querySelector('h2') ? headerSection.querySelector('h2').textContent : 'Dalubhasaan Ng Lungsod Ng Lucena';
            const reportTitle = title ? title.textContent : 'Program Master List Year 2025';
            
            // Clone table and remove action buttons/no-print elements
            const tableClone = table.cloneNode(true);
            const noPrintElements = tableClone.querySelectorAll('.no-print');
            noPrintElements.forEach(el => el.remove());
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Program Report</title>
                    <style>
                        @page {
                            margin: 1cm;
                            size: A4 landscape;
                        }
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 0;
                            padding: 20px;
                        }
                        .header-section {
                            text-align: center;
                            margin-bottom: 30px;
                            page-break-after: avoid;
                        }
                        .header-section img {
                            width: 60px;
                            height: 60px;
                            margin-bottom: 10px;
                        }
                        .header-section h1 {
                            font-size: 18px;
                            font-weight: bold;
                            color: #1e40af;
                            margin: 5px 0;
                        }
                        .header-section h2 {
                            font-size: 14px;
                            color: #4b5563;
                            margin: 5px 0;
                        }
                        .report-title {
                            font-size: 16px;
                            font-weight: bold;
                            color: #1f2937;
                            margin: 15px 0;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin-top: 20px;
                            font-size: 10px;
                            page-break-inside: auto;
                        }
                        th, td { 
                            border: 1px solid #ddd; 
                            padding: 6px; 
                            text-align: left;
                            word-wrap: break-word;
                        }
                        th { 
                            background-color: #3b82f6; 
                            color: white;
                            font-weight: bold;
                        }
                        tr:nth-child(even) { 
                            background-color: #f9f9f9; 
                        }
                        .no-print { 
                            display: none; 
                        }
                        @media print {
                            .no-print { display: none; }
                            body { margin: 0; padding: 10px; }
                            table { font-size: 9px; }
                            th, td { padding: 4px; }
                            .header-section {
                                margin-bottom: 20px;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header-section">
                        ${logoSrc ? `<img src="${logoSrc}" alt="Logo">` : ''}
                        <h1>${orgName}</h1>
                        <h2>${orgSubtitle}</h2>
                        <div class="report-title">${reportTitle}</div>
                    </div>
                    ${tableClone.outerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function downloadProgramPDF() {
            const modal = document.getElementById('programModal');
            const programId = modal.dataset.currentProgramId;
            const program = programData[programId];
            
            if (!program) {
                alert('Program data not found');
                return;
            }
            
            // Create a temporary element for PDF generation
            const tempElement = document.createElement('div');
            tempElement.style.cssText = `
                font-family: Arial, sans-serif;
                padding: 20px;
                background: white;
                color: black;
                width: 800px;
                margin: 0 auto;
            `;
            
            tempElement.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1e40af; padding-bottom: 15px;">
                    <h1 style="color: #1e40af; margin: 0; font-size: 24px;">Lucena Manpower Skill Training Center</h1>
                    <h2 style="color: #374151; margin: 10px 0; font-size: 18px;">Dalubhasaan Ng Lungsod Ng Lucena</h2>
                    <h3 style="color: #374151; margin: 5px 0; font-size: 16px;">${program.name} Master List Year 2025</h3>
                </div>
                ${document.querySelector('#programModal .overflow-x-auto').innerHTML}
            `;
            
            // Add to body temporarily
            document.body.appendChild(tempElement);
            
            // Generate PDF
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `${program.name.replace(/\s+/g, '_')}_Master_List_2025.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                     scale: 2,
                    useCORS: true,
                    letterRendering: true
                 },
                jsPDF: {
                     unit: 'mm',
                     format: 'a4',
                     orientation: 'landscape'
                 }
            };
            
            html2pdf().set(opt).from(tempElement).save().then(() => {
                // Remove temporary element
                document.body.removeChild(tempElement);
            });
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('programModal');
            if (event.target === modal) {
                closeProgramModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('programModal');
                if (!modal.classList.contains('hidden')) {
                    closeProgramModal();
                }
            }
        });
        </script>

        <!-- Advanced Document Management System -->
        <div id="documentManagementContent" class="container-card hidden">
            <div class="mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Document Management</h3>
                    <button onclick="showDocTab('overview')" id="docTab-overview" class="doc-tab-active whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-tachometer-alt mr-2"></i>Overview
                    </button>
                    <button onclick="showDocTab('bulk')" id="docTab-bulk" class="doc-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-layer-group mr-2"></i>Bulk Operations
                    </button>
                    <button onclick="showDocTab('search')" id="docTab-search" class="doc-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-search mr-2"></i>Document Search
                    </button>
                    <button onclick="showDocTab('applicant-profiles')" id="docTab-applicant-profiles" class="doc-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-users mr-2"></i>Applicant Profiles
                    </button>
                    <button onclick="showDocTab('archived')" id="docTab-archived" class="doc-tab whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-archive mr-2"></i>Archived Documents
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div id="docContent-overview" class="doc-content">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 rounded-lg text-white">
                        <div class="flex items-center">
                            <i class="fas fa-file-alt text-3xl mr-4"></i>
                            <div>
                                <p class="text-blue-100">Total Documents</p>
                                <p class="text-2xl font-bold">{{ total_documents_count|default:0 }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 rounded-lg text-white">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-3xl mr-4"></i>
                            <div>
                                <p class="text-green-100">Approved</p>
                                <p class="text-2xl font-bold">{{ approved_learners_count|default:0 }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 p-6 rounded-lg text-white">
                        <div class="flex items-center">
                            <i class="fas fa-clock text-3xl mr-4"></i>
                            <div>
                                <p class="text-yellow-100">Pending Review</p>
                                <p class="text-2xl font-bold">{{ pending_learners_count|default:0 }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Documents -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h4 class="text-lg font-semibold mb-4">Recent Documents</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Version</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="recentDocumentsTableBody">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                        <i class="fas fa-file-alt text-gray-300 text-4xl mb-2"></i>
                                        <p>No recent documents to display</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Bulk Operations Tab -->
            <div id="docContent-bulk" class="doc-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <h4 class="text-lg font-semibold mb-4">Bulk Document Operations</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="border rounded-lg p-4">
                                <h5 class="font-medium mb-2">Bulk Upload</h5>
                                <p class="text-sm text-gray-600 mb-3">Upload multiple documents at once</p>
                                <button onclick="openBulkUploadModal()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-upload mr-2"></i>Select Files
                                </button>
                            </div>
                            
                            <div class="border rounded-lg p-4">
                                <h5 class="font-medium mb-2">Bulk Download</h5>
                                <p class="text-sm text-gray-600 mb-3">Download selected documents as ZIP</p>
                                <button class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700" onclick="openBulkDownloadModal()">
                                    <i class="fas fa-download mr-2"></i>Download Selected
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="border rounded-lg p-4">
                                <h5 class="font-medium mb-2">Bulk Review</h5>
                                <p class="text-sm text-gray-600 mb-3">Review multiple applications for completeness</p>
                                <button class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700" onclick="openBulkReviewModal()">
                                    <i class="fas fa-search mr-2"></i>Review All
                                </button>
                            </div>
                            
                            <div class="border rounded-lg p-4">
                                <h5 class="font-medium mb-2">Bulk Approval</h5>
                                <p class="text-sm text-gray-600 mb-3">Approve multiple documents</p>
                                <button class="w-full bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700" onclick="openBulkApprovalModal()">
                                    <i class="fas fa-check-double mr-2"></i>Approve Selected
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Document Search Tab -->
            <div id="docContent-search" class="doc-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h4 class="text-lg font-semibold">Document Search</h4>
                    </div>
                    
                    <!-- Search and Filter Controls -->
                    <div class="mb-6 space-y-4">
                        <!-- Top Row: Search Bar and Document Type Filter -->
                        <div class="flex justify-between items-center">
                            <div class="flex space-x-4">
                                <!-- Search Bar -->
                                <div class="flex space-x-2">
                                    <input type="text" id="documentSearchInput" placeholder="Search by applicant name..." 
                                           class="border border-gray-300 rounded-lg px-3 py-2 text-sm w-64">
                                    <button onclick="performDocumentSearch()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                        <i class="fas fa-search mr-2"></i>Search
                                    </button>
                                </div>
                                
                                <!-- Document Type Filter -->
                                <select id="documentTypeFilter" onchange="handleDocumentTypeFilter()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="">All Document Types</option>
                                    <option value="applicant_profile">Applicant Profile</option>
                                    <option value="modules_manuals">Modules and Manuals</option>
                                    <option value="policy_guidelines">Policy and Guidelines</option>
                                </select>
                            </div>
                            
                            <!-- Show Entities Dropdown -->
                            <select id="documentShowEntities" onchange="changeDocumentEntitiesPerPage()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="5">Show 5</option>
                                <option value="10" selected>Show 10</option>
                            </select>
                        </div>
                        
                        <!-- Bottom Row: Additional Filters -->
                        <div class="flex space-x-4">
                            <select id="documentBatchFilter" onchange="performDocumentSearch()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="">All Batches</option>
                                <option value="1">Batch 1</option>
                                <option value="2">Batch 2</option>
                                <option value="3">Batch 3</option>
                            </select>
                            <select id="documentProgramFilter" onchange="performDocumentSearch()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="">All Programs</option>
                                {% for program in programs %}
                                <option value="{{ program.id }}">{{ program.program_name }}</option>
                                {% endfor %}
                            </select>
                            <select id="filterByYear" onchange="performDocumentSearch()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="">All Years</option>
                                {% for year in years_range %}
                                <option value="{{ year }}">{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Tables Section -->
                    <div class="document-tables-container">
                        <!-- Applicant Profile Table -->
                        <div id="applicantProfileTable" class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Applicant Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Program</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Upload Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Batch</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="documentSearchTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Results will be populated by JavaScript -->
                                    <tr>
                                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Policy and Guidelines Table -->
                        <div id="policyGuidelinesTable" class="overflow-x-auto hidden">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Program</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Upload Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Batch</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="policyGuidelinesTableBody" class="bg-white divide-y divide-gray-200">
                                    {% for document in lmstc_documents %}
                                    {% if document.document_type == 'policy_guidelines' and document.status == 'active' %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                                Policy & Guidelines
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900">{{ document.document_name }}</div>
                                            <div class="text-sm text-gray-500">{{ document.description|truncatewords:10 }}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            {% if document.program %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                                    {{ document.program.program_name }}
                                                </span>
                                            {% else %}
                                                <span class="text-sm text-gray-500">General</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {{ document.created_at|date:"M d, Y"|default:"N/A" }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            {% if document.batch %}
                                                <span class="text-sm text-gray-500">{{ document.get_batch_display }}</span>
                                            {% else %}
                                                <span class="text-sm text-gray-500">All batches</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            {% if document.document_file %}
                                            <a href="{{ document.document_file.url }}" target="_blank" 
                                               class="text-blue-600 hover:text-blue-900 mr-3">
                                                <i class="fas fa-eye mr-1"></i>View
                                            </a>
                                            <a href="{{ document.document_file.url }}" download 
                                               class="text-green-600 hover:text-green-900 mr-3">
                                                <i class="fas fa-download mr-1"></i>Download
                                            </a>
                                            {% endif %}
                                            <button onclick="archiveDocument('{{ document.id }}', 'lmstc_document')" 
                                                    class="text-orange-600 hover:text-orange-900">
                                                <i class="fas fa-archive mr-1"></i>Archive
                                            </button>
                                        </td>
                                    </tr>
                                    {% endif %}
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                            No policy documents found.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Modules and Manuals Table -->
                        <div id="modulesManualsTable" class="overflow-x-auto hidden">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Program</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Upload Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Batch</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="modulesManualsTableBody" class="bg-white divide-y divide-gray-200">
                                    {% for document in lmstc_documents %}
                                    {% if document.document_type == 'modules_manuals' and document.status == 'active' %}
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                                                Modules & Manuals
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900">{{ document.document_name }}</div>
                                            <div class="text-sm text-gray-500">{{ document.description|truncatewords:10|default:"No description" }}</div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            {% if document.program %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                                    {{ document.program.program_name }}
                                                </span>
                                            {% else %}
                                                <span class="text-sm text-gray-500">General</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {{ document.uploaded_at|date:"M d, Y"|default:"N/A" }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            {% if document.batch %}
                                                <span class="text-sm text-gray-500">{{ document.get_batch_display }}</span>
                                            {% else %}
                                                <span class="text-sm text-gray-500">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            {% if document.document_file %}
                                            <a href="{{ document.document_file.url }}" target="_blank" 
                                               class="text-blue-600 hover:text-blue-900 mr-3">
                                                <i class="fas fa-eye mr-1"></i>View
                                            </a>
                                            <a href="{{ document.document_file.url }}" download 
                                               class="text-green-600 hover:text-green-900 mr-3">
                                                <i class="fas fa-download mr-1"></i>Download
                                            </a>
                                            {% endif %}
                                            <button onclick="archiveDocument('{{ document.id }}', 'lmstc_document')" 
                                                    class="text-orange-600 hover:text-orange-900">
                                                <i class="fas fa-archive mr-1"></i>Archive
                                            </button>
                                        </td>
                                    </tr>
                                    {% endif %}
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                            No modules/manuals documents found.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="mt-6 flex justify-between items-center">
                        <div class="text-sm text-gray-700">
                            Showing <span id="documentStartRange">1</span> to <span id="documentEndRange">10</span> of <span id="documentTotalCount">0</span> results
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="previousDocumentPage()" id="documentPrevBtn" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                Previous
                            </button>
                            <button onclick="nextDocumentPage()" id="documentNextBtn" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                Next
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Applicant Profiles Tab -->
            <div id="docContent-applicant-profiles" class="doc-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h4 class="text-lg font-semibold">Applicant Profile Information</h4>
                        <div class="flex space-x-4">
                            <!-- Filter Controls -->
                            <div class="flex space-x-2">
                                <select id="batchFilter" onchange="applyApplicantFilters()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="">All Batches</option>
                                    <option value="1">Batch 1</option>
                                    <option value="2">Batch 2</option>
                                    <option value="3">Batch 3</option>
                                    <option value="4">Batch 4</option>
                                    <option value="5">Batch 5</option>
                                </select>
                                <select id="yearFilter" onchange="applyApplicantFilters()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="">All Years</option>
                                    {% for year in years_range %}
                                    <option value="{{ year }}">{{ year }}</option>
                                    {% endfor %}
                                </select>
                                <select id="programFilter" onchange="applyApplicantFilters()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="">All Programs</option>
                                    {% for program in Programss %}
                                    <option value="{{ program.program_name }}">{{ program.program_name }}</option>
                                    {% endfor %}
                                </select>
                                <button onclick="applyApplicantFilters()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                    <i class="fas fa-filter mr-2"></i>Filter
                                </button>
                                <button onclick="clearApplicantFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm">
                                    <i class="fas fa-times mr-2"></i>Clear
                                </button>
                                <!-- Show Entities Dropdown -->
                                <select id="applicantShowEntities" onchange="changeApplicantEntitiesPerPage()" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="5">Show 5</option>
                                    <option value="10" selected>Show 10</option>
                                    <option value="20">Show 20</option>
                                    <option value="50">Show 50</option>
                                    <option value="100">Show 100</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Learner Profiles Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Picture</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Program Completed</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entry Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Batch</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="applicantProfilesTableBody" class="bg-white divide-y divide-gray-200">
                                {% for learner_profile in profile %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex-shrink-0 h-12 w-12">
                                            {% if learner_profile.id_picture %}
                                                <img class="h-12 w-12 rounded-full object-cover border-2 border-gray-200" 
                                                     src="{{ learner_profile.id_picture.url }}" 
                                                     alt="ID Picture"
                                                     onerror="this.src='/static/images/default-avatar.png'">
                                            {% else %}
                                                <img class="h-12 w-12 rounded-full object-cover border-2 border-gray-200" 
                                                     src="/static/images/default-avatar.png" 
                                                     alt="Default Avatar">
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">
                                            {{ learner_profile.first_name }} {{ learner_profile.middle_name|default:"" }} {{ learner_profile.last_name }}
                                        </div>
                                        <div class="text-sm text-gray-500">{{ learner_profile.email }}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        {% for passed_program in learner_profile.user.passed_programs.all %}
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 mr-1 mb-1">
                                                {{ passed_program.program_name }}
                                            </span>
                                        {% empty %}
                                            {% for approved_program in learner_profile.user.approved_programs.all %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 mr-1 mb-1">
                                                    {{ approved_program.program.program_name }} (In Progress)
                                                </span>
                                            {% empty %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                                                    No Program
                                                </span>
                                            {% endfor %}
                                        {% endfor %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        {{ learner_profile.entry_date|date:"Y-m-d"|default:"N/A" }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        {% if learner_profile.user %}
                                            {% for approved in learner_profile.user.approved_programs.all %}
                                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 mr-1 mb-1">
                                                    {% if approved.batch_number %}
                                                        batch {{ approved.batch_number }}{% if approved.enrollment_year %} ({{ approved.enrollment_year }}){% endif %}
                                                    {% else %}
                                                        No batch
                                                    {% endif %}
                                                </span>
                                            {% empty %}
                                                <span class="text-sm text-gray-500">No batch</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-sm text-gray-500">No batch</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onclick="viewLearnerProfile('{{ learner_profile.id }}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                            <i class="fas fa-eye mr-1"></i>View
                                        </button>
                                        <button onclick="window.open('{% url 'download_registration_form' learner_profile.id %}', '_blank')" class="text-green-600 hover:text-green-900">
                                            <i class="fas fa-download mr-1"></i>Download
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                        <i class="fas fa-users text-4xl mb-4"></i>
                                        <p>No learner profiles found</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="flex items-center justify-between mt-6">
                        <div class="text-sm text-gray-700">
                            Showing <span class="font-medium">1</span> to <span class="font-medium">0</span> of <span class="font-medium">0</span> results
                        </div>
                        <div class="flex space-x-2" id="applicantProfilePaginationNav">
                            <button id="applicantProfilePrevBtn" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Previous
                            </button>
                            <button id="applicantProfileNextBtn" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Next
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Archived Documents Tab -->
            <div id="docContent-archived" class="doc-content hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h4 class="text-lg font-semibold">Archived Documents</h4>
                            <p class="text-sm text-gray-500 mt-1">View and restore archived documents</p>
                        </div>
                        <div class="flex space-x-2">
                            <!-- Search Box -->
                            <input type="text" id="archivedSearchInput" placeholder="Search archived documents..." 
                                   class="border border-gray-300 rounded-lg px-4 py-2 text-sm" 
                                   onkeyup="searchArchivedDocuments()">
                            
                            <!-- Filter by Type -->
                            <select id="archivedDocTypeFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm" onchange="loadArchivedDocuments()">
                                <option value="">All Types</option>
                                <option value="lmstc">LMSTC Documents</option>
                                <option value="manual">Manuals</option>
                                <option value="policy">Policies</option>
                            </select>
                            
                            <!-- Bulk Actions -->
                            <button onclick="bulkRestoreDocuments()" id="bulkRestoreBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm" disabled>
                                <i class="fas fa-undo mr-2"></i>Restore Selected
                            </button>
                            <button onclick="bulkDeleteArchivedDocuments()" id="bulkDeleteArchivedBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm" disabled>
                                <i class="fas fa-trash mr-2"></i>Delete Selected
                            </button>
                        </div>
                    </div>

                    <!-- Archived Documents Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left">
                                        <input type="checkbox" id="selectAllArchived" onchange="toggleSelectAllArchived()" class="rounded border-gray-300">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Batch</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Program</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Uploaded By</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Archived At</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="archivedDocumentsTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                        <i class="fas fa-archive text-4xl mb-4"></i>
                                        <p>Loading archived documents...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="flex items-center justify-between mt-6">
                        <div class="text-sm text-gray-700" id="archivedDocumentsInfo">
                            No archived documents
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        // Document Management Tab Functions
        function showDocTab(tabName) {
            // Hide all content
            document.querySelectorAll('.doc-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.doc-tab, .doc-tab-active').forEach(tab => {
                tab.classList.remove('doc-tab-active');
                tab.classList.add('doc-tab');
            });

            // Show selected content
            document.getElementById('docContent-' + tabName).classList.remove('hidden');

            // Add active class to selected tab
            document.getElementById('docTab-' + tabName).classList.remove('doc-tab');
            document.getElementById('docTab-' + tabName).classList.add('doc-tab-active');

            // Initialize document search when search tab is opened
            if (tabName === 'search') {
                setTimeout(() => {
                    initializeDocumentSearch();
                }, 100);
            }
            
            // Load archived documents when archived tab is opened
            if (tabName === 'archived') {
                loadArchivedDocuments();
            }
            
            // Initialize applicant profiles pagination when applicant-profiles tab is opened
            if (tabName === 'applicant-profiles') {
                setTimeout(() => {
                    // Reset filtered rows to trigger getting all rows
                    applicantProfileFilteredRows = [];
                    updateApplicantProfilePagination();
                }, 100);
            }
        }

        // ===== Document Archive/Delete/Restore Functions =====

        // Archive a single document
        function archiveDocument(documentId, documentType) {
            if (!confirm('Are you sure you want to archive this document? It can be restored later.')) {
                return;
            }

            fetch('/archive-document/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `document_id=${documentId}&document_type=${documentType}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('success', data.message);
                    // Refresh Document Search results
                    performDocumentSearch();
                    // Also refresh bulk download data if modal is open
                    if (document.getElementById('bulkDownloadModal') && !document.getElementById('bulkDownloadModal').classList.contains('hidden')) {
                        loadDocumentsData();
                    }
                } else {
                    showNotification('error', data.error || 'Failed to archive document');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('error', 'An error occurred while archiving the document');
            });
        }

        // Delete a single document permanently
        function deleteDocument(documentId, documentType) {
            const modal = document.getElementById('deleteConfirmModal');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            
            modal.classList.remove('hidden');
            
            confirmBtn.onclick = function() {
                modal.classList.add('hidden');
                
                fetch('/delete-document/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `document_id=${documentId}&document_type=${documentType}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('success', data.message);
                        if (!document.getElementById('docContent-archived').classList.contains('hidden')) {
                            loadArchivedDocuments();
                        }
                    } else {
                        showNotification('error', data.error || 'Failed to delete document');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('error', 'An error occurred while deleting the document');
                });
            };
        }

        // Restore an archived document
        function restoreDocument(documentId, documentType) {
            if (!confirm('Are you sure you want to restore this document?')) {
                return;
            }

            fetch('/restore-document/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `document_id=${documentId}&document_type=${documentType}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('success', data.message);
                    loadArchivedDocuments();
                } else {
                    showNotification('error', data.error || 'Failed to restore document');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('error', 'An error occurred while restoring the document');
            });
        }

        // Bulk restore archived documents
        function bulkRestoreDocuments() {
            const checkboxes = document.querySelectorAll('.archived-document-checkbox:checked');
            if (checkboxes.length === 0) {
                showNotification('warning', 'Please select at least one document to restore');
                return;
            }

            if (!confirm(`Are you sure you want to restore ${checkboxes.length} document(s)?`)) {
                return;
            }

            let restoredCount = 0;
            const promises = Array.from(checkboxes).map(cb => {
                const docId = cb.value;
                const docType = cb.getAttribute('data-type') || 'lmstc';
                
                return fetch('/restore-document/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `document_id=${docId}&document_type=${docType}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) restoredCount++;
                });
            });

            Promise.all(promises).then(() => {
                showNotification('success', `Successfully restored ${restoredCount} document(s)`);
                loadArchivedDocuments();
                document.getElementById('selectAllArchived').checked = false;
            });
        }

        // Bulk delete archived documents
        function bulkDeleteArchivedDocuments() {
            const checkboxes = document.querySelectorAll('.archived-document-checkbox:checked');
            if (checkboxes.length === 0) {
                showNotification('warning', 'Please select at least one document to delete');
                return;
            }

            const modal = document.getElementById('deleteBulkConfirmModal');
            const confirmBtn = document.getElementById('confirmBulkDeleteBtn');
            const countSpan = document.getElementById('bulkDeleteCount');
            
            countSpan.textContent = checkboxes.length;
            modal.classList.remove('hidden');
            
            confirmBtn.onclick = function() {
                modal.classList.add('hidden');
                
                const documentIds = Array.from(checkboxes).map(cb => cb.value);
                const documentType = checkboxes[0].getAttribute('data-type') || 'lmstc';
                
                fetch('/bulk-delete-documents/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: `document_ids=${JSON.stringify(documentIds)}&document_type=${documentType}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('success', data.message);
                        loadArchivedDocuments();
                        document.getElementById('selectAllArchived').checked = false;
                    } else {
                        showNotification('error', data.error || 'Failed to delete documents');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('error', 'An error occurred during bulk delete');
                });
            };
        }

        // Load archived documents
        function loadArchivedDocuments() {
            const documentType = document.getElementById('archivedDocTypeFilter').value;
            const searchQuery = document.getElementById('archivedSearchInput').value;
            
            const tableBody = document.getElementById('archivedDocumentsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading archived documents...</p>
                    </td>
                </tr>
            `;

            fetch(`/get-archived-documents/?document_type=${documentType}&search=${searchQuery}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.documents.length > 0) {
                        displayArchivedDocuments(data.documents);
                        document.getElementById('archivedDocumentsInfo').textContent = 
                            `Showing ${data.documents.length} archived document(s)`;
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                    <i class="fas fa-archive text-4xl mb-4"></i>
                                    <p>No archived documents found</p>
                                </td>
                            </tr>
                        `;
                        document.getElementById('archivedDocumentsInfo').textContent = 'No archived documents';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-red-500">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>Error loading archived documents</p>
                            </td>
                        </tr>
                    `;
                });
        }

        // Display archived documents in table
        function displayArchivedDocuments(documents) {
            const tableBody = document.getElementById('archivedDocumentsTableBody');
            
            tableBody.innerHTML = documents.map(doc => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="archived-document-checkbox rounded border-gray-300" 
                               value="${doc.id}" data-type="${doc.document_type}" 
                               onchange="updateArchivedBulkButtons()">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${doc.name}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                            ${doc.type_display}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${doc.batch}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${doc.program}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${doc.uploaded_by}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.archived_at}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="restoreDocument('${doc.id}', '${doc.document_type}')" 
                                class="text-green-600 hover:text-green-900 mr-3">
                            <i class="fas fa-undo mr-1"></i>Restore
                        </button>
                        <button onclick="deleteDocument('${doc.id}', '${doc.document_type}')" 
                                class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash mr-1"></i>Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Search archived documents
        function searchArchivedDocuments() {
            loadArchivedDocuments();
        }

        // Toggle select all archived documents
        function toggleSelectAllArchived() {
            const selectAll = document.getElementById('selectAllArchived');
            const checkboxes = document.querySelectorAll('.archived-document-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateArchivedBulkButtons();
        }

        // Update bulk action buttons for archived documents
        function updateArchivedBulkButtons() {
            const checkboxes = document.querySelectorAll('.archived-document-checkbox:checked');
            const bulkRestoreBtn = document.getElementById('bulkRestoreBtn');
            const bulkDeleteBtn = document.getElementById('bulkDeleteArchivedBtn');
            
            if (checkboxes.length > 0) {
                bulkRestoreBtn.disabled = false;
                bulkDeleteBtn.disabled = false;
                bulkRestoreBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                bulkDeleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                bulkRestoreBtn.disabled = true;
                bulkDeleteBtn.disabled = true;
                bulkRestoreBtn.classList.add('opacity-50', 'cursor-not-allowed');
                bulkDeleteBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // Show notification
        function showNotification(type, message) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' :
                type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
            } text-white`;
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${
                        type === 'success' ? 'check-circle' :
                        type === 'error' ? 'exclamation-circle' :
                        type === 'warning' ? 'exclamation-triangle' : 'info-circle'
                    } mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function closeUploadDocumentModal() {
            document.getElementById('uploadDocumentModal').classList.add('hidden');
            resetUploadForm();
        }

        function selectDocumentType(type) {
            // Reset all selections
            document.querySelectorAll('input[name="document_type"]').forEach(radio => {
                radio.checked = false;
                radio.closest('.border-2').classList.remove('border-blue-500', 'border-green-500', 'border-purple-500');
                radio.closest('.border-2').classList.add('border-gray-200');
            });

            // Select the chosen type
            const selectedRadio = document.getElementById(`type_${type}`);
            selectedRadio.checked = true;
            
            // Update visual selection
            const container = selectedRadio.closest('.border-2');
            container.classList.remove('border-gray-200');
            if (type === 'applicant_profile') {
                container.classList.add('border-blue-500');
            } else if (type === 'manual') {
                container.classList.add('border-green-500');
            } else if (type === 'policy') {
                container.classList.add('border-purple-500');
            }

            // Show form fields
            showDocumentFields(type);
            
            // Enable upload button
            document.getElementById('uploadBtn').disabled = false;
        }

        function showDocumentFields(type) {
            // Hide all specific fields first
            document.getElementById('applicantProfileFields').classList.add('hidden');
            document.getElementById('manualPolicyFields').classList.add('hidden');
            document.getElementById('policySpecificFields').classList.add('hidden');
            
            // Show common form
            document.getElementById('documentDetailsForm').classList.remove('hidden');
            
            // Show type-specific fields
            if (type === 'applicant_profile') {
                document.getElementById('applicantProfileFields').classList.remove('hidden');
            } else if (type === 'manual' || type === 'policy') {
                document.getElementById('manualPolicyFields').classList.remove('hidden');
                
                if (type === 'policy') {
                    document.getElementById('policySpecificFields').classList.remove('hidden');
                }
                
                // Load categories for the selected type
                loadCategories(type);
            }
        }
        function loadCategories(type) {
            // This would typically make an AJAX call to get categories
            // For now, we'll populate with sample data
            const categorySelect = document.querySelector('select[name="category_id"]');
            categorySelect.innerHTML = '<option value="">Select a category...</option>';
            
            if (type === 'manual') {
                categorySelect.innerHTML += `
                    <option value="1">Training Materials</option>
                    <option value="2">Equipment Manuals</option>
                    <option value="3">Safety Procedures</option>
                    <option value="4">Assessment Guides</option>
                `;
            } else if (type === 'policy') {
                categorySelect.innerHTML += `
                    <option value="5">Academic Policies</option>
                    <option value="6">Administrative Policies</option>
                    <option value="7">Safety Policies</option>
                    <option value="8">Student Conduct</option>
                `;
            }
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                // Check file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size must be less than 10MB');
                    input.value = '';
                    return;
                }
                
                // Show file preview
                document.getElementById('fileUploadArea').classList.add('hidden');
                document.getElementById('filePreview').classList.remove('hidden');
                document.getElementById('fileName').textContent = file.name;
            }
        }

        function removeFile() {
            document.getElementById('documentFile').value = '';
            document.getElementById('fileUploadArea').classList.remove('hidden');
            document.getElementById('filePreview').classList.add('hidden');
        }

        function resetUploadForm() {
            document.getElementById('documentUploadForm').reset();
            document.getElementById('documentDetailsForm').classList.add('hidden');
            document.getElementById('applicantProfileFields').classList.add('hidden');
            document.getElementById('manualPolicyFields').classList.add('hidden');
            document.getElementById('policySpecificFields').classList.add('hidden');
            document.getElementById('uploadBtn').disabled = true;
            
            // Reset visual selections
            document.querySelectorAll('.border-2').forEach(container => {
                container.classList.remove('border-blue-500', 'border-green-500', 'border-purple-500');
                container.classList.add('border-gray-200');
            });
            
            removeFile();
        }

        function uploadDocument() {
            const form = document.getElementById('documentUploadForm');
            const formData = new FormData(form);
            
            // Show loading state
            const uploadBtn = document.getElementById('uploadBtn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Uploading...';
            uploadBtn.disabled = true;
            
            // Make AJAX request to upload document
            fetch('/upload-document/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Document uploaded successfully!');
                    closeUploadDocumentModal();
                    // Refresh the document list if needed
                    performDocumentSearch();
                } else {
                    alert('Error uploading document: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error uploading document. Please try again.');
            })
            .finally(() => {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            });
        }

        // Document Search Functions
        let documentCurrentPage = 1;
        let documentTotalResults = 0;
        let documentResultsPerPage = 10;

        // Handle Document Type Filter
        function handleDocumentTypeFilter() {
            const selectedType = document.getElementById('documentTypeFilter').value;
            const applicantTable = document.getElementById('applicantProfileTable');
            const policyTable = document.getElementById('policyGuidelinesTable');
            const modulesTable = document.getElementById('modulesManualsTable');
            
            // Hide all tables first
            applicantTable.classList.add('hidden');
            policyTable.classList.add('hidden');
            if (modulesTable) modulesTable.classList.add('hidden');
            
            if (selectedType === 'applicant_profile') {
                applicantTable.classList.remove('hidden');
            } else if (selectedType === 'policy_guidelines') {
                policyTable.classList.remove('hidden');
            } else if (selectedType === 'modules_manuals') {
                if (modulesTable) modulesTable.classList.remove('hidden');
                // Also show in main search table for JavaScript-generated results
                applicantTable.classList.remove('hidden');
            } else {
                // Show all tables when "All Document Types" is selected
                applicantTable.classList.remove('hidden');
                policyTable.classList.remove('hidden');
                if (modulesTable) modulesTable.classList.remove('hidden');
            }
            
            // Trigger search to filter by document type
            performDocumentSearch();
            
            // Update pagination and counts based on visible table
            updateDocumentCounts();
        }
        
        // Update document counts based on visible tables
        function updateDocumentCounts() {
            const selectedType = document.getElementById('documentTypeFilter').value;
            const applicantTable = document.getElementById('applicantProfileTable');
            const policyTable = document.getElementById('policyGuidelinesTable');
            
            let totalCount = 0;
            
            if (selectedType === 'applicant_profile') {
                const rows = applicantTable.querySelectorAll('tbody tr:not(.hidden)');
                totalCount = rows.length;
            } else if (selectedType === 'policy_guidelines') {
                const rows = policyTable.querySelectorAll('tbody tr:not(.hidden)');
                totalCount = rows.length;
            } else {
                const applicantRows = applicantTable.querySelectorAll('tbody tr:not(.hidden)');
                const policyRows = policyTable.querySelectorAll('tbody tr:not(.hidden)');
                totalCount = applicantRows.length + policyRows.length;
            }
            
            // Update the total count display
            const totalCountElement = document.getElementById('documentTotalCount');
            if (totalCountElement) {
                totalCountElement.textContent = totalCount;
            }
        }

        // Initialize document search on page load
        function initializeDocumentSearch() {
            // Set initial state - show applicant profiles by default
            const documentTypeFilter = document.getElementById('documentTypeFilter');
            if (documentTypeFilter) {
                documentTypeFilter.value = '';
                handleDocumentTypeFilter();
            }
            // Reset pagination and perform initial search
            documentCurrentPage = 1;
            performDocumentSearch();
        }

        // Learner Profile Modal Functions
        function openLearnerProfileModal(profileId) {
            const modal = document.getElementById('learnerProfileModal');
            const content = document.getElementById('learnerProfileContent');
            
            // Show modal
            modal.classList.remove('hidden');
            
            // Show loading state
            content.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">Loading learner profile...</p>
                </div>
            `;
            
            // Simulate loading learner profile data (replace with actual AJAX call)
            setTimeout(() => {
                // This should be replaced with actual data fetching
                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-900 mb-3">Personal Information</h4>
                            <div class="space-y-2">
                                <p><span class="font-medium">Profile ID:</span> ${profileId}</p>
                                <p><span class="font-medium">Name:</span> Loading...</p>
                                <p><span class="font-medium">Email:</span> Loading...</p>
                                <p><span class="font-medium">Phone:</span> Loading...</p>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-900 mb-3">Program Information</h4>
                            <div class="space-y-2">
                                <p><span class="font-medium">Program:</span> Loading...</p>
                                <p><span class="font-medium">Batch:</span> Loading...</p>
                                <p><span class="font-medium">Entry Date:</span> Loading...</p>
                                <p><span class="font-medium">Status:</span> Loading...</p>
                            </div>
                        </div>
                    </div>
                `;
            }, 1000);
        }

        function closeLearnerProfileModal() {
            document.getElementById('learnerProfileModal').classList.add('hidden');
        }

        // Alias functions for different button calls
        function viewLearnerProfileDetail(profileId) {
            openLearnerProfileModal(profileId);
        }

        function viewLearnerProfile(profileId) {
            openLearnerProfileModal(profileId);
        }

        function downloadLearnerProfile(profileId) {
            // Implement download functionality
            console.log('Downloading learner profile:', profileId);
            showNotification('Download started for learner profile ' + profileId, 'success');
        }

        // Learner Profile Modal Functions
        function openLearnerProfileModal(profileId) {
            const modal = document.getElementById('learnerProfileModal');
            const content = document.getElementById('learnerProfileContent');
            
            // Find the learner profile data
            const profile = mockDocuments.find(doc => doc.id == profileId);
            
            if (profile) {
                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Full Name</label>
                                <p class="mt-1 text-sm text-gray-900">${profile.applicantName}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Program</label>
                                <p class="mt-1 text-sm text-gray-900">${profile.program}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Entry Date</label>
                                <p class="mt-1 text-sm text-gray-900">${profile.uploadDate}</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Document Type</label>
                                <p class="mt-1 text-sm text-gray-900">${profile.documentType}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Status</label>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                    Active
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                modal.classList.remove('hidden');
            }
        }

        function closeLearnerProfileModal() {
            document.getElementById('learnerProfileModal').classList.add('hidden');
        }

        function downloadLearnerProfileFromModal() {
            // Implementation for downloading from modal
            console.log('Download learner profile from modal');
        }

        // Alias functions for different button calls
        function viewLearnerProfileDetail(profileId) {
            openLearnerProfileModal(profileId);
        }

        function viewLearnerProfile(profileId) {
            openLearnerProfileModal(profileId);
        }

        function downloadLearnerProfile(profileId) {
            console.log('Download learner profile:', profileId);
        }

        // Learner Profile Modal Functions
        function openLearnerProfileModal(profileId) {
            // Find the learner profile data
            const profile = mockDocuments.find(doc => doc.id == profileId);
            if (!profile) {
                alert('Profile not found');
                return;
            }
            
            // Populate modal content
            const content = document.getElementById('learnerProfileContent');
            content.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Personal Information</h4>
                        <div class="space-y-2">
                            <p><span class="font-medium">Name:</span> ${profile.applicantName}</p>
                            <p><span class="font-medium">Program:</span> ${profile.program}</p>
                            <p><span class="font-medium">Entry Date:</span> ${profile.uploadDate}</p>
                            <p><span class="font-medium">Status:</span> ${profile.status || 'Active'}</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Document Information</h4>
                        <div class="space-y-2">
                            <p><span class="font-medium">Document Type:</span> ${profile.documentType}</p>
                            <p><span class="font-medium">File Size:</span> ${profile.fileSize || 'N/A'}</p>
                            <p><span class="font-medium">Last Modified:</span> ${profile.uploadDate}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Show modal
            document.getElementById('learnerProfileModal').classList.remove('hidden');
        }

        function closeLearnerProfileModal() {
            document.getElementById('learnerProfileModal').classList.add('hidden');
        }

        function viewLearnerProfileDetail(profileId) {
            openLearnerProfileModal(profileId);
        }

        function viewLearnerProfile(profileId) {
            openLearnerProfileModal(profileId);
        }

        function downloadLearnerProfile(profileId) {
            // Implement download functionality
            alert('Download functionality for profile ID: ' + profileId);
        }

        function downloadLearnerProfileFromModal() {
            // Implement download from modal
            alert('Download from modal functionality');
            closeLearnerProfileModal();
        }

        // Real document data from backend (Learner_Profile records + LMSTC_Documents records)
        const mockDocuments = [
            // Include Learner_Profile records
            {% for learner_profile in all_learner_profiles %}
            {
                id: 'LP-{{ learner_profile.id }}',
                documentType: "Applicant Profile",
                applicantName: "{{ learner_profile.first_name|escapejs }} {% if learner_profile.middle_name %}{{ learner_profile.middle_name|escapejs }} {% endif %}{{ learner_profile.last_name|escapejs }}",
                program: "{% if learner_profile.user %}{% for approved in learner_profile.user.approved_programs.all %}{{ approved.program.program_name|escapejs }}{% if not forloop.last %}, {% endif %}{% empty %}N/A{% endfor %}{% else %}N/A{% endif %}",
                programId: {% if learner_profile.user %}{% for approved in learner_profile.user.approved_programs.all %}{{ approved.program.id }}{% empty %}null{% endfor %}{% else %}null{% endif %},
                uploadDate: "{% if learner_profile.entry_date %}{{ learner_profile.entry_date|date:'Y-m-d' }}{% else %}N/A{% endif %}",
                uploadYear: {% if learner_profile.entry_date %}{{ learner_profile.entry_date.year }}{% else %}null{% endif %},
                batch: "{% if learner_profile.user %}{% for approved in learner_profile.user.approved_programs.all %}{% if approved.batch_number %}{{ approved.batch_number }}{% else %}N/A{% endif %}{% empty %}N/A{% endfor %}{% else %}N/A{% endif %}",
                profileId: {{ learner_profile.id }},
                description: "",
                source: 'learner_profile'
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
            {% if all_learner_profiles and lmstc_documents %},{% endif %}
            // Include LMSTC_Documents records (including 2024 imported records)
            {% for doc in lmstc_documents %}
            {% if doc.document_type == 'applicant_profile' %}
            {
                id: 'LMSTC-{{ doc.id }}',
                documentType: "Applicant Profile",
                applicantName: "{% if doc.learner_profile %}{{ doc.learner_profile.first_name|escapejs }} {{ doc.learner_profile.last_name|escapejs }}{% else %}{% if doc.applicant %}{{ doc.applicant.get_full_name|escapejs|default:doc.applicant.username|escapejs }}{% else %}{{ doc.document_name|escapejs }}{% endif %}{% endif %}",
                documentName: "{{ doc.document_name|escapejs }}",
                program: "{% if doc.program %}{{ doc.program.program_name|escapejs }}{% else %}N/A{% endif %}",
                programId: {% if doc.program %}{{ doc.program.id }}{% else %}null{% endif %},
                uploadDate: "{% if doc.uploaded_at %}{{ doc.uploaded_at|date:'Y-m-d' }}{% else %}N/A{% endif %}",
                uploadYear: {% if doc.uploaded_at %}{{ doc.uploaded_at.year }}{% else %}null{% endif %},
                batch: "{% if doc.batch %}{{ doc.batch|slice:'6:' }}{% else %}N/A{% endif %}",
                profileId: {% if doc.learner_profile %}{{ doc.learner_profile.id }}{% else %}null{% endif %},
                documentId: {{ doc.id }},
                document_type_value: 'applicant_profile',
                fileUrl: "{% if doc.document_file %}{{ doc.document_file.url }}{% else %}null{% endif %}",
                description: "{{ doc.description|default_if_none:''|escapejs }}",
                source: 'lmstc_document'
            }{% if not forloop.last %},{% endif %}
            {% elif doc.document_type == 'modules_manuals' %}
            {
                id: 'LMSTC-{{ doc.id }}',
                documentType: "Modules and Manuals",
                applicantName: "{{ doc.document_name|escapejs }}",
                documentName: "{{ doc.document_name|escapejs }}",
                program: "{% if doc.program %}{{ doc.program.program_name|escapejs }}{% else %}N/A{% endif %}",
                programId: {% if doc.program %}{{ doc.program.id }}{% else %}null{% endif %},
                uploadDate: "{% if doc.uploaded_at %}{{ doc.uploaded_at|date:'Y-m-d' }}{% else %}N/A{% endif %}",
                uploadYear: {% if doc.uploaded_at %}{{ doc.uploaded_at.year }}{% else %}null{% endif %},
                batch: "{% if doc.batch %}{{ doc.batch|slice:'6:' }}{% else %}N/A{% endif %}",
                documentId: {{ doc.id }},
                document_type_value: 'modules_manuals',
                fileUrl: "{% if doc.document_file %}{{ doc.document_file.url }}{% else %}null{% endif %}",
                description: "{{ doc.description|default_if_none:''|escapejs }}",
                source: 'lmstc_document'
            }{% if not forloop.last %},{% endif %}
            {% elif doc.document_type == 'policy_guidelines' %}
            {
                id: 'LMSTC-{{ doc.id }}',
                documentType: "Policy and Guidelines",
                applicantName: "{{ doc.document_name|escapejs }}",
                documentName: "{{ doc.document_name|escapejs }}",
                program: "{% if doc.program %}{{ doc.program.program_name|escapejs }}{% else %}N/A{% endif %}",
                programId: {% if doc.program %}{{ doc.program.id }}{% else %}null{% endif %},
                uploadDate: "{% if doc.uploaded_at %}{{ doc.uploaded_at|date:'Y-m-d' }}{% else %}N/A{% endif %}",
                uploadYear: {% if doc.uploaded_at %}{{ doc.uploaded_at.year }}{% else %}null{% endif %},
                batch: "{% if doc.batch %}{{ doc.batch|slice:'6:' }}{% else %}N/A{% endif %}",
                documentId: {{ doc.id }},
                document_type_value: 'policy_guidelines',
                fileUrl: "{% if doc.document_file %}{{ doc.document_file.url }}{% else %}null{% endif %}",
                description: "{{ doc.description|default_if_none:''|escapejs }}",
                source: 'lmstc_document'
            }{% if not forloop.last %},{% endif %}
            {% endif %}
            {% endfor %}
        ];

        // Helper to pull the first matching value from the description text
        function extractFieldFromDescription(description, keys = []) {
            if (!description) return '';
            const parts = description.split(';').map(p => p.trim()).filter(Boolean);
            for (const key of keys) {
                const match = parts.find(p => p.toLowerCase().startsWith(key.toLowerCase()));
                if (match && match.includes(':')) {
                    return match.split(':').slice(1).join(':').trim();
                }
            }
            return '';
        }

        // Normalize 2024.xlsx imported rows so the table shows real names/programs
        function normalizeImported2024Records() {
            mockDocuments.forEach(doc => {
                const isImported2024 = (
                    doc.source === 'lmstc_document' &&
                    (doc.uploadYear === 2024 ||
                     (doc.uploadDate && doc.uploadDate.toString().includes('2024')) ||
                     (doc.applicantName && doc.applicantName.includes('(2024)')))
                );

                if (!isImported2024) return;

                doc.isImported2024 = true;

                // Applicant Name: prefer description field, else clean document name
                const desc = doc.description || '';
                // Try to build from First/Last fields if present in description
                const firstName = extractFieldFromDescription(desc, ['first name', 'firstname', 'given name']);
                const lastName = extractFieldFromDescription(desc, ['last name', 'lastname', 'family name']);
                const nameFromDesc = (firstName || lastName)
                    ? `${firstName} ${lastName}`.trim()
                    : extractFieldFromDescription(desc, ['full name', 'name', 'applicant name']);
                const cleanedDocName = (doc.applicantName || '')
                    .replace(/\(2024\)/gi, '')
                    .replace(/Imported Record\s*\d+/i, '')
                    .replace(/-\s*Profile/gi, '')
                    .trim();
                doc.applicantName = nameFromDesc || cleanedDocName || extractFieldFromDescription(desc, ['applicant profile', 'profile']) || 'Applicant Profile';

                // Program: try description fallback, else keep existing
                const programFromDesc = extractFieldFromDescription(desc, ['program', 'course', 'qualification']);
                if (programFromDesc) {
                    doc.program = programFromDesc;
                } else if (!doc.program || doc.program === 'N/A') {
                    doc.program = 'N/A';
                }

                // Upload date fixed for archive import
                doc.uploadDate = '2024';
                doc.uploadYear = 2024;

                // Batch: map trimester/batch text if present
                const batchText = extractFieldFromDescription(desc, ['trimester', 'batch']);
                if (batchText) {
                    if (/1st/i.test(batchText)) doc.batch = '1';
                    else if (/2nd/i.test(batchText)) doc.batch = '2';
                    else if (/3rd/i.test(batchText)) doc.batch = '3';
                    else doc.batch = batchText;
                } else if (!doc.batch || doc.batch === 'N/A') {
                    doc.batch = '2024';
                }
            });
        }

        normalizeImported2024Records();

        function performDocumentSearch() {
            // Check if mockDocuments exists and has data
            if (!mockDocuments || mockDocuments.length === 0) {
                console.warn('mockDocuments is empty or undefined');
                const tableBody = document.getElementById('documentSearchTableBody');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                No documents available. Please ensure data is loaded.
                            </td>
                        </tr>
                    `;
                }
                updateDocumentPagination(0, 0, 0);
                return;
            }

            const searchInput = document.getElementById('documentSearchInput');
            const batchFilterEl = document.getElementById('documentBatchFilter');
            const programFilterEl = document.getElementById('documentProgramFilter');
            const yearFilterEl = document.getElementById('filterByYear');
            const documentTypeFilterEl = document.getElementById('documentTypeFilter');
            
            const searchQuery = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const batchFilter = batchFilterEl ? batchFilterEl.value : '';
            const programFilter = programFilterEl ? programFilterEl.value : '';
            const yearFilter = yearFilterEl ? yearFilterEl.value : '';
            const documentTypeFilter = documentTypeFilterEl ? documentTypeFilterEl.value : '';

            // Filter documents based on search criteria - only show active documents
            let filteredDocuments = mockDocuments.filter(doc => {
                // Skip archived documents (they should only appear in Archived Documents tab)
                if (doc.status && (doc.status === 'archived' || doc.status === 'Archived')) {
                    return false;
                }
                
                let matchesSearch = true;
                let matchesBatch = true;
                let matchesProgram = true;
                let matchesYear = true;
                let matchesDocumentType = true;

                // Filter by document type
                if (documentTypeFilter) {
                    if (documentTypeFilter === 'applicant_profile') {
                        matchesDocumentType = doc.documentType === 'Applicant Profile' || doc.source === 'learner_profile';
                    } else if (documentTypeFilter === 'modules_manuals') {
                        matchesDocumentType = doc.documentType === 'Modules and Manuals' || 
                                             (doc.source === 'lmstc_document' && doc.document_type_value === 'modules_manuals');
                    } else if (documentTypeFilter === 'policy_guidelines') {
                        matchesDocumentType = doc.documentType === 'Policy and Guidelines' || 
                                             (doc.source === 'lmstc_document' && doc.document_type_value === 'policy_guidelines');
                    }
                }

                // Search by applicant name or document name (first or last name)
                if (searchQuery) {
                    const searchText = (doc.applicantName || doc.document_name || doc.documentName || '').toLowerCase();
                    const nameParts = searchText.split(' ');
                    matchesSearch = nameParts.some(part => part.includes(searchQuery)) || 
                                   searchText.includes(searchQuery) ||
                                   (doc.document_name && doc.document_name.toLowerCase().includes(searchQuery));
                }

                // Filter by batch
                if (batchFilter) {
                    // Handle different batch formats: "1", "2", "3" or "batch_1", "batch_2", etc.
                    const docBatch = String(doc.batch || '').toLowerCase().trim();
                    const filterBatch = String(batchFilter).toLowerCase().trim();
                    
                    // Extract batch number from various formats
                    let docBatchNum = null;
                    if (docBatch === filterBatch) {
                        docBatchNum = filterBatch;
                    } else if (docBatch.startsWith('batch_')) {
                        docBatchNum = docBatch.replace('batch_', '');
                    } else if (docBatch.startsWith('batch ')) {
                        docBatchNum = docBatch.replace('batch ', '');
                    } else if (docBatch.match(/^\d+$/)) {
                        docBatchNum = docBatch;
                    }
                    
                    matchesBatch = docBatchNum === filterBatch || docBatch === filterBatch;
                }

                // Filter by program
                if (programFilter) {
                    matchesProgram = doc.programId && doc.programId.toString() === programFilter;
                }

                // Filter by year
                if (yearFilter) {
                    matchesYear = doc.uploadYear && doc.uploadYear.toString() === yearFilter;
                }

                return matchesSearch && matchesBatch && matchesProgram && matchesYear && matchesDocumentType;
            });

            displayDocumentSearchResults(filteredDocuments);
        }

        function displayDocumentSearchResults(documents) {
            const tableBody = document.getElementById('documentSearchTableBody');
            documentTotalResults = documents.length;

            if (documents.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            <i class="fas fa-search text-4xl mb-4"></i>
                            <p>No documents found matching your criteria</p>
                        </td>
                    </tr>
                `;
                updateDocumentPagination(0, 0, 0);
                return;
            }

            // Calculate pagination
            const startIndex = (documentCurrentPage - 1) * documentResultsPerPage;
            const endIndex = Math.min(startIndex + documentResultsPerPage, documents.length);
            const pageDocuments = documents.slice(startIndex, endIndex);

            // Generate table rows
            let tableHTML = '';
            pageDocuments.forEach(doc => {
                tableHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${doc.documentType}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${doc.applicantName || doc.documentName || doc.document_name || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                ${doc.program}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${doc.uploadDate}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${doc.batch !== 'N/A' ? doc.batch.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : '<span class="text-gray-400">N/A</span>'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            ${doc.isImported2024 ? `
                                <span class="text-gray-400">Info isn't available</span>
                            ` : `
                                ${(doc.fileUrl && doc.fileUrl !== 'null' && doc.fileUrl !== '') ? `
                                    <button onclick="viewDocument('${doc.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                    <a href="${doc.fileUrl}" download class="text-green-600 hover:text-green-900 mr-3">
                                        <i class="fas fa-download mr-1"></i>Download
                                    </a>
                                ` : `
                                    <button onclick="viewDocument('${doc.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                `}
                                ${(doc.source === 'lmstc_document' && (doc.document_type_value === 'modules_manuals' || doc.document_type_value === 'policy_guidelines')) ? `
                                    <button onclick="archiveDocument('${doc.documentId || doc.id.replace('LMSTC-', '')}', 'lmstc_document')" 
                                            class="text-orange-600 hover:text-orange-900">
                                        <i class="fas fa-archive mr-1"></i>Archive
                                    </button>
                                ` : ''}
                            `}
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = tableHTML;
            updateDocumentPagination(startIndex + 1, endIndex, documentTotalResults);
        }

        function updateDocumentPagination(start, end, total) {
            const startEl = document.getElementById('documentStartRange');
            const endEl = document.getElementById('documentEndRange');
            const totalEl = document.getElementById('documentTotalCount');
            
            if (startEl) startEl.textContent = start || 0;
            if (endEl) endEl.textContent = end || 0;
            if (totalEl) totalEl.textContent = total || 0;

            // Update button states
            const prevBtn = document.getElementById('documentPrevBtn');
            const nextBtn = document.getElementById('documentNextBtn');
            
            if (prevBtn) {
                prevBtn.disabled = documentCurrentPage <= 1;
                prevBtn.classList.toggle('opacity-50', documentCurrentPage <= 1);
                prevBtn.classList.toggle('cursor-not-allowed', documentCurrentPage <= 1);
            }
            if (nextBtn) {
                const maxPages = Math.ceil(total / documentResultsPerPage);
                nextBtn.disabled = documentCurrentPage >= maxPages;
                nextBtn.classList.toggle('opacity-50', documentCurrentPage >= maxPages);
                nextBtn.classList.toggle('cursor-not-allowed', documentCurrentPage >= maxPages);
            }
        }

        function previousDocumentPage() {
            if (documentCurrentPage > 1) {
                documentCurrentPage--;
                performDocumentSearch();
            }
        }

        function nextDocumentPage() {
            const maxPages = Math.ceil(documentTotalResults / documentResultsPerPage);
            if (documentCurrentPage < maxPages) {
                documentCurrentPage++;
                performDocumentSearch();
            }
        }
        function changeDocumentEntitiesPerPage() {
            const showEntities = document.getElementById('documentShowEntities');
            documentResultsPerPage = parseInt(showEntities.value);
            documentCurrentPage = 1; // Reset to first page
            performDocumentSearch();
        }

        function applyDocumentFilters() {
            documentCurrentPage = 1; // Reset to first page
            performDocumentSearch();
        }

        function clearDocumentFilters() {
            document.getElementById('documentSearchInput').value = '';
            document.getElementById('documentBatchFilter').value = '';
            document.getElementById('documentProgramFilter').value = '';
            const yearFilter = document.getElementById('filterByYear');
            if (yearFilter) yearFilter.value = '';
            documentCurrentPage = 1;
            performDocumentSearch();
        }

        function viewDocument(documentId) {
            // Find the document by ID
            const document = mockDocuments.find(doc => doc.id === documentId || doc.id === String(documentId));
            if (document) {
                // If it's an LMSTC_Document with a file URL, open it
                if (document.fileUrl && document.fileUrl !== 'null' && document.fileUrl !== '#') {
                    window.open(document.fileUrl, '_blank');
                } 
                // If it's a Learner_Profile, open the profile detail modal
                else if (document.profileId && document.source === 'learner_profile') {
                    viewLearnerProfileDetail(document.profileId);
                }
                // If it's an LMSTC_Document linked to a Learner_Profile, open the profile
                else if (document.profileId && document.source === 'lmstc_document') {
                    viewLearnerProfileDetail(document.profileId);
                }
                else {
                    alert('Document file not available. This record may not have an associated file.');
                }
            } else {
                alert('Document not found.');
            }
        }

        // Add event listeners for document search
        document.addEventListener('DOMContentLoaded', function() {
            // Add enter key support for document search input
            const documentSearchInput = document.getElementById('documentSearchInput');
            if (documentSearchInput) {
                documentSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        documentCurrentPage = 1;
                        performDocumentSearch();
                    }
                });
            }

            // Add change listeners for document filters
            const documentFilters = ['documentBatchFilter', 'documentProgramFilter'];
            documentFilters.forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element) {
                    element.addEventListener('change', function() {
                        documentCurrentPage = 1;
                        performDocumentSearch();
                    });
                }
            });

            // Load initial document search results
            performDocumentSearch();
        });

        // Applicant Profile Functions - Pagination variables
        let applicantProfileCurrentPage = 1;
        let applicantProfileResultsPerPage = 10;
        let applicantProfileFilteredRows = [];

        function applyApplicantFilters() {
            const batchFilter = document.getElementById('batchFilter')?.value || '';
            const yearFilter = document.getElementById('yearFilter')?.value || '';
            const programFilter = document.getElementById('programFilter')?.value || '';
            
            const tableRows = document.querySelectorAll('#applicantProfilesTableBody tr');
            applicantProfileFilteredRows = [];
            
            tableRows.forEach(row => {
                // Skip empty state rows or rows with colspan
                if (row.querySelector('td[colspan]')) {
                    return;
                }
                
                const batchCell = row.querySelector('td:nth-child(5)');
                const entryDateCell = row.querySelector('td:nth-child(4)');
                const programCell = row.querySelector('td:nth-child(3)');
                
                // Skip if essential cells are missing
                if (!batchCell || !entryDateCell || !programCell) {
                    return;
                }
                
                const batchText = batchCell.textContent.trim();
                const entryDate = entryDateCell.textContent.trim();
                
                // Extract batch number from batch cell text (e.g., "batch 1 (2024)" -> "1")
                let batchNumbers = [];
                const batchSpans = batchCell.querySelectorAll('span');
                if (batchSpans.length > 0) {
                    batchSpans.forEach(span => {
                        const spanText = span.textContent.trim().toLowerCase();
                        // Match patterns like "batch 1", "batch 2", etc.
                        const batchMatch = spanText.match(/batch\s+(\d+)/);
                        if (batchMatch) {
                            batchNumbers.push(batchMatch[1]);
                        }
                    });
                } else {
                    // Fallback: try to extract from cell text
                    const batchMatch = batchText.toLowerCase().match(/batch\s+(\d+)/);
                    if (batchMatch) {
                        batchNumbers.push(batchMatch[1]);
                    }
                }
                
                // Extract year from batch cell (from parentheses) or entry date
                let years = [];
                if (batchSpans.length > 0) {
                    batchSpans.forEach(span => {
                        const spanText = span.textContent.trim();
                        // Extract year from parentheses like "(2024)"
                        const yearMatch = spanText.match(/\((\d{4})\)/);
                        if (yearMatch) {
                            years.push(yearMatch[1]);
                        }
                    });
                }
                // Also get year from entry date
                if (entryDate && entryDate !== 'N/A') {
                    const entryYear = entryDate.split('-')[0];
                    if (entryYear && !years.includes(entryYear)) {
                        years.push(entryYear);
                    }
                }
                
                // Get program names - check for spans first, then fallback to cell text
                let programs = [];
                const programSpans = programCell.querySelectorAll('span');
                if (programSpans.length > 0) {
                    programSpans.forEach(span => {
                        let programText = span.textContent.trim();
                        // Remove "(In Progress)" suffix if present
                        programText = programText.replace(/\s*\(In Progress\)\s*/gi, '').trim();
                        if (programText && programText !== 'No Program') {
                            programs.push(programText);
                        }
                    });
                } else {
                    const programText = programCell.textContent.trim();
                    if (programText && programText !== 'No Program') {
                        programs.push(programText);
                    }
                }
                
                let showRow = true;
                
                // Apply batch filter
                if (batchFilter) {
                    if (batchNumbers.length === 0 || !batchNumbers.includes(batchFilter)) {
                        showRow = false;
                    }
                }
                
                // Apply year filter
                if (yearFilter) {
                    if (years.length === 0 || !years.includes(yearFilter)) {
                        showRow = false;
                    }
                }
                
                // Apply program filter
                if (programFilter) {
                    const filterProgramLower = programFilter.toLowerCase();
                    const matchesProgram = programs.some(prog => 
                        prog.toLowerCase().includes(filterProgramLower) || 
                        filterProgramLower.includes(prog.toLowerCase())
                    );
                    if (!matchesProgram) {
                        showRow = false;
                    }
                }
                
                if (showRow) {
                    applicantProfileFilteredRows.push(row);
                }
            });
            
            applicantProfileCurrentPage = 1; // Reset to first page
            updateApplicantProfilePagination();
        }

        function clearApplicantFilters() {
            document.getElementById('batchFilter').value = '';
            document.getElementById('yearFilter').value = '';
            document.getElementById('programFilter').value = '';

            const tableRows = document.querySelectorAll('#applicantProfilesTableBody tr');
            // Filter out empty state rows
            applicantProfileFilteredRows = Array.from(tableRows).filter(row => {
                return !row.querySelector('td[colspan]');
            });

            applicantProfileCurrentPage = 1; // Reset to first page
            updateApplicantProfilePagination();
        }

        function changeApplicantEntitiesPerPage() {
            const showEntities = document.getElementById('applicantShowEntities');
            applicantProfileResultsPerPage = parseInt(showEntities.value);
            applicantProfileCurrentPage = 1; // Reset to first page
            updateApplicantProfilePagination();
        }

        function updateApplicantProfilePagination() {
            // If no filtered rows, get all rows
            if (applicantProfileFilteredRows.length === 0) {
                applicantProfileFilteredRows = Array.from(document.querySelectorAll('#applicantProfilesTableBody tr'));
            }
            
            const totalRows = applicantProfileFilteredRows.length;
            const totalPages = Math.ceil(totalRows / applicantProfileResultsPerPage);
            
            // Hide all rows first
            applicantProfileFilteredRows.forEach(row => {
                row.style.display = 'none';
            });
            
            // Show rows for current page
            const startIndex = (applicantProfileCurrentPage - 1) * applicantProfileResultsPerPage;
            const endIndex = Math.min(startIndex + applicantProfileResultsPerPage, totalRows);
            
            for (let i = startIndex; i < endIndex; i++) {
                if (applicantProfileFilteredRows[i]) {
                    applicantProfileFilteredRows[i].style.display = '';
                }
            }
            
            // Update pagination info
            const actualStart = totalRows > 0 ? startIndex + 1 : 0;
            const actualEnd = Math.min(endIndex, totalRows);
            const paginationInfo = document.querySelector('#docContent-applicant-profiles .flex.items-center.justify-between .text-sm.text-gray-700');
            if (paginationInfo) {
                paginationInfo.innerHTML = `Showing <span class="font-medium">${actualStart}</span> to <span class="font-medium">${actualEnd}</span> of <span class="font-medium">${totalRows}</span> results`;
            }
            
            // Update page number buttons
            updateApplicantProfilePageNumbers(totalPages);
            
            // Update Previous/Next button states directly using IDs
            const prevBtn = document.getElementById('applicantProfilePrevBtn');
            const nextBtn = document.getElementById('applicantProfileNextBtn');
            
            if (prevBtn) {
                prevBtn.disabled = applicantProfileCurrentPage === 1;
                prevBtn.classList.toggle('opacity-50', applicantProfileCurrentPage === 1);
                prevBtn.classList.toggle('cursor-not-allowed', applicantProfileCurrentPage === 1);
            }
            
            if (nextBtn) {
                nextBtn.disabled = applicantProfileCurrentPage >= totalPages;
                nextBtn.classList.toggle('opacity-50', applicantProfileCurrentPage >= totalPages);
                nextBtn.classList.toggle('cursor-not-allowed', applicantProfileCurrentPage >= totalPages);
            }
        }

        function updateApplicantProfilePageNumbers(totalPages) {
            const paginationNav = document.getElementById('applicantProfilePaginationNav');
            if (!paginationNav) return;
            
            // Clear existing page numbers (keep Previous and Next buttons)
            const buttons = paginationNav.querySelectorAll('button');
            buttons.forEach((btn) => {
                // Keep only the Previous and Next buttons (by ID)
                if (btn.id !== 'applicantProfilePrevBtn' && btn.id !== 'applicantProfileNextBtn') {
                    btn.remove();
                }
            });
            
            // Get Previous and Next buttons by ID
            const prevBtn = document.getElementById('applicantProfilePrevBtn');
            const nextBtn = document.getElementById('applicantProfileNextBtn');
            
            // Add page number buttons between Previous and Next
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `px-3 py-2 text-sm font-medium ${i === applicantProfileCurrentPage ? 'text-white bg-blue-600' : 'text-gray-500 bg-white border border-gray-300'} rounded-lg hover:bg-gray-50`;
                pageBtn.textContent = i;
                pageBtn.onclick = () => {
                    applicantProfileCurrentPage = i;
                    updateApplicantProfilePagination();
                };
                if (nextBtn) {
                    paginationNav.insertBefore(pageBtn, nextBtn);
                } else {
                    paginationNav.appendChild(pageBtn);
                }
            }
            
            // Update Previous/Next button onclick handlers
            if (prevBtn) {
                prevBtn.onclick = () => {
                    if (applicantProfileCurrentPage > 1) {
                        applicantProfileCurrentPage--;
                        updateApplicantProfilePagination();
                    }
                };
            }
            
            if (nextBtn) {
                nextBtn.onclick = () => {
                    if (applicantProfileCurrentPage < totalPages) {
                        applicantProfileCurrentPage++;
                        updateApplicantProfilePagination();
                    }
                };
            }
        }

        function updateApplicantPaginationInfo(visibleCount) {
            // Legacy function for compatibility - redirect to new pagination
            updateApplicantProfilePagination();
        }

        function viewApplicantProfile(profileId) {
            // Create modal for viewing applicant profile details
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.id = 'applicantProfileModal';
            
            modal.innerHTML = `
                <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                    <div class="mt-3">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900">Applicant Profile Details</h3>
                            <button onclick="closeApplicantProfileModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="mt-2 px-7 py-3">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div class="text-center">
                                        <img class="mx-auto h-32 w-32 rounded-full object-cover border-4 border-gray-200" 
                                             src="/media/uploads/id_pictures/default-avatar.png" 
                                             alt="Profile Picture"
                                             onerror="this.src='/static/images/default-avatar.png'">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Full Name</label>
                                        <p class="mt-1 text-sm text-gray-900">Juan Dela Cruz</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Email</label>
                                        <p class="mt-1 text-sm text-gray-900">juan.delacruz@email.com</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Contact Number</label>
                                        <p class="mt-1 text-sm text-gray-900">+63 912 345 6789</p>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Program Applied</label>
                                        <p class="mt-1 text-sm text-gray-900">Welding</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Entry Date</label>
                                        <p class="mt-1 text-sm text-gray-900">January 15, 2024</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Batch</label>
                                        <p class="mt-1 text-sm text-gray-900">1st Trimester</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Address</label>
                                        <p class="mt-1 text-sm text-gray-900">123 Main St, Barangay Sample, City, Province</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="items-center px-4 py-3">
                            <div class="flex justify-end space-x-3">
                                <button onclick="downloadApplicantProfile(${profileId})" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-green-600">
                                    <i class="fas fa-download mr-2"></i>Download PDF
                                </button>
                                <button onclick="closeApplicantProfileModal()" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-600">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeApplicantProfileModal();
                }
            });
        }

        function closeApplicantProfileModal() {
            const modal = document.getElementById('applicantProfileModal');
            if (modal) {
                modal.remove();
            }
        }

        function downloadApplicantProfile(profileId) {
            const url = `/download-registration-form/${profileId}/`;
            window.open(url, '_blank');
            showNotification('Generating PDF for Profile ID: ' + profileId, 'success');
            closeApplicantProfileModal();
        }

        // Learner Profile Functions
        function viewLearnerProfile(profileId) {
            // Fetch learner profile data via AJAX
            fetch(`/get_learner_profile/${profileId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showLearnerProfileModal(data.profile);
                    } else {
                        showNotification('Error loading profile: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error loading profile', 'error');
                });
        }

        function showLearnerProfileModal(profile) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
            modal.id = 'learnerProfileModal';
            
            const programsHtml = profile.programs && profile.programs.length > 0 
                ? profile.programs.map(prog => `<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 mr-1 mb-1">${prog}</span>`).join('')
                : '<span class="text-gray-500">No programs completed</span>';
            
            const batchInfoHtml = profile.batch_info && profile.batch_info.length > 0
                ? profile.batch_info.map(batch => {
                    const statusClass = batch.status === 'Completed' ? 'bg-green-50 border-green-200 text-green-800' : 'bg-blue-50 border-blue-200 text-blue-800';
                    const statusIcon = batch.status === 'Completed' ? 'fa-check-circle' : 'fa-clock';
                    return `
                        <div class="mb-2 p-2 ${statusClass} border rounded">
                            <div class="flex items-center justify-between">
                                <div>
                                    <span class="font-medium">${batch.program}</span>
                                    <span class="text-sm ml-2">${batch.batch}</span>
                                </div>
                                <span class="text-xs flex items-center">
                                    <i class="fas ${statusIcon} mr-1"></i>${batch.status}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('')
                : '<span class="text-gray-500">No batch information</span>';
            
            const classificationsHtml = profile.classifications && profile.classifications.length > 0
                ? profile.classifications.map(c => `<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800 mr-1 mb-1">${c}</span>`).join('')
                : '<span class="text-gray-500">None</span>';
            
            const disabilityTypesHtml = profile.disability_types && profile.disability_types.length > 0
                ? profile.disability_types.map(d => `<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800 mr-1 mb-1">${d}</span>`).join('')
                : '<span class="text-gray-500">None</span>';
            
            modal.innerHTML = `
                <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
                    <div class="mt-3">
                        <div class="flex justify-between items-center mb-4 sticky top-0 bg-white pb-2 border-b">
                            <h3 class="text-2xl font-bold text-gray-900">Learner Profile Details</h3>
                            <button onclick="closeLearnerProfileModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="mt-2 px-4 py-3">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <!-- Left Column: Photo and Basic Info -->
                                <div class="space-y-4">
                                    <div class="text-center bg-gray-50 p-4 rounded-lg">
                                        <img class="mx-auto h-40 w-40 rounded-full object-cover border-4 border-gray-200 shadow-md" 
                                             src="${profile.id_picture || '/static/images/default-avatar.png'}" 
                                             alt="Profile Picture"
                                             onerror="this.src='/static/images/default-avatar.png'">
                                        <h4 class="mt-4 text-lg font-semibold text-gray-900">${profile.full_name}</h4>
                                        <p class="text-sm text-gray-600">Username: ${profile.username || 'N/A'}</p>
                                    </div>
                                    
                                    <!-- Personal Information -->
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <h5 class="font-semibold text-blue-900 mb-3 flex items-center">
                                            <i class="fas fa-user mr-2"></i>Personal Information
                                        </h5>
                                        <div class="space-y-2 text-sm">
                                            <div><span class="font-medium text-gray-700">First Name:</span> <span class="text-gray-900">${profile.first_name}</span></div>
                                            <div><span class="font-medium text-gray-700">Middle Name:</span> <span class="text-gray-900">${profile.middle_name}</span></div>
                                            <div><span class="font-medium text-gray-700">Last Name:</span> <span class="text-gray-900">${profile.last_name}</span></div>
                                            <div><span class="font-medium text-gray-700">Sex:</span> <span class="text-gray-900">${profile.sex}</span></div>
                                            <div><span class="font-medium text-gray-700">Civil Status:</span> <span class="text-gray-900">${profile.civil_status}</span></div>
                                            <div><span class="font-medium text-gray-700">Nationality:</span> <span class="text-gray-900">${profile.nationality}</span></div>
                                            <div><span class="font-medium text-gray-700">Birthdate:</span> <span class="text-gray-900">${profile.birthdate || 'N/A'}</span></div>
                                            <div><span class="font-medium text-gray-700">Age:</span> <span class="text-gray-900">${profile.age}</span></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Birth Information -->
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <h5 class="font-semibold text-green-900 mb-3 flex items-center">
                                            <i class="fas fa-birthday-cake mr-2"></i>Birth Information
                                        </h5>
                                        <div class="space-y-2 text-sm">
                                            <div><span class="font-medium text-gray-700">Birthplace Region:</span> <span class="text-gray-900">${profile.birthplace_region}</span></div>
                                            <div><span class="font-medium text-gray-700">Birthplace Province:</span> <span class="text-gray-900">${profile.birthplace_province}</span></div>
                                            <div><span class="font-medium text-gray-700">Birthplace City:</span> <span class="text-gray-900">${profile.birthplace_city}</span></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Middle Column: Contact and Address -->
                                <div class="space-y-4">
                                    <!-- Contact Information -->
                                    <div class="bg-yellow-50 p-4 rounded-lg">
                                        <h5 class="font-semibold text-yellow-900 mb-3 flex items-center">
                                            <i class="fas fa-phone mr-2"></i>Contact Information
                                        </h5>
                                        <div class="space-y-2 text-sm">
                                            <div><span class="font-medium text-gray-700">Email:</span> <span class="text-gray-900">${profile.email}</span></div>
                                            <div><span class="font-medium text-gray-700">Contact Number:</span> <span class="text-gray-900">${profile.contact_number}</span></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Address Information -->
                                    <div class="bg-indigo-50 p-4 rounded-lg">
                                        <h5 class="font-semibold text-indigo-900 mb-3 flex items-center">
                                            <i class="fas fa-map-marker-alt mr-2"></i>Address Information
                                        </h5>
                                        <div class="space-y-2 text-sm">
                                            <div><span class="font-medium text-gray-700">Street:</span> <span class="text-gray-900">${profile.street}</span></div>
                                            <div><span class="font-medium text-gray-700">Barangay:</span> <span class="text-gray-900">${profile.barangay}</span></div>
                                            <div><span class="font-medium text-gray-700">City:</span> <span class="text-gray-900">${profile.city}</span></div>
                                            <div><span class="font-medium text-gray-700">Province:</span> <span class="text-gray-900">${profile.province}</span></div>
                                            <div><span class="font-medium text-gray-700">Region:</span> <span class="text-gray-900">${profile.region}</span></div>
                                            <div><span class="font-medium text-gray-700">District:</span> <span class="text-gray-900">${profile.district}</span></div>
                                            <div class="mt-2 pt-2 border-t border-indigo-200">
                                                <span class="font-medium text-gray-700">Permanent Address:</span>
                                                <p class="text-gray-900 mt-1">${profile.permanent_address}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Educational & Employment -->
                                    <div class="bg-teal-50 p-4 rounded-lg">
                                        <h5 class="font-semibold text-teal-900 mb-3 flex items-center">
                                            <i class="fas fa-graduation-cap mr-2"></i>Educational & Employment
                                        </h5>
                                        <div class="space-y-2 text-sm">
                                            <div><span class="font-medium text-gray-700">Educational Attainment:</span> <span class="text-gray-900">${profile.educational_attainment}</span></div>
                                            <div><span class="font-medium text-gray-700">Employment Status:</span> <span class="text-gray-900">${profile.employment_status}</span></div>
                                            <div><span class="font-medium text-gray-700">Monthly Income:</span> <span class="text-gray-900">${profile.monthly_income}</span></div>
                                            <div><span class="font-medium text-gray-700">Date Hired:</span> <span class="text-gray-900">${profile.date_hired || 'N/A'}</span></div>
                                            <div><span class="font-medium text-gray-700">Company Name:</span> <span class="text-gray-900">${profile.company_name}</span></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right Column: Programs and Other Info -->
                                <div class="space-y-4">
                                    <!-- Program Information -->
                                    <div class="bg-purple-50 p-4 rounded-lg">
                                        <h5 class="font-semibold text-purple-900 mb-3 flex items-center">
                                            <i class="fas fa-book mr-2"></i>Program Information
                                        </h5>
                                        <div class="space-y-2 text-sm">
                                            <div><span class="font-medium text-gray-700">Entry Date:</span> <span class="text-gray-900">${profile.entry_date || 'N/A'}</span></div>
                                            <div><span class="font-medium text-gray-700">Course/Qualification:</span> <span class="text-gray-900">${profile.course_or_qualification}</span></div>
                                            <div><span class="font-medium text-gray-700">Scholarship Package:</span> <span class="text-gray-900">${profile.scholarship_package}</span></div>
                                            <div class="mt-2">
                                                <span class="font-medium text-gray-700 block mb-1">Programs:</span>
                                                <div class="flex flex-wrap gap-1">${programsHtml}</div>
                                            </div>
                                            <div class="mt-2">
                                                <span class="font-medium text-gray-700 block mb-1">Batch Information:</span>
                                                <div>${batchInfoHtml}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Classification & Disability -->
                                    <div class="bg-pink-50 p-4 rounded-lg">
                                        <h5 class="font-semibold text-pink-900 mb-3 flex items-center">
                                            <i class="fas fa-tags mr-2"></i>Classification & Disability
                                        </h5>
                                        <div class="space-y-2 text-sm">
                                            <div>
                                                <span class="font-medium text-gray-700 block mb-1">Classifications:</span>
                                                <div class="flex flex-wrap gap-1">${classificationsHtml}</div>
                                            </div>
                                            <div class="mt-2">
                                                <span class="font-medium text-gray-700">Other Classification:</span> <span class="text-gray-900">${profile.other_classification}</span>
                                            </div>
                                            <div class="mt-2">
                                                <span class="font-medium text-gray-700 block mb-1">Disability Types:</span>
                                                <div class="flex flex-wrap gap-1">${disabilityTypesHtml}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Additional Information -->
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h5 class="font-semibold text-gray-900 mb-3 flex items-center">
                                            <i class="fas fa-info-circle mr-2"></i>Additional Information
                                        </h5>
                                        <div class="space-y-2 text-sm">
                                            <div><span class="font-medium text-gray-700">Parent/Guardian:</span> <span class="text-gray-900">${profile.parent_guardian}</span></div>
                                            <div><span class="font-medium text-gray-700">Applicant Name (Signature):</span> <span class="text-gray-900">${profile.applicant_name}</span></div>
                                            <div><span class="font-medium text-gray-700">Date Accomplished:</span> <span class="text-gray-900">${profile.date_accomplished || 'N/A'}</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="items-center px-4 py-3 mt-4 border-t sticky bottom-0 bg-white">
                            <div class="flex justify-end space-x-3">
                                <button onclick="window.open('/download-registration-form/${profile.id}/', '_blank')" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-green-600">
                                    <i class="fas fa-download mr-2"></i>Download PDF
                                </button>
                                <button onclick="closeLearnerProfileModal()" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-gray-600">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeLearnerProfileModal();
                }
            });
        }

        function closeLearnerProfileModal() {
            const modal = document.getElementById('learnerProfileModal');
            if (modal) {
                modal.remove();
            }
        }

        // Function for Document Search View button (reuses viewLearnerProfile)
        function viewLearnerProfileDetail(profileId) {
            viewLearnerProfile(profileId);
        }

        function downloadLearnerProfile(profileId) {
            // Create a form and submit it to trigger the download
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/download_learner_profile/${profileId}/`;
            
            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
            
            showNotification('PDF download started for Learner Profile ID: ' + profileId, 'success');
            closeLearnerProfileModal();
        }

        // Utility function to show notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        'fa-info-circle'
                    } mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        </script>

        <style>
        .doc-tab {
            color: #6b7280;
            border-color: transparent;
        }
        
        .doc-tab:hover {
            color: #374151;
            border-color: #d1d5db;
        }
        
        .doc-tab-active {
            color: #2563eb;
            border-color: #3b82f6;
        }
        </style>
        
        <!-- Ticket Management Content -->
        <div id="ticketContent" class="container-card hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <h3 class="text-2xl font-bold text-gray-800">Support Ticket Management</h3>
                <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                    <!-- Status Filter -->
                    <div class="filter-control">
                        <label for="ticketStatusFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Status:</label>
                        <select id="ticketStatusFilter" onchange="filterTicketsByStatus()" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Status</option>
                            <option value="open">Open</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    <!-- Priority Filter -->
                    <div class="filter-control">
                        <label for="ticketPriorityFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Priority:</label>
                        <select id="ticketPriorityFilter" onchange="filterTicketsByPriority()" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Priorities</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <!-- Category Filter -->
                    <div class="filter-control">
                        <label for="ticketCategoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Category:</label>
                        <select id="ticketCategoryFilter" onchange="filterTicketsByCategory()" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Categories</option>
                            <option value="academic">Academic/Training Issues</option>
                            <option value="technical">Technical Issues</option>
                            <option value="administrative">Administrative Issues</option>
                            <option value="complaint">Complaint</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Ticket Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-ticket-alt text-blue-500 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Total Tickets</p>
                            <p class="text-2xl font-semibold text-gray-900" id="totalTicketsCount">{{ total_tickets_count|default:0 }}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 border-l-4 border-yellow-500">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock text-yellow-500 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Open Tickets</p>
                            <p class="text-2xl font-semibold text-gray-900" id="openTicketsCount">{{ open_tickets_count|default:0 }}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Resolved</p>
                            <p class="text-2xl font-semibold text-gray-900" id="resolvedTicketsCount">{{ resolved_tickets_count|default:0 }}</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-4 border-l-4 border-red-500">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">High Priority</p>
                            <p class="text-2xl font-semibold text-gray-900" id="highPriorityTicketsCount">{{ high_priority_tickets_count|default:0 }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Actions Bar -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                    <!-- Search -->
                    <div class="search-control">
                        <label for="ticketSearch" class="block text-sm font-medium text-gray-700 mb-1">Search Tickets:</label>
                        <div class="relative">
                            <input type="text" id="ticketSearch" placeholder="Search by ticket ID, subject, or user..." 
                                   class="w-full md:w-80 px-3 py-2 pl-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                   onkeyup="searchTickets()">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="refreshTickets()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button onclick="exportTickets()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                </div>
            </div>

            <!-- Tickets Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tl-md">Ticket ID</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Subject</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Created By</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Category</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Priority</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Status</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Assigned To</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Created Date</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tr-md">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsTableBody" class="bg-white divide-y divide-gray-200">
                        {% if all_tickets %}
                            {% for ticket in all_tickets %}
                            <tr class="hover:bg-gray-50 ticket-row" data-status="{{ ticket.status }}" data-priority="{{ ticket.priority }}" data-category="{{ ticket.category }}">
                                <td class="py-2 px-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ ticket.ticket_id }}</td>
                                <td class="py-2 px-4 text-sm text-gray-900">{{ ticket.subject|truncatewords:8 }}</td>
                                <td class="py-2 px-4 whitespace-nowrap text-sm text-gray-900">{% if ticket.created_by %}{{ ticket.created_by.get_full_name|default:ticket.created_by.username }}{% else %}Unknown{% endif %}</td>
                                <td class="py-2 px-4 whitespace-nowrap text-sm text-gray-900">{{ ticket.get_category_display }}</td>
                                <td class="py-2 px-4 whitespace-nowrap">
                                    {% if ticket.priority == 'high' %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">High</span>
                                    {% else %}
                                        {% if ticket.priority == 'medium' %}
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Medium</span>
                                        {% else %}
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Low</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="py-2 px-4 whitespace-nowrap">
                                    {% if ticket.status == 'open' %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Open</span>
                                    {% else %}
                                        {% if ticket.status == 'in_progress' %}
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">In Progress</span>
                                        {% else %}
                                            {% if ticket.status == 'resolved' %}
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Resolved</span>
                                            {% else %}
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Closed</span>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="py-2 px-4 whitespace-nowrap text-sm text-gray-900">{% if ticket.assigned_to %}{{ ticket.assigned_to.get_full_name|default:ticket.assigned_to.username }}{% else %}Unassigned{% endif %}</td>
                                <td class="py-2 px-4 whitespace-nowrap text-sm text-gray-900">{{ ticket.created_at|date:"Y-m-d" }}</td>
                                <td class="py-2 px-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="viewTicket('{{ ticket.ticket_id }}')" class="text-blue-600 hover:text-blue-900 mr-2" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="respondToTicket('{{ ticket.ticket_id }}')" class="text-green-600 hover:text-green-900 mr-2" title="Respond">
                                        <i class="fas fa-reply"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="9" class="py-8 px-4 text-center text-gray-500">
                                    <i class="fas fa-ticket-alt text-4xl text-gray-300 mb-3"></i>
                                    <p class="text-lg">No tickets found</p>
                                    <p class="text-sm">Tickets will appear here when users submit support requests</p>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="flex items-center justify-between mt-4">
                <div class="flex items-center text-sm text-gray-700">
                    <span>Showing <span id="ticketStartRange">1</span> to <span id="ticketEndRange">10</span> of <span id="ticketTotalCount">25</span> tickets</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="previousTicketPage()" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                        Previous
                    </button>
                    <span class="px-3 py-2 text-sm font-medium text-gray-700 bg-blue-50 border border-blue-300 rounded-lg">
                        <span id="ticketCurrentPage">1</span>
                    </span>
                    <button onclick="nextTicketPage()" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                        Next
                    </button>
                </div>
            </div>
        </div>
        <!-- Ticket View Modal -->
        <div id="ticketViewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Ticket Details</h3>
                        <button onclick="closeTicketModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div id="ticketModalContent" class="space-y-4">
                        <!-- Ticket details will be loaded here -->
                    </div>
                    
                    <div class="flex justify-end space-x-2 mt-6">
                        <button onclick="closeTicketModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                            Close
                        </button>
                        <button onclick="respondToTicketFromModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-reply mr-2"></i>Respond
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ticket Response Modal -->
        <div id="ticketResponseModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Respond to Ticket</h3>
                        <button onclick="closeResponseModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="ticketResponseForm">
                        <input type="hidden" id="responseTicketId" value="">
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Response</label>
                            <textarea id="ticketResponseMessage" rows="6" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your response..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Update Status</label>
                            <select id="ticketStatusUpdate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Keep current status</option>
                                <option value="in_progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Attachment (Optional)</label>
                            <input type="file" id="ticketResponseAttachment" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" accept=".jpg,.jpeg,.png,.pdf,.doc,.docx">
                        </div>
                        
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="closeResponseModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-paper-plane mr-2"></i>Send Response
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Ticket Assignment Modal -->
        <div id="ticketAssignmentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Assign Ticket</h3>
                        <button onclick="closeAssignmentModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="ticketAssignmentForm">
                        <input type="hidden" id="assignmentTicketId" value="">
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Assign to</label>
                            <select id="ticketAssignee" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Select assignee...</option>
                                <option value="admin">Admin Support</option>
                                <option value="trainer1">Trainer A</option>
                                <option value="trainer2">Trainer B</option>
                                <option value="trainer3">Trainer C</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                            <select id="ticketPriorityUpdate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Keep current priority</option>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        
                        <div class="flex justify-end space-x-2">
                            <button type="button" onclick="closeAssignmentModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                <i class="fas fa-user-plus mr-2"></i>Assign Ticket
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script>
        // Ticket Management Functions
        let currentTicketPage = 1;
        let ticketsPerPage = 10;
        let currentTicketFilters = {
            status: 'all',
            priority: 'all',
            category: 'all',
            search: ''
        };

        // Initialize ticket management
        function initializeTicketManagement() {
            updateTicketStatistics();
            loadTickets();
        }

        // Update ticket statistics using the tickets currently rendered in the table
        function updateTicketStatistics() {
            const rows = Array.from(document.querySelectorAll('.ticket-row'));
            const total = rows.length;
            const open = rows.filter(row => row.dataset.status === 'open').length;
            const resolved = rows.filter(row => row.dataset.status === 'resolved').length;
            const highPriority = rows.filter(row => row.dataset.priority === 'high').length;

            document.getElementById('totalTicketsCount').textContent = total;
            document.getElementById('openTicketsCount').textContent = open;
            document.getElementById('resolvedTicketsCount').textContent = resolved;
            document.getElementById('highPriorityTicketsCount').textContent = highPriority;
        }

        // Load tickets
        function loadTickets() {
            // This would typically fetch tickets from the server
            // For now, we'll use the sample data in the HTML
            updateTicketPagination();
        }

        // Filter tickets by status
        function filterTicketsByStatus() {
            const status = document.getElementById('ticketStatusFilter').value;
            currentTicketFilters.status = status;
            applyTicketFilters();
        }

        // Filter tickets by priority
        function filterTicketsByPriority() {
            const priority = document.getElementById('ticketPriorityFilter').value;
            currentTicketFilters.priority = priority;
            applyTicketFilters();
        }

        // Filter tickets by category
        function filterTicketsByCategory() {
            const category = document.getElementById('ticketCategoryFilter').value;
            currentTicketFilters.category = category;
            applyTicketFilters();
        }

        // Search tickets
        function searchTickets() {
            const searchTerm = document.getElementById('ticketSearch').value.toLowerCase();
            currentTicketFilters.search = searchTerm;
            applyTicketFilters();
        }

        // Apply all ticket filters
        function applyTicketFilters() {
            const rows = document.querySelectorAll('.ticket-row');
            let visibleCount = 0;

            rows.forEach(row => {
                const status = row.dataset.status;
                const priority = row.dataset.priority;
                const category = row.dataset.category;
                const ticketId = row.querySelector('td:first-child').textContent.toLowerCase();
                const subject = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const createdBy = row.querySelector('td:nth-child(3)').textContent.toLowerCase();

                let showRow = true;

                // Status filter
                if (currentTicketFilters.status !== 'all' && status !== currentTicketFilters.status) {
                    showRow = false;
                }

                // Priority filter
                if (currentTicketFilters.priority !== 'all' && priority !== currentTicketFilters.priority) {
                    showRow = false;
                }

                // Category filter
                if (currentTicketFilters.category !== 'all' && category !== currentTicketFilters.category) {
                    showRow = false;
                }

                // Search filter
                if (currentTicketFilters.search && 
                    !ticketId.includes(currentTicketFilters.search) && 
                    !subject.includes(currentTicketFilters.search) && 
                    !createdBy.includes(currentTicketFilters.search)) {
                    showRow = false;
                }

                if (showRow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            updateTicketPagination();
        }

        // Update ticket pagination
        function updateTicketPagination() {
            const visibleRows = document.querySelectorAll('.ticket-row:not([style*="display: none"])');
            const totalTickets = visibleRows.length;
            const totalPages = Math.ceil(totalTickets / ticketsPerPage);
            
            document.getElementById('ticketTotalCount').textContent = totalTickets;
            document.getElementById('ticketCurrentPage').textContent = currentTicketPage;
            
            const startRange = (currentTicketPage - 1) * ticketsPerPage + 1;
            const endRange = Math.min(currentTicketPage * ticketsPerPage, totalTickets);
            
            document.getElementById('ticketStartRange').textContent = startRange;
            document.getElementById('ticketEndRange').textContent = endRange;
        }

        // Pagination functions
        function previousTicketPage() {
            if (currentTicketPage > 1) {
                currentTicketPage--;
                loadTickets();
            }
        }

        function nextTicketPage() {
            const visibleRows = document.querySelectorAll('.ticket-row:not([style*="display: none"])');
            const totalPages = Math.ceil(visibleRows.length / ticketsPerPage);
            
            if (currentTicketPage < totalPages) {
                currentTicketPage++;
                loadTickets();
            }
        }

        // View ticket details
        async function viewTicket(ticketId) {
            try {
                const response = await fetch(`/get-ticket-details/${ticketId}/`);
                const data = await response.json();
                
                if (data.success) {
                    const ticket = data.ticket;
                    
                    // Determine status badge class
                    let statusBadge = '';
                    if (ticket.status === 'Open') {
                        statusBadge = '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Open</span>';
                    } else if (ticket.status === 'In Progress') {
                        statusBadge = '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">In Progress</span>';
                    } else if (ticket.status === 'Resolved') {
                        statusBadge = '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Resolved</span>';
                    } else {
                        statusBadge = '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Closed</span>';
                    }
                    
                    // Determine priority badge class
                    let priorityBadge = '';
                    if (ticket.priority.includes('High')) {
                        priorityBadge = '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">High</span>';
                    } else if (ticket.priority.includes('Medium')) {
                        priorityBadge = '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Medium</span>';
                    } else {
                        priorityBadge = '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Low</span>';
                    }
                    
                    const modalContent = document.getElementById('ticketModalContent');
                    modalContent.innerHTML = `
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Ticket ID</label>
                                    <p class="text-sm text-gray-900">${ticket.ticket_id}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Status</label>
                                    ${statusBadge}
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Subject</label>
                                <p class="text-sm text-gray-900">${ticket.subject}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Description</label>
                                <p class="text-sm text-gray-900">${ticket.description}</p>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Created By</label>
                                    <p class="text-sm text-gray-900">${ticket.created_by || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Created Date</label>
                                    <p class="text-sm text-gray-900">${ticket.created_at}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Category</label>
                                    <p class="text-sm text-gray-900">${ticket.category}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Priority</label>
                                    ${priorityBadge}
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Recipient</label>
                                    <p class="text-sm text-gray-900">${ticket.recipient || 'N/A'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Attachment</label>
                                    ${ticket.attachment ? `<a href="${ticket.attachment}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm"><i class="fas fa-paperclip mr-1"></i>View Attachment</a>` : '<p class="text-sm text-gray-500">No attachment</p>'}
                                </div>
                            </div>
                            ${ticket.responses && ticket.responses.length > 0 ? `
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Responses</label>
                                    <div class="space-y-3">
                                        ${ticket.responses.map(r => `
                                            <div class="bg-gray-50 p-3 rounded-lg">
                                                <div class="flex justify-between items-start mb-1">
                                                    <span class="text-sm font-medium text-gray-900">${r.responder}</span>
                                                    <span class="text-xs text-gray-500">${r.created_at}</span>
                                                </div>
                                                <p class="text-sm text-gray-700">${r.message}</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    // Store ticket ID for response modal
                    document.getElementById('responseTicketId').value = ticketId;
                    document.getElementById('ticketViewModal').classList.remove('hidden');
                } else {
                    showNotification(data.message || 'Failed to load ticket details', 'error');
                }
            } catch (error) {
                console.error('Error fetching ticket:', error);
                showNotification('Error loading ticket details', 'error');
            }
        }

        // Respond to ticket
        function respondToTicket(ticketId) {
            document.getElementById('responseTicketId').value = ticketId;
            document.getElementById('ticketResponseModal').classList.remove('hidden');
        }

        // Assign ticket
        function assignTicket(ticketId) {
            document.getElementById('assignmentTicketId').value = ticketId;
            document.getElementById('ticketAssignmentModal').classList.remove('hidden');
        }

        // Close modals
        function closeTicketModal() {
            document.getElementById('ticketViewModal').classList.add('hidden');
        }

        function closeResponseModal() {
            document.getElementById('ticketResponseModal').classList.add('hidden');
            document.getElementById('ticketResponseForm').reset();
        }

        function closeAssignmentModal() {
            document.getElementById('ticketAssignmentModal').classList.add('hidden');
            document.getElementById('ticketAssignmentForm').reset();
        }

        // Respond to ticket from modal
        function respondToTicketFromModal() {
            closeTicketModal();
            respondToTicket(document.getElementById('responseTicketId').value);
        }

        // Refresh tickets
        function refreshTickets() {
            loadTickets();
            showNotification('Tickets refreshed successfully', 'success');
        }

        // Export tickets
        function exportTickets() {
            showNotification('Exporting tickets...', 'info');
            // This would typically trigger a CSV/Excel export
        }

        // Handle ticket response form submission
        document.getElementById('ticketResponseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const ticketId = document.getElementById('responseTicketId').value;
            const message = document.getElementById('ticketResponseMessage').value;
            const status = document.getElementById('ticketStatusUpdate').value;
            
            if (!message.trim()) {
                showNotification('Please enter a response message', 'error');
                return;
            }
            
            try {
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                const response = await fetch('/update-ticket-status/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        ticket_id: ticketId,
                        response: message,
                        status: status
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Response sent successfully', 'success');
                    closeResponseModal();
                    // Reload page to show updated ticket
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showNotification(data.message || 'Failed to send response', 'error');
                }
            } catch (error) {
                console.error('Error sending response:', error);
                showNotification('Error sending response', 'error');
            }
        });

        // Handle ticket assignment form submission
        document.getElementById('ticketAssignmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const ticketId = document.getElementById('assignmentTicketId').value;
            const assignee = document.getElementById('ticketAssignee').value;
            const priority = document.getElementById('ticketPriorityUpdate').value;
            
            if (!assignee) {
                showNotification('Please select an assignee', 'error');
                return;
            }
            
            // This would typically send the assignment to the server
            showNotification('Ticket assigned successfully', 'success');
            closeAssignmentModal();
        });

        // Initialize ticket management when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeTicketManagement();
        });
        </script>
        
        <!-- Applicant List Content -->
        <div id="applicantListContent" class="container-card hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                <div>
                    <h3 class="text-xl font-bold text-gray-800">Applicant List</h3>
                    {% if batch_cycle %}
                    <p class="text-sm text-gray-600 mt-1">
                        <i class="fas fa-info-circle mr-1"></i>
                        Showing pending applications. When approved, they will be assigned to <strong>Batch {{ batch_cycle.current_batch }}</strong>.
                    </p>
                    {% endif %}
                </div>
                <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                    <!-- Program Filter -->
                    <div class="filter-control">
                        <label for="applicantProgramFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Program:</label>
                        <select id="applicantProgramFilter" onchange="filterApplicantsByProgram()" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Programs</option>
                            {% for program in Programss %}
                                <option value="{{ program.program_name }}">{{ program.program_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Items Per Page -->
                    <div class="items-per-page">
                        <label for="applicantItemsPerPage" class="block text-sm font-medium text-gray-700 mb-1">Show entries:</label>
                        <select id="applicantItemsPerPage" onchange="changeApplicantItemsPerPage()" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tl-md">Applicant Name</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Program Applied</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Batch</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Application Type</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Application Date</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Status</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tr-md">Action</th>
                        </tr>
                    </thead>
                    <tbody id="applicantTableBody" class="bg-white divide-y divide-gray-200">
                        {% if applicants %}
                            {% for application in applicants %}
                            <tr class="hover:bg-gray-50 applicant-row" data-program="{{ application.program.program_name }}" data-application-id="{{ application.id }}" data-profile-id="{% with profile=application.applicant.learner_profile.first %}{% if profile %}{{ profile.pk }}{% endif %}{% endwith %}">
                                <td class="py-2 px-4 whitespace-nowrap">
                                    {% with profile=application.applicant.learner_profile.first %}
                                        {% if profile %}
                                            {{ profile.first_name }} {{ profile.last_name }}
                                        {% else %}
                                            {{ application.applicant.first_name }} {{ application.applicant.last_name }}
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td class="py-2 px-4 whitespace-nowrap">{{ application.program.program_name }}</td>
                                <td class="py-2 px-4 whitespace-nowrap">
                                    {% if batch_cycle %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                                            Batch {{ batch_cycle.current_batch }}
                                        </span>
                                    {% else %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                            N/A
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="py-2 px-4 whitespace-nowrap">
                                    {% if application.is_walkin %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                            Walk-in
                                        </span>
                                    {% else %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                            Online
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="py-2 px-4 whitespace-nowrap">{{ application.applied_at }}</td>
                                <td class="py-2 px-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                        {{ application.status }}
                                    </span>
                                </td>
                                <td class="py-2 px-4 whitespace-nowrap space-x-2">
                                    {% if application.applicant.learner_profile.first %}
                                        <button onclick="openApplicantModal('{{ application.applicant.learner_profile.first.pk }}')" class="text-blue-600 hover:text-blue-800">View</button>
                                    {% else %}
                                        <span class="text-gray-400">No Profile</span>
                                    {% endif %}
                                    {% if application.is_walkin %}
                                        <button onclick="openWalkinDeclineModal('{{ application.walkin_application_id }}', '{% with profile=application.applicant.learner_profile.first %}{% if profile %}{{ profile.first_name }} {{ profile.last_name }}{% else %}{{ application.applicant.first_name }} {{ application.applicant.last_name }}{% endif %}{% endwith %}')" class="text-red-600 hover:text-red-800">Decline</button>
                                    {% else %}
                                        <button onclick="openDeclineModal('{{ application.id }}', '{% with profile=application.applicant.learner_profile.first %}{% if profile %}{{ profile.first_name }} {{ profile.last_name }}{% else %}{{ application.applicant.first_name }} {{ application.applicant.last_name }}{% endif %}{% endwith %}')" class="text-red-600 hover:text-red-800">Decline</button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr id="applicantNoDataRow">
                                <td colspan="7" class="text-center py-4 text-gray-500">No applicants yet.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            <div class="pagination-controls">
                <div class="pagination-info" id="applicantPaginationInfo">
                    Showing 1 to 10 of 0 entries
                </div>
                <div class="pagination-nav" id="applicantPaginationNav">
                    <button onclick="changeApplicantPage('prev')" id="applicantPrevBtn">Previous</button>
                    <div id="applicantPageNumbers"></div>
                    <button onclick="changeApplicantPage('next')" id="applicantNextBtn">Next</button>
                </div>
            </div>
        </div>
        <!-- Approved Applicants Content -->
        <div id="approvedApplicantsContent" class="container-card hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                <div>
                    <h3 class="text-xl font-bold text-gray-800">Approved Applicants</h3>
                    {% if batch_cycle %}
                    <p class="text-sm text-gray-600 mt-1">
                        <i class="fas fa-info-circle mr-1"></i>
                        Showing approved applicants for <strong>Batch {{ batch_cycle.current_batch }}</strong> only. Applications from other batches are hidden.
                    </p>
                    {% endif %}
                </div>
                <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                    <!-- Program Filter -->
                    <div class="filter-control">
                        <label for="approvedProgramFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Program:</label>
                        <select id="approvedProgramFilter" onchange="filterApprovedByProgram()" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Programs</option>
                            {% for program in Programss %}
                                <option value="{{ program.program_name }}">{{ program.program_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Items Per Page -->
                    <div class="items-per-page">
                        <label for="approvedItemsPerPage" class="block text-sm font-medium text-gray-700 mb-1">Show entries:</label>
                        <select id="approvedItemsPerPage" onchange="changeApprovedItemsPerPage()" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tl-md">Applicant Name</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Program Applied</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Batch</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Application Type</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tr-md">Action</th>
                        </tr>
                    </thead>
                    <tbody id="approvedTableBody" class="bg-white divide-y divide-gray-200">
                        {% for approved in approved_applicants %}
                        <tr class="hover:bg-gray-50 approved-row" data-program="{{ approved.program.program_name }}" data-profile-id="{% with profile=approved.applicant.learner_profile.first %}{% if profile %}{{ profile.pk }}{% endif %}{% endwith %}">
                            <td class="py-2 px-4 whitespace-nowrap">
                                {% with profile=approved.applicant.learner_profile.first %}
                                    {% if profile %}
                                        {{ profile.first_name }} {{ profile.last_name }}
                                    {% else %}
                                        {{ approved.applicant.first_name }} {{ approved.applicant.last_name }}
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td class="py-2 px-4 whitespace-nowrap">{{ approved.program.program_name }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">
                                {% if batch_cycle %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                                        Batch {{ batch_cycle.current_batch }}
                                    </span>
                                {% else %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                        N/A
                                    </span>
                                {% endif %}
                            </td>
                            <td class="py-2 px-4 whitespace-nowrap">
                                {% if approved.application_type == 'online' %}
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                        Online
                                    </span>
                                {% else %}
                                    {% if approved.application_type == 'walkin' %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                            Walk-in
                                        </span>
                                    {% else %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                            Unknown
                                        </span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td class="py-2 px-4 whitespace-nowrap space-x-2">
                                {% if approved.applicant and approved.applicant.learner_profile.first %}
                                    <button onclick="openApprovedModal('{{ approved.applicant.learner_profile.first.pk }}')" class="text-blue-600 hover:text-blue-800">View</button>
                                    <button onclick="window.open('{% url 'download_registration_form' approved.applicant.learner_profile.first.pk %}', '_blank')" class="text-green-600 hover:text-green-800">
                                        Download PDF
                                    </button>
                                {% else %}
                                    <span class="text-gray-400">No Profile</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr id="approvedNoDataRow">
                            <td colspan="5" class="text-center text-gray-500 py-4">No approved applicants found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            <div class="pagination-controls">
                <div class="pagination-info" id="approvedPaginationInfo">
                    Showing 1 to 10 of 0 entries
                </div>
                <div class="pagination-nav" id="approvedPaginationNav">
                    <button onclick="changeApprovedPage('prev')" id="approvedPrevBtn">Previous</button>
                    <div id="approvedPageNumbers"></div>
                    <button onclick="changeApprovedPage('next')" id="approvedNextBtn">Next</button>
                </div>
            </div>
        </div>

        <!-- Active Jobs Content -->
        <div id="activeJobsContent" class="container-card hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Active Jobs</h3>
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-2">
                    <label for="activeJobsSearch" class="text-gray-700">Search:</label>
                    <input type="text" id="activeJobsSearch" class="border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Search...">
                </div>
                <button onclick="openAddJobModal()" id="postJobBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    <i class="fas fa-plus mr-2"></i>Post Job
                </button>
            </div>
            
            <!-- Modal Window for Add Job -->
            <div id="addJobModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
                <div class="bg-white w-[50rem] max-w-full max-h-[90vh] overflow-y-auto p-6 rounded-lg relative">
                    <button onclick="closeAddJobModal()" class="absolute top-2 right-2 text-blue-900 font-bold text-xl">&times;</button>
                    <h2 class="text-2xl font-bold text-blue-900 mb-4">Add New Job</h2>
                    
                    <form id="addJobForm" method="POST" action="{% url 'add_job' %}" class="space-y-4">
                        {% csrf_token %}
                        <!-- Job Title -->
                        <div>
                            <label class="block text-gray-700 font-semibold">Job Title</label>
                            <input name="job_title" type="text" class="w-full border rounded p-2" placeholder="Enter job title" required>
                        </div>
                        
                        <!-- Company -->
                        <div>
                            <label class="block text-gray-700 font-semibold">Company</label>
                            <input name="company" type="text" class="w-full border rounded p-2" placeholder="Enter company name" required>
                        </div>
                        
                        <!-- Address -->
                        <div>
                            <label class="block text-gray-700 font-semibold">Address</label>
                            <input name='address' type="text" class="w-full border rounded p-2" placeholder="Enter address" required>
                        </div>
                        
                        <!-- Job Description -->
                        <div>
                            <label class="block text-gray-700 font-semibold">Job Description</label>
                            <textarea name="job_description" class="w-full border rounded p-2" rows="3" placeholder="Enter job description" required></textarea>
                        </div>
                        
                        <!-- Availability & Program dropdowns -->
                        <div class="flex space-x-2">
                            <div class="flex-1">
                                <label class="block text-gray-700 font-semibold">Availability</label>
                                <select name="availability" class="w-full border rounded p-2" required>
                                    <option value="">Select duration</option>
                                    <option>1 Week</option>
                                    <option>2 Weeks</option>
                                    <option>1 Month</option>
                                    <option>2 Months</option>
                                    <option>3 Months</option>
                                </select>
                            </div>
                            <div class="flex-1">
                                <label class="block text-gray-700 font-semibold">Program</label>
                                <select name="expertise" class="w-full border rounded p-2 text-black bg-white" required>
                                    <option value="" class="text-black">Select program</option>
                                    {% for prog in Programss %}
                                        <option value="{{ prog.id }}" class="text-black">{{ prog.program_name }}</option>
                                    {% empty %}
                                        <option class="text-black" disabled>No programs available</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <!-- Skills input section -->
                        <div>
                            <label class="block text-gray-700 font-semibold mb-1">Skills</label>
                            
                            <!-- Container for tags -->
                            <div id="skillContainer"
                                 class="w-full border rounded p-2 mb-3 flex flex-wrap gap-2 min-h-[40px] items-center">
                                <!-- Tags with hidden inputs will appear here -->
                            </div>
                            
                            <!-- Suggested skills -->
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-700 font-semibold">Suggested based on user profile</span>
                                    <button type="button" class="text-gray-400 hover:text-gray-600 text-sm">&times;</button>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" class="skill-btn px-3 py-1 bg-white border rounded-full text-sm hover:bg-gray-100">Wiring and harness installation</button>
                                    <button type="button" class="skill-btn px-3 py-1 bg-white border rounded-full text-sm hover:bg-gray-100">Assembling vehicle engines and parts</button>
                                    <button type="button" class="skill-btn px-3 py-1 bg-white border rounded-full text-sm hover:bg-gray-100">Baking</button>
                                    <button type="button" class="skill-btn px-3 py-1 bg-white border rounded-full text-sm hover:bg-gray-100">Electrical wiring and installation</button>
                                    <button type="button" class="skill-btn px-3 py-1 bg-white border rounded-full text-sm hover:bg-gray-100">Testing and troubleshooting gadgets</button>
                                    <button type="button" class="skill-btn px-3 py-1 bg-white border rounded-full text-sm hover:bg-gray-100">Haircutting and styling</button>
                                    <button type="button" class="skill-btn px-3 py-1 bg-white border rounded-full text-sm hover:bg-gray-100">Client assessment</button>
                                    <button type="button" class="skill-btn px-3 py-1 bg-white border rounded-full text-sm hover:bg-gray-100">Installing air-conditioning units</button>
                                    <button type="button" class="skill-btn px-3 py-1 bg-white border rounded-full text-sm hover:bg-gray-100">Arc welding techniques</button>
                                    <button type="button" class="skill-btn px-3 py-1 bg-white border rounded-full text-sm hover:bg-gray-100">Garment construction</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Email/Link -->
                        <div>
                            <label class="block text-gray-700 font-semibold">Email or Link</label>
                            <input name="email_or_link" type="text" class="w-full border rounded p-2" placeholder="Enter email or link to job post" required>
                        </div>
                        
                        <!-- Submit Button -->
                        <button type="submit" class="w-full bg-blue-900 text-white font-bold py-2 rounded hover:bg-blue-800">Post Job</button>
                    </form>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tl-md">Job Title</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Posted Date</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Status</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tr-md">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for job in jobss|dictsortreversed:"posted_at" %}
                        <tr class="hover:bg-gray-50">
                            <td class="py-2 px-4 whitespace-nowrap">{{ job.job_title }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">{{ job.posted_at }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                    {{ job.status }}
                                </span>
                            </td>
                            <td class="py-2 px-4 whitespace-nowrap space-x-2">
                                <button
                                     onclick="openViewModals(this)"
                                     class="text-yellow-600 hover:text-yellow-800"
                                    data-title="{{ job.job_title }}"
                                    data-company="{{ job.company }}"
                                    data-address="{{ job.address }}"
                                    data-description="{{ job.job_description }}"
                                    data-availability="{{ job.availability }}"
                                    data-program="{{ job.program.program_name }}"
                                    data-skills="{{ job.skills|join:',' }}"
                                    data-email="{{ job.email_or_link }}"
                                    data-job-id="{{ job.id }}">
                                    View
                                </button>
                                <button class="text-red-600 hover:text-red-800">Archive</button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-4">No jobs posted yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Your existing View Job Modal (keep as is) -->
        <div id="viewJobModal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
            <div class="bg-white w-[50rem] max-w-full max-h-[90vh] overflow-y-auto p-6 rounded-lg relative">
                <button onclick="closeViewJobModal()" class="absolute top-2 right-2 text-blue-900 font-bold text-xl">&times;</button>
                <h2 class="text-2xl font-bold text-blue-900 mb-4">Job Details</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-semibold">Job Title</label>
                        <input id="view-title" type="text" class="w-full border rounded p-2 bg-gray-100" disabled>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold">Company</label>
                        <input id="view-company" type="text" class="w-full border rounded p-2 bg-gray-100" disabled>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold">Address</label>
                        <input id="view-address" type="text" class="w-full border rounded p-2 bg-gray-100" disabled>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold">Job Description</label>
                        <textarea id="view-description" class="w-full border rounded p-2 bg-gray-100" rows="3" disabled></textarea>
                    </div>
                    <div class="flex space-x-2">
                        <div class="flex-1">
                            <label class="block text-gray-700 font-semibold">Availability</label>
                            <input id="view-availability" type="text" class="w-full border rounded p-2 bg-gray-100" disabled>
                        </div>
                        <div class="flex-1">
                            <label class="block text-gray-700 font-semibold">Program</label>
                            <input id="view-program" type="text" class="w-full border rounded p-2 bg-gray-100" disabled>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold">Skills</label>
                        <div id="view-skills" class="flex flex-wrap gap-2 p-2 border rounded bg-gray-100 min-h-[40px] text-sm text-blue-800"></div>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold">Email or Link</label>
                        <input id="view-email" type="text" class="w-full border rounded p-2 bg-gray-100" disabled>
                    </div>
                </div>
                <div class="flex space-x-2 mt-4">
                    <button id="edit-button" onclick="toggleEditMode()" class="bg-blue-500 text-white px-4 py-2 rounded">
                        Edit
                    </button>
                    <button id="update-button" onclick="updateJobDetails()" class="bg-green-500 text-white px-4 py-2 rounded hidden">
                        Update
                    </button>
                </div>
            </div>
        </div>

        <!-- Archived Jobs Content -->
        <div id="archivedJobsContent" class="container-card hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Archived Jobs</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tl-md">Job Title</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Posted Date</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Status</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Reason for Archiving</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tr-md">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for job in archived_jobs %}
                        <tr class="hover:bg-gray-50">
                            <td class="py-2 px-4 whitespace-nowrap">{{ job.job_title }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">{{ job.posted_at }}</td>
                            <td class="py-2 px-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-300 text-gray-800">
                                    Archived
                                </span>
                            </td>
                            <td class="py-2 px-4 whitespace-nowrap">{{ job.archive_reason|default:"N/A" }}</td>
                            <td class="py-2 px-4 whitespace-nowrap space-x-2">
                                <button class="text-blue-600 hover:text-blue-800">View</button>
                                <button class="text-green-600 hover:text-green-800">Restore</button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4">No archived jobs yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Trainor List Content -->
        <div id="trainorListContent" class="container-card hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                <h3 class="text-xl font-bold text-gray-800">Trainer List</h3>
                <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                    <!-- Program Filter -->
                    <div class="filter-control">
                        <label for="trainerProgramFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Program:</label>
                        <select id="trainerProgramFilter" onchange="filterTrainersByProgram()" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Programs</option>
                            {% for program in Programss %}
                                <option value="{{ program.program_name }}">{{ program.program_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <!-- Items Per Page -->
                    <div class="items-per-page">
                        <label for="trainerItemsPerPage" class="block text-sm font-medium text-gray-700 mb-1">Show entries:</label>
                        <select id="trainerItemsPerPage" onchange="changeTrainerItemsPerPage()" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <!-- Add Trainer Button -->
                    <div class="flex items-end">
                        <button id="addTrainorBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                            <i class="fas fa-plus mr-2"></i>Add Trainer
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tl-md">Trainer Name</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Email</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Program Assigned</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Date Joined</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tr-md">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="trainerTableBody" class="bg-white divide-y divide-gray-200">
                        {% if trainers %}
                            {% for trainer in trainers %}
                            <tr class="hover:bg-gray-50 trainer-row" data-programs="{% for prog in trainer.programs.all %}{{ prog.program_name }}{% if not forloop.last %},{% endif %}{% endfor %}">
                                <td class="py-2 px-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center">
                                                <span class="text-white font-medium text-sm">
                                                    {{ trainer.user.first_name|first|default:trainer.user.username|first }}{{ trainer.user.last_name|first|default:"" }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">
                                                {% if trainer.user.first_name and trainer.user.last_name %}
                                                    {{ trainer.user.first_name }} {{ trainer.user.last_name }}
                                                {% else %}
                                                    {{ trainer.user.username }}
                                                {% endif %}
                                            </div>
                                            <div class="text-sm text-gray-500">
                                                @{{ trainer.user.username }}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-2 px-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">{{ trainer.user.email }}</div>
                                </td>
                                <td class="py-2 px-4">
                                    <div class="flex flex-wrap gap-1">
                                        {% if trainer.programs.all %}
                                            {% for program in trainer.programs.all %}
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                    {{ program.program_name }}
                                                </span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                                No Programs Assigned
                                            </span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="py-2 px-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ trainer.user.date_joined|date:"M d, Y" }}
                                </td>
                                <td class="py-2 px-4 whitespace-nowrap text-sm font-medium space-x-2">
                                    <button onclick="manageTrainerPrograms('{{ trainer.id }}', '{% if trainer.user.first_name %}{{ trainer.user.first_name }} {{ trainer.user.last_name }}{% else %}{{ trainer.user.username }}{% endif %}')" class="text-green-600 hover:text-green-800">
                                        <i class="fas fa-tasks mr-1"></i>Manage
                                    </button>
                                    <button type="button" class="remove-trainer-btn text-red-600 hover:text-red-800" data-trainer-id="{{ trainer.id }}" data-trainer-name="{% if trainer.user.first_name %}{{ trainer.user.first_name }} {{ trainer.user.last_name }}{% else %}{{ trainer.user.username }}{% endif %}">
                                        <i class="fas fa-user-times mr-1"></i>Remove
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr id="trainerNoDataRow">
                                <td colspan="5" class="text-center py-4 text-gray-500">No trainers found.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            <div class="pagination-controls">
                <div class="pagination-info" id="trainerPaginationInfo">
                    Showing 1 to 10 of 0 entries
                </div>
                <div class="pagination-nav" id="trainerPaginationNav">
                    <button onclick="changeTrainerPage('prev')" id="trainerPrevBtn">Previous</button>
                    <div id="trainerPageNumbers"></div>
                    <button onclick="changeTrainerPage('next')" id="trainerNextBtn">Next</button>
                </div>
            </div>
        </div>

        <!-- Accounts Content -->
        <div id="accountsContent" class="container-card hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                <h3 class="text-xl font-bold text-gray-800">Account Management</h3>
                <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                    <!-- Account Type Filter -->
                    <div class="filter-control">
                        <label for="accountTypeFilter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Account Type:</label>
                        <select id="accountTypeFilter" onchange="filterAccountsByType()" class="w-full md:w-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">All Accounts</option>
                            <option value="admin">Admin (Superuser)</option>
                            <option value="trainor">Trainor (Staff)</option>
                        </select>
                    </div>
                    <!-- Items Per Page -->
                    <div class="items-per-page">
                        <label for="accountItemsPerPage" class="block text-sm font-medium text-gray-700 mb-1">Show entries:</label>
                        <select id="accountItemsPerPage" onchange="changeAccountItemsPerPage()" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tl-md">Username</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Password</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Account Type</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider">Date Joined</th>
                            <th class="py-3 px-4 bg-blue-500 text-left text-xs font-semibold text-white uppercase tracking-wider rounded-tr-md">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="accountTableBody" class="bg-white divide-y divide-gray-200">
                        {% if all_users %}
                            {% for user in all_users %}
                            <tr class="hover:bg-gray-50 account-row" data-account-type="{% if user.is_superuser %}admin{% else %}{% if user.is_staff %}trainor{% else %}other{% endif %}{% endif %}" data-user-id="{{ user.id }}" data-username="{{ user.username }}">
                                <td class="py-2 px-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <div class="h-10 w-10 rounded-full {% if user.is_superuser %}bg-red-500{% else %}{% if user.is_staff %}bg-green-500{% else %}bg-gray-500{% endif %}{% endif %} flex items-center justify-center">
                                                <span class="text-white font-medium text-sm">
                                                    {{ user.username|first|upper }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">
                                                {{ user.username }}
                                            </div>
                                            <div class="text-sm text-gray-500">
                                                {% if user.email %}{{ user.email }}{% else %}No email{% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-2 px-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">P******</div>
                                </td>
                                <td class="py-2 px-4 whitespace-nowrap">
                                    {% if user.is_superuser %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                                            <i class="fas fa-user-shield mr-1"></i>Admin (Superuser)
                                        </span>
                                    {% else %}
                                        {% if user.is_staff %}
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                <i class="fas fa-chalkboard-teacher mr-1"></i>Trainor (Staff)
                                            </span>
                                        {% else %}
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                                <i class="fas fa-user mr-1"></i>Other
                                            </span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="py-2 px-4 whitespace-nowrap text-sm text-gray-500">
                                    {{ user.date_joined|date:"M d, Y" }}
                                </td>
                                <td class="py-2 px-4 whitespace-nowrap text-sm font-medium space-x-2">
                                    <button onclick="viewAccountDetails('{{ user.id }}', '{{ user.username }}')" class="text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-eye mr-1"></i>View
                                    </button>
                                    <button onclick="changeAccountPassword('{{ user.id }}', '{{ user.username }}')" class="text-yellow-600 hover:text-yellow-800">
                                        <i class="fas fa-key mr-1"></i>Change Password
                                    </button>
                                    <button onclick="removeAccount('{{ user.id }}', '{{ user.username }}')" class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-trash mr-1"></i>Remove
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-8 text-gray-500">
                                    <i class="fas fa-users-slash text-4xl mb-2 text-gray-300"></i>
                                    <p class="text-lg">No accounts found</p>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            <div class="pagination-controls">
                <div class="pagination-info" id="accountPaginationInfo">
                    Showing 1 to 10 of 0 entries
                </div>
                <div class="pagination-nav" id="accountPaginationNav">
                    <button onclick="changeAccountPage('prev')" id="accountPrevBtn">Previous</button>
                    <div id="accountPageNumbers"></div>
                    <button onclick="changeAccountPage('next')" id="accountNextBtn">Next</button>
                </div>
            </div>
        </div>
    </main>
    <script>
        // Sidebar Toggle Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
            const sidebarToggleIcon = document.getElementById('sidebarToggleIcon');
            
            // Initialize sidebar state
            updateSidebarState();
            
            // Add event listener for the arrow toggle button
            sidebarToggleBtn.addEventListener('click', function() {
                // Toggle the auto-collapse class on the sidebar
                sidebar.classList.toggle('auto-collapse');
                updateSidebarState();
            });
            
            // Function to update sidebar state and arrow icon
            function updateSidebarState() {
                if (sidebar.classList.contains('auto-collapse')) {
                    // Sidebar is collapsed - show right arrow to expand
                    sidebarToggleIcon.className = 'fas fa-arrow-right';
                    mainContent.style.marginLeft = '4rem';
                } else {
                    // Sidebar is expanded - show left arrow to collapse
                    sidebarToggleIcon.className = 'fas fa-arrow-left';
                    mainContent.style.marginLeft = '0';
                }
            }
        });

        // ✅ FIXED NOTIFICATION SYSTEM
        let notificationInterval;

        async function loadNotifications() {
            try {
                const response = await fetch('/get-notifications/');
                if (!response.ok) throw new Error('Failed to fetch notifications');
                const data = await response.json();
                updateNotificationBadge(data.unread_count);
                populateNotificationsList(data.notifications);
            } catch (error) {
                console.error('Error loading notifications:', error);
                document.getElementById('notifications-list').innerHTML = '<div class="p-4 text-center text-red-500">Error loading notifications</div>';
            }
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notification-badge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Try to extract program name from notification title formats like
        // "New Application: <Program>", "Application Approved: <Program>", etc.
        function extractProgramName(title) {
            try {
                if (!title) return '';
                const parts = String(title).split(':');
                if (parts.length >= 2) {
                    return parts.slice(1).join(':').trim();
                }
                return '';
            } catch (e) {
                return '';
            }
        }

        function populateNotificationsList(notifications) {
            const list = document.getElementById('notifications-list');
            
            if (notifications.length === 0) {
                list.innerHTML = '<div class="p-4 text-center text-gray-500">No notifications</div>';
                return;
            }
            
            list.innerHTML = notifications.map(notification => {
                const programName = notification.program || extractProgramName(notification.title);
                const profileId = notification.profile_id || '';
                const applicationId = notification.application_id || '';
                return `
                <div class="notification-item p-3 border-b hover:bg-gray-50 cursor-pointer ${!notification.is_read ? 'bg-blue-50' : ''}"
                     data-notification-id="${notification.id}"
                     data-notification-type="${notification.notification_type}"
                     data-program="${programName || ''}"
                     data-profile-id="${profileId}"
                     data-application-id="${applicationId}"
                    onclick="markNotificationAsRead(${notification.id}, '${notification.notification_type}')">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900 ${!notification.is_read ? 'font-bold' : ''}">${notification.title}</p>
                            <p class="text-xs text-gray-600 mt-1">${notification.message}</p>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-400">${notification.created_at}</span>
                                <span class="text-xs px-2 py-1 rounded-full ${getNotificationTypeColor(notification.notification_type)}">
                                    ${notification.notification_type}
                                </span>
                            </div>
                        </div>
                        ${!notification.is_read ? '<div class="w-2 h-2 bg-blue-500 rounded-full ml-2 mt-1"></div>' : ''}
                    </div>
                </div>
            `}).join('');
        }

        function getNotificationTypeColor(type) {
            switch(type) {
                case 'approval': return 'bg-green-100 text-green-800';
                case 'rejection': return 'bg-red-100 text-red-800';
                case 'application': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        async function markNotificationAsRead(notificationId, notificationType) {
            try {
                const response = await fetch(`/mark-notification-read/${notificationId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json',
                    }
                });
                if (response.ok) {
                    // Update the notification item visually
                    const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
                    if (notificationItem) {
                        notificationItem.classList.remove('unread');
                    }
                    // Reload notifications to update badge
                    loadNotifications();
                    
                    // Close the notification box
                    const notificationBox = document.getElementById('notification-box');
                    if (notificationBox) {
                        notificationBox.classList.add('hidden');
                    }
                    
                    // Collect embedded metadata from this notification (if present)
                    const program = notificationItem?.dataset?.program || '';
                    const profileId = notificationItem?.dataset?.profileId || '';
                    const applicationId = notificationItem?.dataset?.applicationId || '';

                    // Fallback: derive type if missing from JSON (some endpoints may omit notification_type)
                    let derivedType = notificationType;
                    if (!derivedType || derivedType === 'undefined') {
                        derivedType = notificationItem?.dataset?.notificationType || '';
                        if (!derivedType) {
                            const titleEl = notificationItem?.querySelector('p.text-sm');
                            const titleText = (titleEl?.textContent || '').toLowerCase();
                            if (titleText.includes('approved')) derivedType = 'approval';
                            else if (titleText.includes('reject')) derivedType = 'rejection';
                            else if (titleText.includes('application')) derivedType = 'application';
                        }
                    }

                    // Navigate based on type and apply filters/highlighting
                    if (derivedType === 'application' || derivedType === 'rejection') {
                        const applicantListLink = document.querySelector('[data-content-type="applicant-list"]');
                        if (applicantListLink) {
                            document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('bg-blue-700'));
                            applicantListLink.classList.add('bg-blue-700');
                            showContent('applicant-list', 'Applicant List');

                            setTimeout(() => {
                                // Pre-filter by program if provided
                                if (program) {
                                    const select = document.getElementById('applicantProgramFilter');
                                    if (select) {
                                        select.value = program;
                                        if (typeof filterApplicantsByProgram === 'function') {
                                            filterApplicantsByProgram();
                                        }
                                    }
                                }

                                // Find target row and highlight
                                let targetRow = null;
                                if (profileId) {
                                    targetRow = document.querySelector(`.applicant-row[data-profile-id="${profileId}"]`);
                                }
                                if (!targetRow && applicationId) {
                                    targetRow = document.querySelector(`.applicant-row[data-application-id="${applicationId}"]`);
                                }
                                if (!targetRow) {
                                    targetRow = document.querySelector('.applicant-row');
                                }
                                if (targetRow) {
                                    targetRow.classList.add('row-highlight');
                                    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    setTimeout(() => targetRow.classList.remove('row-highlight'), 2000);
                                }

                                // Open modal directly if we have a profileId
                                if (profileId && typeof openApplicantModal === 'function') {
                                    setTimeout(() => openApplicantModal(profileId), 300);
                                }
                            }, 200);
                        }
                    } else if (derivedType === 'approval') {
                        // Navigate to Approved Applicants
                        const approvedLink = document.querySelector('[data-content-type="approved-applicants"]');
                        if (approvedLink) {
                            document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('bg-blue-700'));
                            approvedLink.classList.add('bg-blue-700');
                            showContent('approved-applicants', 'Approved Applicants');

                            setTimeout(() => {
                                if (program) {
                                    const select = document.getElementById('approvedProgramFilter');
                                    if (select) {
                                        select.value = program;
                                        if (typeof filterApprovedByProgram === 'function') {
                                            filterApprovedByProgram();
                                        }
                                    }
                                }
                                let targetRow = null;
                                if (profileId) {
                                    targetRow = document.querySelector(`.approved-row[data-profile-id="${profileId}"]`);
                                }
                                if (!targetRow) {
                                    targetRow = document.querySelector('.approved-row');
                                }
                                if (targetRow) {
                                    targetRow.classList.add('row-highlight');
                                    targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    setTimeout(() => targetRow.classList.remove('row-highlight'), 2000);
                                }
                            }, 200);
                        }
                    }
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        async function markAllNotificationsRead() {
            try {
                // Get CSRF token from the form (same method as other AJAX calls)
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                if (!csrfToken) {
                    console.error('CSRF token not found');
                    showNotification('Authentication error. Please refresh the page and try again.', 'error');
                    return;
                }

                // Show loading state
                const markAllReadBtn = document.getElementById('mark-all-read');
                if (markAllReadBtn) {
                    markAllReadBtn.textContent = 'Marking...';
                    markAllReadBtn.disabled = true;
                }

                const response = await fetch('/mark-all-notifications-read/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showNotification('All notifications marked as read', 'success');
                        loadNotifications();
                        updateNotificationBadge(0); // Clear the badge
                    } else {
                        throw new Error(data.error || 'Unknown error');
                    }
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                showNotification('Error marking notifications as read. Please try again.', 'error');
            } finally {
                // Reset button state
                const markAllReadBtn = document.getElementById('mark-all-read');
                if (markAllReadBtn) {
                    markAllReadBtn.textContent = 'Mark all read';
                    markAllReadBtn.disabled = false;
                }
            }
        }

        // ✅ FIXED BELL BUTTON CLICK HANDLER
        document.addEventListener('DOMContentLoaded', function() {
            const bellBtn = document.getElementById('bell-btn');
            const notificationBox = document.getElementById('notification-box');
            const markAllReadBtn = document.getElementById('mark-all-read');
            
            // Initialize notification badge with new items count (applications + tickets + documents)
            const totalNewApplications = {{ total_new_applications|default:0 }};
            const newTicketsCount = {{ new_tickets_count|default:0 }};
            const newDocumentsCount = {{ new_documents_count|default:0 }};
            const totalNewItems = totalNewApplications + newTicketsCount + newDocumentsCount;
            if (totalNewItems > 0) {
                updateNotificationBadge(totalNewItems);
            }
            
            if (bellBtn && notificationBox) {
                // Load notifications on page load
                loadNotifications();
                
                // Set up auto-refresh every 30 seconds
                notificationInterval = setInterval(loadNotifications, 30000);
                
                // ✅ FIXED: Bell button click handler with explicit show/hide
                bellBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Instead of toggle, explicitly show/hide
                    if (notificationBox.classList.contains('hidden')) {
                        notificationBox.classList.remove('hidden');
                        // Reload notifications when opening
                        loadNotifications();
                    } else {
                        notificationBox.classList.add('hidden');
                    }
                });
                
                // Mark all read button
                if (markAllReadBtn) {
                    markAllReadBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Prevent multiple clicks while processing
                        if (markAllReadBtn.disabled) {
                            return;
                        }
                        
                        markAllNotificationsRead();
                    });
                }
                
                // Close notification box when clicking outside
                document.addEventListener('click', function(e) {
                    if (!bellBtn.contains(e.target) && !notificationBox.contains(e.target)) {
                        notificationBox.classList.add('hidden');
                    }
                });
            }
        });

        // Clean up interval when page unloads
        window.addEventListener('beforeunload', function() {
            if (notificationInterval) {
                clearInterval(notificationInterval);
            }
        });

        // Pagination and filtering variables
        let applicantCurrentPage = 1;
        let applicantItemsPerPage = 10;
        let applicantTotalItems = 0;
        let applicantData = [];
        let applicantFilteredData = [];
        let applicantCurrentFilter = 'all';

        let approvedCurrentPage = 1;
        let approvedItemsPerPage = 10;
        let approvedTotalItems = 0;
        let approvedData = [];
        let approvedFilteredData = [];
        let approvedCurrentFilter = 'all';

        let accountCurrentPage = 1;
        let accountItemsPerPage = 10;
        let accountTotalItems = 0;
        let accountData = [];
        let accountFilteredData = [];
        let accountCurrentFilter = 'all';

        // Initialize pagination when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize applicant data
            const applicantRows = document.querySelectorAll('.applicant-row');
            applicantData = Array.from(applicantRows);
            applicantFilteredData = applicantData;
            applicantTotalItems = applicantFilteredData.length;
            
            // Initialize approved data
            const approvedRows = document.querySelectorAll('.approved-row');
            approvedData = Array.from(approvedRows);
            approvedFilteredData = approvedData;
            approvedTotalItems = approvedFilteredData.length;
            
            // Setup initial pagination
            updateApplicantPagination();
            updateApprovedPagination();
        });

        // Filter applicants by program
        function filterApplicantsByProgram() {
            const programFilter = document.getElementById('applicantProgramFilter').value;
            applicantCurrentFilter = programFilter;
            applicantCurrentPage = 1;
            
            if (programFilter === 'all') {
                applicantFilteredData = applicantData;
            } else {
                applicantFilteredData = applicantData.filter(row => {
                    return row.getAttribute('data-program') === programFilter;
                });
            }
            
            applicantTotalItems = applicantFilteredData.length;
            
            // Show no data message if no results
            const noDataRow = document.getElementById('applicantNoDataRow');
            if (applicantFilteredData.length === 0 && !noDataRow) {
                const tableBody = document.getElementById('applicantTableBody');
                const newRow = document.createElement('tr');
                newRow.id = 'applicantNoDataRow';
                newRow.innerHTML = `<td colspan="5" class="text-center py-4 text-gray-500">No matching applicants found.</td>`;
                tableBody.appendChild(newRow);
            } else if (applicantFilteredData.length > 0 && noDataRow) {
                noDataRow.remove();
            }
            
            updateApplicantPagination();
        }

        // Filter approved applicants by program
        function filterApprovedByProgram() {
            const programFilter = document.getElementById('approvedProgramFilter').value;
            approvedCurrentFilter = programFilter;
            approvedCurrentPage = 1;
            
            if (programFilter === 'all') {
                approvedFilteredData = approvedData;
            } else {
                approvedFilteredData = approvedData.filter(row => {
                    return row.getAttribute('data-program') === programFilter;
                });
            }
            
            approvedTotalItems = approvedFilteredData.length;
            
            // Show no data message if no results
            const noDataRow = document.getElementById('approvedNoDataRow');
            if (approvedFilteredData.length === 0 && !noDataRow) {
                const tableBody = document.getElementById('approvedTableBody');
                const newRow = document.createElement('tr');
                newRow.id = 'approvedNoDataRow';
                newRow.innerHTML = `<td colspan="3" class="text-center py-4 text-gray-500">No matching approved applicants found.</td>`;
                tableBody.appendChild(newRow);
            } else if (approvedFilteredData.length > 0 && noDataRow) {
                noDataRow.remove();
            }
            
            updateApprovedPagination();
        }

        // Applicant List Pagination Functions
        function changeApplicantItemsPerPage() {
            const select = document.getElementById('applicantItemsPerPage');
            applicantItemsPerPage = parseInt(select.value);
            applicantCurrentPage = 1;
            updateApplicantPagination();
        }

        function changeApplicantPage(direction) {
            const totalPages = Math.ceil(applicantTotalItems / applicantItemsPerPage);
            
            if (direction === 'prev' && applicantCurrentPage > 1) {
                applicantCurrentPage--;
            } else if (direction === 'next' && applicantCurrentPage < totalPages) {
                applicantCurrentPage++;
            } else if (typeof direction === 'number') {
                applicantCurrentPage = direction;
            }
            
            updateApplicantPagination();
        }

        function updateApplicantPagination() {
            const totalPages = Math.ceil(applicantTotalItems / applicantItemsPerPage);
            const startIndex = (applicantCurrentPage - 1) * applicantItemsPerPage;
            const endIndex = startIndex + applicantItemsPerPage;
            
            // Hide all rows
            applicantData.forEach(row => row.style.display = 'none');
            
            // Show current page rows from filtered data
            for (let i = startIndex; i < endIndex && i < applicantTotalItems; i++) {
                if (applicantFilteredData[i]) {
                    applicantFilteredData[i].style.display = '';
                }
            }
            
            // Update pagination info
            const actualEnd = Math.min(endIndex, applicantTotalItems);
            const actualStart = applicantTotalItems > 0 ? startIndex + 1 : 0;
            document.getElementById('applicantPaginationInfo').textContent =
                 `Showing ${actualStart} to ${actualEnd} of ${applicantTotalItems} entries${applicantCurrentFilter !== 'all' ? ' (filtered)' : ''}`;
            
            // Update pagination buttons
            document.getElementById('applicantPrevBtn').disabled = applicantCurrentPage === 1;
            document.getElementById('applicantNextBtn').disabled = applicantCurrentPage === totalPages || totalPages === 0;
            
            // Update page numbers
            updateApplicantPageNumbers(totalPages);
        }

        function updateApplicantPageNumbers(totalPages) {
            const pageNumbersDiv = document.getElementById('applicantPageNumbers');
            pageNumbersDiv.innerHTML = '';
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, applicantCurrentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.onclick = () => changeApplicantPage(i);
                if (i === applicantCurrentPage) {
                    button.classList.add('active');
                }
                pageNumbersDiv.appendChild(button);
            }
        }

        // Approved Applicants Pagination Functions
        function changeApprovedItemsPerPage() {
            const select = document.getElementById('approvedItemsPerPage');
            approvedItemsPerPage = parseInt(select.value);
            approvedCurrentPage = 1;
            updateApprovedPagination();
        }

        function changeApprovedPage(direction) {
            const totalPages = Math.ceil(approvedTotalItems / approvedItemsPerPage);
            
            if (direction === 'prev' && approvedCurrentPage > 1) {
                approvedCurrentPage--;
            } else if (direction === 'next' && approvedCurrentPage < totalPages) {
                approvedCurrentPage++;
            } else if (typeof direction === 'number') {
                approvedCurrentPage = direction;
            }
            
            updateApprovedPagination();
        }

        function updateApprovedPagination() {
            const totalPages = Math.ceil(approvedTotalItems / approvedItemsPerPage);
            const startIndex = (approvedCurrentPage - 1) * approvedItemsPerPage;
            const endIndex = startIndex + approvedItemsPerPage;
            
            // Hide all rows
            approvedData.forEach(row => row.style.display = 'none');
            
            // Show current page rows from filtered data
            for (let i = startIndex; i < endIndex && i < approvedTotalItems; i++) {
                if (approvedFilteredData[i]) {
                    approvedFilteredData[i].style.display = '';
                }
            }
            
            // Update pagination info
            const actualEnd = Math.min(endIndex, approvedTotalItems);
            const actualStart = approvedTotalItems > 0 ? startIndex + 1 : 0;
            document.getElementById('approvedPaginationInfo').textContent =
                 `Showing ${actualStart} to ${actualEnd} of ${approvedTotalItems} entries${approvedCurrentFilter !== 'all' ? ' (filtered)' : ''}`;
            
            // Update pagination buttons
            document.getElementById('approvedPrevBtn').disabled = approvedCurrentPage === 1;
            document.getElementById('approvedNextBtn').disabled = approvedCurrentPage === totalPages || totalPages === 0;
            
            // Update page numbers
            updateApprovedPageNumbers(totalPages);
        }

        function updateApprovedPageNumbers(totalPages) {
            const pageNumbersDiv = document.getElementById('approvedPageNumbers');
            pageNumbersDiv.innerHTML = '';
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, approvedCurrentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.onclick = () => changeApprovedPage(i);
                if (i === approvedCurrentPage) {
                    button.classList.add('active');
                }
                pageNumbersDiv.appendChild(button);
            }
        }

        // Account Management Functions
        function filterAccountsByType() {
            const typeFilter = document.getElementById('accountTypeFilter').value;
            accountCurrentFilter = typeFilter;
            accountCurrentPage = 1;
            
            if (typeFilter === 'all') {
                accountFilteredData = accountData;
            } else {
                accountFilteredData = accountData.filter(row => {
                    return row.getAttribute('data-account-type') === typeFilter;
                });
            }
            
            accountTotalItems = accountFilteredData.length;
            updateAccountPagination();
        }

        function changeAccountItemsPerPage() {
            const select = document.getElementById('accountItemsPerPage');
            accountItemsPerPage = parseInt(select.value);
            accountCurrentPage = 1;
            updateAccountPagination();
        }

        function changeAccountPage(direction) {
            const totalPages = Math.ceil(accountTotalItems / accountItemsPerPage);
            
            if (direction === 'prev' && accountCurrentPage > 1) {
                accountCurrentPage--;
            } else if (direction === 'next' && accountCurrentPage < totalPages) {
                accountCurrentPage++;
            } else if (typeof direction === 'number') {
                accountCurrentPage = direction;
            }
            
            updateAccountPagination();
        }
        function updateAccountPagination() {
            const totalPages = Math.ceil(accountTotalItems / accountItemsPerPage);
            const startIndex = (accountCurrentPage - 1) * accountItemsPerPage;
            const endIndex = startIndex + accountItemsPerPage;
            
            // Hide all rows
            accountData.forEach(row => row.style.display = 'none');
            
            // Show current page rows from filtered data
            for (let i = startIndex; i < endIndex && i < accountTotalItems; i++) {
                if (accountFilteredData[i]) {
                    accountFilteredData[i].style.display = '';
                }
            }
            
            // Update pagination info
            const actualEnd = Math.min(endIndex, accountTotalItems);
            const actualStart = accountTotalItems > 0 ? startIndex + 1 : 0;
            document.getElementById('accountPaginationInfo').textContent =
                 `Showing ${actualStart} to ${actualEnd} of ${accountTotalItems} entries${accountCurrentFilter !== 'all' ? ' (filtered)' : ''}`;
            
            // Update pagination buttons
            document.getElementById('accountPrevBtn').disabled = accountCurrentPage === 1;
            document.getElementById('accountNextBtn').disabled = accountCurrentPage === totalPages || totalPages === 0;
            
            // Update page numbers
            updateAccountPageNumbers(totalPages);
        }

        function updateAccountPageNumbers(totalPages) {
            const pageNumbersDiv = document.getElementById('accountPageNumbers');
            pageNumbersDiv.innerHTML = '';
            
            const maxVisiblePages = 5;
            let startPage = Math.max(1, accountCurrentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.onclick = () => changeAccountPage(i);
                if (i === accountCurrentPage) {
                    button.classList.add('active');
                }
                pageNumbersDiv.appendChild(button);
            }
        }

        // Account Modal Functions
        function viewAccountDetails(userId, username) {
            fetch(`/admin/get-account-details/${userId}/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('viewAccountUsername').value = data.username;
                    document.getElementById('viewAccountPassword').value = data.password;
                    document.getElementById('viewAccountEmail').value = data.email || 'No email';
                    document.getElementById('viewAccountDateJoined').value = data.date_joined;
                    
                    let accountTypeHTML = '';
                    if (data.is_superuser) {
                        accountTypeHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800"><i class="fas fa-user-shield mr-1"></i>Admin (Superuser)</span>';
                    } else if (data.is_staff) {
                        accountTypeHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-chalkboard-teacher mr-1"></i>Trainor (Staff)</span>';
                    } else {
                        accountTypeHTML = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800"><i class="fas fa-user mr-1"></i>Other</span>';
                    }
                    document.getElementById('viewAccountType').innerHTML = accountTypeHTML;
                    
                    document.getElementById('viewAccountModal').classList.add('active');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load account details');
                });
        }

        function closeViewAccountModal() {
            document.getElementById('viewAccountModal').classList.remove('active');
            document.getElementById('viewAccountPassword').type = 'password';
            document.getElementById('passwordToggleIcon').className = 'fas fa-eye';
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('viewAccountPassword');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        function changeAccountPassword(userId, username) {
            document.getElementById('changePasswordUserId').value = userId;
            document.getElementById('changePasswordUsername').value = username;
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordMatchError').classList.add('hidden');
            document.getElementById('changePasswordModal').classList.add('active');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('active');
        }

        function toggleNewPasswordVisibility() {
            const passwordInput = document.getElementById('newPassword');
            const toggleIcon = document.getElementById('newPasswordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        function toggleConfirmPasswordVisibility() {
            const passwordInput = document.getElementById('confirmPassword');
            const toggleIcon = document.getElementById('confirmPasswordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        // Handle Change Password Form Submission
        document.addEventListener('DOMContentLoaded', function() {
            const changePasswordForm = document.getElementById('changePasswordForm');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const userId = document.getElementById('changePasswordUserId').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    const errorDiv = document.getElementById('passwordMatchError');
                    
                    if (newPassword !== confirmPassword) {
                        errorDiv.classList.remove('hidden');
                        return;
                    }
                    
                    errorDiv.classList.add('hidden');
                    
                    fetch(`/admin/change-account-password/${userId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({ new_password: newPassword })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Password changed successfully!');
                            closeChangePasswordModal();
                        } else {
                            alert('Error: ' + (data.error || 'Failed to change password'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to change password');
                    });
                });
            }
        });

        function removeAccount(userId, username) {
            const row = document.querySelector(`tr[data-user-id="${userId}"]`);
            const accountType = row ? row.getAttribute('data-account-type') : '';
            
            let typeText = '';
            if (accountType === 'admin') {
                typeText = 'Admin (Superuser)';
            } else if (accountType === 'trainor') {
                typeText = 'Trainor (Staff)';
            } else {
                typeText = 'Other';
            }
            
            document.getElementById('removeAccountUserId').value = userId;
            document.getElementById('removeAccountUsername').textContent = username;
            document.getElementById('removeAccountType').textContent = typeText;
            document.getElementById('removeAccountModal').classList.add('active');
        }

        function closeRemoveAccountModal() {
            document.getElementById('removeAccountModal').classList.remove('active');
        }

        function confirmRemoveAccount() {
            const userId = document.getElementById('removeAccountUserId').value;
            
            fetch(`/admin/remove-account/${userId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Account removed successfully!');
                    closeRemoveAccountModal();
                    location.reload(); // Reload to update the table
                } else {
                    alert('Error: ' + (data.error || 'Failed to remove account'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to remove account');
            });
        }

        // Update the showContent function to reinitialize pagination when switching tabs
        function showContent(contentType, pageName) {
            hideAllContent();
            mainContentTitle.textContent = pageName;
            
            switch(contentType) {
                case 'dashboard':
                    dashboardContent.classList.remove('hidden');
                    break;
                case 'programs':
                    programsContent.classList.remove('hidden');
                    break;
                case 'applicant-list':
                    applicantListContent.classList.remove('hidden');
                    // Reinitialize applicant pagination
                    setTimeout(() => {
                        const applicantRows = document.querySelectorAll('.applicant-row');
                        applicantData = Array.from(applicantRows);
                        
                        // Apply current filter
                        if (applicantCurrentFilter === 'all') {
                            applicantFilteredData = applicantData;
                        } else {
                            applicantFilteredData = applicantData.filter(row => {
                                return row.getAttribute('data-program') === applicantCurrentFilter;
                            });
                        }
                        
                        applicantTotalItems = applicantFilteredData.length;
                        updateApplicantPagination();
                    }, 100);
                    break;
                case 'approved-applicants':
                    approvedApplicantsContent.classList.remove('hidden');
                    // Reinitialize approved pagination
                    setTimeout(() => {
                        const approvedRows = document.querySelectorAll('.approved-row');
                        approvedData = Array.from(approvedRows);
                        
                        // Apply current filter
                        if (approvedCurrentFilter === 'all') {
                            approvedFilteredData = approvedData;
                        } else {
                            approvedFilteredData = approvedData.filter(row => {
                                return row.getAttribute('data-program') === approvedCurrentFilter;
                            });
                        }
                        
                        approvedTotalItems = approvedFilteredData.length;
                        updateApprovedPagination();
                    }, 100);
                    break;
                case 'active-jobs':
                    activeJobsContent.classList.remove('hidden');
                    break;
                case 'archived-jobs':
                    archivedJobsContent.classList.remove('hidden');
                    break;
                case 'trainor-list':
                    trainorListContent.classList.remove('hidden');
                    break;
                case 'overlay':
                    overlayText.textContent = `You are on the ${pageName} page`;
                    overlayPage.classList.add('active');
                    break;
                case 'program-management':
                    document.getElementById('programManagementContent').classList.remove('hidden');
                    break;
                case 'document-management':
                    document.getElementById('documentManagementContent').classList.remove('hidden');
                    // Initialize the first tab (overview) by default
                    showDocTab('overview');
                    break;
                case 'ticket':
                    document.getElementById('ticketContent').classList.remove('hidden');
                    // Initialize ticket management when shown
                    if (typeof initializeTicketManagement === 'function') {
                        initializeTicketManagement();
                    }
                    break;
                case 'accounts':
                    document.getElementById('accountsContent').classList.remove('hidden');
                    // Reinitialize account pagination
                    setTimeout(() => {
                        const accountRows = document.querySelectorAll('.account-row');
                        accountData = Array.from(accountRows);
                        
                        // Apply current filter
                        if (accountCurrentFilter === 'all') {
                            accountFilteredData = accountData;
                        } else {
                            accountFilteredData = accountData.filter(row => {
                                return row.getAttribute('data-account-type') === accountCurrentFilter;
                            });
                        }
                        
                        accountTotalItems = accountFilteredData.length;
                        updateAccountPagination();
                    }, 100);
                    break;
            }
        }

        // Chart.js initialization - Program Enrollment Distribution
        const doughnutCtx = document.getElementById('doughnutChart').getContext('2d');
        
        // Program data - dynamic from Django template
        const chartLabels = [];
        
        const approvedCounts = [];
        const totalCounts = [];
        
        // Calculate approval rates (percentage)
        const approvalRates = approvedCounts.map((approved, index) => {
            const total = totalCounts[index];
            return total > 0 ? Math.round((approved / total) * 100) : 0;
        });
        
        // Generate colors for each program
        const colors = [
            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
            '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6366F1'
        ];
        
        new Chart(doughnutCtx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Approval Rate (%)',
                    data: approvalRates,
                    backgroundColor: colors.slice(0, chartLabels.length),
                    borderWidth: 1,
                    borderColor: '#ffffff',
                    indexAxis: 'y' // This makes it horizontal
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const programIndex = context.dataIndex;
                                const approved = programData[programIndex].approved;
                                const total = programData[programIndex].total;
                                const rate = total > 0 ? Math.round((approved / total) * 100) : 0;
                                return [
                                    `Approved: ${approved}`,
                                    `Total Applied: ${total}`,
                                    `Approval Rate: ${rate}%`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Approval Rate (%)',
                            color: '#6B7280',
                            font: {
                                weight: 'bold'
                            }
                        },
                        beginAtZero: true
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Programs',
                            color: '#6B7280',
                            font: {
                                weight: 'bold'
                            }
                        }
                    }
                }
            }
        });

        const barCtx = document.getElementById('barChart').getContext('2d');
        new Chart(barCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'Applications',
                    data: [45, 52, 38, 67, 73, 89, 95, 78, 65, 82, 91, 76],
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    borderColor: '#3B82F6',
                    borderWidth: 2,
                    pointBackgroundColor: '#3B82F6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    tension: 0.3, // Smooth curves
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Months',
                            color: '#6B7280',
                            font: {
                                weight: 'bold'
                            }
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Number of Applications',
                            color: '#6B7280',
                            font: {
                                weight: 'bold'
                            }
                        },
                        beginAtZero: true,
                        grid: {
                            color: '#E5E7EB'
                        }
                    }
                }
            }
        });

        // Navigation functionality
        document.addEventListener('DOMContentLoaded', () => {
            const navLinks = document.querySelectorAll('.nav-link');
            const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
            const mainContentTitle = document.getElementById('mainContentTitle');
            
            // Content areas
            const dashboardContent = document.getElementById('dashboardContent');
            const cloneContent = document.getElementById('cloneContent');
            const programsContent = document.getElementById('programsContent');
            const applicantListContent = document.getElementById('applicantListContent');
            const approvedApplicantsContent = document.getElementById('approvedApplicantsContent');
            const activeJobsContent = document.getElementById('activeJobsContent');
            const archivedJobsContent = document.getElementById('archivedJobsContent');
            const trainorListContent = document.getElementById('trainorListContent');
            const overlayPage = document.getElementById('overlayPage');
            const overlayText = document.getElementById('overlayText');
            const goBackBtn = document.getElementById('goBackBtn');

            // Modal elements
            const trainerRegistrationModal = document.getElementById('trainerRegistrationModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const addTrainorBtn = document.getElementById('addTrainorBtn');
            const togglePassword = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');

            function hideAllContent() {
                dashboardContent.classList.add('hidden');
                cloneContent.classList.add('hidden');
                programsContent.classList.add('hidden');
                applicantListContent.classList.add('hidden');
                approvedApplicantsContent.classList.add('hidden');
                activeJobsContent.classList.add('hidden');
                archivedJobsContent.classList.add('hidden');
                trainorListContent.classList.add('hidden');
                document.getElementById('programManagementContent').classList.add('hidden');
                document.getElementById('documentManagementContent').classList.add('hidden');
                document.getElementById('ticketContent').classList.add('hidden');
                document.getElementById('accountsContent').classList.add('hidden');
                overlayPage.classList.remove('active');
            }

            function showContent(contentType, pageName) {
                hideAllContent();
                mainContentTitle.textContent = pageName;

                switch(contentType) {
                    case 'dashboard':
                        dashboardContent.classList.remove('hidden');
                        break;
                    case 'clone':
                        cloneContent.classList.remove('hidden');
                        // Initialize enrollments section when it's shown
                        if (typeof generateCalendar === 'function') {
                            generateCalendar();
                        }
                        if (typeof updateEventsTable === 'function') {
                            updateEventsTable();
                        }
                        if (typeof checkBatchCycleStatus === 'function') {
                            checkBatchCycleStatus();
                        }
                        break;
                    case 'programs':
                        programsContent.classList.remove('hidden');
                        break;
                    case 'applicant-list':
                        applicantListContent.classList.remove('hidden');
                        break;
                    case 'approved-applicants':
                        approvedApplicantsContent.classList.remove('hidden');
                        break;
                    case 'active-jobs':
                        activeJobsContent.classList.remove('hidden');
                        break;
                    case 'archived-jobs':
                        archivedJobsContent.classList.remove('hidden');
                        break;
                    case 'trainor-list':
                        trainorListContent.classList.remove('hidden');
                        break;
                    case 'overlay':
                        overlayText.textContent = `You are on the ${pageName} page`;
                        overlayPage.classList.add('active');
                        break;
                    case 'program-management':
                        document.getElementById('programManagementContent').classList.remove('hidden');
                        break;
                    case 'document-management':
                        document.getElementById('documentManagementContent').classList.remove('hidden');
                        break;
                    case 'ticket':
                        document.getElementById('ticketContent').classList.remove('hidden');
                        // Initialize ticket management when shown
                        if (typeof initializeTicketManagement === 'function') {
                            initializeTicketManagement();
                        }
                        break;
                }
            }

            // Navigation event listeners
            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const pageName = event.currentTarget.dataset.page;
                    const contentType = event.currentTarget.dataset.contentType;
                    showContent(contentType, pageName);
                    
                    // Update active state
                    navLinks.forEach(nav => nav.classList.remove('bg-blue-700'));
                    link.classList.add('bg-blue-700');
                });
            });

            // Dropdown toggles
            dropdownToggles.forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const dropdownMenu = toggle.nextElementSibling;
                    const dropdownChevron = toggle.querySelector('.fa-chevron-down');
                    if (dropdownMenu && dropdownChevron) {
                        dropdownMenu.classList.toggle('active');
                        dropdownChevron.classList.toggle('rotate-180');
                    }
                });
            });

            // Modal functionality
            if (addTrainorBtn) {
                addTrainorBtn.addEventListener('click', () => {
                    trainerRegistrationModal.classList.add('active');
                });
            }

            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                    trainerRegistrationModal.classList.remove('active');
                });
            }

            if (togglePassword && passwordInput) {
                togglePassword.addEventListener('click', () => {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    togglePassword.querySelector('i').classList.toggle('fa-eye');
                    togglePassword.querySelector('i').classList.toggle('fa-eye-slash');
                });
            }

            // Go back button
            if (goBackBtn) {
                goBackBtn.addEventListener('click', () => {
                    overlayPage.classList.remove('active');
                });
            }

            // Initialize with dashboard
            showContent('dashboard', 'Dashboard');
        });
        // Modal functions for applicant details
        async function openApplicantModal(profileId) {
            try {
                const modal = document.getElementById('applicantModal');
                if (!modal) {
                    console.error('Applicant modal not found');
                    alert('Modal not found. Please refresh the page.');
                    return;
                }
                
                modal.classList.add('active');
                console.log('Modal opened, fetching data for profile ID:', profileId);
                
                const response = await fetch(`/api/profile/${profileId}/`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const applicantData = await response.json();
                console.log('Data received:', applicantData);
                populateApplicantModal(applicantData);
            } catch (error) {
                console.error('Error fetching applicant data:', error);
                alert('Error loading applicant data: ' + error.message);
                // Keep modal open even if data loading fails
            }
        }

        function populateApplicantModal(data) {
            // Basic information
            document.getElementById('modal-entry-date').value = data.entry_date || '';
            document.getElementById('modal-last-name').value = data.last_name || '';
            document.getElementById('modal-first-name').value = data.first_name || '';
            document.getElementById('modal-middle-name').value = data.middle_name || '';
            
            // Address
            document.getElementById('modal-region-name').value = data.region_name || '';
            document.getElementById('modal-province-name').value = data.province_name || '';
            document.getElementById('modal-city-name').value = data.city_name || '';
            document.getElementById('modal-barangay-name').value = data.barangay_name || '';
            document.getElementById('modal-district').value = data.district || '';
            document.getElementById('modal-street').value = data.street || '';
            document.getElementById('modal-email').value = data.email || '';
            document.getElementById('modal-contact-number').value = data.contact_number || '';
            document.getElementById('modal-nationality').value = data.nationality || '';
            
            // Personal information
            document.getElementById('modal-sex').value = data.sex || '';
            document.getElementById('modal-civil-status').value = data.civil_status || '';
            document.getElementById('modal-employment-status').value = data.employment_status || '';
            document.getElementById('modal-monthly-income').value = data.monthly_income || '';
            document.getElementById('modal-date-hired').value = data.date_hired || '';
            document.getElementById('modal-company-name').value = data.company_name || '';
            document.getElementById('modal-birthdate').value = data.birthdate || '';
            document.getElementById('modal-age').value = data.age || '';
            
            // Birthplace
            document.getElementById('modal-birthplace-region').value = data.birthplace_regionb_name || '';
            document.getElementById('modal-birthplace-province').value = data.birthplace_provinceb_name || '';
            document.getElementById('modal-birthplace-city').value = data.birthplace_cityb_name || '';
            
            // Other information
            document.getElementById('modal-educational-attainment').value = data.educational_attainment || '';
            document.getElementById('modal-parent-guardian').value = data.parent_guardian || '';
            document.getElementById('modal-permanent-address').value = data.permanent_address || '';
            document.getElementById('modal-course-qualification').value = data.course_or_qualification || '';
            document.getElementById('modal-applicant-name').value = data.applicant_name || '';
            document.getElementById('modal-date-accomplished').value = data.date_accomplished || '';
            
            // Classifications
            const classificationsDiv = document.getElementById('modal-classifications');
            classificationsDiv.innerHTML = '';
            if (data.classifications && data.classifications.length > 0) {
                data.classifications.forEach(classification => {
                    const span = document.createElement('span');
                    span.className = 'inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2 mb-2';
                    span.textContent = classification.name;
                    classificationsDiv.appendChild(span);
                });
            } else {
                classificationsDiv.textContent = 'None specified';
            }
            
            // Disability type
            document.getElementById('modal-disability-type').textContent = data.disability_type?.name || 'None';
            
            // Disability causes
            const causesDiv = document.getElementById('modal-disability-causes');
            causesDiv.innerHTML = '';
            if (data.disability_causes && data.disability_causes.length > 0) {
                data.disability_causes.forEach(cause => {
                    const span = document.createElement('span');
                    span.className = 'inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2 mb-2';
                    span.textContent = cause.name;
                    causesDiv.appendChild(span);
                });
            } else {
                causesDiv.textContent = 'None';
            }
            
            // Profile picture
            const profilePic = document.getElementById('modal-profile-picture');
            if (data.id_picture) {
                profilePic.src = data.id_picture;
                profilePic.alt = "Profile Picture";
            } else {
                profilePic.src = "/static/default-profile.png";
                profilePic.alt = "No Profile Picture";
            }
        }

        function closeApplicantModal() {
            const modal = document.getElementById('applicantModal');
            modal.classList.remove('active');
        }

        // Modal functions for approved applicant details
        async function openApprovedModal(profileId) {
            try {
                const modal = document.getElementById('approvedModal');
                if (!modal) {
                    console.error('Approved modal not found');
                    alert('Modal not found. Please refresh the page.');
                    return;
                }
                
                modal.classList.add('active');
                console.log('Approved modal opened, fetching data for profile ID:', profileId);
                
                const response = await fetch(`/api/profile/${profileId}/`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const applicantData = await response.json();
                console.log('Approved data received:', applicantData);
                populateApprovedModal(applicantData); // Use separate function
            } catch (error) {
                console.error('Error fetching approved applicant data:', error);
                alert('Error loading applicant data: ' + error.message);
                // Keep modal open even if data loading fails
            }
        }
        
        function populateApprovedModal(data) {
            // Basic information
            document.querySelector('#approvedModal #modal-entry-date').value = data.entry_date || '';
            document.querySelector('#approvedModal #modal-last-name').value = data.last_name || '';
            document.querySelector('#approvedModal #modal-first-name').value = data.first_name || '';
            document.querySelector('#approvedModal #modal-middle-name').value = data.middle_name || '';
            
            // Address
            document.querySelector('#approvedModal #modal-region-name').value = data.region_name || '';
            document.querySelector('#approvedModal #modal-province-name').value = data.province_name || '';
            document.querySelector('#approvedModal #modal-city-name').value = data.city_name || '';
            document.querySelector('#approvedModal #modal-barangay-name').value = data.barangay_name || '';
            document.querySelector('#approvedModal #modal-district').value = data.district || '';
            document.querySelector('#approvedModal #modal-street').value = data.street || '';
            document.querySelector('#approvedModal #modal-email').value = data.email || '';
            document.querySelector('#approvedModal #modal-contact-number').value = data.contact_number || '';
            document.querySelector('#approvedModal #modal-nationality').value = data.nationality || '';
            
            // Personal information
            document.querySelector('#approvedModal #modal-sex').value = data.sex || '';
            document.querySelector('#approvedModal #modal-civil-status').value = data.civil_status || '';
            document.querySelector('#approvedModal #modal-employment-status').value = data.employment_status || '';
            document.querySelector('#approvedModal #modal-monthly-income').value = data.monthly_income || '';
            document.querySelector('#approvedModal #modal-date-hired').value = data.date_hired || '';
            document.querySelector('#approvedModal #modal-company-name').value = data.company_name || '';
            document.querySelector('#approvedModal #modal-birthdate').value = data.birthdate || '';
            document.querySelector('#approvedModal #modal-age').value = data.age || '';
            
            // Birthplace
            document.querySelector('#approvedModal #modal-birthplace-region').value = data.birthplace_regionb_name || '';
            document.querySelector('#approvedModal #modal-birthplace-province').value = data.birthplace_provinceb_name || '';
            document.querySelector('#approvedModal #modal-birthplace-city').value = data.birthplace_cityb_name || '';
            
            // Other information
            document.querySelector('#approvedModal #modal-educational-attainment').value = data.educational_attainment || '';
            document.querySelector('#approvedModal #modal-parent-guardian').value = data.parent_guardian || '';
            document.querySelector('#approvedModal #modal-permanent-address').value = data.permanent_address || '';
            document.querySelector('#approvedModal #modal-course-qualification').value = data.course_or_qualification || '';
            document.querySelector('#approvedModal #modal-applicant-name').value = data.applicant_name || '';
            document.querySelector('#approvedModal #modal-date-accomplished').value = data.date_accomplished || '';
            
            // Classifications
            const classificationsDiv = document.querySelector('#approvedModal #modal-classifications');
            classificationsDiv.innerHTML = '';
            if (data.classifications && data.classifications.length > 0) {
                data.classifications.forEach(classification => {
                    const span = document.createElement('span');
                    span.className = 'inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2 mb-2';
                    span.textContent = classification.name;
                    classificationsDiv.appendChild(span);
                });
            } else {
                classificationsDiv.textContent = 'None specified';
            }
            
            // Disability type
            document.querySelector('#approvedModal #modal-disability-type').textContent = data.disability_type?.name || 'None';
            
            // Disability causes
            const causesDiv = document.querySelector('#approvedModal #modal-disability-causes');
            causesDiv.innerHTML = '';
            if (data.disability_causes && data.disability_causes.length > 0) {
                data.disability_causes.forEach(cause => {
                    const span = document.createElement('span');
                    span.className = 'inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded mr-2 mb-2';
                    span.textContent = cause.name;
                    causesDiv.appendChild(span);
                });
            } else {
                causesDiv.textContent = 'None';
            }
            
            // Profile picture
            const profilePic = document.querySelector('#approvedModal #modal-profile-picture');
            if (data.id_picture) {
                profilePic.src = data.id_picture;
                profilePic.alt = "Profile Picture";
            } else {
                profilePic.src = "/static/default-profile.png";
                profilePic.alt = "No Profile Picture";
            }
        }

        function closeApprovedModal() {
            const modal = document.getElementById('approvedModal');
            modal.classList.remove('active');
        }

        // Decline modal functions
        function openDeclineModal(applicationId, applicantName) {
            document.getElementById('declineApplicantName').textContent = applicantName;
            document.getElementById('declineApplicationId').value = applicationId;
            // Regular program application decline
            const form = document.getElementById('declineForm');
            if (form) {
                form.action = "{% url 'decline_application' %}";
            }
            const typeInput = document.getElementById('declineType');
            if (typeInput) {
                typeInput.value = 'program';
            }
            // Reset form fields
            document.getElementById('commonReason').value = '';
            document.getElementById('declineReason').value = '';
            document.getElementById('declineModal').classList.add('active');
        }

        // Walk-in decline modal function
        function openWalkinDeclineModal(applicationId, applicantName) {
            document.getElementById('declineApplicantName').textContent = applicantName;
            document.getElementById('declineApplicationId').value = applicationId;
            // Set type to walkin
            const typeInput = document.getElementById('declineType');
            if (typeInput) {
                typeInput.value = 'walkin';
            }
            // Reset form fields
            document.getElementById('commonReason').value = '';
            document.getElementById('declineReason').value = '';
            document.getElementById('declineModal').classList.add('active');
        }

        function closeDeclineModal() {
            document.getElementById('declineModal').classList.remove('active');
        }

        // Field Review Modal functions
        function openFieldReviewModal(applicationId, applicantName) {
            document.getElementById('reviewApplicantName').textContent = applicantName;
            document.getElementById('reviewApplicationId').value = applicationId;
            document.getElementById('fieldReviewModal').classList.add('active');
            // Reset all checkboxes
            document.querySelectorAll('#fieldReviewForm input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.getElementById('reviewNotes').value = '';
        }

        function closeFieldReviewModal() {
            document.getElementById('fieldReviewModal').classList.remove('active');
        }

        function updateReasonText() {
            const select = document.getElementById("commonReason");
            const textarea = document.getElementById("declineReason");
            const selected = select.value;
            const typeInput = document.getElementById('declineType');
            const contextType = typeInput ? typeInput.value : 'program';
            
            // If "Incomplete/Incorrect Info" is selected for regular applications,
            // show field review modal. For walk-in applications, just copy the text.
            if (selected === "Incomplete/Incorrect Info" && contextType === 'program') {
                // Close decline modal
                closeDeclineModal();
                // Open field review modal with same application data
                const applicationId = document.getElementById('declineApplicationId').value;
                const applicantName = document.getElementById('declineApplicantName').textContent;
                openFieldReviewModal(applicationId, applicantName);
            } else if (selected === "Incomplete/Incorrect Info" && contextType === 'walkin') {
                // For walk-in applications, just copy the text (no field review modal)
                textarea.value = selected;
            } else if (selected && selected !== "Other") {
                textarea.value = selected;
            } else if (selected === "Other") {
                textarea.value = "";
            }
        }

        // Handle decline form submission for both regular and walk-in applications
        document.addEventListener('DOMContentLoaded', function() {
            const declineForm = document.getElementById('declineForm');
            if (declineForm) {
                declineForm.addEventListener('submit', function(e) {
                    const typeInput = document.getElementById('declineType');
                    const applicationType = typeInput ? typeInput.value : 'program';
                    const declineReason = document.getElementById('declineReason').value.trim();
                    const applicationId = document.getElementById('declineApplicationId').value;

                    // Validate reason
                    if (!declineReason) {
                        e.preventDefault();
                        showNotification('Please provide a reason for declining', 'error');
                        return false;
                    }

                    // Handle walk-in applications via AJAX
                    if (applicationType === 'walkin') {
                        e.preventDefault();
                        
                        // Show loading state
                        const submitBtn = declineForm.querySelector('button[type="submit"]');
                        const originalText = submitBtn.innerHTML;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Declining...';
                        submitBtn.disabled = true;

                        fetch(`/decline-walkin/${applicationId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ reason: declineReason })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showNotification('Walk-in application declined successfully', 'success');
                                closeDeclineModal();
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                showNotification(data.message || 'Error declining application', 'error');
                                submitBtn.innerHTML = originalText;
                                submitBtn.disabled = false;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showNotification('Error declining application', 'error');
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        });
                        
                        return false;
                    }
                    // Regular applications will submit normally via form POST
                });
            }
        });

        // PDF download function
        function downloadApplicantProfileAsPDF(profileId, username, programName) {
            fetch(`/api/profile/${profileId}/`)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then((data) => {
                    const tempModal = createTempModalForPDF(data, username, programName);
                    const opt = {
                        margin: [10, 10, 10, 10],
                        filename: `${username.replace(/\s+/g, "_")}_${programName.replace(/\s+/g, "_")}_Profile.pdf`,
                        image: { type: "jpeg", quality: 0.98 },
                        html2canvas: {
                            scale: 2,
                            useCORS: true,
                            letterRendering: true,
                        },
                        jsPDF: {
                            unit: "mm",
                            format: "a4",
                            orientation: "portrait",
                        },
                    };
                    return window.html2pdf().set(opt).from(tempModal).save();
                })
                .then(() => {
                    console.log("PDF downloaded successfully");
                })
                .catch((error) => {
                    console.error("Error generating PDF:", error);
                    alert("Error generating PDF. Please try again.");
                });
        }

        function createTempModalForPDF(data, username, programName) {
            const tempDiv = document.createElement("div");
            tempDiv.style.cssText = `
                font-family: Arial, sans-serif;
                padding: 20px;
                background: white;
                color: black;
                max-width: 800px;
                margin: 0 auto;
                line-height: 1.4;
            `;

            tempDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1e40af; padding-bottom: 15px;">
                    <h1 style="color: #1e40af; margin: 0; font-size: 24px;">DLL-LMSTC Registration Form</h1>
                    <h2 style="color: #374151; margin: 10px 0; font-size: 18px;">LEARNERS PROFILE FORM</h2>
                    <h3 style="color: #374151; margin: 5px 0; font-size: 16px;">Applicant: ${username}</h3>
                    <h3 style="color: #374151; margin: 5px 0; font-size: 16px;">Program: ${programName}</h3>
                </div>
                <!-- Add more PDF content here -->
            `;

            return tempDiv;
        }

        // Job posting functions
        function openAddJobModal() {
            document.getElementById('addJobModal').classList.remove('hidden');
        }

        function closeAddJobModal() {
            document.getElementById('addJobModal').classList.add('hidden');
        }

        // Skills functionality
        document.addEventListener('DOMContentLoaded', function() {
            const skillButtons = document.querySelectorAll('.skill-btn');
            const skillContainer = document.getElementById('skillContainer');
            
            if (skillButtons.length > 0 && skillContainer) {
                skillButtons.forEach(button => {
                    button.addEventListener('click', function () {
                        const skillName = button.textContent.trim();
                        
                        // Check if skill already exists
                        const existingTags = [...skillContainer.querySelectorAll('.tag')];
                        if (existingTags.some(tag => tag.dataset.skill === skillName)) {
                            return; // Already added, do nothing
                        }
                        
                        // Create tag element
                        const tag = document.createElement('div');
                        tag.className = 'tag flex items-center bg-blue-100 text-blue-800 rounded-full px-3 py-1 text-sm';
                        tag.dataset.skill = skillName;
                        tag.innerHTML = `
                            <span>${skillName}</span>
                            <button type="button" class="ml-2 text-blue-500 hover:text-blue-700 font-bold">&times;</button>
                        `;
                        
                        // Add hidden input for form submission
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = 'skills[]';
                        hiddenInput.value = skillName;
                        tag.appendChild(hiddenInput);
                        
                        // Add remove functionality
                        tag.querySelector('button').addEventListener('click', () => {
                            skillContainer.removeChild(tag);
                        });
                        
                        skillContainer.appendChild(tag);
                    });
                });
            }
        });

        // Add these JavaScript functions to your existing script section
        function openViewModals(button) {
            // Populate fields from data attributes
            document.getElementById('view-title').value = button.dataset.title || '';
            document.getElementById('view-company').value = button.dataset.company || '';
            document.getElementById('view-address').value = button.dataset.address || '';
            document.getElementById('view-description').value = button.dataset.description || '';
            document.getElementById('view-availability').value = button.dataset.availability || '';
            document.getElementById('view-program').value = button.dataset.program || '';
            document.getElementById('view-email').value = button.dataset.email || '';
            
            // Store job ID for updates
            document.getElementById('viewJobModal').dataset.jobId = button.dataset.jobId;
            
            // Populate skills
            const skillContainer = document.getElementById('view-skills');
            skillContainer.innerHTML = '';
            
            if (button.dataset.skills && button.dataset.skills.trim() !== '') {
                const skills = button.dataset.skills.split(',');
                skills.forEach(skill => {
                    if (skill.trim()) {
                        const tag = document.createElement('div');
                        tag.className = 'bg-blue-100 px-3 py-1 rounded-full';
                        tag.textContent = skill.trim();
                        skillContainer.appendChild(tag);
                    }
                });
            } else {
                const noSkills = document.createElement('div');
                noSkills.className = 'text-gray-500 italic';
                noSkills.textContent = 'No skills specified';
                skillContainer.appendChild(noSkills);
            }
            
            // Reset to view mode
            resetToViewMode();
            
            // Show modal
            document.getElementById('viewJobModal').classList.remove('hidden');
        }

        function closeViewJobModal() {
            document.getElementById('viewJobModal').classList.add('hidden');
            resetToViewMode();
        }

        function toggleEditMode() {
            console.log("Edit mode toggled");
            
            // Enable input fields for editing
            document.getElementById('view-title').disabled = false;
            document.getElementById('view-company').disabled = false;
            document.getElementById('view-address').disabled = false;
            document.getElementById('view-description').disabled = false;
            document.getElementById('view-availability').disabled = false;
            document.getElementById('view-program').disabled = false;
            document.getElementById('view-email').disabled = false;
            
            // Change background color to indicate editing
            const inputs = ['view-title', 'view-company', 'view-address', 'view-description', 'view-availability', 'view-program', 'view-email'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                input.classList.remove('bg-gray-100');
                input.classList.add('bg-white');
            });
            
            // Hide Edit button and show Update button
            document.getElementById('edit-button').classList.add('hidden');
            document.getElementById('update-button').classList.remove('hidden');
        }

        function resetToViewMode() {
            // Disable input fields
            const inputs = ['view-title', 'view-company', 'view-address', 'view-description', 'view-availability', 'view-program', 'view-email'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                input.disabled = true;
                input.classList.remove('bg-white');
                input.classList.add('bg-gray-100');
            });
            
            // Show Edit button and hide Update button
            document.getElementById('edit-button').classList.remove('hidden');
            document.getElementById('update-button').classList.add('hidden');
        }

        function updateJobDetails() {
            const jobId = document.getElementById('viewJobModal').dataset.jobId;
            
            // Collect updated values
            const updatedData = {
                job_title: document.getElementById('view-title').value,
                company: document.getElementById('view-company').value,
                address: document.getElementById('view-address').value,
                job_description: document.getElementById('view-description').value,
                availability: document.getElementById('view-availability').value,
                program: document.getElementById('view-program').value,
                email_or_link: document.getElementById('view-email').value
            };
            
            // Log updated values (you can replace this with actual AJAX call to your Django backend)
            console.log('Job ID:', jobId);
            console.log('Updated Data:', updatedData);
            
            // Example AJAX call to update job (uncomment and modify according to your Django URLs)
            /*
            fetch(`/update-job/${jobId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(updatedData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success notification
                    showNotification('Job updated successfully!', 'success');
                    
                    // Update the table row with new data
                    updateJobTableRow(jobId, updatedData);
                    
                    // Close modal
                    closeViewJobModal();
                } else {
                    showNotification('Error updating job: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error updating job. Please try again.', 'error');
            });
            */
            
            // For now, just show a success message and reset to view mode
            showNotification('Job details updated successfully!', 'success');
            resetToViewMode();
        }

        // Helper function to show notifications
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type} active`;
            notification.innerHTML = `
                <i class="icon fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            const container = document.getElementById('notificationContainer');
            container.appendChild(notification);
            
            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.classList.remove('active');
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        // Helper function to update table row after successful update
        function updateJobTableRow(jobId, updatedData) {
            // Find the table row and update the job title
            const tableRows = document.querySelectorAll('#activeJobsContent tbody tr');
            tableRows.forEach(row => {
                const viewButton = row.querySelector('button[data-job-id="' + jobId + '"]');
                if (viewButton) {
                    // Update the job title in the table
                    const titleCell = row.querySelector('td:first-child');
                    if (titleCell) {
                        titleCell.textContent = updatedData.job_title;
                    }
                    
                    // Update button data attributes
                    viewButton.dataset.title = updatedData.job_title;
                    viewButton.dataset.company = updatedData.company;
                    viewButton.dataset.address = updatedData.address;
                    viewButton.dataset.description = updatedData.job_description;
                    viewButton.dataset.availability = updatedData.availability;
                    viewButton.dataset.program = updatedData.program;
                    viewButton.dataset.email = updatedData.email_or_link;
                }
            });
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('viewJobModal');
            if (event.target === modal) {
                closeViewJobModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('viewJobModal');
                if (!modal.classList.contains('hidden')) {
                    closeViewJobModal();
                }
            }
        });

        // Walk-in Modal Functionality - New 3-Step Process
        function openWalkinModal() {
            document.getElementById('walkinModal').classList.add('active');
            showWalkinStep(1);
            // Reset form data
            document.getElementById('walkinFullName').value = '';
            document.getElementById('walkinProgram').value = '';
            document.getElementById('walkinApplicantId').value = '';
            document.getElementById('walkinApplicationId').value = '';
        }

        function closeWalkinModal() {
            document.getElementById('walkinModal').classList.remove('active');
            showWalkinStep(1);
        }

        function showWalkinStep(step) {
            // Hide all steps
            document.getElementById('walkinStep1').style.display = 'none';
            document.getElementById('walkinStep2').style.display = 'none';
            document.getElementById('walkinStep3').style.display = 'none';
            
            // Show the requested step
            document.getElementById('walkinStep' + step).style.display = 'block';
        }

        // Step 1: Create Account
        function createWalkinAccount() {
            const fullName = document.getElementById('walkinFullName').value.trim();
            
            if (!fullName) {
                showNotification('Please enter the applicant\'s full name.', 'error');
                return;
            }

            // Show loading state
            const btn = document.querySelector('#walkinStep1 button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating Account...';
            btn.disabled = true;

            // Send request to create account
            fetch('/create-walkin-account/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    full_name: fullName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Store applicant data
                    document.getElementById('walkinApplicantId').value = data.applicant_id;
                    document.getElementById('walkinUsername').textContent = data.username;
                    document.getElementById('walkinPassword').textContent = data.password;
                    
                    // Move to step 2
                    showWalkinStep(2);
                    showNotification('Account created successfully! Now select a program.', 'success');
                } else {
                    showNotification(data.message || 'Failed to create account', 'error');
                }
                
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred while creating the account', 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // Step 2: Apply to Program
        function applyWalkinProgram() {
            const applicantId = document.getElementById('walkinApplicantId').value;
            const programId = document.getElementById('walkinProgram').value;
            
            if (!programId) {
                showNotification('Please select a program.', 'error');
                return;
            }

            // Show loading state
            const btn = document.querySelector('#walkinStep2 button[onclick="applyWalkinProgram()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';
            btn.disabled = true;

            // Send request to apply to program
            fetch('/apply-walkin-program/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    applicant_id: applicantId,
                    program_id: programId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Store application data
                    document.getElementById('walkinApplicationId').value = data.application_id;
                    document.getElementById('walkinQueueNumber').textContent = data.queue_number;
                    
                    // Move to step 3
                    showWalkinStep(3);
                    showNotification('Walk-in application submitted successfully!', 'success');
                    
                    // Refresh the page after a delay to show updated counts
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                } else {
                    showNotification(data.message || 'Failed to submit application', 'error');
                }
                
                // Reset button
                btn.innerHTML = originalText;
                btn.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred while submitting the application', 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // Walk-in Applicant Details Modal Functions
        function viewWalkinApplicantDetails(username, fullName, status, queueNumber) {
            const modal = document.getElementById('walkinDetailsModal');
            if (!modal) {
                console.error('Walk-in details modal not found');
                return;
            }

            // Set the modal content
            document.getElementById('walkinDetailsName').textContent = fullName || 'N/A';
            document.getElementById('walkinDetailsUsername').textContent = username || '-';
            document.getElementById('walkinDetailsPassword').textContent = 'lmstc';
            
            // Set status with appropriate styling
            const statusDiv = document.getElementById('walkinDetailsStatus');
            const statusText = document.getElementById('walkinDetailsStatusText');
            const statusIcon = document.getElementById('walkinDetailsStatusIcon');
            statusText.textContent = status || 'N/A';
            
            // Update status badge color and icon based on status
            statusDiv.className = 'rounded px-3 py-2';
            if (status === 'Approved') {
                statusDiv.className += ' bg-green-100 border border-green-300 text-green-800';
                statusIcon.innerHTML = '<i class="fas fa-check-circle mr-2"></i>';
            } else if (status === 'Pending') {
                statusDiv.className += ' bg-yellow-100 border border-yellow-300 text-yellow-800';
                statusIcon.innerHTML = '<i class="fas fa-clock mr-2"></i>';
            } else if (status === 'Declined') {
                statusDiv.className += ' bg-red-100 border border-red-300 text-red-800';
                statusIcon.innerHTML = '<i class="fas fa-times-circle mr-2"></i>';
            } else {
                statusDiv.className += ' bg-gray-100 border border-gray-300 text-gray-800';
                statusIcon.innerHTML = '<i class="fas fa-info-circle mr-2"></i>';
            }
            
            document.getElementById('walkinDetailsQueue').textContent = queueNumber || '-';
            
            // Show the modal
            modal.classList.add('active');
        }

        function closeWalkinDetailsModal() {
            const modal = document.getElementById('walkinDetailsModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // Age calculation function
        function calculateAge() {
            const birthdate = document.getElementById('birthdate').value;
            if (birthdate) {
                const today = new Date();
                const birth = new Date(birthdate);
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                
                document.getElementById('age').value = age;
            }
        }

        // Event listeners for walk-in modal
        document.addEventListener('DOMContentLoaded', function() {
            // New Walk-in button
            const newWalkinBtn = document.getElementById('newWalkinBtn');
            if (newWalkinBtn) {
                newWalkinBtn.addEventListener('click', openWalkinModal);
            }

            // Modal close buttons
            const walkinCloseBtn = document.getElementById('walkinCloseBtn');
            if (walkinCloseBtn) {
                walkinCloseBtn.addEventListener('click', closeWalkinModal);
            }

            // Step navigation buttons
            const walkinNextBtn = document.getElementById('walkinNextBtn');
            if (walkinNextBtn) {
                walkinNextBtn.addEventListener('click', nextWalkinStep);
            }

            const walkinPrevBtn = document.getElementById('walkinPrevBtn');
            if (walkinPrevBtn) {
                walkinPrevBtn.addEventListener('click', prevWalkinStep);
            }

            // Age calculation
            const birthdateInput = document.getElementById('birthdate');
            if (birthdateInput) {
                birthdateInput.addEventListener('change', calculateAge);
            }

            // Close modal when clicking outside
            const walkinModal = document.getElementById('walkinModal');
            if (walkinModal) {
                walkinModal.addEventListener('click', function(event) {
                    if (event.target === walkinModal) {
                        closeWalkinModal();
                    }
                });
            }

            // Walk-in Details Modal click outside to close
            const walkinDetailsModal = document.getElementById('walkinDetailsModal');
            if (walkinDetailsModal) {
                walkinDetailsModal.addEventListener('click', function(event) {
                    if (event.target === walkinDetailsModal) {
                        closeWalkinDetailsModal();
                    }
                });
            }

            // Address cascade functionality (if needed)
            // You can add region/province/city/barangay dropdown population here
            // similar to the Registration_f1.html implementation
        });

        // Form validation before submission
        function validateWalkinForm() {
            const requiredFields = [
                'first_name', 'last_name', 'sex', 'birthdate', 'contact_no'
            ];

            for (let field of requiredFields) {
                const element = document.getElementById(field);
                if (element && !element.value.trim()) {
                    alert(`Please fill in the ${field.replace('_', ' ')} field.`);
                    element.focus();
                    return false;
                }
            }

            return true;
        }

        // Handle form submission
        document.addEventListener('DOMContentLoaded', function() {
            const walkinForm = document.getElementById('walkinForm');
            if (walkinForm) {
                walkinForm.addEventListener('submit', function(event) {
                    if (!validateWalkinForm()) {
                        event.preventDefault();
                        return false;
                    }
                    // Form will submit normally if validation passes
                });
            }
        });

        // Add Program Modal Functionality
        function openAddProgramModal() {
            document.getElementById('addProgramModal').classList.add('active');
        }

        function closeAddProgramModal() {
            document.getElementById('addProgramModal').classList.remove('active');
            // Reset form
            document.getElementById('addProgramForm').reset();
            // Reset competencies data
            resetCompetenciesData(false);
        }

        // ==================== PROGRAM COMPETENCIES MANAGEMENT ====================
        
        // Global counter for unique IDs
        let competencyCounter = 0;
        
        // Data structure to hold competencies
        let competenciesData = {
            basic: [],
            common: [],
            core: []
        };
        
        let editCompetenciesData = {
            basic: [],
            common: [],
            core: []
        };
        
        // Data structure to hold job opportunities
        let jobOpportunities = [];
        let editJobOpportunities = [];
        let jobCounter = 0;
        
        // Switch between competency tabs (Add Modal)
        function switchCompetencyTab(type) {
            // Hide all tabs
            document.querySelectorAll('.competency-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active styling from all tab buttons
            document.querySelectorAll('#addProgramModal .competency-tab').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('text-gray-500');
            });
            
            // Show selected tab
            document.getElementById(type + 'Competencies').classList.remove('hidden');
            
            // Add active styling to selected tab button
            const activeBtn = document.getElementById(type + 'Tab');
            activeBtn.classList.add('border-blue-500', 'text-blue-600');
            activeBtn.classList.remove('text-gray-500');
        }
        
        // Switch between competency tabs (Edit Modal)
        function switchEditCompetencyTab(type) {
            // Hide all tabs
            document.querySelectorAll('#editProgramModal .competency-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active styling from all tab buttons
            document.querySelectorAll('#editProgramModal .competency-tab').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('text-gray-500');
            });
            
            // Show selected tab
            document.getElementById('edit' + type.charAt(0).toUpperCase() + type.slice(1) + 'Competencies').classList.remove('hidden');
            
            // Add active styling to selected tab button
            const activeBtn = document.getElementById('edit' + type.charAt(0).toUpperCase() + type.slice(1) + 'Tab');
            activeBtn.classList.add('border-blue-500', 'text-blue-600');
            activeBtn.classList.remove('text-gray-500');
        }
        
        // Add a new competency (Add Modal)
        function addCompetency(type) {
            const id = competencyCounter++;
            const competency = {
                id: id,
                name: '',
                learning_outcomes: []
            };
            
            competenciesData[type].push(competency);
            renderCompetency(type, competency, false);
        }
        
        // Add a new competency (Edit Modal)
        function addEditCompetency(type) {
            const id = competencyCounter++;
            const competency = {
                id: id,
                name: '',
                learning_outcomes: []
            };
            
            editCompetenciesData[type].push(competency);
            renderCompetency(type, competency, true);
        }
        
        // Render a competency in the UI
        function renderCompetency(type, competency, isEdit) {
            const prefix = isEdit ? 'edit' : '';
            const listId = prefix + type.charAt(0).toUpperCase() + type.slice(1) + 'CompetenciesList';
            const container = document.getElementById(listId);
            
            const competencyDiv = document.createElement('div');
            competencyDiv.className = 'border border-gray-300 rounded-lg p-3 bg-gray-50';
            competencyDiv.id = `${prefix}competency-${type}-${competency.id}`;
            
            competencyDiv.innerHTML = `
                <div class="mb-2">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-semibold text-gray-700">Competency Name</label>
                        <button type="button" onclick="removeCompetency('${type}', ${competency.id}, ${isEdit})" 
                                class="text-red-500 hover:text-red-700 text-xs">
                            <i class="fas fa-times"></i> Remove
                        </button>
                    </div>
                    <input type="text" 
                           class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" 
                           placeholder="Enter competency name (e.g., Communication Skills)"
                           value="${competency.name}"
                           onchange="updateCompetencyName('${type}', ${competency.id}, this.value, ${isEdit})">
                </div>
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-semibold text-gray-700">Learning Outcomes</label>
                        <button type="button" onclick="addLearningOutcome('${type}', ${competency.id}, ${isEdit})" 
                                class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                            <i class="fas fa-plus"></i> Add Outcome
                        </button>
                    </div>
                    <div id="${prefix}outcomes-${type}-${competency.id}" class="space-y-1">
                        ${competency.learning_outcomes.map((outcome, index) => 
                            renderLearningOutcomeHTML(type, competency.id, index, outcome, isEdit)
                        ).join('')}
                    </div>
                </div>
            `;
            
            container.appendChild(competencyDiv);
        }
        
        // Render learning outcome HTML
        function renderLearningOutcomeHTML(type, compId, outcomeIndex, outcome, isEdit) {
            const prefix = isEdit ? 'edit' : '';
            return `
                <div class="flex gap-2" id="${prefix}outcome-${type}-${compId}-${outcomeIndex}">
                    <input type="text" 
                           class="flex-1 px-2 py-1 text-xs border border-gray-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-400" 
                           placeholder="Learning outcome description"
                           value="${outcome}"
                           onchange="updateLearningOutcome('${type}', ${compId}, ${outcomeIndex}, this.value, ${isEdit})">
                    <button type="button" onclick="removeLearningOutcome('${type}', ${compId}, ${outcomeIndex}, ${isEdit})" 
                            class="text-red-500 hover:text-red-700 text-xs px-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }
        
        // Update competency name
        function updateCompetencyName(type, id, value, isEdit) {
            const data = isEdit ? editCompetenciesData : competenciesData;
            const competency = data[type].find(c => c.id === id);
            if (competency) {
                competency.name = value;
                updateHiddenInput(isEdit);
            }
        }
        
        // Add learning outcome
        function addLearningOutcome(type, compId, isEdit) {
            const data = isEdit ? editCompetenciesData : competenciesData;
            const competency = data[type].find(c => c.id === compId);
            if (competency) {
                competency.learning_outcomes.push('');
                const outcomeIndex = competency.learning_outcomes.length - 1;
                
                const prefix = isEdit ? 'edit' : '';
                const container = document.getElementById(`${prefix}outcomes-${type}-${compId}`);
                const outcomeDiv = document.createElement('div');
                outcomeDiv.innerHTML = renderLearningOutcomeHTML(type, compId, outcomeIndex, '', isEdit);
                container.appendChild(outcomeDiv.firstElementChild);
                
                updateHiddenInput(isEdit);
            }
        }
        
        // Update learning outcome
        function updateLearningOutcome(type, compId, outcomeIndex, value, isEdit) {
            const data = isEdit ? editCompetenciesData : competenciesData;
            const competency = data[type].find(c => c.id === compId);
            if (competency && competency.learning_outcomes[outcomeIndex] !== undefined) {
                competency.learning_outcomes[outcomeIndex] = value;
                updateHiddenInput(isEdit);
            }
        }
        
        // Remove learning outcome
        function removeLearningOutcome(type, compId, outcomeIndex, isEdit) {
            const data = isEdit ? editCompetenciesData : competenciesData;
            const competency = data[type].find(c => c.id === compId);
            if (competency) {
                competency.learning_outcomes.splice(outcomeIndex, 1);
                
                // Re-render all outcomes for this competency
                const prefix = isEdit ? 'edit' : '';
                const container = document.getElementById(`${prefix}outcomes-${type}-${compId}`);
                container.innerHTML = competency.learning_outcomes.map((outcome, index) => 
                    renderLearningOutcomeHTML(type, compId, index, outcome, isEdit)
                ).join('');
                
                updateHiddenInput(isEdit);
            }
        }
        
        // Remove competency
        function removeCompetency(type, id, isEdit) {
            const data = isEdit ? editCompetenciesData : competenciesData;
            const index = data[type].findIndex(c => c.id === id);
            if (index !== -1) {
                data[type].splice(index, 1);
                
                const prefix = isEdit ? 'edit' : '';
                const element = document.getElementById(`${prefix}competency-${type}-${id}`);
                if (element) {
                    element.remove();
                }
                
                updateHiddenInput(isEdit);
            }
        }
        
        // Update hidden input with JSON data
        function updateHiddenInput(isEdit) {
            const data = isEdit ? editCompetenciesData : competenciesData;
            const inputId = isEdit ? 'editProgramCompetenciesData' : 'programCompetenciesData';
            
            // Clean up data - remove id field and empty entries
            const cleanData = {
                basic: data.basic.map(c => ({
                    name: c.name,
                    learning_outcomes: (c.learning_outcomes || []).filter(o => o.trim() !== '')
                })).filter(c => (c.name || '').trim() !== ''),
                common: data.common.map(c => ({
                    name: c.name,
                    learning_outcomes: (c.learning_outcomes || []).filter(o => o.trim() !== '')
                })).filter(c => (c.name || '').trim() !== ''),
                core: data.core.map(c => ({
                    name: c.name,
                    learning_outcomes: (c.learning_outcomes || []).filter(o => o.trim() !== '')
                })).filter(c => (c.name || '').trim() !== '')
            };
            
            // Ensure job opportunities are preserved
            const jobOps = Array.isArray(data.job_opportunities)
                ? data.job_opportunities.filter(n => n && n.trim() !== '')
                : [];
            
            // Backward-compatibility keys so existing templates keep working
            const compatibilityData = {
                basic_competencies: cleanData.basic.map(c => c.name),
                common_competencies: cleanData.common.map(c => c.name),
                core_competencies: cleanData.core.map(c => c.name)
            };
            
            const finalData = {
                ...cleanData,
                ...compatibilityData,
                job_opportunities: jobOps
            };
            
            document.getElementById(inputId).value = JSON.stringify(finalData);
        }
        
        // Load existing competencies when editing
        function loadExistingCompetencies(competenciesJson) {
            // Reset edit data
            editCompetenciesData = {
                basic: [],
                common: [],
                core: []
            };
            
            // Clear existing UI
            ['basic', 'common', 'core'].forEach(type => {
                const listId = 'edit' + type.charAt(0).toUpperCase() + type.slice(1) + 'CompetenciesList';
                const container = document.getElementById(listId);
                if (container) {
                    container.innerHTML = '';
                }
            });
            
            if (!competenciesJson || competenciesJson === 'null' || competenciesJson === '{}') {
                return;
            }
            
            try {
                const raw = typeof competenciesJson === 'string' ? JSON.parse(competenciesJson) : competenciesJson;

                // Normalize to the new shape { basic: [{name, learning_outcomes:[]}, ...], common: [...], core: [...] }
                const normalized = { basic: [], common: [], core: [] };

                // Helper to push items into normalized structure
                function pushItems(type, items) {
                    if (!Array.isArray(items)) return;
                    items.forEach(it => {
                        const id = competencyCounter++;
                        if (typeof it === 'string') {
                            normalized[type].push({ id, name: it, learning_outcomes: [] });
                        } else if (it && typeof it === 'object') {
                            normalized[type].push({
                                id,
                                name: it.name || '',
                                learning_outcomes: Array.isArray(it.learning_outcomes) ? it.learning_outcomes : []
                            });
                        }
                    });
                }

                // Prefer new keys if present
                if (raw.basic || raw.common || raw.core) {
                    pushItems('basic', raw.basic || []);
                    pushItems('common', raw.common || []);
                    pushItems('core', raw.core || []);
                } else {
                    // Fallback to old keys basic_competencies/common_competencies/core_competencies (arrays of strings)
                    pushItems('basic', raw.basic_competencies || []);
                    pushItems('common', raw.common_competencies || []);
                    pushItems('core', raw.core_competencies || []);
                }

                // Apply normalized data into editCompetenciesData and render
                ['basic', 'common', 'core'].forEach(type => {
                    normalized[type].forEach(comp => {
                        editCompetenciesData[type].push({
                            id: comp.id,
                            name: comp.name,
                            learning_outcomes: comp.learning_outcomes
                        });
                        renderCompetency(type, comp, true);
                    });
                });

                // Load job opportunities (supported in both shapes)
                if (raw.job_opportunities) {
                    loadJobOpportunities(raw.job_opportunities, true);
                }

                updateHiddenInput(true);
            } catch (e) {
                console.error('Error loading competencies:', e);
            }
        }
        // Reset competencies data when modal closes
        function resetCompetenciesData(isEdit) {
            if (isEdit) {
                editCompetenciesData = {
                    basic: [],
                    common: [],
                    core: []
                };
                ['basic', 'common', 'core'].forEach(type => {
                    const listId = 'edit' + type.charAt(0).toUpperCase() + type.slice(1) + 'CompetenciesList';
                    const container = document.getElementById(listId);
                    if (container) {
                        container.innerHTML = '';
                    }
                });
                // Reset job opportunities
                editJobOpportunities = [];
                const jobContainer = document.getElementById('editJobOpportunitiesList');
                if (jobContainer) {
                    jobContainer.innerHTML = '';
                }
            } else {
                competenciesData = {
                    basic: [],
                    common: [],
                    core: []
                };
                ['basic', 'common', 'core'].forEach(type => {
                    const listId = type.charAt(0).toUpperCase() + type.slice(1) + 'CompetenciesList';
                    const container = document.getElementById(listId);
                    if (container) {
                        container.innerHTML = '';
                    }
                });
                // Reset job opportunities
                jobOpportunities = [];
                const jobContainer = document.getElementById('jobOpportunitiesList');
                if (jobContainer) {
                    jobContainer.innerHTML = '';
                }
            }
        }
        
        // ==================== JOB OPPORTUNITIES MANAGEMENT ====================
        
        // Add a job opportunity
        function addJobOpportunity(isEdit) {
            const id = jobCounter++;
            const opportunities = isEdit ? editJobOpportunities : jobOpportunities;
            opportunities.push({ id: id, name: '' });
            renderJobOpportunity(id, '', isEdit);
            updateJobOpportunitiesHidden(isEdit);
        }
        
        // Render a job opportunity in the UI
        function renderJobOpportunity(id, name, isEdit) {
            const prefix = isEdit ? 'edit' : '';
            const listId = prefix + 'JobOpportunitiesList';
            const container = document.getElementById(listId);
            
            const jobDiv = document.createElement('div');
            jobDiv.className = 'flex gap-2';
            jobDiv.id = `${prefix}job-${id}`;
            
            jobDiv.innerHTML = `
                <input type="text" 
                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-purple-500" 
                       placeholder="e.g., Automotive Mechanic, Building Electrician"
                       value="${name}"
                       onchange="updateJobOpportunity(${id}, this.value, ${isEdit})">
                <button type="button" onclick="removeJobOpportunity(${id}, ${isEdit})" 
                        class="text-red-500 hover:text-red-700 text-sm px-3 py-2 border border-red-300 rounded hover:bg-red-50">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            container.appendChild(jobDiv);
        }
        
        // Update job opportunity value
        function updateJobOpportunity(id, value, isEdit) {
            const opportunities = isEdit ? editJobOpportunities : jobOpportunities;
            const job = opportunities.find(j => j.id === id);
            if (job) {
                job.name = value;
                updateJobOpportunitiesHidden(isEdit);
            }
        }
        
        // Remove job opportunity
        function removeJobOpportunity(id, isEdit) {
            const opportunities = isEdit ? editJobOpportunities : jobOpportunities;
            const index = opportunities.findIndex(j => j.id === id);
            if (index > -1) {
                opportunities.splice(index, 1);
                const prefix = isEdit ? 'edit' : '';
                const jobElement = document.getElementById(`${prefix}job-${id}`);
                if (jobElement) {
                    jobElement.remove();
                }
                updateJobOpportunitiesHidden(isEdit);
            }
        }
        
        // Update hidden input with job opportunities data
        function updateJobOpportunitiesHidden(isEdit) {
            const opportunities = isEdit ? editJobOpportunities : jobOpportunities;
            // Filter out empty job opportunities
            const cleanOpportunities = opportunities
                .map(j => j.name)
                .filter(name => name && name.trim() !== '');
            
            // Job opportunities are part of competencies data
            const data = isEdit ? editCompetenciesData : competenciesData;
            data.job_opportunities = cleanOpportunities;
            updateHiddenInput(isEdit);
        }
        
        // Load existing job opportunities when editing
        function loadJobOpportunities(opportunitiesArray, isEdit) {
            const opportunities = isEdit ? editJobOpportunities : jobOpportunities;
            const prefix = isEdit ? 'edit' : '';
            const container = document.getElementById(prefix + 'JobOpportunitiesList');
            
            // Clear existing
            opportunities.length = 0;
            if (container) {
                container.innerHTML = '';
            }
            
            // Load new opportunities
            if (Array.isArray(opportunitiesArray)) {
                opportunitiesArray.forEach(jobName => {
                    if (jobName && jobName.trim() !== '') {
                        const id = jobCounter++;
                        opportunities.push({ id: id, name: jobName });
                        renderJobOpportunity(id, jobName, isEdit);
                    }
                });
            }
        }
        
        // ==================== END JOB OPPORTUNITIES MANAGEMENT ====================
        
        // ==================== END PROGRAM COMPETENCIES MANAGEMENT ====================
        
        // Add Program Modal Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Add Program button
            const addProgramBtn = document.getElementById('addProgramBtn');
            if (addProgramBtn) {
                addProgramBtn.addEventListener('click', openAddProgramModal);
            }

            // Close modal button
            const closeProgramModalBtn = document.getElementById('closeProgramModalBtn');
            if (closeProgramModalBtn) {
                closeProgramModalBtn.addEventListener('click', closeAddProgramModal);
            }

            // Close modal when clicking outside
            const addProgramModal = document.getElementById('addProgramModal');
            if (addProgramModal) {
                addProgramModal.addEventListener('click', function(event) {
                    if (event.target === addProgramModal) {
                        closeAddProgramModal();
                    }
                });
            }

            // Handle form submission with confirmation
            const addProgramForm = document.getElementById('addProgramForm');
            if (addProgramForm) {
                addProgramForm.addEventListener('submit', function(event) {
                    // Update hidden input with competencies data before validation
                    updateHiddenInput(false);
                    
                    const programName = document.getElementById('programName').value.trim();
                    const programDescription = document.getElementById('programDescription').value.trim();
                    const programSchedule = document.getElementById('programSchedule').value.trim();

                    if (!programName || !programDescription || !programSchedule) {
                        event.preventDefault();
                        alert('Please fill in all required fields (Program Name, Description, and Schedule).');
                        return false;
                    }

                    // Show confirmation dialog
                    if (!confirm(`Are you sure you want to add the program "${programName}"?`)) {
                        event.preventDefault();
                        return false;
                    }

                    // Show loading state
                    const submitBtn = addProgramForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding Program...';
                    submitBtn.disabled = true;

                    // Form will submit normally if validation passes
                    // The loading state will be reset when the page reloads
                });
            }

            // Program Search Functionality
            const programSearchFilter = document.getElementById('programSearchFilter');
            if (programSearchFilter) {
                programSearchFilter.addEventListener('input', function() {
                    filterPrograms();
                });
            }
        });

        // Program Search/Filter Function
        function filterPrograms() {
            const searchTerm = document.getElementById('programSearchFilter').value.toLowerCase().trim();
            const programRows = document.querySelectorAll('#programTableBody tr');
            let visibleCount = 0;

            programRows.forEach(row => {
                // Skip the "no data" row
                if (row.id === 'programNoDataRow') {
                    return;
                }

                const programName = row.querySelector('td:first-child')?.textContent?.toLowerCase() || '';
                const programTrainer = row.querySelector('td:nth-child(3)')?.textContent?.toLowerCase() || '';
                const programSkills = row.querySelector('td:nth-child(4)')?.textContent?.toLowerCase() || '';
                const programSchedule = row.querySelector('td:nth-child(2)')?.textContent?.toLowerCase() || '';

                // Check if search term matches any of the program data
                const isVisible = searchTerm === '' || 
                    programName.includes(searchTerm) ||
                    programTrainer.includes(searchTerm) ||
                    programSkills.includes(searchTerm) ||
                    programSchedule.includes(searchTerm);

                if (isVisible) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Update pagination info
            updateProgramPaginationInfo(visibleCount, searchTerm);

            // Show/hide no results message
            showNoResultsMessage(visibleCount, searchTerm);
        }

        // Update pagination information for filtered results
        function updateProgramPaginationInfo(visibleCount, searchTerm) {
            const paginationInfo = document.getElementById('programPaginationInfo');
            if (paginationInfo) {
                if (searchTerm === '') {
                    // Show original count when no search
                    const totalPrograms = document.querySelectorAll('#programTableBody tr:not(#programNoDataRow)').length;
                    paginationInfo.textContent = totalPrograms > 0 ? 
                        `Showing ${totalPrograms} program${totalPrograms !== 1 ? 's' : ''} total` : 
                        'Showing 0 programs';
                } else {
                    // Show filtered count
                    paginationInfo.textContent = `Showing ${visibleCount} program${visibleCount !== 1 ? 's' : ''} matching "${searchTerm}"`;
                }
            }
        }

        // Show no results message when search yields no results
        function showNoResultsMessage(visibleCount, searchTerm) {
            const noDataRow = document.getElementById('programNoDataRow');
            const hasPrograms = document.querySelectorAll('#programTableBody tr:not(#programNoDataRow)').length > 0;
            
            if (hasPrograms && visibleCount === 0 && searchTerm !== '') {
                // Show "no results found" message
                if (noDataRow) {
                    noDataRow.style.display = '';
                    noDataRow.innerHTML = `
                        <td colspan="5" class="text-center py-8 text-gray-500">
                            <i class="fas fa-search text-4xl mb-2 text-gray-300"></i>
                            <p class="text-lg">No programs found</p>
                            <p class="text-sm">No programs match your search for "${searchTerm}"</p>
                        </td>
                    `;
                }
            } else if (hasPrograms && visibleCount > 0) {
                // Hide no data row when there are visible results
                if (noDataRow) {
                    noDataRow.style.display = 'none';
                }
            } else if (!hasPrograms) {
                // Show original "no programs available" message
                if (noDataRow) {
                    noDataRow.style.display = '';
                    noDataRow.innerHTML = `
                        <td colspan="5" class="text-center py-8 text-gray-500">
                            <i class="fas fa-graduation-cap text-4xl mb-2 text-gray-300"></i>
                            <p class="text-lg">No programs available</p>
                            <p class="text-sm">Click "Add Program" to create your first program</p>
                        </td>
                    `;
                }
            }
        }

        // Program Management Modal Functions
        function openViewProgramModal() {
            document.getElementById('viewProgramModal').classList.add('active');
        }

        function closeViewProgramModal() {
            document.getElementById('viewProgramModal').classList.remove('active');
        }

        function openEditProgramModal() {
            document.getElementById('editProgramModal').classList.add('active');
            // Initialize competency tabs - show basic by default
            switchEditCompetencyTab('basic');
        }

        function closeEditProgramModal() {
            document.getElementById('editProgramModal').classList.remove('active');
            document.getElementById('editProgramForm').reset();
            // Reset competencies data
            resetCompetenciesData(true);
            // Reset tabs to default (basic)
            switchEditCompetencyTab('basic');
        }

        function openDeleteProgramModal() {
            document.getElementById('deleteProgramModal').classList.add('active');
        }

        function closeDeleteProgramModal() {
            document.getElementById('deleteProgramModal').classList.remove('active');
        }

        // View Program Function
        function viewProgram(button) {
            const programId = button.getAttribute('data-program-id');
            const programName = button.getAttribute('data-program-name');
            const programDescription = button.getAttribute('data-program-description');
            const programSchedule = button.getAttribute('data-program-schedule');
            const programTrainer = button.getAttribute('data-program-trainer');
            const programSkills = button.getAttribute('data-program-skills');
            const programImage = button.getAttribute('data-program-image');
            const programCompetencies = button.getAttribute('data-program-competencies');

            // Populate view modal
            document.getElementById('viewProgramName').textContent = programName;
            document.getElementById('viewProgramDescription').textContent = programDescription;
            document.getElementById('viewProgramSchedule').textContent = programSchedule;
            document.getElementById('viewProgramTrainer').textContent = programTrainer;
            document.getElementById('viewProgramSkills').textContent = programSkills;

            // Handle program image
            const imageElement = document.getElementById('viewProgramImage');
            const imagePlaceholder = document.getElementById('viewProgramImagePlaceholder');
            
            if (programImage && programImage.trim() !== '') {
                imageElement.src = programImage;
                imageElement.style.display = 'block';
                imagePlaceholder.style.display = 'none';
            } else {
                imageElement.style.display = 'none';
                imagePlaceholder.style.display = 'block';
            }

            // Display job opportunities
            const jobOpportunitiesList = document.getElementById('viewJobOpportunitiesList');
            jobOpportunitiesList.innerHTML = '';
            
            try {
                if (programCompetencies && programCompetencies !== 'null' && programCompetencies !== '{}') {
                    const competencies = typeof programCompetencies === 'string' ? JSON.parse(programCompetencies) : programCompetencies;
                    
                    if (competencies.job_opportunities && Array.isArray(competencies.job_opportunities) && competencies.job_opportunities.length > 0) {
                        competencies.job_opportunities.forEach(job => {
                            if (job && job.trim() !== '') {
                                const li = document.createElement('li');
                                li.textContent = job;
                                li.className = 'text-gray-700';
                                jobOpportunitiesList.appendChild(li);
                            }
                        });
                    } else {
                        jobOpportunitiesList.innerHTML = '<li class="text-gray-500">No job opportunities specified</li>';
                    }
                } else {
                    jobOpportunitiesList.innerHTML = '<li class="text-gray-500">No job opportunities specified</li>';
                }
            } catch (e) {
                console.error('Error loading job opportunities:', e);
                jobOpportunitiesList.innerHTML = '<li class="text-gray-500">Error loading job opportunities</li>';
            }

            openViewProgramModal();
        }

        // Edit Program Function
        function editProgram(button) {
            const programId = button.getAttribute('data-program-id');
            const programName = button.getAttribute('data-program-name');
            const programDescription = button.getAttribute('data-program-description');
            const programSchedule = button.getAttribute('data-program-schedule');
            const programTrainer = button.getAttribute('data-program-trainer');
            const programCompetencies = button.getAttribute('data-program-competencies');

            // Populate edit modal
            document.getElementById('editProgramId').value = programId;
            document.getElementById('editProgramName').value = programName;
            document.getElementById('editProgramDescription').value = programDescription;
            document.getElementById('editProgramSchedule').value = programSchedule;
            document.getElementById('editProgramTrainer').value = programTrainer;

            // Load existing competencies
            resetCompetenciesData(true); // Clear previous data
            if (programCompetencies && programCompetencies !== '{}' && programCompetencies !== 'null') {
                loadExistingCompetencies(programCompetencies);
            }

            // Set form action for editing
            const form = document.getElementById('editProgramForm');
            form.action = `/edit-program/${programId}/`;

            openEditProgramModal();
        }

        // Delete Program Function
        function deleteProgram(button) {
            const programId = button.getAttribute('data-program-id');
            const programName = button.getAttribute('data-program-name');

            // Populate delete modal
            document.getElementById('deleteProgramName').textContent = programName;

            // Set up confirm delete button
            const confirmBtn = document.getElementById('confirmDeleteProgram');
            confirmBtn.onclick = function() {
                // Create and submit delete form
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/delete-program/${programId}/`;
                
                // Add CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);

                document.body.appendChild(form);
                form.submit();
            };

            openDeleteProgramModal();
        }

        // Event Listeners for Program Management
        document.addEventListener('DOMContentLoaded', function() {
            // Use event delegation for View, Edit, and Delete Program buttons
            // This ensures the buttons work even after dynamic content changes
            const programTableBody = document.getElementById('programTableBody');
            if (programTableBody) {
                programTableBody.addEventListener('click', function(event) {
                    const target = event.target.closest('button');
                    if (!target) return;

                    // View Program button
                    if (target.classList.contains('view-program-btn')) {
                        viewProgram(target);
                    }
                    // Edit Program button
                    else if (target.classList.contains('edit-program-btn')) {
                        editProgram(target);
                    }
                    // Delete Program button
                    else if (target.classList.contains('delete-program-btn')) {
                        deleteProgram(target);
                    }
                });
            }

            // Modal close events
            document.getElementById('viewProgramModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeViewProgramModal();
                }
            });

            document.getElementById('editProgramModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeEditProgramModal();
                }
            });

            document.getElementById('deleteProgramModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeDeleteProgramModal();
                }
            });

            // Edit form submission with validation
            const editProgramForm = document.getElementById('editProgramForm');
            if (editProgramForm) {
                editProgramForm.addEventListener('submit', function(event) {
                    // Update hidden input with competencies data before validation
                    updateHiddenInput(true);
                    
                    const programName = document.getElementById('editProgramName').value.trim();
                    const programDescription = document.getElementById('editProgramDescription').value.trim();
                    const programSchedule = document.getElementById('editProgramSchedule').value.trim();

                    if (!programName || !programDescription || !programSchedule) {
                        event.preventDefault();
                        alert('Please fill in all required fields (Program Name, Description, and Schedule).');
                        return false;
                    }

                    // Show confirmation dialog
                    if (!confirm(`Are you sure you want to update the program "${programName}"?`)) {
                        event.preventDefault();
                        return false;
                    }

                    // Show loading state
                    const submitBtn = editProgramForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating Program...';
                    submitBtn.disabled = true;
                });
            }
        });

        // Walk-in approval functions
        function approveWalkIn(applicationId) {
            if (confirm('Are you sure you want to approve this walk-in application?')) {
                fetch(`/approve-walkin/${applicationId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Walk-in application approved successfully!', 'success');
                        location.reload();
                    } else {
                        showNotification(data.message || 'Error approving application', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error approving application', 'error');
                });
            }
        }

        // Old declineWalkIn function removed - now using openWalkinDeclineModal with the decline modal

        // OCR Processing Functions
        function openFileSelectionModal() {
            document.getElementById('fileSelectionModal').classList.remove('hidden');
        }

        function closeFileSelectionModal() {
            document.getElementById('fileSelectionModal').classList.add('hidden');
        }

        function closeTextDisplayModal() {
            document.getElementById('textDisplayModal').classList.add('hidden');
        }

        function processSelectedFile() {
            const fileInput = document.getElementById('ocrFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Please select a file first', 'error');
                return;
            }

            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                showNotification('Please select an Excel file (.xlsx or .xls)', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            document.getElementById('ocrStatus').textContent = 'Processing file...';
            closeFileSelectionModal();

            fetch('/process-excel-ocr/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('ocrStatus').textContent = 'File processed successfully';
                    displayExtractedText(data.extracted_data, data.columns);
                } else {
                    document.getElementById('ocrStatus').textContent = 'Processing failed';
                    showNotification(data.message || 'Error processing file', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('ocrStatus').textContent = 'Processing failed';
                showNotification('Error processing file', 'error');
            });
        }
        function displayExtractedText(data, columns) {
            const textContent = document.getElementById('extractedTextContent');
            let html = '<div class="space-y-4">';
            
            // Display columns
            html += '<div><h5 class="font-semibold mb-2">Detected Columns:</h5>';
            html += '<div class="flex flex-wrap gap-2 mb-4">';
            columns.forEach(col => {
                html += `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">${col}</span>`;
            });
            html += '</div></div>';
            
            // Display sample data
            html += '<div><h5 class="font-semibold mb-2">Sample Data (First 5 rows):</h5>';
            html += '<div class="overflow-x-auto"><table class="min-w-full border border-gray-300">';
            html += '<thead class="bg-gray-50"><tr>';
            columns.forEach(col => {
                html += `<th class="border border-gray-300 px-2 py-1 text-xs">${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            data.slice(0, 5).forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td class="border border-gray-300 px-2 py-1 text-xs">${row[col] || ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div></div>';
            html += '</div>';
            
            textContent.innerHTML = html;
            
            // Store data for saving
            window.extractedOCRData = data;
            window.extractedColumns = columns;
            
            document.getElementById('textDisplayModal').classList.remove('hidden');
        }

        function saveExtractedData() {
            if (!window.extractedOCRData || !window.extractedColumns) {
                showNotification('No data to save', 'error');
                return;
            }

            const saveButton = document.querySelector('#textDisplayModal button[onclick="saveExtractedData()"]');
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';

            fetch('/save-excel-data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    data: window.extractedOCRData,
                    columns: window.extractedColumns
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Data saved successfully. ${data.created_count} records created, ${data.updated_count} records updated.`, 'success');
                    closeTextDisplayModal();
                } else {
                    showNotification(data.message || 'Error saving data', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error saving data', 'error');
            })
            .finally(() => {
                saveButton.disabled = false;
                saveButton.textContent = 'Save Data';
            });
        }

        // Process default 2024.xlsx file
        function processDefault2024File() {
            document.getElementById('ocrStatus').textContent = 'Processing 2024.xlsx...';

            fetch('/process-default-excel/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('ocrStatus').textContent = '2024.xlsx processed successfully';
                    displayExtractedText(data.extracted_data, data.columns);
                } else {
                    document.getElementById('ocrStatus').textContent = 'Processing failed';
                    showNotification(data.message || 'Error processing 2024.xlsx', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('ocrStatus').textContent = 'Processing failed';
                showNotification('Error processing 2024.xlsx', 'error');
            });
        }

        // Bulk Review Modal Functions
        function openBulkReviewModal() {
            document.getElementById('bulkReviewModal').classList.add('active');
            loadBulkReviewData();
        }

        function closeBulkReviewModal() {
            document.getElementById('bulkReviewModal').classList.remove('active');
        }

        // Bulk Download Modal Functions
        let learnerProfilesData = [];
        let filteredData = [];

        function openBulkDownloadModal() {
            document.getElementById('bulkDownloadModal').classList.remove('hidden');
            // Toggle download controls based on current selection
            (function() {
                const documentType = document.getElementById('filterByDocumentType')?.value || '';
                const filesBtn = document.getElementById('downloadFilesBtn');
                const ddWrapper = document.getElementById('downloadDropdownWrapper');
                if (filesBtn && ddWrapper) {
                    if (documentType === 'modules_manuals' || documentType === 'policy_guidelines') {
                        filesBtn.classList.remove('hidden');
                        ddWrapper.classList.add('hidden');
                    } else {
                        filesBtn.classList.add('hidden');
                        ddWrapper.classList.remove('hidden');
                    }
                }
            })();
            loadDocumentsData();
        }

        function closeBulkDownloadModal() {
            document.getElementById('bulkDownloadModal').classList.add('hidden');
            clearFilters();
        }

        // Bulk Upload Modal Functions
        let selectedFiles = [];
        let selectedDocumentType = '';

        function openBulkUploadModal() {
            document.getElementById('bulkUploadModal').classList.remove('hidden');
            resetBulkUploadForm();
        }

        function closeBulkUploadModal() {
            document.getElementById('bulkUploadModal').classList.add('hidden');
            resetBulkUploadForm();
        }

        function selectBulkDocumentType(type) {
            selectedDocumentType = type;
            document.querySelectorAll('.document-type-card').forEach(card => {
                card.classList.remove('border-blue-500', 'bg-blue-50');
            });
            event.currentTarget.classList.add('border-blue-500', 'bg-blue-50');
            // Map to corresponding radio input id based on selected type
            let targetId = '';
            if (type === 'modules_manuals') {
                targetId = 'bulk_type_manuals';
            } else if (type === 'policy_guidelines') {
                targetId = 'bulk_type_policy';
            } else if (type === 'applicant_profile') {
                targetId = 'bulk_type_applicant';
            }
            if (targetId) {
                const radio = document.getElementById(targetId);
                if (radio) radio.checked = true;
            }
            checkFormValidity();
        }

        function handleBulkFileSelection(event) {
            const files = Array.from(event.target.files);
            const maxSize = 10 * 1024 * 1024;
            files.forEach(file => {
                if (file.size > maxSize) {
                    alert('File "' + file.name + '" exceeds 10MB');
                    return;
                }
                selectedFiles.push({file: file, name: file.name, size: formatFileSize(file.size), type: file.type, batch: '', program: ''});
            });
            updateFilesTable();
            checkFormValidity();
        }

        function updateFilesTable() {
            const section = document.getElementById('selectedFilesSection');
            if (selectedFiles.length === 0) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            document.getElementById('fileCount').textContent = selectedFiles.length;
            document.getElementById('uploadFileCount').textContent = selectedFiles.length + ' file' + (selectedFiles.length > 1 ? 's' : '') + ' selected';
            document.getElementById('selectedFilesTableBody').innerHTML = selectedFiles.map((f, i) => 
                '<tr><td class="px-4 py-2 text-sm"><i class="fas fa-file mr-2"></i>' + f.name + '</td><td class="px-4 py-2 text-sm">' + f.size + '</td><td class="px-4 py-2 text-sm">' + f.name.split('.').pop().toUpperCase() + '</td><td class="px-4 py-2 text-sm"><button onclick="removeFile(' + i + ')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button></td></tr>'
            ).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFilesTable();
            checkFormValidity();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function checkFormValidity() {
            document.getElementById('bulkUploadSubmitBtn').disabled = !(selectedDocumentType && selectedFiles.length > 0);
        }

        function resetBulkUploadForm() {
            selectedFiles = [];
            selectedDocumentType = '';
            document.getElementById('bulkFileInput').value = '';
            document.getElementById('bulkBatchSelect').value = '';
            document.getElementById('bulkProgramSelect').value = '';
            document.getElementById('bulkDescription').value = '';
            document.getElementById('selectedFilesSection').classList.add('hidden');
            document.getElementById('uploadProgressSection').classList.add('hidden');
            document.getElementById('uploadFileCount').textContent = '0 files selected';
            document.querySelectorAll('.document-type-card').forEach(card => card.classList.remove('border-blue-500', 'bg-blue-50'));
            document.querySelectorAll('input[name="document_type"]').forEach(radio => radio.checked = false);
            checkFormValidity();
        }

        function submitBulkUpload() {
            if (!selectedDocumentType || selectedFiles.length === 0) {
                alert('Please select document type and files');
                return;
            }
            
            const progressSection = document.getElementById('uploadProgressSection');
            progressSection.classList.remove('hidden');
            const progressBar = document.getElementById('uploadProgressBar');
            const progressText = document.getElementById('uploadProgressText');
            const statusText = document.getElementById('uploadStatusText');
            const submitBtn = document.getElementById('bulkUploadSubmitBtn');
            submitBtn.disabled = true;
            
            statusText.textContent = 'Preparing upload...';
            
            // Prepare FormData
            const formData = new FormData();
            formData.append('document_type', selectedDocumentType);
            formData.append('bulk_batch', document.getElementById('bulkBatchSelect').value);
            formData.append('bulk_program', document.getElementById('bulkProgramSelect').value);
            formData.append('bulk_description', document.getElementById('bulkDescription').value);
            
            // Add files
            selectedFiles.forEach((fileData, index) => {
                formData.append('file_' + index, fileData.file);
                formData.append('file_' + index + '_batch', fileData.batch);
                formData.append('file_' + index + '_program', fileData.program);
            });
            
            // Get CSRF token
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += 10;
                    progressBar.style.width = progress + '%';
                    progressText.textContent = progress + '%';
                }
            }, 300);
            
            statusText.textContent = 'Uploading files...';
            
            // Upload to server
            fetch('/bulk-upload-lmstc-documents/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressText.textContent = '100%';
                
                if (data.success) {
                    statusText.textContent = data.message;
                    
                    // Show detailed results
                    let message = data.message + '\n\n';
                    if (data.failed_count > 0) {
                        message += 'Failed files:\n';
                        data.failed_files.forEach(f => {
                            message += '- ' + f.name + ': ' + f.reason + '\n';
                        });
                    }
                    
                    setTimeout(() => {
                        alert(message);
                        closeBulkUploadModal();
                        // Optionally reload the documents list
                        location.reload();
                    }, 1000);
                } else {
                    statusText.textContent = 'Upload failed!';
                    alert('Upload failed: ' + data.error);
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                console.error('Error:', error);
                statusText.textContent = 'Upload failed!';
                alert('Upload failed: ' + error.message);
                submitBtn.disabled = false;
            });
        }

        // Global variables for documents data
        let documentsData = [];
        let filteredDocumentsData = [];

        function handleDocumentTypeChange() {
            const documentType = document.getElementById('filterByDocumentType')?.value || '';
            const filesBtn = document.getElementById('downloadFilesBtn');
            const ddWrapper = document.getElementById('downloadDropdownWrapper');
            if (filesBtn && ddWrapper) {
                if (documentType === 'modules_manuals' || documentType === 'policy_guidelines') {
                    filesBtn.classList.remove('hidden');
                    ddWrapper.classList.add('hidden');
                } else {
                    filesBtn.classList.add('hidden');
                    ddWrapper.classList.remove('hidden');
                }
            }
            loadDocumentsData();
        }

        function loadDocumentsData() {
            // Show loading state
            const tableBody = document.getElementById('documentsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading data...
                    </td>
                </tr>
            `;

            // Get current filter values
            const searchQuery = document.getElementById('filterById')?.value || '';
            const documentType = document.getElementById('filterByDocumentType')?.value || '';
            const year = document.getElementById('filterByYear')?.value || '';
            const batch = document.getElementById('filterByBatch')?.value || '';

            // Build query parameters
            const params = new URLSearchParams();
            if (searchQuery) params.append('search', searchQuery);
            if (documentType) params.append('document_type', documentType);
            if (year) params.append('year', year);
            if (batch) params.append('batch', batch);

            // Fetch real-time data from Django backend
            fetch(`/get-bulk-download-documents/?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        documentsData = data.documents || [];
                        filteredDocumentsData = [...documentsData];
                        populateDocumentsTable();
                        updateRecordCounts();
                    } else {
                        console.error('Error loading documents:', data.error);
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-red-500">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>Error loading data: ${data.error || 'Unknown error'}
                                </td>
                            </tr>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching documents:', error);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-red-500">
                                <i class="fas fa-exclamation-triangle mr-2"></i>Error loading data: ${error.message}
                            </td>
                        </tr>
                    `;
                });
        }

        function populateDocumentsTable() {
            const tableBody = document.getElementById('documentsTableBody');
            
            if (filteredDocumentsData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            No documents found matching the current filters.
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = filteredDocumentsData.map(doc => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="document-checkbox" value="${doc.id}" onchange="updateSelectedCount()">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${doc.id}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${doc.document_name}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${doc.document_type}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${doc.uploaded_at}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${doc.batch}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${doc.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${doc.status}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function loadLearnerProfilesData() {
            // Show loading state
            const tableBody = document.getElementById('learnerProfilesTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading data...
                    </td>
                </tr>
            `;

            // Simulate API call to load learner profiles data
            // In real implementation, this would fetch from your Django backend
            setTimeout(() => {
                // Sample data - replace with actual API call
                learnerProfilesData = [
                    {
                        id: 'LP001',
                        fullName: 'John Doe',
                        programsCompleted: 'Digital Literacy, Computer Basics',
                        yearCompleted: '2024',
                        batch: 'Batch 1',
                        status: 'completed'
                    },
                    {
                        id: 'LP002',
                        fullName: 'Jane Smith',
                        programsCompleted: 'Advanced Computing',
                        yearCompleted: '2023',
                        batch: 'Batch 2',
                        status: 'completed'
                    },
                    {
                        id: 'LP003',
                        fullName: 'Mike Johnson',
                        programsCompleted: 'Web Development',
                        yearCompleted: '2024',
                        batch: 'Batch 1',
                        status: 'in-progress'
                    },
                    {
                        id: 'LP004',
                        fullName: 'Sarah Wilson',
                        programsCompleted: 'Data Analysis',
                        yearCompleted: '2022',
                        batch: 'Batch 3',
                        status: 'completed'
                    },
                    {
                        id: 'LP005',
                        fullName: 'Robert Brown',
                        programsCompleted: 'Mobile Development',
                        yearCompleted: '2024',
                        batch: 'Batch 2',
                        status: 'pending'
                    }
                ];

                filteredData = [...learnerProfilesData];
                populateLearnerProfilesTable();
                updateRecordCounts();
            }, 1000);
        }

        function populateLearnerProfilesTable() {
            const tableBody = document.getElementById('learnerProfilesTableBody');
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            No records found matching the current filters.
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = filteredData.map(profile => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="profile-checkbox" value="${profile.id}" onchange="updateSelectedCount()">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${profile.id}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${profile.fullName}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${profile.programsCompleted}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${profile.yearCompleted}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${profile.batch}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(profile.status)}">
                            ${profile.status.charAt(0).toUpperCase() + profile.status.slice(1)}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusColor(status) {
            switch(status) {
                case 'completed':
                    return 'bg-green-100 text-green-800';
                case 'in-progress':
                    return 'bg-yellow-100 text-yellow-800';
                case 'pending':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function applyFilters() {
            // Instead of filtering locally, reload data with filters from API
            loadDocumentsData();
        }

        function clearFilters() {
            document.getElementById('filterById').value = '';
            document.getElementById('filterByDocumentType').value = '';
            document.getElementById('filterByYear').value = '';
            document.getElementById('filterByBatch').value = '';
            
            // Reload data without filters from API
            (function() {
                const filesBtn = document.getElementById('downloadFilesBtn');
                const ddWrapper = document.getElementById('downloadDropdownWrapper');
                if (filesBtn && ddWrapper) {
                    filesBtn.classList.add('hidden');
                    ddWrapper.classList.remove('hidden');
                }
            })();
            loadDocumentsData();
        }

        function updateRecordCounts() {
            document.getElementById('recordCount').textContent = `${filteredDocumentsData.length} records found`;
            document.getElementById('totalCount').textContent = filteredDocumentsData.length;
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.document-checkbox:checked');
            document.getElementById('selectedCount').textContent = checkboxes.length;
            
            // Update select all checkbox state
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const allCheckboxes = document.querySelectorAll('.document-checkbox');
            
            if (checkboxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkboxes.length === allCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.document-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelectedCount();
        }

        function selectAllRecords() {
            const checkboxes = document.querySelectorAll('.document-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedCount();
        }

        function deselectAllRecords() {
            const checkboxes = document.querySelectorAll('.document-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCount();
        }
        function downloadSelectedProfiles() {
            const selectedCheckboxes = document.querySelectorAll('.profile-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                showNotificationToast('Warning', 'Please select at least one profile to download.', 'warning');
                return;
            }

            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            const downloadOverall = document.getElementById('downloadOverall').checked;
            const downloadSpecificYear = document.getElementById('downloadSpecificYear').checked;
            
            // Show loading state
            const downloadButton = document.querySelector('button[onclick="downloadSelectedProfiles()"]');
            const originalText = downloadButton.innerHTML;
            downloadButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Preparing Download...';
            downloadButton.disabled = true;

            // Simulate download preparation
            setTimeout(() => {
                // In real implementation, this would make an API call to your Django backend
                // to generate and download the ZIP file with selected profiles
                
                const downloadData = {
                    selectedIds: selectedIds,
                    downloadOverall: downloadOverall,
                    downloadSpecificYear: downloadSpecificYear,
                    filters: {
                        id: document.getElementById('filterById').value,
                        profile: document.getElementById('filterByProfile').value,
                        year: document.getElementById('filterByYear').value,
                        batch: document.getElementById('filterByBatch').value
                    }
                };

                console.log('Download data:', downloadData);
                
                // Simulate successful download
                showNotificationToast('Success', `Successfully prepared download for ${selectedIds.length} profiles.`, 'success');
                
                // Reset button
                downloadButton.innerHTML = originalText;
                downloadButton.disabled = false;
                
                // Close modal
                closeBulkDownloadModal();
                
            }, 2000);
        }

        function loadBulkReviewData() {
            fetch('/get_bulk_review_data/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update statistics
                        document.getElementById('totalApplicationsCount').textContent = data.statistics.total_applications;
                        document.getElementById('readyForApprovalCount').textContent = data.statistics.ready_for_approval;
                        document.getElementById('pendingReviewCount').textContent = data.statistics.pending_review;

                        // Populate program applications table
                        populateApplicationTable('programApplicationsTable', data.program_applications, 'program');
                        
                        // Populate walk-in applications table
                        populateApplicationTable('walkinApplicationsTable', data.walkin_applications, 'walkin');
                    } else {
                        showNotificationToast('Error', data.error || 'Failed to load review data', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotificationToast('Error', 'Failed to load review data', 'error');
                });
        }

        function populateApplicationTable(tableId, applications, type) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';

            applications.forEach(app => {
                const row = document.createElement('tr');
                const statusClass = app.is_complete ? 'text-green-600' : 'text-orange-600';
                const documentsStatus = getDocumentsStatus(app);
                
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">
                        <input type="checkbox" class="review-checkbox" data-review-id="${app.dms_review_id}" data-type="${type}">
                    </td>
                    <td class="border border-gray-300 px-4 py-2">${app.applicant_name}</td>
                    <td class="border border-gray-300 px-4 py-2">${app.program_name}</td>
                    <td class="border border-gray-300 px-4 py-2">${app.applied_date}</td>
                    <td class="border border-gray-300 px-4 py-2 ${statusClass}">${app.status}</td>
                    <td class="border border-gray-300 px-4 py-2">${documentsStatus}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function getDocumentsStatus(app) {
            const docs = [];
            if (app.has_id_picture) docs.push('✓ ID Picture');
            else docs.push('✗ ID Picture');
            
            if (app.has_learner_profile) docs.push('✓ Profile');
            else docs.push('✗ Profile');
            
            if (app.has_signature) docs.push('✓ Signature');
            else docs.push('✗ Signature');
            
            return docs.join('<br>');
        }

        function toggleSelectAllProgram() {
            const selectAll = document.getElementById('selectAllProgram');
            const checkboxes = document.querySelectorAll('#programApplicationsTable .review-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        function toggleSelectAllWalkin() {
            const selectAll = document.getElementById('selectAllWalkin');
            const checkboxes = document.querySelectorAll('#walkinApplicationsTable .review-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        function processBulkReview() {
            const selectedCheckboxes = document.querySelectorAll('.review-checkbox:checked');
            const selectedReviews = Array.from(selectedCheckboxes).map(cb => cb.dataset.reviewId);

            if (selectedReviews.length === 0) {
                showNotificationToast('Warning', 'Please select at least one application to review', 'warning');
                return;
            }

            fetch('/process_bulk_review/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    selected_reviews: selectedReviews
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotificationToast('Success', data.message, 'success');
                    closeBulkReviewModal();
                    // Refresh the page or update the UI as needed
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showNotificationToast('Error', data.error || 'Failed to process review', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotificationToast('Error', 'Failed to process review', 'error');
            });
        }

        // Bulk Approval Modal Functions
        function openBulkApprovalModal() {
            document.getElementById('bulkApprovalModal').classList.add('active');
            loadBulkApprovalData();
        }

        function closeBulkApprovalModal() {
            document.getElementById('bulkApprovalModal').classList.remove('active');
        }

        function loadBulkApprovalData() {
            fetch('/get_bulk_approval_data/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update statistics
                        document.getElementById('approvalReadyCount').textContent = data.statistics.ready_for_approval;
                        document.getElementById('selectedForApprovalCount').textContent = '0';

                        // Populate approval applications table
                        populateApprovalTable('approvalApplicationsTable', data.approval_applications);
                    } else {
                        showNotificationToast('Error', data.error || 'Failed to load approval data', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotificationToast('Error', 'Failed to load approval data', 'error');
                });
        }

        function populateApprovalTable(tableId, applications) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = '';

            applications.forEach(app => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-2">
                        <input type="checkbox" class="approval-checkbox" data-approval-id="${app.id}" onchange="updateSelectedCount()">
                    </td>
                    <td class="border border-gray-300 px-4 py-2">${app.applicant_name}</td>
                    <td class="border border-gray-300 px-4 py-2">${app.program_name}</td>
                    <td class="border border-gray-300 px-4 py-2">${app.application_type}</td>
                    <td class="border border-gray-300 px-4 py-2">${app.review_date}</td>
                    <td class="border border-gray-300 px-4 py-2 text-green-600">${app.status}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function toggleSelectAllApproval() {
            const selectAll = document.getElementById('selectAllApproval');
            const checkboxes = document.querySelectorAll('.approval-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selectedCount = document.querySelectorAll('.approval-checkbox:checked').length;
            document.getElementById('selectedForApprovalCount').textContent = selectedCount;
        }

        function processBulkApproval() {
            const selectedCheckboxes = document.querySelectorAll('.approval-checkbox:checked');
            const selectedApprovals = Array.from(selectedCheckboxes).map(cb => cb.dataset.approvalId);

            if (selectedApprovals.length === 0) {
                showNotificationToast('Warning', 'Please select at least one application to approve', 'warning');
                return;
            }

            if (!confirm(`Are you sure you want to approve ${selectedApprovals.length} application(s)?`)) {
                return;
            }

            fetch('/process_bulk_approval/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    selected_approvals: selectedApprovals
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotificationToast('Success', data.message, 'success');
                    closeBulkApprovalModal();
                    // Refresh the page or update the UI as needed
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showNotificationToast('Error', data.error || 'Failed to process approval', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotificationToast('Error', 'Failed to process approval', 'error');
            });
        }

        // Notification Toast Functions
        function showNotificationToast(title, message, type) {
            const toast = document.getElementById('notificationToast');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');

            // Set icon based on type
            let iconClass = '';
            let iconColor = '';
            switch(type) {
                case 'success':
                    iconClass = 'fas fa-check-circle';
                    iconColor = 'text-green-500';
                    break;
                case 'error':
                    iconClass = 'fas fa-exclamation-circle';
                    iconColor = 'text-red-500';
                    break;
                case 'warning':
                    iconClass = 'fas fa-exclamation-triangle';
                    iconColor = 'text-yellow-500';
                    break;
                default:
                    iconClass = 'fas fa-info-circle';
                    iconColor = 'text-blue-500';
            }

            toastIcon.innerHTML = `<i class="${iconClass} ${iconColor}"></i>`;
            toastTitle.textContent = title;
            toastMessage.textContent = message;

            toast.classList.remove('hidden');
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                hideNotificationToast();
            }, 5000);
        }

        function hideNotificationToast() {
            document.getElementById('notificationToast').classList.add('hidden');
        }

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

    <!-- File Selection Modal -->
    <div id="fileSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Select Excel File for OCR Processing</h3>
                        <button onclick="closeFileSelectionModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Choose File</label>
                            <input type="file" id="ocrFileInput" accept=".xlsx,.xls" 
                                   class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                        
                        <div class="border-t pt-4">
                            <p class="text-sm text-gray-600 mb-2">Or process the default file:</p>
                            <button onclick="processDefault2024File(); closeFileSelectionModal();" 
                                    class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">
                                <i class="fas fa-file-excel mr-2"></i>Process 2024.xlsx
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="closeFileSelectionModal()" 
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="processSelectedFile()" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Process File
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Text Display Modal -->
    <div id="textDisplayModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Extracted Excel Data</h3>
                        <button onclick="closeTextDisplayModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div id="extractedTextContent" class="max-h-96 overflow-y-auto border border-gray-200 p-4 rounded-lg mb-4">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeTextDisplayModal()" 
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="saveExtractedData()" 
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i class="fas fa-save mr-2"></i>Save Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Review Modal -->
    <div id="bulkReviewModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close-btn" onclick="closeBulkReviewModal()">&times;</button>
            <h3 class="text-2xl font-bold text-purple-600 mb-6 text-center">Bulk Review Applications</h3>
            
            <!-- Review Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div class="text-center">
                        <p class="text-sm text-blue-600 font-medium">Total Applications</p>
                        <p class="text-2xl font-bold text-blue-800" id="totalApplicationsCount">0</p>
                    </div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <div class="text-center">
                        <p class="text-sm text-green-600 font-medium">Ready for Approval</p>
                        <p class="text-2xl font-bold text-green-800" id="readyForApprovalCount">0</p>
                    </div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                    <div class="text-center">
                        <p class="text-sm text-orange-600 font-medium">Pending Review</p>
                        <p class="text-2xl font-bold text-orange-800" id="pendingReviewCount">0</p>
                    </div>
                </div>
            </div>

            <!-- Program Applications Section -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-semibold text-gray-800">Program Applications</h4>
                    <label class="flex items-center">
                        <input type="checkbox" id="selectAllProgram" class="mr-2" onchange="toggleSelectAllProgram()">
                        <span class="text-sm text-gray-600">Select All</span>
                    </label>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="border border-gray-300 px-4 py-2 text-left">Select</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Applicant</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Program</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Applied Date</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Status</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Documents</th>
                            </tr>
                        </thead>
                        <tbody id="programApplicationsTable">
                            <!-- Content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Walk-in Applications Section -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-semibold text-gray-800">Walk-in Applications</h4>
                    <label class="flex items-center">
                        <input type="checkbox" id="selectAllWalkin" class="mr-2" onchange="toggleSelectAllWalkin()">
                        <span class="text-sm text-gray-600">Select All</span>
                    </label>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="border border-gray-300 px-4 py-2 text-left">Select</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Applicant</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Program</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Applied Date</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Status</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Documents</th>
                            </tr>
                        </thead>
                        <tbody id="walkinApplicationsTable">
                            <!-- Content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeBulkReviewModal()" 
                        class="px-6 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="processBulkReview()" 
                        class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    <i class="fas fa-search mr-2"></i>Review Selected
                </button>
            </div>
        </div>
    </div>

    <!-- Bulk Approval Modal -->
    <div id="bulkApprovalModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close-btn" onclick="closeBulkApprovalModal()">&times;</button>
            <h3 class="text-2xl font-bold text-orange-600 mb-6 text-center">Bulk Approval Applications</h3>
            
            <!-- Approval Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <div class="text-center">
                        <p class="text-sm text-green-600 font-medium">Ready for Approval</p>
                        <p class="text-2xl font-bold text-green-800" id="approvalReadyCount">0</p>
                    </div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <div class="text-center">
                        <p class="text-sm text-blue-600 font-medium">Selected for Approval</p>
                        <p class="text-2xl font-bold text-blue-800" id="selectedForApprovalCount">0</p>
                    </div>
                </div>
            </div>

            <!-- Applications Ready for Approval -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="text-lg font-semibold text-gray-800">Applications Ready for Approval</h4>
                    <label class="flex items-center">
                        <input type="checkbox" id="selectAllApproval" class="mr-2" onchange="toggleSelectAllApproval()">
                        <span class="text-sm text-gray-600">Select All</span>
                    </label>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="border border-gray-300 px-4 py-2 text-left">Select</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Applicant</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Program</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Application Type</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Review Date</th>
                                <th class="border border-gray-300 px-4 py-2 text-left">Status</th>
                            </tr>
                        </thead>
                        <tbody id="approvalApplicationsTable">
                            <!-- Content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeBulkApprovalModal()" 
                        class="px-6 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="processBulkApproval()" 
                        class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                    <i class="fas fa-check-double mr-2"></i>Approve Selected
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="fixed top-4 right-4 z-50 hidden">
        <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4 max-w-sm">
            <div class="flex items-center">
                <div id="toastIcon" class="flex-shrink-0 mr-3">
                    <!-- Icon will be set by JavaScript -->
                </div>
                <div class="flex-1">
                    <p id="toastTitle" class="text-sm font-medium text-gray-900"></p>
                    <p id="toastMessage" class="text-sm text-gray-500"></p>
                </div>
                <button onclick="hideNotificationToast()" class="ml-3 text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    <!-- Bulk Download Modal -->
    <div id="bulkDownloadModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex justify-between items-center pb-4 border-b">
                    <h3 class="text-2xl font-bold text-gray-900">Bulk Document Download</h3>
                    <button onclick="closeBulkDownloadModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Filters Section -->
                <div class="mt-6 bg-gray-50 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold mb-4 text-gray-800">
                        <i class="fas fa-filter mr-2"></i>Filter Options
                    </h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- ID Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by ID or Names</label>
                            <input type="text" id="filterById" placeholder="Enter ID..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <!-- Document Type Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Document Type</label>
                            <select id="filterByDocumentType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="handleDocumentTypeChange()">
                                <option value="">All Document Types</option>
                                <option value="modules_manuals">Manuals</option>
                                <option value="policy_guidelines">Policy and Guidelines</option>
                                <option value="applicant_profile">Applicant Profile</option>
                            </select>
                        </div>
                        <!-- Year Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Year</label>
                            <select id="filterByYear" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">All Years</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                        <!-- Batch Filter -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Batch</label>
                            <select id="filterByBatch" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">All Batches</option>
                                <option value="1">Batch 1</option>
                                <option value="2">Batch 2</option>
                                <option value="3">Batch 3</option>
                            </select>
                        </div>
                    </div>

                    <!-- Filter Actions -->
                    <div class="mt-4 flex space-x-3">
                        <button onclick="applyFilters()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-search mr-2"></i>Apply Filters
                        </button>
                        <button onclick="clearFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-times mr-2"></i>Clear Filters
                        </button>
                    </div>
                        <h4 class="text-lg font-semibold text-gray-800">
                            <i class="fas fa-table mr-2"></i>Table of Documents
                        </h4>
                        <div class="flex items-center space-x-2">
                            <span id="recordCount" class="text-sm text-gray-600">0 records found</span>
                            <button onclick="selectAllRecords()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-sm">
                                Select All
                            </button>
                            <button onclick="deselectAllRecords()" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm">
                                Deselect All
                            </button>
                        </div>
                    </div>

                    <!-- Table Container with Scroll -->
                    <div class="overflow-x-auto max-h-96 border rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        ID
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Document Name
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Document Type
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Upload Date
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Batch
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Status
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="documentsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Table rows will be populated by JavaScript -->
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="mt-6 flex justify-between items-center pt-4 border-t">
                    <div class="text-sm text-gray-600">
                        <span id="selectedCount">0</span> of <span id="totalCount">0</span> records selected
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="closeBulkDownloadModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                        <!-- Direct Files Download Button (visible for Manuals/Policy) -->
                        <button id="downloadFilesBtn" onclick="downloadSelectedFilesZIP()" class="hidden bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex items-center">
                            <i class="fas fa-file-archive mr-2"></i>Download Selected Files
                        </button>
                        <!-- Download Dropdown -->
                        <div id="downloadDropdownWrapper" class="relative inline-block text-left">
                            <button onclick="toggleDownloadDropdown()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex items-center">
                                <i class="fas fa-download mr-2"></i>Download Selected
                                <i class="fas fa-chevron-down ml-2"></i>
                            </button>
                            <div id="downloadDropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10 border border-gray-200">
                                <div class="py-1">
                                    <button onclick="downloadSelectedDocuments('excel')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-file-excel mr-2 text-green-500"></i>Download as Excel
                                    </button>
                                    <button onclick="downloadSelectedDocuments('zip')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                        <i class="fas fa-file-archive mr-2 text-yellow-500"></i>Download as ZIP
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex justify-between items-center pb-4 border-b">
                    <h3 class="text-2xl font-bold text-gray-900">Bulk Upload - LMSTC Documents</h3>
                    <button onclick="closeBulkUploadModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Upload Form -->
                <form id="bulkUploadForm" enctype="multipart/form-data" class="mt-6">
                    {% csrf_token %}
                    
                    <!-- Document Type Selection -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-3">Document Type <span class="text-red-500">*</span></label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-500 transition-colors document-type-card" onclick="selectBulkDocumentType('modules_manuals')">
                                <input type="radio" name="document_type" value="modules_manuals" id="bulk_type_manuals" class="hidden">
                                <div class="text-center">
                                    <i class="fas fa-book text-3xl text-blue-500 mb-2"></i>
                                    <h4 class="font-medium text-gray-900">Manuals</h4>
                                    <p class="text-sm text-gray-500 mt-1">Upload manuals and modules</p>
                                </div>
                            </div>
                            <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-green-500 transition-colors document-type-card" onclick="selectBulkDocumentType('policy_guidelines')">
                                <input type="radio" name="document_type" value="policy_guidelines" id="bulk_type_policy" class="hidden">
                                <div class="text-center">
                                    <i class="fas fa-file-contract text-3xl text-green-500 mb-2"></i>
                                    <h4 class="font-medium text-gray-900">Policy and Guidelines</h4>
                                    <p class="text-sm text-gray-500 mt-1">Upload policy documents</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload Area -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Files <span class="text-red-500">*</span></label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition-colors">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600 mb-2">Drag and drop files here or click to browse</p>
                            <input type="file" id="bulkFileInput" name="documents" multiple class="hidden" onchange="handleBulkFileSelection(event)">
                            <button type="button" onclick="document.getElementById('bulkFileInput').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mt-2">
                                <i class="fas fa-folder-open mr-2"></i>Browse Files
                            </button>
                            <p class="text-xs text-gray-500 mt-2">Supported formats: PDF, DOC, DOCX, XLS, XLSX (Max 10MB per file)</p>
                        </div>
                    </div>

                    <!-- Selected Files Table -->
                    <div id="selectedFilesSection" class="mb-6 hidden">
                        <h4 class="text-lg font-semibold mb-3">Selected Files (<span id="fileCount">0</span>)</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">File Name</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Size</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="selectedFilesTableBody" class="divide-y divide-gray-200">
                                    <!-- Files will be populated here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Bulk Settings -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">All Batches</label>
                            <select id="bulkBatchSelect" name="bulk_batch" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">All Batches</option>
                                <option value="1">Batch 1</option>
                                <option value="2">Batch 2</option>
                                <option value="3">Batch 3</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Program (Optional)</label>
                            <select name="bulk_program" id="bulkProgramSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Program</option>
                                {% for program in programs %}
                                <option value="{{ program.id }}">{{ program.program_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                        <textarea name="bulk_description" id="bulkDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Add a description for these documents..."></textarea>
                    </div>

                    <!-- Progress Bar -->
                    <div id="uploadProgressSection" class="mb-6 hidden">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">Upload Progress</span>
                            <span id="uploadProgressText" class="text-sm text-gray-600">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="uploadProgressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p id="uploadStatusText" class="text-xs text-gray-500 mt-2"></p>
                    </div>
                </form>

                <!-- Modal Footer -->
                <div class="mt-6 flex justify-between items-center pt-4 border-t">
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        <span id="uploadFileCount">0 files selected</span>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="closeBulkUploadModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                        <button onclick="submitBulkUpload()" id="bulkUploadSubmitBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg" disabled>
                            <i class="fas fa-upload mr-2"></i>Upload Documents
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Document Details Form -->
        <div id="documentDetailsForm" class="hidden">
            <!-- Common Fields -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Document Title</label>
                    <input type="text" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Version</label>
                    <input type="text" name="version" value="1.0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                <textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>

            <!-- Applicant Profile Specific Fields -->
            <div id="applicantProfileFields" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Applicant</label>
                        <select name="applicant_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select an applicant...</option>
                            {% for applicant in applicants %}
                            <option value="{{ applicant.applicant.id }}">{{ applicant.applicant.get_full_name|default:applicant.applicant.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Manual/Policy Specific Fields -->
            <div id="manualPolicyFields" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Program</label>
                        <select name="program_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Programs</option>
                            {% for program in programs %}
                            <option value="{{ program.id }}">{{ program.program_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Batch</label>
                        <select id="filterByBatch" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">All Batches</option>
                            <option value="1">Batch 1</option>
                            <option value="2">Batch 2</option>
                            <option value="3">Batch 3</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Semester</label>
                        <select name="semester" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">All Semesters</option>
                            <option value="semester_1">Semester 1</option>
                            <option value="semester_2">Semester 2</option>
                            <option value="semester_3">Semester 3</option>
                        </select>
                    </div>
                </div>

                <!-- Category Selection for Manual/Policy -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <select name="category_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select a category...</option>
                        <!-- Categories will be populated via JavaScript based on document type -->
                    </select>
                </div>

                <!-- Policy Specific Fields -->
                <div id="policySpecificFields" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Effective Date</label>
                            <input type="date" name="effective_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Document Type</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-500 transition-colors" onclick="selectDocumentType('applicant_profile')">
                                    <input type="radio" name="document_type" value="applicant_profile" id="type_applicant" class="hidden">
                                    <div class="text-center">
                                        <i class="fas fa-user-circle text-3xl text-blue-500 mb-2"></i>
                                        <h4 class="font-medium text-gray-900">Applicant Profile</h4>
                                        <p class="text-sm text-gray-500">Learner profile documents</p>
                                    </div>
                                </div>
                                <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-green-500 transition-colors" onclick="selectDocumentType('manual')">
                                    <input type="radio" name="document_type" value="manual" id="type_manual" class="hidden">
                                    <div class="text-center">
                                        <i class="fas fa-book text-3xl text-green-500 mb-2"></i>
                                        <h4 class="font-medium text-gray-900">Manuals</h4>
                                        <p class="text-sm text-gray-500">Training manuals and guides</p>
                                    </div>
                                </div>
                                <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-purple-500 transition-colors" onclick="selectDocumentType('policy')">
                                    <input type="radio" name="document_type" value="policy" id="type_policy" class="hidden">
                                    <div class="text-center">
                                        <i class="fas fa-file-contract text-3xl text-purple-500 mb-2"></i>
                                        <h4 class="font-medium text-gray-900">Policy</h4>
                                        <p class="text-sm text-gray-500">Policies and procedures</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Document Details Form -->
                        <div id="documentDetailsForm" class="hidden">
                            <!-- Common Fields -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Document Title</label>
                                    <input type="text" name="title" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Version</label>
                                    <input type="text" name="version" value="1.0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>

                            <!-- Applicant Profile Specific Fields -->
                            <div id="applicantProfileFields" class="hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Applicant</label>
                                        <select name="applicant_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">Select an applicant...</option>
                                            {% for applicant in applicants %}
                                            <option value="{{ applicant.applicant.id }}">{{ applicant.applicant.get_full_name|default:applicant.applicant.username }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Manual/Policy Specific Fields -->
                            <div id="manualPolicyFields" class="hidden">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Program</label>
                                        <select name="program_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">All Programs</option>
                                            {% for program in programs %}
                                            <option value="{{ program.id }}">{{ program.program_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Batch</label>
                                        <select name="batch" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">All Batches</option>
                                            <option value="batch_1">Batch 1</option>
                                            <option value="batch_2">Batch 2</option>
                                            <option value="batch_3">Batch 3</option>
                                            <option value="batch_4">Batch 4</option>
                                            <option value="batch_5">Batch 5</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Semester</label>
                                        <select name="semester" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">All Semesters</option>
                                            <option value="semester_1">Semester 1</option>
                                            <option value="semester_2">Semester 2</option>
                                            <option value="semester_3">Semester 3</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Category Selection for Manual/Policy -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                    <select name="category_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Select a category...</option>
                                        <!-- Categories will be populated via JavaScript based on document type -->
                                    </select>
                                </div>

                                <!-- Policy Specific Fields -->
                                <div id="policySpecificFields" class="hidden">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Effective Date</label>
                                            <input type="date" name="effective_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Expiry Date</label>
                                            <input type="date" name="expiry_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- File Upload -->
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload File</label>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors">
                                    <input type="file" name="document_file" id="documentFile" class="hidden" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" onchange="handleFileSelect(this)">
                                    <div id="fileUploadArea" onclick="document.getElementById('documentFile').click()" class="cursor-pointer">
                                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                        <p class="text-gray-500 mb-2">Click to upload or drag and drop</p>
                                        <p class="text-sm text-gray-400">PDF, DOC, DOCX, JPG, PNG (Max 10MB)</p>
                                    </div>
                                    <div id="filePreview" class="hidden mt-4">
                                        <div class="flex items-center justify-center space-x-2">
                                            <i class="fas fa-file text-blue-500"></i>
                                            <span id="fileName" class="text-sm text-gray-700"></span>
                                            <button type="button" onclick="removeFile()" class="text-red-500 hover:text-red-700">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Modal Footer -->
                <div class="mt-6 flex justify-between items-center pt-4 border-t">
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        Select document type to continue
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="closeUploadDocumentModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                        <button onclick="uploadDocument()" id="uploadBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-upload mr-2"></i>Upload Document
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Learner Profile Details Modal -->
    <div id="learnerProfileModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex justify-between items-center pb-4 border-b">
                    <h3 class="text-2xl font-bold text-gray-900">Learner Profile Details</h3>
                    <button onclick="closeLearnerProfileModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Modal Content -->
                <div id="learnerProfileContent" class="mt-6">
                    <!-- Content will be populated by JavaScript -->
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500">Loading learner profile...</p>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="mt-6 flex justify-end space-x-3 pt-4 border-t">
                    <button onclick="closeLearnerProfileModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                    <button onclick="downloadLearnerProfileFromModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-download mr-2"></i>Download Profile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Learner Profile Detail Modal -->
    <div id="learnerProfileModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex justify-between items-center pb-4 border-b">
                    <h3 class="text-2xl font-bold text-gray-900">Learner Profile Details</h3>
                    <button onclick="closeLearnerProfileModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Modal Content -->
                <div id="learnerProfileContent" class="mt-6">
                    <!-- Content will be populated by JavaScript -->
                </div>

                <!-- Modal Footer -->
                <div class="flex justify-end mt-6 pt-4 border-t">
                    <button onclick="closeLearnerProfileModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 mr-2">
                        Close
                    </button>
                    <button onclick="downloadLearnerProfileFromModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-download mr-2"></i>Download Profile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Learner Profile Details Modal -->
    <div id="learnerProfileModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex justify-between items-center pb-4 border-b">
                    <h3 class="text-2xl font-bold text-gray-900">Learner Profile Details</h3>
                    <button onclick="closeLearnerProfileModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Modal Content -->
                <div id="learnerProfileContent" class="mt-6">
                    <!-- Content will be populated by JavaScript -->
                </div>

                <!-- Modal Footer -->
                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
                    <button onclick="closeLearnerProfileModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        Close
                    </button>
                    <button onclick="downloadLearnerProfileFromModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-download mr-2"></i>Download Profile
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Trainer View Details Modal -->
    <div id="trainerViewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex justify-between items-center pb-4 border-b">
                    <h3 class="text-2xl font-bold text-gray-900">Trainer Details</h3>
                    <button onclick="closeTrainerViewModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Modal Content -->
                <div id="trainerViewContent" class="mt-6">
                    <!-- Content will be populated by JavaScript -->
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500">Loading trainer details...</p>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="mt-6 flex justify-end space-x-3 pt-4 border-t">
                    <button onclick="closeTrainerViewModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trainer Edit Modal -->
    <div id="trainerEditModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <!-- Modal Header -->
                <div class="flex justify-between items-center pb-4 border-b">
                    <h3 class="text-2xl font-bold text-gray-900">Edit Trainer Password</h3>
                    <button onclick="closeTrainerEditModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Modal Content -->
                <form id="trainerEditForm" class="mt-6">
                    <input type="hidden" id="editTrainerId" name="trainer_id">
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Trainer Name</label>
                        <div id="editTrainerName" class="bg-gray-50 border rounded w-full py-2 px-3 text-gray-700"></div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Current Username</label>
                        <div id="editTrainerUsername" class="bg-gray-50 border rounded w-full py-2 px-3 text-gray-700"></div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Assigned Program</label>
                        <div id="editTrainerProgram" class="bg-gray-50 border rounded w-full py-2 px-3 text-gray-700"></div>
                    </div>
                    
                    <div class="mb-6">
                        <label for="editTrainerPassword" class="block text-gray-700 text-sm font-bold mb-2">New Password</label>
                        <div class="relative">
                            <input type="password" id="editTrainerPassword" name="new_password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500 pr-10" placeholder="Enter new password" required>
                            <button type="button" id="toggleEditPassword" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-600">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Password must be at least 8 characters long</p>
                    </div>
                    
                    <div class="mb-6">
                        <label for="editTrainerConfirmPassword" class="block text-gray-700 text-sm font-bold mb-2">Confirm New Password</label>
                        <input type="password" id="editTrainerConfirmPassword" name="confirm_password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-blue-500 focus:border-blue-500" placeholder="Confirm new password" required>
                    </div>
                </form>

                <!-- Modal Footer -->
                <div class="mt-6 flex justify-end space-x-3 pt-4 border-t">
                    <button onclick="closeTrainerEditModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                        Cancel
                    </button>
                    <button onclick="saveTrainerPassword()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-save mr-2"></i>Update Password
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Trainer Remove Confirmation Modal -->
    {% include 'warning_modal.html' with modal_id='trainerRemoveModal' modal_title='Remove Trainer' title_color='text-red-600' question='Are you sure?' warning_text='This action cannot be undone.' icon_color='text-red-500' detail_message='You are about to remove trainer: <strong id="removeTrainerName"></strong>' additional_warning='This will permanently delete the trainer account and all associated data.' alert_bg_color='red' close_function='closeTrainerRemoveModal()' confirm_function='confirmRemoveTrainer()' confirm_button_id='confirmRemoveBtn' confirm_button_color='red' confirm_text='Yes, Remove Trainer' cancel_text='No, Cancel' %}

    <script>
        // Enrollment Management System JavaScript
        let currentDate = new Date();
        let selectedDate = null;
        let selectedEvent = null;
        let currentCategory = 'all';
        let currentBatch = 1;
        let currentTrimester = 1;
        let events = []; // This will store all events
        let editingEventId = null;

        // Load events from database
        function loadEvents() {
            const params = new URLSearchParams({
                category: currentCategory === 'all' ? 'all' : currentCategory,
                batch: currentBatch === 'all' ? 'all' : currentBatch,
                trimester: currentTrimester === 'all' ? 'all' : currentTrimester
            });
            
            fetch(`/api/events/?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Convert string dates to Date objects
                        events = data.events.map(event => ({
                            ...event,
                            startDate: new Date(event.start_date),
                            endDate: event.end_date ? new Date(event.end_date) : null,
                            startTime: event.start_time,
                            endTime: event.end_time
                        }));
                        
                        generateCalendar();
                        updateEventsTable();
                        document.getElementById('eventCount').textContent = events.length;
                    } else {
                        console.error('Error loading events:', data.error);
                        showNotification('Error loading events', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error loading events', 'error');
                });
        }

        // Refresh events list
        function refreshEventsList() {
            // Refresh the table display
            updateEventsTable();
            showNotification('Events list refreshed', 'success');
        }
        
        // Refresh program monitoring table
        function refreshMonitoring() {
            location.reload();
        }

        // Set up periodic checking for ended enrollment events (every 5 minutes)
        document.addEventListener('DOMContentLoaded', function() {
            // Check batch cycle status periodically
            setInterval(checkForEndedEnrollmentEvents, 5 * 60 * 1000);
            
            // Initialize events from template data
            initializeEventsFromTemplate();
            generateCalendar();
        });

        // Initialize events from template data
        function initializeEventsFromTemplate() {
            // Convert eventsData to events format for calendar compatibility
            events = eventsData.map(event => ({
                ...event,
                startDate: new Date(event.startDate),
                endDate: event.endDate ? new Date(event.endDate) : null
            }));
            
            // Update event count
            document.getElementById('eventCount').textContent = events.length;
        }

        function selectCategory(category) {
            currentCategory = category;
            
            // Update button styles
            const allBtn = document.getElementById('allCategoryBtn');
            const enrollmentBtn = document.getElementById('enrollmentCategoryBtn');
            const departmentalBtn = document.getElementById('departmentalCategoryBtn');
            
            // Reset all buttons to inactive state
            allBtn.className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors';
            enrollmentBtn.className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors';
            departmentalBtn.className = 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors';
            
            // Set active button
            if (category === 'all') {
                allBtn.className = 'px-4 py-2 rounded-lg bg-blue-600 text-white font-medium transition-colors';
                document.getElementById('enrollmentControls').style.display = 'none';
            } else if (category === 'enrollment') {
                enrollmentBtn.className = 'px-4 py-2 rounded-lg bg-blue-600 text-white font-medium transition-colors';
                document.getElementById('enrollmentControls').style.display = 'block';
            } else if (category === 'departmental') {
                departmentalBtn.className = 'px-4 py-2 rounded-lg bg-blue-600 text-white font-medium transition-colors';
                document.getElementById('enrollmentControls').style.display = 'none';
            }
            
            updateEventsTable();
            generateCalendar();
        }

        // Batch Cycle Management Functions
        let currentBatchCycle = null;
        
        function checkBatchCycleStatus() {
            fetch('{% url "get_batch_cycle_status" %}')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentBatchCycle = data.cycle;
                        updateBatchCycleDisplay();
                        console.log('Batch Cycle Status:', currentBatchCycle);
                    } else {
                        console.error('Error fetching batch cycle status:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error fetching batch cycle status:', error);
                });
        }
        
        function checkForEndedEnrollmentEvents() {
            fetch('{% url "check_enrollment_events" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.activated_count > 0) {
                            console.log('Batch activated from enrollment event');
                            showNotification(`Batch ${data.current_batch} has been automatically activated!`, 'success');
                            
                            // Refresh batch cycle status
                            checkBatchCycleStatus();
                            
                            // Refresh events list
                            refreshEventsList();
                        }
                    } else {
                        console.error('Error checking enrollment events:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error checking enrollment events:', error);
                });
        }
        
        function updateBatchCycleDisplay() {
            if (!currentBatchCycle) return;
            
            // Update batch display in the UI if elements exist
            const batchDisplay = document.getElementById('currentBatchDisplay');
            if (batchDisplay) {
                batchDisplay.textContent = `Batch ${currentBatchCycle.current_batch}`;
            }
            
            const cycleStateDisplay = document.getElementById('cycleStateDisplay');
            if (cycleStateDisplay) {
                cycleStateDisplay.textContent = currentBatchCycle.cycle_state_display;
            }
            
            const semesterDisplay = document.getElementById('currentSemesterDisplay');
            if (semesterDisplay) {
                semesterDisplay.textContent = `Semester ${currentBatchCycle.current_semester}`;
            }
            
            // Disable batch selection if not in waiting state
            const batchButtons = document.querySelectorAll('[id^="batch"][id$="Btn"]');
            batchButtons.forEach(btn => {
                if (!currentBatchCycle.can_start_enrollment) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.title = 'Batch cycle in progress. Complete all semesters before starting new enrollment.';
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.title = '';
                }
            });
        }
        
        function getCsrfToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function selectBatch(batch) {
            currentBatch = batch;
            
            // Update button styles
            for (let i = 1; i <= 3; i++) {
                const btn = document.getElementById(`batch${i}Btn`);
                if (i === batch) {
                    btn.className = 'batch-btn px-4 py-2 rounded-lg bg-blue-600 text-white font-medium transition-colors';
                } else {
                    btn.className = 'batch-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors';
                }
            }
            
            updateEventsTable();
            generateCalendar();
        }

        function selectTrimester(trimester) {
            currentTrimester = trimester;
            
            // Update button styles
            for (let i = 1; i <= 3; i++) {
                const btn = document.getElementById(`trimester${i}Btn`);
                if (i === trimester) {
                    btn.className = 'trimester-btn px-4 py-2 rounded-lg bg-green-600 text-white font-medium transition-colors';
                } else {
                    btn.className = 'trimester-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium hover:bg-gray-300 transition-colors';
                }
            }
            
            updateEventsTable();
            generateCalendar();
        }

        function generateCalendar() {
            const calendarContainer = document.getElementById('enrollmentCalendar');
            if (!calendarContainer) return;

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            let calendarHTML = `
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="previousMonth()">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <h3 class="text-lg font-semibold">${monthNames[month]} ${year}</h3>
                    <button class="calendar-nav-btn" onclick="nextMonth()">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day-header">Sun</div>
                    <div class="calendar-day-header">Mon</div>
                    <div class="calendar-day-header">Tue</div>
                    <div class="calendar-day-header">Wed</div>
                    <div class="calendar-day-header">Thu</div>
                    <div class="calendar-day-header">Fri</div>
                    <div class="calendar-day-header">Sat</div>
            `;
            
            const today = new Date();
            const currentDay = startDate;
            
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const dayEvents = getEventsForDate(currentDay);
                    const isToday = currentDay.toDateString() === today.toDateString();
                    const isCurrentMonth = currentDay.getMonth() === month;
                    const isSelected = selectedDate && currentDay.toDateString() === selectedDate.toDateString();
                    
                    let dayClass = 'calendar-day';
                    if (!isCurrentMonth) dayClass += ' other-month';
                    if (isToday) dayClass += ' today';
                    if (isSelected) dayClass += ' selected';
                    
                    calendarHTML += `
                        <div class="${dayClass}" onclick="selectCalendarDate('${currentDay.toISOString()}')">
                            <div class="calendar-day-number">${currentDay.getDate()}</div>
                    `;
                    
                    dayEvents.forEach(event => {
                        calendarHTML += `
                            <div class="calendar-event ${event.category}" onclick="selectEventFromCalendar(${event.id}, event)">
                                ${event.title}
                            </div>
                        `;
                    });
                    
                    calendarHTML += '</div>';
                    currentDay.setDate(currentDay.getDate() + 1);
                }
            }
            
            calendarHTML += '</div>';
            calendarContainer.innerHTML = calendarHTML;
        }

        function getEventsForDate(date) {
            return events.filter(event => {
                const eventDate = new Date(event.startDate);
                return eventDate.toDateString() === date.toDateString() &&
                       (currentCategory === 'all' || event.category === currentCategory) &&
                       (event.category !== 'enrollment' || 
                        (event.batch === currentBatch && event.trimester === currentTrimester)) &&
                       (event.category !== 'departmental' || currentCategory === 'all' || currentCategory === 'departmental');
            });
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar();
        }

        function selectCalendarDate(dateString) {
            selectedDate = new Date(dateString);
            generateCalendar();
        }

        function selectEventFromCalendar(eventId, e) {
            e.stopPropagation();
            selectedEvent = events.find(event => event.id === eventId);
            updateSelectedEventInfo();
            highlightEventInTable(eventId);
        }

        function updateSelectedEventInfo() {
            const infoContainer = document.getElementById('selectedEventInfo');
            if (!selectedEvent) {
                infoContainer.innerHTML = '<p class="text-gray-600 text-sm">Select an event from the calendar or table to manage it</p>';
                return;
            }
            
            const startDate = new Date(selectedEvent.startDate).toLocaleDateString();
            const endDate = new Date(selectedEvent.endDate).toLocaleDateString();
            
            infoContainer.innerHTML = `
                <div class="space-y-2">
                    <h5 class="font-semibold text-gray-800">${selectedEvent.title}</h5>
                    <p class="text-sm text-gray-600"><strong>Category:</strong> ${selectedEvent.category}</p>
                    <p class="text-sm text-gray-600"><strong>Date:</strong> ${startDate} - ${endDate}</p>
                    ${selectedEvent.batch ? `<p class="text-sm text-gray-600"><strong>Batch:</strong> ${selectedEvent.batch}</p>` : ''}
                    ${selectedEvent.trimester ? `<p class="text-sm text-gray-600"><strong>Trimester:</strong> ${selectedEvent.trimester}</p>` : ''}
                    <p class="text-sm text-gray-600"><strong>Description:</strong> ${selectedEvent.description || 'No description'}</p>
                </div>
            `;
        }

        function updateEventsTable() {
            const tableBody = document.getElementById('eventsTableBody');
            if (!tableBody) return;
            
            const filteredEvents = events.filter(event => {
                if (currentCategory === 'all') return true;
                if (event.category !== currentCategory) return false;
                if (event.category === 'enrollment') {
                    return event.batch === currentBatch && event.trimester === currentTrimester;
                }
                return true;
            });
            
            if (filteredEvents.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-calendar-times text-4xl mb-2 text-gray-300"></i>
                            <p class="text-lg">No events found</p>
                            <p class="text-sm">Create a new event to get started</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = filteredEvents.map(event => {
                const startDate = new Date(event.startDate).toLocaleDateString();
                const endDate = new Date(event.endDate).toLocaleDateString();
                const batchTrimester = event.category === 'enrollment' ? 
                    `Batch ${event.batch} - ${event.trimester}${getOrdinalSuffix(event.trimester)} Sem` : 'N/A';
                
                return `
                    <tr class="hover:bg-gray-50" data-event-id="${event.id}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="event-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-event-id="${event.id}" value="${event.id}" onchange="updateEventSelection()">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${event.title}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${event.category === 'enrollment' ? 'bg-green-100 text-green-800' : 'bg-purple-100 text-purple-800'}">
                                ${event.category}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${startDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${endDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${batchTrimester}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${event.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                ${event.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="selectEventFromTable(${event.id})" class="text-blue-600 hover:text-blue-900 mr-2">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editEvent(${event.id})" class="text-yellow-600 hover:text-yellow-900 mr-2">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteEvent(${event.id})" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getOrdinalSuffix(num) {
            const suffixes = ['st', 'nd', 'rd'];
            return suffixes[num - 1] || 'th';
        }

        function selectEventFromTable(eventId) {
            selectedEvent = events.find(event => event.id === eventId);
            updateSelectedEventInfo();
            highlightEventInTable(eventId);
        }

        function highlightEventInTable(eventId) {
            // Remove previous highlights
            document.querySelectorAll('tr[data-event-id]').forEach(row => {
                row.classList.remove('bg-blue-50');
            });
            
            // Highlight selected row
            const row = document.querySelector(`tr[data-event-id="${eventId}"]`);
            if (row) {
                row.classList.add('bg-blue-50');
            }
        }

        function showNewEventModal() {
            editingEventId = null;
            document.getElementById('eventModalTitle').textContent = 'Create New Event';
            document.getElementById('eventForm').reset();
            document.getElementById('eventModal').classList.add('active');
            
            // Set default category
            document.getElementById('eventCategory').value = currentCategory;
            toggleEnrollmentFields();
            
            // Fetch BatchCycle data to auto-populate batch and trimester
            if (currentCategory === 'enrollment') {
                fetchBatchCycleStatus();
            }
        }
        
        function fetchBatchCycleStatus() {
            fetch('/api/batch-cycle/status/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const batchMap = {'1': 'Batch 1', '2': 'Batch 2', '3': 'Batch 3'};
                    const trimesterMap = {'1': '1st Semester', '2': '2nd Semester', '3': '3rd Semester'};
                    
                    document.getElementById('eventBatch').value = batchMap[data.cycle.current_batch] || 'N/A';
                    document.getElementById('eventTrimester').value = trimesterMap[data.cycle.current_semester] || 'N/A';
                    
                    // Store raw values for submission
                    document.getElementById('eventBatch').dataset.rawValue = data.cycle.current_batch;
                    document.getElementById('eventTrimester').dataset.rawValue = data.cycle.current_semester;
                } else {
                    document.getElementById('eventBatch').value = 'Error loading';
                    document.getElementById('eventTrimester').value = 'Error loading';
                }
            })
            .catch(error => {
                console.error('Error fetching batch cycle:', error);
                document.getElementById('eventBatch').value = 'Error';
                document.getElementById('eventTrimester').value = 'Error';
            });
        }

        function editEvent(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;
            
            editingEventId = eventId;
            document.getElementById('eventModalTitle').textContent = 'Edit Event';
            
            // Populate form
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventCategory').value = event.category;
            document.getElementById('eventStartDate').value = event.startDate.toISOString().split('T')[0];
            document.getElementById('eventEndDate').value = event.endDate.toISOString().split('T')[0];
            document.getElementById('eventStartTime').value = event.startTime || '';
            document.getElementById('eventEndTime').value = event.endTime || '';
            document.getElementById('eventDescription').value = event.description || '';
            
            if (event.category === 'enrollment') {
                document.getElementById('eventBatch').value = event.batch;
                document.getElementById('eventTrimester').value = event.trimester;
            }
            
            toggleEnrollmentFields();
            document.getElementById('eventModal').classList.add('active');
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
            editingEventId = null;
        }

        function toggleEnrollmentFields() {
            const category = document.getElementById('eventCategory').value;
            const enrollmentFields = document.getElementById('enrollmentFields');
            const timeFields = document.getElementById('timeFields');
            
            if (category === 'enrollment') {
                enrollmentFields.classList.remove('hidden');
                timeFields.classList.add('hidden'); // Hide time fields for enrollment
                // Fetch batch cycle data
                fetchBatchCycleStatus();
            } else {
                enrollmentFields.classList.add('hidden');
                timeFields.classList.remove('hidden'); // Show time fields for departmental
            }
        }
        // Event form submission
        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('eventTitle').value,
                category: document.getElementById('eventCategory').value,
                start_date: document.getElementById('eventStartDate').value,
                end_date: document.getElementById('eventEndDate').value,
                description: document.getElementById('eventDescription').value,
                status: 'active'
            };
            
            if (formData.category === 'enrollment') {
                // Use raw values from dataset for enrollment events
                const batchField = document.getElementById('eventBatch');
                const trimesterField = document.getElementById('eventTrimester');
                formData.batch = batchField.dataset.rawValue || batchField.value;
                formData.trimester = trimesterField.dataset.rawValue || trimesterField.value;
                // Don't send time fields for enrollment events
            } else {
                // Send time fields for departmental events
                formData.start_time = document.getElementById('eventStartTime').value;
                formData.end_time = document.getElementById('eventEndTime').value;
            }
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            if (editingEventId) {
                // Update existing event
                fetch(`/api/events/update/${editingEventId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Event updated successfully!', 'success');
                        closeEventModal();
                        // Update local arrays
                        const eventIndex = eventsData.findIndex(event => event.id === editingEventId);
                        if (eventIndex !== -1) {
                            eventsData[eventIndex] = {
                                ...eventsData[eventIndex],
                                ...formData,
                                startDate: formData.start_date,
                                endDate: formData.end_date
                            };
                            events[eventIndex] = {
                                ...events[eventIndex],
                                ...formData,
                                startDate: new Date(formData.start_date),
                                endDate: formData.end_date ? new Date(formData.end_date) : null
                            };
                        }
                        refreshEventsList();
                        generateCalendar();
                    } else {
                        showNotification('Error updating event: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error updating event', 'error');
                });
            } else {
                // Create new event
                fetch('/api/events/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Event created successfully!', 'success');
                        closeEventModal();
                        // Add to local arrays
                        const newEvent = {
                            id: data.event.id,
                            title: formData.title,
                            category: formData.category,
                            startDate: formData.start_date,
                            endDate: formData.end_date,
                            description: formData.description,
                            status: formData.status,
                            batch: formData.batch || null,
                            trimester: formData.trimester || null,
                            startTime: formData.start_time || null,
                            endTime: formData.end_time || null
                        };
                        eventsData.push(newEvent);
                        events.push({
                            ...newEvent,
                            startDate: new Date(formData.start_date),
                            endDate: formData.end_date ? new Date(formData.end_date) : null
                        });
                        refreshEventsList();
                        generateCalendar();
                    } else {
                        showNotification('Error creating event: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error creating event', 'error');
                });
            }
        });

        function editSelectedEvent() {
            if (!selectedEvent) {
                showNotification('Please select an event first', 'warning');
                return;
            }
            editEvent(selectedEvent.id);
        }

        function archiveSelectedEvent() {
            if (!selectedEvent) {
                showNotification('Please select an event first', 'warning');
                return;
            }
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`/api/events/archive/${selectedEvent.id}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Event archived successfully!', 'success');
                    selectedEvent = null;
                    updateSelectedEventInfo();
                    refreshEventsList();
                    generateCalendar();
                } else {
                    showNotification('Error archiving event: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error archiving event', 'error');
            });
        }

        function removeSelectedEvent() {
            // Get all checked event checkboxes
            const checkedBoxes = document.querySelectorAll('.event-checkbox:checked');
            
            if (checkedBoxes.length === 0) {
                showNotification('Please select at least one event to delete', 'warning');
                return;
            }
            
            // Collect event IDs from checked boxes
            const eventIds = Array.from(checkedBoxes).map(cb => cb.getAttribute('data-event-id'));
            const eventCount = eventIds.length;
            
            // Confirmation message with count
            const confirmMessage = eventCount === 1 
                ? 'Are you sure you want to delete this event? This action cannot be undone.'
                : `Are you sure you want to delete ${eventCount} events? This action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                let successCount = 0;
                let errorCount = 0;
                
                // Delete each event
                const deletePromises = eventIds.map(eventId => {
                    return fetch(`/api/events/delete/${eventId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting event:', error);
                        errorCount++;
                    });
                });
                
                // Wait for all deletions to complete
                Promise.all(deletePromises).then(() => {
                    if (successCount > 0 && errorCount === 0) {
                        const message = successCount === 1 
                            ? 'Event deleted successfully!' 
                            : `${successCount} events deleted successfully!`;
                        showNotification(message, 'success');
                    } else if (successCount > 0 && errorCount > 0) {
                        showNotification(`${successCount} events deleted, ${errorCount} failed`, 'warning');
                    } else {
                        showNotification('Error deleting events', 'error');
                    }
                    
                    // Reset selection and reload
                    selectedEvent = null;
                    updateSelectedEventInfo();
                    refreshEventsList();
                    generateCalendar();
                    
                    // Uncheck select all checkbox
                    const selectAllCheckbox = document.getElementById('selectAllEvents');
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = false;
                        selectAllCheckbox.indeterminate = false;
                    }
                });
            }
        }

        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                fetch(`/api/events/delete/${eventId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Event deleted successfully!', 'success');
                        if (selectedEvent && selectedEvent.id === eventId) {
                            selectedEvent = null;
                            updateSelectedEventInfo();
                        }
                        refreshEventsList();
                        generateCalendar();
                    } else {
                        showNotification('Error deleting event: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('Error deleting event', 'error');
                });
            }
        }

        function toggleAllEvents() {
            const selectAll = document.getElementById('selectAllEvents');
            const checkboxes = document.querySelectorAll('.event-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
            
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'warning' ? 'bg-yellow-500' : 
                           type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            notification.className += ` ${bgColor} text-white`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'warning' ? 'exclamation-triangle' : type === 'error' ? 'times' : 'info'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Modal functions for dashboard cards
        function openApplicantStatsModal() {
            document.getElementById('applicantStatsModal').classList.add('active');
        }

        function closeApplicantStatsModal() {
            document.getElementById('applicantStatsModal').classList.remove('active');
        }

        function openApprovedStatsModal() {
            document.getElementById('approvedStatsModal').classList.add('active');
        }

        function closeApprovedStatsModal() {
            document.getElementById('approvedStatsModal').classList.remove('active');
        }

        function openProgramStatsModal() {
            document.getElementById('programStatsModal').classList.add('active');
        }

        function closeProgramStatsModal() {
            document.getElementById('programStatsModal').classList.remove('active');
        }
    </script>

    <!-- Applicant Statistics Modal -->
    {% include 'modals/applicant_stats_modal.html' %}

    <!-- Approved Applicant Statistics Modal -->
    {% include 'modals/approved_stats_modal.html' %}
    <!-- Program Statistics Modal -->
    {% include 'modals/program_stats_modal.html' %}
    <script>
        // Dashboard Statistics Modal Functions
        function openApplicantStatsModal() {
            document.getElementById('applicantStatsModal').classList.add('active');
        }

        function closeApplicantStatsModal() {
            document.getElementById('applicantStatsModal').classList.remove('active');
        }

        function openApprovedStatsModal() {
            document.getElementById('approvedStatsModal').classList.add('active');
        }

        function closeApprovedStatsModal() {
            document.getElementById('approvedStatsModal').classList.remove('active');
        }

        function openProgramStatsModal() {
            document.getElementById('programStatsModal').classList.add('active');
        }

        function closeProgramStatsModal() {
            document.getElementById('programStatsModal').classList.remove('active');
        }

        // Fix Program Modal Data Issue
        // Populate program data with actual data from Django template
        programData = {
            {% for prog in combined_programs %}
            '{{ prog.id }}': {
                name: '{{ prog.program_name|escapejs }}',
                students: [
                    {% for applicant in prog.approved_applicants %}
                    {
                        name: '{{ applicant.profile.first_name|escapejs }} {{ applicant.profile.middle_name|escapejs }} {{ applicant.profile.last_name|escapejs }}',
                        program: '{{ prog.program_name|escapejs }}',
                        contact: '{{ applicant.profile.phone_number|default:"N/A"|escapejs }}',
                        address: '{{ applicant.profile.address|default:"N/A"|escapejs }}',
                        status: 'Approved'
                    }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ]
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        };

        // Events List Functions
        let eventsData = [
            {% for event in events %}
            {
                id: '{{ event.id }}',
                title: '{{ event.title|escapejs }}',
                category: '{{ event.category|default:"General"|escapejs }}',
                startDate: '{{ event.start_date|date:"Y-m-d" }}',
                endDate: '{{ event.end_date|date:"Y-m-d" }}',
                batchTrimester: '{{ event.batch_trimester|default:"N/A"|escapejs }}',
                status: '{{ event.status|default:"Active"|escapejs }}'
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        function refreshEventsList() {
            const tableBody = document.getElementById('eventsTableBody');
            const eventCount = document.getElementById('eventCount');
            const noEventsRow = document.getElementById('noEventsRow');
            
            // Clear existing rows except the no events row
            tableBody.innerHTML = '<tr id="noEventsRow" class="hidden"><td colspan="8" class="px-6 py-12 text-center"><div class="flex flex-col items-center justify-center"><i class="fas fa-calendar-times text-4xl text-gray-300 mb-4"></i><h3 class="text-lg font-medium text-gray-500 mb-2">No Events Found</h3><p class="text-gray-400 text-sm mb-4">Create your first event to get started</p><button onclick="showNewEventModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors"><i class="fas fa-plus mr-2"></i>Create Event</button></div></td></tr>';
            
            if (eventsData.length === 0) {
                document.getElementById('noEventsRow').classList.remove('hidden');
                eventCount.textContent = '0';
                return;
            }
            
            // Update event count
            eventCount.textContent = eventsData.length;
            
            // Populate table with events
            eventsData.forEach((event, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="event-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                               data-event-id="${event.id}" value="${event.id}" onchange="updateEventSelection()">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${event.title}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${event.category}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${event.startDate}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${event.endDate}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${event.batchTrimester}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                            ${event.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="editEvent('${event.id}')" class="text-blue-600 hover:text-blue-900 transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteEvent('${event.id}')" class="text-red-600 hover:text-red-900 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function toggleAllEvents() {
            const selectAll = document.getElementById('selectAllEvents');
            const checkboxes = document.querySelectorAll('#eventsTableBody input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateEventSelection();
        }

        function updateEventSelection() {
            const checkboxes = document.querySelectorAll('#eventsTableBody input[type="checkbox"]');
            const selectAll = document.getElementById('selectAllEvents');
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            
            selectAll.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
            selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
        }

        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event?')) {
                // Remove from eventsData array
                eventsData = eventsData.filter(event => event.id !== eventId);
                
                // Remove from events array for calendar
                events = events.filter(event => event.id !== eventId);
                
                // Refresh both calendar and table
                refreshEventsList();
                generateCalendar();
            }
        }

        // Initialize events list when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            refreshEventsList();
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = ['applicantStatsModal', 'approvedStatsModal', 'programStatsModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Dropdown functionality for bulk document download
        function toggleDownloadDropdown() {
            const dropdown = document.getElementById('downloadDropdown');
            dropdown.classList.toggle('hidden');
        }

        function downloadSelectedDocuments(format) {
            const selectedCheckboxes = document.querySelectorAll('.document-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                alert('Please select at least one document to download.');
                return;
            }

            // Close dropdown
            document.getElementById('downloadDropdown').classList.add('hidden');

            // Show loading state
            const button = document.querySelector('[onclick="toggleDownloadDropdown()"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Preparing download...';
            button.disabled = true;

            // Get selected documents data
            const selectedDocuments = filteredDocumentsData.filter(doc => 
                selectedIds.includes(((doc.document_id !== undefined && doc.document_id !== null) ? doc.document_id : doc.id).toString())
            );

            // Prepare download based on format
            if (format === 'excel') {
                downloadAsExcel(selectedDocuments);
            } else if (format === 'zip') {
                downloadAsZIP(selectedDocuments);
            }

            // Reset button after a delay
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 3000);
        }


        function downloadAsExcel(documents) {
            // Get selected document IDs
            const selectedCheckboxes = document.querySelectorAll('.document-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) {
                alert('Please select at least one document to download.');
                return;
            }
            
            // Get current filter values (for reference)
            const filters = {
                batch: document.getElementById('filterByBatch')?.value || '',
                year: document.getElementById('filterByYear')?.value || '',
                document_type: document.getElementById('filterByDocumentType')?.value || '',
                search: document.getElementById('filterById')?.value || ''
            };
            
            // Call backend API to generate Excel with selected documents
            console.log('Downloading with selected IDs:', selectedIds);
            
            // Get CSRF token from cookie or meta tag
            let csrftoken = getCookie('csrftoken');
            if (!csrftoken) {
                // Try getting from meta tag as fallback
                const metaTag = document.querySelector('meta[name="csrf-token"]');
                if (metaTag) {
                    csrftoken = metaTag.content;
                }
            }
            
            // Try getting from hidden input as another fallback
            if (!csrftoken) {
                const hiddenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
                if (hiddenInput) {
                    csrftoken = hiddenInput.value;
                }
            }
            
            console.log('CSRF Token:', csrftoken ? 'Found (length: ' + csrftoken.length + ')' : 'NOT FOUND');
            
            if (!csrftoken) {
                alert('CSRF token not found. Please refresh the page and try again.');
                return;
            }
            
            fetch('/download-bulk-documents-excel/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ 
                    selected_ids: selectedIds,
                    filters: filters 
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response content-type:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    // Check if response is JSON (error message) or HTML (server error)
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json().then(data => {
                            throw new Error(data.error || 'Server returned an error');
                        });
                    } else {
                        // HTML error page - likely 500 or authentication issue
                        return response.text().then(text => {
                            console.error('Server error response:', text.substring(0, 500));
                            throw new Error(`Server error (${response.status}): Please check if you are logged in and try again.`);
                        });
                    }
                }
                return response.blob();
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                a.download = `Documents_Report_${timestamp}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Show success message
                alert('Excel file downloaded successfully!');
            })
            .catch(error => {
                console.error('Error downloading Excel:', error);
                alert('Error downloading Excel file: ' + error.message);
            });
        }

        function downloadAsZIP(documents) {
            // First create Excel file
            const wb = XLSX.utils.book_new();
            
            // Prepare data for Excel
            const excelData = documents.map(doc => ({
                'ID': doc.id,
                'Document Name': doc.document_name,
                'Document Type': (doc.document_type === 'modules_manuals'
                                  ? 'Manuals'
                                  : (doc.document_type === 'policy_guidelines'
                                     ? 'Policy and Guidelines'
                                     : (doc.document_type === 'applicant_profile'
                                        ? 'Applicant Profile'
                                        : (doc.document_type || 'Unknown')))),
                'Upload Date': new Date(doc.uploaded_at).toLocaleDateString(),
                'Batch': `Batch ${doc.batch}`,
                'Status': doc.status.charAt(0).toUpperCase() + doc.status.slice(1),
                'Learner Name': doc.learner_profile ? doc.learner_profile.full_name : 'N/A'
            }));
            
            // Create worksheet
            const ws = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, 'Documents');
            
            // Convert to binary
            const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            
            // Create ZIP file using JSZip
            const zip = new JSZip();
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            
            // Add Excel file to ZIP
            zip.file(`documents_report_${timestamp}.xlsx`, excelBuffer);
            
            // Generate and download ZIP
            zip.generateAsync({ type: 'blob' }).then(function(content) {
                const url = window.URL.createObjectURL(content);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `documents_report_${timestamp}.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            });
        }

        // Download selected actual files (Manuals/Policy) as ZIP
        function downloadSelectedFilesZIP() {
            const selectedCheckboxes = document.querySelectorAll('.document-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            if (selectedIds.length === 0) {
                alert('Please select at least one document to download.');
                return;
            }

            // Map selected ids to document objects - use doc.id since checkbox uses doc.id format (LMSTC-xxx or LP-xxx)
            const selectedDocs = filteredDocumentsData.filter(doc => 
                selectedIds.includes(doc.id)
            );
            
            console.log('Selected IDs:', selectedIds);
            console.log('Selected Documents:', selectedDocs);
            console.log('Document file URLs:', selectedDocs.map(doc => ({ id: doc.id, file_url: doc.file_url, has_file: !!doc.file_url })));
            
            const docsWithFiles = selectedDocs.filter(doc => {
                const hasUrl = doc.file_url && doc.file_url !== 'null' && doc.file_url !== null && doc.file_url !== '';
                if (!hasUrl) {
                    console.warn(`Document ${doc.id} (${doc.document_name}) has no file_url:`, doc.file_url);
                }
                return hasUrl;
            });
            
            if (docsWithFiles.length === 0) {
                if (selectedDocs.length === 0) {
                    alert('No documents matched the selected IDs. Please try refreshing the page.');
                } else {
                    const docNames = selectedDocs.map(doc => `"${doc.document_name}"`).join(', ');
                    alert(`Selected ${selectedDocs.length} document(s) (${docNames}), but none have downloadable files attached.\n\nThis usually means:\n- The documents were created without file uploads\n- The files were deleted from the server\n- The document records are metadata-only\n\nPlease check if the documents actually have files, or upload files to these documents first.`);
                }
                return;
            }

            const zip = new JSZip();
            const promises = docsWithFiles.map((doc, index) => {
                const fileUrl = doc.file_url;
                const urlSegments = (fileUrl || '').split('/');
                const urlFilename = urlSegments[urlSegments.length - 1] || '';
                const baseName = (doc.document_name || urlFilename || `document_${index}`);
                // Sanitize filename
                let safeName = baseName.replace(/[^a-zA-Z0-9_\-\.]/g, '_');
                if (!safeName || safeName === '_') {
                    safeName = `document_${(doc.document_id || doc.id || index)}`;
                }

                return fetch(fileUrl)
                    .then(resp => {
                        if (!resp.ok) throw new Error(`Failed to fetch ${fileUrl}`);
                        return resp.blob();
                    })
                    .then(blob => {
                        zip.file(safeName, blob);
                    })
                    .catch(err => {
                        console.error('Skipping file due to error:', fileUrl, err);
                    });
            });

            Promise.all(promises).then(() => {
                zip.generateAsync({ type: 'blob' }).then(content => {
                    const url = window.URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    a.download = `documents_files_${timestamp}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                });
            });
        }


        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('downloadDropdown');
            const button = document.querySelector('[onclick="toggleDownloadDropdown()"]');
            
            if (dropdown && button && !dropdown.contains(event.target) && !button.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        // Notification function
        function showNotification(title, message, type) {
            // Create notification element if it doesn't exist
            let notification = document.getElementById('downloadNotification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'downloadNotification';
                notification.className = 'fixed top-4 right-4 z-50 max-w-sm';
                document.body.appendChild(notification);
            }

            const bgColor = type === 'success' ? 'bg-green-100 border-green-500 text-green-700' : 'bg-red-100 border-red-500 text-red-700';
            const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';

            notification.innerHTML = `
                <div class="border-l-4 p-4 ${bgColor} rounded shadow-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="${icon}"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium">${title}</p>
                            <p class="text-sm">${message}</p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (notification && notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Trainer Management Functions
        let currentTrainerData = null;

        // View Trainer Details Function
        function viewTrainerDetails(trainerId) {
            // Show loading state
            const modal = document.getElementById('trainerViewModal');
            const content = document.getElementById('trainerViewContent');
            
            content.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">Loading trainer details...</p>
                </div>
            `;
            
            modal.classList.remove('hidden');

            // Fetch trainer details from backend
            fetch(`/api/trainer-details/${trainerId}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentTrainerData = data.trainer;
                    displayTrainerDetails(data.trainer);
                } else {
                    content.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                            <p class="text-red-500">Error loading trainer details</p>
                            <p class="text-gray-500 text-sm">${data.message || 'Unknown error occurred'}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                content.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                        <p class="text-red-500">Error loading trainer details</p>
                        <p class="text-gray-500 text-sm">Network error occurred</p>
                    </div>
                `;
            });
        }

        function displayTrainerDetails(trainer) {
            const content = document.getElementById('trainerViewContent');
            
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Trainer Profile Section -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="h-16 w-16 rounded-full bg-blue-500 flex items-center justify-center">
                                <span class="text-white font-bold text-xl">
                                    ${trainer.user.first_name ? trainer.user.first_name.charAt(0) : trainer.user.username.charAt(0)}${trainer.user.last_name ? trainer.user.last_name.charAt(0) : ''}
                                </span>
                            </div>
                            <div>
                                <h4 class="text-xl font-bold text-gray-900">
                                    ${trainer.user.first_name && trainer.user.last_name ? 
                                        `${trainer.user.first_name} ${trainer.user.last_name}` : 
                                        trainer.user.username}
                                </h4>
                                <p class="text-gray-600">@${trainer.user.username}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Account Information -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white border rounded-lg p-4">
                            <h5 class="font-semibold text-gray-800 mb-3">Account Information</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Username:</span>
                                    <span class="font-medium">${trainer.user.username}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Password:</span>
                                    <span class="font-medium font-mono">••••••••</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Email:</span>
                                    <span class="font-medium">${trainer.user.email || 'No email'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Date Joined:</span>
                                    <span class="font-medium">${new Date(trainer.user.date_joined).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white border rounded-lg p-4">
                            <h5 class="font-semibold text-gray-800 mb-3">Program Assignment</h5>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Program:</span>
                                    <span class="font-medium">${trainer.program ? trainer.program.program_name : 'No Program Assigned'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Status:</span>
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${trainer.program ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                        ${trainer.program ? 'Active' : 'Unassigned'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="bg-white border rounded-lg p-4">
                        <h5 class="font-semibold text-gray-800 mb-3">Additional Information</h5>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Account Type:</span>
                                <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                    <i class="fas fa-chalkboard-teacher mr-1"></i>Trainer
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Last Login:</span>
                                <span class="font-medium">${trainer.user.last_login ? new Date(trainer.user.last_login).toLocaleDateString() : 'Never'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function closeTrainerViewModal() {
            document.getElementById('trainerViewModal').classList.add('hidden');
            currentTrainerData = null;
        }
        // Edit Trainer Function
        function editTrainer(trainerId) {
            // Show loading state
            const modal = document.getElementById('trainerEditModal');
            modal.classList.remove('hidden');

            // Fetch trainer details for editing
            fetch(`/api/trainer-details/${trainerId}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    populateEditForm(data.trainer);
                } else {
                    showNotification('Error', 'Failed to load trainer details for editing', 'error');
                    closeTrainerEditModal();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error', 'Network error occurred', 'error');
                closeTrainerEditModal();
            });
        }

        function populateEditForm(trainer) {
            document.getElementById('editTrainerId').value = trainer.id;
            document.getElementById('editTrainerName').textContent = 
                trainer.user.first_name && trainer.user.last_name ? 
                    `${trainer.user.first_name} ${trainer.user.last_name}` : 
                    trainer.user.username;
            document.getElementById('editTrainerUsername').textContent = trainer.user.username;
            document.getElementById('editTrainerProgram').textContent = 
                trainer.program ? trainer.program.program_name : 'No Program Assigned';
            
            // Clear password fields
            document.getElementById('editTrainerPassword').value = '';
            document.getElementById('editTrainerConfirmPassword').value = '';
        }

        function closeTrainerEditModal() {
            document.getElementById('trainerEditModal').classList.add('hidden');
            // Clear form
            document.getElementById('trainerEditForm').reset();
        }

        function saveTrainerPassword() {
            const trainerId = document.getElementById('editTrainerId').value;
            const newPassword = document.getElementById('editTrainerPassword').value;
            const confirmPassword = document.getElementById('editTrainerConfirmPassword').value;

            // Validation
            if (!newPassword || !confirmPassword) {
                showNotification('Error', 'Please fill in all password fields', 'error');
                return;
            }

            if (newPassword.length < 8) {
                showNotification('Error', 'Password must be at least 8 characters long', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNotification('Error', 'Passwords do not match', 'error');
                return;
            }

            // Show loading state
            const saveBtn = document.querySelector('[onclick="saveTrainerPassword()"]');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Updating...';
            saveBtn.disabled = true;

            // Send request to backend
            fetch(`/api/trainer-update-password/${trainerId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Success', 'Trainer password updated successfully', 'success');
                    closeTrainerEditModal();
                } else {
                    showNotification('Error', data.message || 'Failed to update password', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error', 'Network error occurred', 'error');
            })
            .finally(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

        // Manage Trainer Programs Functions
        let currentManageTrainerId = null;
        
        async function manageTrainerPrograms(trainerId, trainerName) {
            currentManageTrainerId = trainerId;
            document.getElementById('trainerNameDisplay').textContent = trainerName;
            document.getElementById('manageTrainerProgramsModal').classList.add('active');
            
            // Load trainer programs
            await loadTrainerPrograms(trainerId);
        }
        
        async function loadTrainerPrograms(trainerId) {
            try {
                const response = await fetch(`/api/trainer/${trainerId}/programs/`);
                const data = await response.json();
                
                if (data.success) {
                    // Display assigned programs
                    const assignedList = document.getElementById('assignedProgramsList');
                    if (data.assigned_programs.length === 0) {
                        assignedList.innerHTML = '<p class="text-gray-400 text-center">No programs assigned yet</p>';
                    } else {
                        assignedList.innerHTML = data.assigned_programs.map(prog => `
                            <div class="flex items-center justify-between p-2 bg-green-50 border border-green-200 rounded">
                                <span class="text-gray-700">${prog.program_name}</span>
                                <button onclick="unassignProgram(${prog.id}, '${prog.program_name}')" 
                                        class="text-red-600 hover:text-red-800 px-2 py-1 text-sm">
                                    <i class="fas fa-times"></i> Remove
                                </button>
                            </div>
                        `).join('');
                    }
                    
                    // Populate dropdown with programs NOT assigned to this trainer AND NOT assigned to other trainers
                    const dropdown = document.getElementById('programToAssign');
                    const assignedIds = data.assigned_programs.map(p => p.id);
                    const programsInUse = data.programs_in_use || []; // Programs assigned to other trainers
                    
                    // Filter out programs that are assigned to this trainer OR other trainers
                    const availablePrograms = data.all_programs.filter(p => 
                        !assignedIds.includes(p.id) && !programsInUse.includes(p.id)
                    );
                    
                    if (availablePrograms.length === 0) {
                        dropdown.innerHTML = '<option value="">No programs available (all assigned)</option>';
                    } else {
                        dropdown.innerHTML = '<option value="">Select a program...</option>' + 
                            availablePrograms.map(prog => 
                                `<option value="${prog.id}">${prog.program_name}</option>`
                            ).join('');
                    }
                } else {
                    showNotification('Error', data.message || 'Failed to load programs', 'error');
                }
            } catch (error) {
                console.error('Error loading trainer programs:', error);
                showNotification('Error', 'Failed to load programs', 'error');
            }
        }
        
        async function assignProgram() {
            const programId = document.getElementById('programToAssign').value;
            if (!programId) {
                showNotification('Warning', 'Please select a program', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/trainer/${currentManageTrainerId}/assign-program/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ program_id: programId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Success', data.message, 'success');
                    await loadTrainerPrograms(currentManageTrainerId);
                    // Refresh the trainer list to show updated programs
                    location.reload();
                } else {
                    showNotification('Error', data.message, 'error');
                }
            } catch (error) {
                console.error('Error assigning program:', error);
                showNotification('Error', 'Failed to assign program', 'error');
            }
        }
        
        async function unassignProgram(programId, programName) {
            if (!confirm(`Are you sure you want to unassign "${programName}" from this trainer?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/trainer/${currentManageTrainerId}/unassign-program/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ program_id: programId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Success', data.message, 'success');
                    await loadTrainerPrograms(currentManageTrainerId);
                    // Refresh the trainer list to show updated programs
                    location.reload();
                } else {
                    showNotification('Error', data.message, 'error');
                }
            } catch (error) {
                console.error('Error unassigning program:', error);
                showNotification('Error', 'Failed to unassign program', 'error');
            }
        }
        
        // Close manage programs modal
        document.getElementById('closeManageProgramsBtn')?.addEventListener('click', () => {
            document.getElementById('manageTrainerProgramsModal').classList.remove('active');
            currentManageTrainerId = null;
        });
        
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Remove Trainer Function - Make it globally accessible
        window.removeTrainer = function(trainerId, trainerName) {
            console.log('removeTrainer called with:', trainerId, trainerName);
            
            try {
                if (!trainerId) {
                    console.error('Invalid trainer ID:', trainerId);
                    showNotification('Error', 'Invalid trainer ID', 'error');
                    return;
                }
                
                if (!trainerName) {
                    trainerName = 'Unknown Trainer';
                }
                
                // Ensure currentTrainerData is accessible
                if (typeof currentTrainerData === 'undefined') {
                    currentTrainerData = null;
                }
                
                currentTrainerData = { id: parseInt(trainerId), name: String(trainerName) };
                console.log('currentTrainerData set:', currentTrainerData);
                
                const nameElement = document.getElementById('removeTrainerName');
                if (nameElement) {
                    nameElement.textContent = trainerName;
                    console.log('Trainer name set in modal');
                } else {
                    console.error('removeTrainerName element not found');
                }
                
                // Show the confirmation modal
                const modal = document.getElementById('trainerRemoveModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                    console.log('Modal shown');
                } else {
                    console.error('Trainer remove modal not found in DOM');
                    alert('Modal not found. Please refresh the page. Modal ID: trainerRemoveModal');
                }
            } catch (error) {
                console.error('Error in removeTrainer:', error);
                alert('Error: ' + error.message);
            }
        };
        
        // Also keep the function without window for backward compatibility
        function removeTrainer(trainerId, trainerName) {
            window.removeTrainer(trainerId, trainerName);
        }

        function closeTrainerRemoveModal() {
            const modal = document.getElementById('trainerRemoveModal');
            if (modal) {
                modal.classList.add('hidden');
            }
            currentTrainerData = null;
        }

        async function confirmRemoveTrainer() {
            if (!currentTrainerData) {
                showNotification('Error', 'No trainer selected for removal', 'error');
                return;
            }

            // Show loading state
            const removeBtn = document.getElementById('confirmRemoveBtn');
            if (!removeBtn) {
                showNotification('Error', 'Confirm button not found. Please refresh the page.', 'error');
                return;
            }
            
            const originalText = removeBtn.innerHTML;
            removeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting Account...';
            removeBtn.disabled = true;

            try {
                // Send request to delete trainer account
                const response = await fetch(`/api/trainer/${currentTrainerData.id}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Success', data.message, 'success');
                    closeTrainerRemoveModal();
                    // Refresh the trainer list
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification('Error', data.message || 'Failed to delete trainer account', 'error');
                    removeBtn.innerHTML = originalText;
                    removeBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error', 'Network error occurred', 'error');
                removeBtn.innerHTML = originalText;
                removeBtn.disabled = false;
            }
        }

        // Manage Trainer Programs Functions
        let currentTrainerId = null;

        function manageTrainerPrograms(trainerId, trainerName) {
            currentTrainerId = trainerId;
            document.getElementById('trainerNameDisplay').textContent = trainerName;
            
            // Open modal
            document.getElementById('manageTrainerProgramsModal').classList.add('active');
            
            // Load trainer programs
            loadTrainerPrograms(trainerId);
        }

        async function loadTrainerPrograms(trainerId) {
            const assignedList = document.getElementById('assignedProgramsList');
            const programSelect = document.getElementById('programToAssign');
            
            assignedList.innerHTML = '<p class="text-gray-400 text-center">Loading...</p>';
            
            try {
                const response = await fetch(`/api/trainer/${trainerId}/programs/`);
                const data = await response.json();
                
                if (data.success) {
                    // Populate assigned programs list
                    if (data.assigned_programs.length === 0) {
                        assignedList.innerHTML = '<p class="text-gray-400 text-center">No programs assigned</p>';
                    } else {
                        assignedList.innerHTML = data.assigned_programs.map(prog => `
                            <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                <span class="text-gray-700">${prog.program_name}</span>
                                <button onclick="unassignProgram(${prog.id})" class="text-red-600 hover:text-red-800 text-sm">
                                    <i class="fas fa-times mr-1"></i>Remove
                                </button>
                            </div>
                        `).join('');
                    }
                    
                    // Populate available programs dropdown
                    const assignedIds = data.assigned_programs.map(p => p.id);
                    const availablePrograms = data.all_programs.filter(p => !assignedIds.includes(p.id));
                    
                    programSelect.innerHTML = '<option value="">Select a program...</option>' + 
                        availablePrograms.map(prog => `<option value="${prog.id}">${prog.program_name}</option>`).join('');
                } else {
                    assignedList.innerHTML = '<p class="text-red-400 text-center">Error loading programs</p>';
                }
            } catch (error) {
                console.error('Error loading programs:', error);
                assignedList.innerHTML = '<p class="text-red-400 text-center">Error loading programs</p>';
            }
        }

        async function assignProgram() {
            const programSelect = document.getElementById('programToAssign');
            const programId = programSelect.value;
            
            if (!programId) {
                showNotification('Warning', 'Please select a program to assign', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/trainer/${currentTrainerId}/assign-program/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ program_id: programId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Success', data.message, 'success');
                    loadTrainerPrograms(currentTrainerId);
                    // Reload the page to refresh the trainer list
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification('Error', data.message, 'error');
                }
            } catch (error) {
                console.error('Error assigning program:', error);
                showNotification('Error', 'Failed to assign program', 'error');
            }
        }

        async function unassignProgram(programId) {
            if (!confirm('Are you sure you want to unassign this program?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/trainer/${currentTrainerId}/unassign-program/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ program_id: programId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Success', data.message, 'success');
                    loadTrainerPrograms(currentTrainerId);
                    // Reload the page to refresh the trainer list
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification('Error', data.message, 'error');
                }
            } catch (error) {
                console.error('Error unassigning program:', error);
                showNotification('Error', 'Failed to unassign program', 'error');
            }
        }

        // Close manage programs modal
        document.getElementById('closeManageProgramsBtn').addEventListener('click', () => {
            document.getElementById('manageTrainerProgramsModal').classList.remove('active');
        });

        // Password toggle functionality for edit modal
        document.addEventListener('DOMContentLoaded', function() {
            const toggleEditPassword = document.getElementById('toggleEditPassword');
            if (toggleEditPassword) {
                toggleEditPassword.addEventListener('click', function() {
                    const passwordField = document.getElementById('editTrainerPassword');
                    const icon = this.querySelector('i');
                    
                    if (passwordField.type === 'password') {
                        passwordField.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        passwordField.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            }


            // Modal close on outside click
            const modals = ['trainerViewModal', 'trainerEditModal', 'trainerRemoveModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(event) {
                        if (event.target === this) {
                            if (modalId === 'trainerViewModal') closeTrainerViewModal();
                            else if (modalId === 'trainerEditModal') closeTrainerEditModal();
                            else if (modalId === 'trainerRemoveModal') closeTrainerRemoveModal();
                        }
                    });
                }
            });
        });
    </script>

</body>
</html>